<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ImobiPro - Gestão Imobiliária</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --accent: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            
            --type-visita: #3b82f6;
            --type-reuniao-construtor: #8b5cf6;
            --type-reuniao-equipe: #0ea5e9;
            --type-documentacao: #10b981;
            --type-plantao: #7c3aed;
            --type-generico: #f59e0b;
            --type-outro: #64748b;
            
            --funnel-lead: #93c5fd;
            --funnel-contato: #60a5fa;
            --funnel-cpf: #3b82f6;
            --funnel-sem-restricao: #1d4ed8;
            --funnel-documentacao: #7c3aed;
            --funnel-aprovado: #10b981;
            --funnel-contrato: #059669;
            --funnel-venda: #047857;
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --header-height: calc(60px + var(--safe-top));
            --nav-height: calc(65px + var(--safe-bottom));
            --radius-lg: 16px;
            --radius-md: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-float: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: var(--dark);
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
        }

        header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: var(--safe-top) 16px 10px;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 50;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: var(--shadow-sm);
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--dark);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .brand span { color: var(--primary); }
        
        .header-actions { display: flex; gap: 12px; }
        .icon-btn {
            background: none; border: none; font-size: 1.2rem;
            color: var(--secondary); padding: 8px;
            border-radius: 50%; transition: 0.2s;
            cursor: pointer;
        }
        .icon-btn:active { background: #f1f5f9; color: var(--primary); transform: scale(0.95); }

        main {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: calc(var(--header-height) + 16px) 16px calc(var(--nav-height) + 80px);
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }

        .view { 
            display: none; 
            animation: fadeIn 0.3s ease;
            width: 100%;
        }
        .view.active { display: block; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
            width: 100%;
        }

        .stat-card {
            background: var(--surface);
            padding: 16px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid var(--border);
            min-height: 90px;
        }
        .stat-card:active { transform: scale(0.98); box-shadow: var(--shadow-sm); }

        .stat-icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem;
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--dark); line-height: 1; }
        .stat-label { font-size: 0.8rem; color: var(--secondary); font-weight: 500; }

        .bg-blue { background: #dbeafe; color: var(--primary); }
        .bg-green { background: #d1fae5; color: var(--success); }
        .bg-orange { background: #ffedd5; color: var(--warning); }
        .bg-red { background: #fee2e2; color: var(--danger); }
        .bg-purple { background: #f3e8ff; color: #8b5cf6; }
        .bg-cyan { background: #cffafe; color: #06b6d4; }

        .section-title {
            font-size: 1.1rem; font-weight: 700; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
            width: 100%;
        }

        .search-container {
            position: relative; margin-bottom: 16px;
            width: 100%;
        }
        .search-input {
            width: 100%; padding: 12px 12px 12px 40px;
            border: 1px solid var(--border); border-radius: var(--radius-md);
            background: var(--surface); font-size: 1rem; outline: none;
            -webkit-appearance: none;
            font-family: 'Inter', sans-serif;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: var(--secondary);
            pointer-events: none;
        }

        .property-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            border-left: 4px solid transparent;
            transition: transform 0.2s;
            cursor: pointer;
            width: 100%;
            border: 1px solid var(--border);
        }
        .property-card:active { transform: scale(0.98); }

        .property-image {
            width: 100%; height: 180px;
            object-fit: cover;
            background: #e2e8f0;
            display: flex; align-items: center; justify-content: center;
            color: var(--secondary);
            position: relative;
        }

        .property-badge {
            position: absolute; top: 12px; left: 12px;
            padding: 4px 10px; border-radius: 20px;
            font-size: 0.7rem; font-weight: 700;
            z-index: 2;
        }
        .badge-sale { background: var(--primary); color: white; }
        .badge-rent { background: var(--success); color: white; }
        .badge-featured { background: var(--warning); color: white; }
        .badge-success { background: var(--success); color: white; }
        .badge-warning { background: var(--warning); color: white; }

        .property-content { padding: 16px; }
        .property-title { 
            font-weight: 700; font-size: 1rem; color: var(--dark);
            margin-bottom: 4px; line-height: 1.3;
        }
        .property-address { 
            font-size: 0.85rem; color: var(--secondary); 
            margin-bottom: 8px; display: flex; align-items: center; gap: 4px;
        }
        .property-features {
            display: flex; gap: 12px; margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .feature {
            display: flex; flex-direction: column; align-items: center;
            font-size: 0.75rem; color: var(--secondary);
            min-width: 50px;
        }
        .feature i { font-size: 1rem; margin-bottom: 2px; color: var(--primary); }
        
        .property-price {
            font-size: 1.3rem; font-weight: 800; color: var(--primary);
            margin-bottom: 8px;
        }
        .property-price .period { font-size: 0.9rem; color: var(--secondary); }

        .property-actions {
            display: flex; gap: 8px; margin-top: 12px;
            padding-top: 12px; border-top: 1px solid var(--border);
            width: 100%;
        }
        .btn-sm {
            flex: 1; padding: 8px; border-radius: 8px;
            border: none; font-size: 0.85rem; font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            cursor: pointer;
            min-height: 36px;
        }
        .btn-light { background: #f1f5f9; color: var(--secondary); }
        .btn-primary-soft { background: #dbeafe; color: var(--primary); }
        .btn-whatsapp { background: #dcfce7; color: #16a34a; }

        .client-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
            border: 1px solid var(--border);
            width: 100%;
        }
        .client-card:active { transform: scale(0.98); }

        .client-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 12px;
        }
        .client-name { font-weight: 700; font-size: 1rem; color: var(--dark); }
        .client-type {
            font-size: 0.7rem; padding: 3px 8px; border-radius: 99px;
            font-weight: 600;
        }

        .client-info {
            display: flex; flex-direction: column; gap: 6px;
        }
        .client-row {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.85rem; color: var(--secondary);
        }

        .client-actions {
            display: flex; gap: 8px; margin-top: 12px;
            padding-top: 12px; border-top: 1px solid var(--border);
            width: 100%;
        }

        .btn-whatsapp-client {
            background: #25D366;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: transform 0.2s;
            flex: 1;
            justify-content: center;
            min-height: 36px;
        }
        
        .btn-whatsapp-client:active {
            transform: scale(0.95);
            background: #1da851;
        }

        .btn-email-client {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: transform 0.2s;
            flex: 1;
            justify-content: center;
            min-height: 36px;
        }
        
        .btn-email-client:active {
            transform: scale(0.95);
        }

        .schedule-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--type-visita);
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
            border: 1px solid var(--border);
        }
        .schedule-card:active { transform: scale(0.98); }
        
        .schedule-card.visita { border-left-color: var(--type-visita); }
        .schedule-card.reuniao-construtor { border-left-color: var(--type-reuniao-construtor); }
        .schedule-card.reuniao-equipe { border-left-color: var(--type-reuniao-equipe); }
        .schedule-card.documentacao { border-left-color: var(--type-documentacao); }
        .schedule-card.plantao { border-left-color: var(--type-plantao); }
        .schedule-card.generico { border-left-color: var(--type-generico); }
        .schedule-card.outro { border-left-color: var(--type-outro); }

        .schedule-header {
            display: flex; justify-content: space-between; margin-bottom: 8px;
            align-items: flex-start;
        }
        .schedule-type { 
            font-size: 0.75rem; padding: 3px 8px; border-radius: 4px;
            font-weight: 600; background: var(--type-visita); color: white;
        }
        .schedule-type.visita { background: var(--type-visita); }
        .schedule-type.reuniao-construtor { background: var(--type-reuniao-construtor); }
        .schedule-type.reuniao-equipe { background: var(--type-reuniao-equipe); }
        .schedule-type.documentacao { background: var(--type-documentacao); }
        .schedule-type.plantao { background: var(--type-plantao); }
        .schedule-type.generico { background: var(--type-generico); }
        .schedule-type.outro { background: var(--type-outro); }
        
        .schedule-time {
            font-size: 0.85rem; color: var(--secondary);
            display: flex; align-items: center; gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .schedule-title { font-weight: 600; color: var(--dark); margin-bottom: 4px; }
        .schedule-notes { font-size: 0.85rem; color: var(--secondary); line-height: 1.4; }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--nav-height);
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around;
            padding-bottom: var(--safe-bottom);
            z-index: 50;
            width: 100%;
        }

        .nav-item {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: #94a3b8; text-decoration: none;
            font-size: 0.7rem; font-weight: 500;
            gap: 4px; transition: 0.2s;
            padding: 8px 4px;
        }
        .nav-item i { font-size: 1.25rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }

        .fab {
            position: fixed;
            bottom: calc(var(--nav-height) + 16px);
            right: 16px;
            width: 56px; height: 56px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-float);
            z-index: 40;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9) rotate(90deg); }

        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: none; opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.active { 
            display: flex; 
            opacity: 1;
        }

        .modal-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--surface);
            border-radius: 20px 20px 0 0;
            padding: 24px 16px calc(24px + var(--safe-bottom));
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 90vh;
            overflow-y: auto;
            z-index: 101;
            width: 100%;
        }
        .modal-overlay.active + .modal-sheet { transform: translateY(0); }

        .sheet-handle {
            width: 40px; height: 4px; background: #cbd5e1;
            border-radius: 2px; margin: 0 auto 20px;
        }

        .form-group { margin-bottom: 16px; width: 100%; }
        .form-label { 
            display: block; font-size: 0.9rem; font-weight: 600; 
            margin-bottom: 6px; color: var(--dark); 
        }
        .form-control {
            width: 100%; padding: 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            background: #f8fafc;
            -webkit-appearance: none;
            font-family: 'Inter', sans-serif;
        }
        .form-control:focus { background: white; border-color: var(--primary); outline: none; }
        textarea.form-control { min-height: 100px; resize: none; }
        select.form-control { color: var(--dark); }

        .form-row {
            display: flex; gap: 12px;
            width: 100%;
        }
        .form-row .form-group { flex: 1; }

        .btn-block {
            width: 100%; padding: 16px;
            border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 700;
            background: var(--primary); color: white;
            margin-top: 10px;
            cursor: pointer;
        }

        .details-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-md);
            width: 100%;
        }
        
        .details-header {
            display: flex; justify-content: space-between;
            align-items: flex-start; margin-bottom: 20px;
            padding-bottom: 15px; border-bottom: 1px solid var(--border);
        }
        
        .details-title {
            font-size: 1.3rem; font-weight: 800;
            color: var(--dark);
            flex: 1;
        }
        
        .details-price {
            font-size: 1.5rem; font-weight: 800;
            color: var(--primary);
        }
        
        .details-section {
            margin-bottom: 20px;
            width: 100%;
        }
        
        .details-section-title {
            font-size: 0.9rem; font-weight: 700;
            color: var(--primary); text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 8px;
            display: flex; align-items: center; gap: 8px;
        }
        
        .details-info-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 12px; margin-bottom: 16px;
            width: 100%;
        }
        
        .info-item {
            display: flex; flex-direction: column; gap: 4px;
        }
        
        .info-label {
            font-size: 0.8rem; color: var(--secondary);
            font-weight: 500;
        }
        
        .info-value {
            font-size: 1rem; color: var(--dark);
            font-weight: 600;
        }
        
        .details-actions {
            display: flex; gap: 12px; margin-top: 24px;
            padding-top: 20px; border-top: 1px solid var(--border);
            width: 100%;
            flex-wrap: wrap;
        }
        
        .btn-details {
            flex: 1; padding: 12px; border-radius: 10px;
            border: none; font-weight: 600;
            display: flex; align-items: center;
            justify-content: center; gap: 8px;
            cursor: pointer; transition: transform 0.2s;
            min-width: 120px;
            min-height: 44px;
        }
        
        .btn-details:active { transform: scale(0.95); }
        
        .btn-details-primary {
            background: var(--primary); color: white;
        }
        
        .btn-details-whatsapp {
            background: #25D366; color: white;
        }
        
        .btn-details-secondary {
            background: var(--light); color: var(--secondary);
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            width: 100%;
        }

        .image-gallery-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            height: 120px;
            background: #f1f5f9;
            cursor: pointer;
        }

        .image-gallery-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .remove-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
            z-index: 2;
        }

        .add-image-btn {
            border: 2px dashed var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-image-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .add-image-btn i {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .image-counter {
            font-size: 0.7rem;
            color: var(--secondary);
            margin-bottom: 8px;
        }

        .empty-state { 
            text-align: center; padding: 40px 20px; 
            color: var(--secondary); 
            width: 100%;
        }
        .empty-state i { font-size: 3rem; margin-bottom: 16px; opacity: 0.3; }
        
        .toast {
            position: fixed; top: var(--header-height); left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--dark); color: white;
            padding: 12px 24px; border-radius: 50px;
            font-size: 0.9rem; font-weight: 500;
            box-shadow: var(--shadow-float); z-index: 200;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 8px;
            white-space: nowrap;
            max-width: 90vw;
        }
        .toast.show { transform: translateX(-50%) translateY(20px); }

        .badge {
            display: inline-block; padding: 2px 8px;
            border-radius: 10px; font-size: 0.7rem;
            font-weight: 700;
        }
        
        .badge-primary { background: var(--primary); color: white; }
        .badge-success { background: var(--success); color: white; }
        .badge-warning { background: var(--warning); color: white; }
        .badge-danger { background: var(--danger); color: white; }
        .badge-purple { background: #7c3aed; color: white; }
        .badge-cyan { background: #0ea5e9; color: white; }
        .badge-pink { background: #db2777; color: white; }
        
        @keyframes pulse { 
            0% { opacity: 1; } 
            50% { opacity: 0.6; } 
            100% { opacity: 1; } 
        }
        
        .highlight { color: var(--primary); font-weight: 700; }

        .carousel-container {
            position: relative;
            width: 100%;
            height: 250px;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
        }

        .carousel-slide {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .carousel-slide.active {
            display: block;
        }

        .carousel-nav {
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: background 0.3s;
        }

        .carousel-dot.active {
            background: white;
        }

        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            z-index: 1;
            transition: background 0.3s;
        }

        .carousel-arrow.prev {
            left: 10px;
        }

        .carousel-arrow.next {
            right: 10px;
        }

        .btn-pdf {
            background: #ef4444;
            color: white;
        }

        .btn-pdf:hover {
            background: #dc2626;
        }

        .fullscreen-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .fullscreen-viewer.active {
            display: flex;
            opacity: 1;
        }

        .fullscreen-image-container {
            width: 100%;
            height: 80vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .fullscreen-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            animation: zoomIn 0.3s ease;
        }

        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .fullscreen-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .fullscreen-nav button {
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .fullscreen-nav button:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1001;
            transition: background 0.3s;
        }

        .fullscreen-close:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .fullscreen-counter {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 1rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            width: fit-content;
            margin: 0 auto;
        }

        .fullscreen-thumbnails {
            display: flex;
            gap: 10px;
            padding: 15px;
            overflow-x: auto;
            max-width: 90%;
            margin-top: 10px;
        }

        .fullscreen-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s, transform 0.3s;
            flex-shrink: 0;
            border: 2px solid transparent;
        }

        .fullscreen-thumbnail:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .fullscreen-thumbnail.active {
            opacity: 1;
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .fullscreen-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .plantoes-info {
            background: #f3e8ff;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            border-left: 3px solid #7c3aed;
        }

        .plantoes-summary {
            font-size: 0.85rem;
            color: #5b21b6;
            margin-bottom: 8px;
        }

        .agenda-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }

        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: white;
            color: var(--secondary);
            flex-shrink: 0;
        }

        .filter-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .filter-chip.visita { border-color: var(--type-visita); color: var(--type-visita); }
        .filter-chip.reuniao-construtor { border-color: var(--type-reuniao-construtor); color: var(--type-reuniao-construtor); }
        .filter-chip.reuniao-equipe { border-color: var(--type-reuniao-equipe); color: var(--type-reuniao-equipe); }
        .filter-chip.documentacao { border-color: var(--type-documentacao); color: var(--type-documentacao); }
        .filter-chip.plantao { border-color: var(--type-plantao); color: var(--type-plantao); }
        .filter-chip.generico { border-color: var(--type-generico); color: var(--type-generico); }
        .filter-chip.outro { border-color: var(--type-outro); color: var(--type-outro); }

        .filter-chip.active.visita { background: var(--type-visita); color: white; }
        .filter-chip.active.reuniao-construtor { background: var(--type-reuniao-construtor); color: white; }
        .filter-chip.active.reuniao-equipe { background: var(--type-reuniao-equipe); color: white; }
        .filter-chip.active.documentacao { background: var(--type-documentacao); color: white; }
        .filter-chip.active.plantao { background: var(--type-plantao); color: white; }
        .filter-chip.active.generico { background: var(--type-generico); color: white; }
        .filter-chip.active.outro { background: var(--type-outro); color: white; }

        .birthday-alert {
            background: linear-gradient(135deg, #fce7f3, #fbcfe8);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid #db2777;
            animation: pulse 2s infinite;
            width: 100%;
        }

        .birthday-alert-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .birthday-alert-title {
            font-weight: 700;
            color: #9d174d;
            font-size: 1rem;
        }

        .birthday-alert-content {
            font-size: 0.85rem;
            color: #831843;
            line-height: 1.4;
        }

        .image-fullscreen {
            width: 100vw;
            height: 100vh;
            object-fit: contain;
            background: #000;
        }

        .warning-note {
            font-size: 0.75rem;
            color: var(--warning);
            font-style: italic;
            margin-top: 8px;
            text-align: center;
            padding: 8px;
            background: #fef3c7;
            border-radius: 6px;
            border: 1px solid #fde68a;
        }

        .funnel-container {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            width: 100%;
        }

        .funnel-stages {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .funnel-stage {
            position: relative;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: var(--shadow-sm);
            width: 100%;
        }

        .funnel-stage:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .funnel-stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .funnel-stage-title {
            font-weight: 700;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .funnel-stage-count {
            background: rgba(255, 255, 255, 0.9);
            color: var(--dark);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 700;
            min-width: 30px;
            text-align: center;
        }

        .funnel-stage-clients {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            width: 100%;
        }

        .funnel-stage.expanded .funnel-stage-clients {
            max-height: 500px;
            margin-top: 12px;
        }

        .funnel-client-item {
            background: rgba(241, 245, 249, 0.7);
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            transition: background 0.2s;
            width: 100%;
        }

        .funnel-client-item:hover {
            background: rgba(226, 232, 240, 0.9);
        }

        .funnel-client-name {
            font-weight: 600;
            color: var(--dark);
        }

        .funnel-client-days {
            font-size: 0.75rem;
            color: var(--secondary);
        }

        .stage-lead { border-left-color: var(--funnel-lead); background: linear-gradient(90deg, rgba(147, 197, 253, 0.1) 0%, rgba(147, 197, 253, 0.05) 100%); }
        .stage-contato { border-left-color: var(--funnel-contato); background: linear-gradient(90deg, rgba(96, 165, 250, 0.1) 0%, rgba(96, 165, 250, 0.05) 100%); }
        .stage-cpf { border-left-color: var(--funnel-cpf); background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%); }
        .stage-sem-restricao { border-left-color: var(--funnel-sem-restricao); background: linear-gradient(90deg, rgba(29, 78, 216, 0.1) 0%, rgba(29, 78, 216, 0.05) 100%); }
        .stage-documentacao { border-left-color: var(--funnel-documentacao); background: linear-gradient(90deg, rgba(124, 58, 237, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%); }
        .stage-aprovado { border-left-color: var(--funnel-aprovado); background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); }
        .stage-contrato { border-left-color: var(--funnel-contrato); background: linear-gradient(90deg, rgba(5, 150, 105, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%); }
        .stage-venda { border-left-color: var(--funnel-venda); background: linear-gradient(90deg, rgba(4, 120, 87, 0.1) 0%, rgba(4, 120, 87, 0.05) 100%); }

        .links-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
        }

        .link-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: transform 0.2s;
            border-left: 4px solid var(--primary);
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-decoration: none;
            color: inherit;
            border: 1px solid var(--border);
        }

        .link-card:active { transform: scale(0.98); }

        .link-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .link-title {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--dark);
            line-height: 1.3;
        }

        .link-url {
            font-size: 0.75rem;
            color: var(--secondary);
            word-break: break-all;
            opacity: 0.8;
        }

        .link-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .dragging {
            opacity: 0.5;
            border: 2px dashed var(--primary) !important;
        }

        .drop-zone {
            background: rgba(37, 99, 235, 0.05);
            border: 2px dashed var(--primary);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: var(--primary);
            margin: 8px 0;
            transition: all 0.3s;
            width: 100%;
        }

        .drop-zone:hover {
            background: rgba(37, 99, 235, 0.1);
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 1.2rem;
            color: var(--primary);
            width: 100%;
        }
        
        .loading i {
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .video-thumbnail {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
        }

        .video-thumbnail i {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .video-url-display {
            background: #f1f5f9;
            border-radius: 6px;
            padding: 8px;
            font-size: 0.75rem;
            word-break: break-all;
            margin-top: 4px;
            border: 1px dashed #cbd5e1;
        }

        .btn-video {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-video:hover {
            opacity: 0.9;
        }

        .btn-video-secondary {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .report-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .report-date-input {
            flex: 1;
            min-width: 150px;
        }

        .report-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .report-summary {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .report-table th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
            font-size: 0.9rem;
        }

        .report-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
        }

        .report-table tr:hover {
            background: #f8fafc;
        }

        @media (max-width: 360px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .details-info-grid {
                grid-template-columns: 1fr;
            }
            
            .property-features {
                justify-content: space-between;
            }
            
            .feature {
                min-width: 45px;
            }
            
            .links-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-details {
                min-width: 100%;
            }
        }

        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        input, select, textarea {
            font-size: 16px !important;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --dark: #f8fafc;
                --light: #0f172a;
                --surface: #1e293b;
                --border: #334155;
            }
            
            body {
                background-color: #0f172a;
            }
            
            .property-card, .client-card, .schedule-card, 
            .details-card, .funnel-container, .link-card,
            .stat-card {
                background: var(--surface);
                border-color: var(--border);
            }
            
            .search-input, .form-control {
                background: #1e293b;
                color: #f8fafc;
                border-color: var(--border);
            }
            
            .btn-light {
                background: #334155;
                color: #cbd5e1;
            }
            
            .btn-details-secondary {
                background: #334155;
                color: #cbd5e1;
            }
            
            .report-table th {
                background: #334155;
            }
        }

        .btn-whatsapp-client i,
        .btn-whatsapp i {
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <i class="fas fa-spinner"></i> Inicializando sistema...
    </div>

    <div id="app" style="display: none; width: 100%; height: 100%;">
        <header>
            <div class="brand">
                <i class="fas fa-home" style="color: var(--primary);"></i>
                <span>Imobi</span>Pro
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="UI.openSettings()"><i class="fas fa-cog"></i></button>
            </div>
        </header>

        <div id="toast" class="toast">
            <i class="fas fa-check-circle"></i> <span>Ação realizada!</span>
        </div>

        <div class="fullscreen-viewer" id="fullscreen-viewer">
            <button class="fullscreen-close" onclick="UI.closeFullscreen()">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="fullscreen-image-container">
                <img id="fullscreen-current-image" class="fullscreen-image" src="" alt="Imagem em tela cheia">
                
                <div class="fullscreen-nav">
                    <button onclick="UI.prevFullscreenImage()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button onclick="UI.nextFullscreenImage()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="fullscreen-counter">
                <span id="fullscreen-counter">1</span> / <span id="fullscreen-total">1</span>
            </div>
            
            <div class="fullscreen-thumbnails" id="fullscreen-thumbnails">
            </div>
        </div>

        <main>
            <div id="dashboard-view" class="view active">
                <div class="section-title">Visão Geral</div>
                <div class="stats-grid">
                    <div class="stat-card" onclick="UI.navigate('imoveis')">
                        <div class="stat-icon bg-blue"><i class="fas fa-building"></i></div>
                        <div class="stat-value" id="dash-total-imoveis">0</div>
                        <div class="stat-label">Imóveis</div>
                    </div>
                    <div class="stat-card" onclick="UI.navigate('clientes')">
                        <div class="stat-icon bg-green"><i class="fas fa-users"></i></div>
                        <div class="stat-value" id="dash-total-clientes">0</div>
                        <div class="stat-label">Clientes</div>
                    </div>
                    <div class="stat-card" onclick="UI.navigate('agenda')">
                        <div class="stat-icon bg-orange"><i class="fas fa-calendar-alt"></i></div>
                        <div class="stat-value" id="dash-visitas">0</div>
                        <div class="stat-label">Agendamentos Hoje</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-red"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-value" id="dash-vendas">R$ 0</div>
                        <div class="stat-label">Vendas Mês</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-cyan"><i class="fas fa-handshake"></i></div>
                        <div class="stat-value" id="dash-negociacoes">0</div>
                        <div class="stat-label">Negociações</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-purple"><i class="fas fa-star"></i></div>
                        <div class="stat-value" id="dash-destaques">0</div>
                        <div class="stat-label">Destaques</div>
                    </div>
                </div>

                <div class="section-title">
                    Aniversariantes Hoje
                    <span class="badge badge-pink" id="aniversariantes-badge" style="display:none">!</span>
                </div>
                <div id="aniversariantes-list">
                </div>

                <div class="section-title">
                    Agenda de Hoje
                    <span class="badge badge-primary" id="visitas-badge" style="display:none">!</span>
                </div>
                <div id="visitas-list">
                </div>
                
                <div class="section-title">
                    Negociações Recentes
                    <span class="badge badge-warning" id="negociacoes-badge" style="display:none">!</span>
                </div>
                <div id="negociacoes-list">
                </div>
            </div>

            <div id="imoveis-view" class="view">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Buscar imóveis (título, endereço, construtora, data entrega)..." oninput="UI.searchImoveis(this.value)">
                </div>
                <div class="form-row" style="margin-bottom: 16px;">
                    <select class="form-control" onchange="UI.filterImoveis(this.value, document.getElementById('filter-status').value)">
                        <option value="">Todos os tipos</option>
                        <option value="apartamento">Apartamento</option>
                        <option value="casa">Casa</option>
                        <option value="terreno">Terreno</option>
                        <option value="comercial">Comercial</option>
                    </select>
                    <select class="form-control" id="filter-status" onchange="UI.filterImoveis(document.querySelector('select').value, this.value)">
                        <option value="">Todos os status</option>
                        <option value="disponivel">Disponível</option>
                        <option value="vendido">Vendido</option>
                        <option value="alugado">Alugado</option>
                        <option value="reservado">Reservado</option>
                    </select>
                </div>
                <div id="imoveis-list"></div>
            </div>

            <div id="clientes-view" class="view">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Buscar clientes..." oninput="UI.renderClientes(this.value)">
                </div>
                <div id="clientes-list"></div>
            </div>

            <div id="agenda-view" class="view">
                <div class="section-title">
                    Agenda
                    <button class="icon-btn" style="background: var(--primary); color: white; border-radius: 8px; padding: 8px;" onclick="UI.openNewVisita()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <div class="agenda-filters" id="agenda-filters">
                    <div class="filter-chip active" data-type="todos" onclick="UI.filterAgenda('todos')">Todos</div>
                    <div class="filter-chip visita" data-type="visita" onclick="UI.filterAgenda('visita')">Visitas</div>
                    <div class="filter-chip reuniao-construtor" data-type="reuniao-construtor" onclick="UI.filterAgenda('reuniao-construtor')">Reunião Construtor</div>
                    <div class="filter-chip reuniao-equipe" data-type="reuniao-equipe" onclick="UI.filterAgenda('reuniao-equipe')">Reunião Equipe</div>
                    <div class="filter-chip documentacao" data-type="documentacao" onclick="UI.filterAgenda('documentacao')">Documentação</div>
                    <div class="filter-chip plantao" data-type="plantao" onclick="UI.filterAgenda('plantao')">Plantões</div>
                    <div class="filter-chip generico" data-type="generico" onclick="UI.filterAgenda('generico')">Genéricos</div>
                    <div class="filter-chip outro" data-type="outro" onclick="UI.filterAgenda('outro')">Outros</div>
                </div>
                
                <div id="agenda-list"></div>
            </div>

            <div id="funil-view" class="view">
                <div class="section-title">
                    Funil de Vendas
                    <button class="icon-btn" style="background: var(--primary); color: white; border-radius: 8px; padding: 8px;" onclick="UI.openFunilSettings()">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card" onclick="UI.filterFunil('lead')">
                        <div class="stat-icon" style="background: var(--funnel-lead); color: #1e3a8a;">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="stat-value" id="funil-lead">0</div>
                        <div class="stat-label">Leads</div>
                    </div>
                    <div class="stat-card" onclick="UI.filterFunil('venda')">
                        <div class="stat-icon" style="background: var(--funnel-venda); color: white;">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-value" id="funil-venda">0</div>
                        <div class="stat-label">Vendas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-purple">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-value" id="funil-taxa">0%</div>
                        <div class="stat-label">Conversão</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-cyan">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-value" id="funil-tempo">0d</div>
                        <div class="stat-label">Tempo Médio</div>
                    </div>
                </div>
                
                <div class="funnel-container">
                    <div class="section-title" style="margin-bottom: 16px;">
                        Progresso do Funil
                        <span class="badge badge-primary" id="funil-total">0 clientes</span>
                    </div>
                    <div id="funil-stages-container">
                    </div>
                </div>
                
                <div class="section-title">
                    Clientes no Funil
                    <select class="form-control" style="width: auto; padding: 4px 12px; font-size: 0.85rem;" onchange="UI.filterClientesFunil(this.value)">
                        <option value="todos">Todos os estágios</option>
                    </select>
                </div>
                <div id="funil-clientes-list"></div>
            </div>

            <div id="links-view" class="view">
                <div class="section-title">
                    Links Úteis
                    <button class="icon-btn" style="background: var(--primary); color: white; border-radius: 8px; padding: 8px;" onclick="UI.openNewLink()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Buscar links..." oninput="UI.renderLinks(this.value)">
                </div>
                
                <div class="links-grid" id="links-grid">
                </div>
            </div>

            <div id="relatorios-view" class="view">
                <div class="section-title">Relatórios</div>
                
                <div class="report-filters">
                    <div style="width: 100%; display: flex; flex-direction: column; gap: 5px;">
                        <label style="font-size: 0.8rem; color: var(--secondary);">Período / Data do Plantão:</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="date" id="report-date-start" class="form-control report-date-input">
                            <input type="date" id="report-date-end" class="form-control report-date-input">
                        </div>
                    </div>
                    
                    <select id="report-type" class="form-control" style="width: 100%; margin-top: 8px;" onchange="UI.toggleReportInputs(this.value)">
                        <option value="clientes">Relatório de Clientes</option>
                        <option value="agendamentos">Relatório de Agendamentos</option>
                        <option value="vendas">Relatório de Vendas</option>
                        <option value="performance">Performance</option>
                        <option value="plantao">Relatório de Plantão (Diário)</option> </select>
                </div>
                
                <div class="report-actions">
                    <button class="btn-block" style="background: var(--primary);" onclick="UI.generateReport()">
                        <i class="fas fa-chart-bar"></i> Gerar Relatório
                    </button>
                    <button class="btn-block" style="background: var(--success);" onclick="UI.exportReport()">
                        <i class="fas fa-file-pdf"></i> Exportar PDF
                    </button>
                </div>
                
                <div id="report-content">
                    <div class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <p>Selecione um período e tipo de relatório para gerar</p>
                    </div>
                </div>
            </div>
        </main>

        <button class="fab" onclick="UI.openNewImovel()" id="main-fab">
            <i class="fas fa-plus"></i>
        </button>

        <nav class="bottom-nav">
            <a href="#" class="nav-item active" data-target="dashboard-view" onclick="UI.switchTab(this); return false;">
                <i class="fas fa-home"></i> <span>Início</span>
            </a>
            <a href="#" class="nav-item" data-target="imoveis-view" onclick="UI.switchTab(this); return false;">
                <i class="fas fa-building"></i> <span>Imóveis</span>
            </a>
            <a href="#" class="nav-item" data-target="clientes-view" onclick="UI.switchTab(this); return false;">
                <i class="fas fa-users"></i> <span>Clientes</span>
            </a>
            <a href="#" class="nav-item" data-target="funil-view" onclick="UI.switchTab(this); return false;">
                <i class="fas fa-filter"></i> <span>Funil</span>
            </a>
            <a href="#" class="nav-item" data-target="agenda-view" onclick="UI.switchTab(this); return false;">
                <i class="fas fa-calendar-alt"></i> <span>Agenda</span>
            </a>
            <a href="#" class="nav-item" data-target="links-view" onclick="UI.switchTab(this); return false;">
                <i class="fas fa-link"></i> <span>Links</span>
            </a>
            <a href="#" class="nav-item" data-target="relatorios-view" onclick="UI.switchTab(this); return false;">
                <i class="fas fa-chart-bar"></i> <span>Relatórios</span>
            </a>
        </nav>

        <!-- Modais -->
        <div class="modal-overlay" id="overlay-imovel-details"></div>
        <div class="modal-sheet" id="sheet-imovel-details">
            <div class="sheet-handle"></div>
            <div id="imovel-details-content">
            </div>
        </div>

        <div class="modal-overlay" id="overlay-cliente"></div>
        <div class="modal-sheet" id="sheet-cliente">
            <div class="sheet-handle"></div>
            <h3 class="section-title" id="title-cliente">Novo Cliente</h3>
            <form id="form-cliente" onsubmit="App.cliente.save(event)">
                <input type="hidden" id="c-id">
                <div class="form-group">
                    <label class="form-label">Nome Completo</label>
                    <input type="text" id="c-nome" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Cliente</label>
                    <select id="c-tipo" class="form-control" required>
                        <option value="comprador">Comprador</option>
                        <option value="vendedor">Vendedor</option>
                        <option value="ambos">Comprador/Vendedor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Etapa no Funil</label>
                    <select id="c-etapa-funil" class="form-control" required>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Telefone (WhatsApp)</label>
                    <input type="tel" id="c-telefone" class="form-control" placeholder="(00) 00000-0000" required oninput="Utils.maskPhone(this)">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="c-email" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Imóvel de Interesse</label>
                    <select id="c-imovel-interesse" class="form-control">
                        <option value="">Selecione um imóvel...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Data de Nascimento</label>
                    <input type="date" id="c-data-nascimento" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Faixa de Preço (Interesse)</label>
                    <input type="text" id="c-faixa-preco" class="form-control" placeholder="Ex: R$ 300.000 - 500.000">
                </div>
                <div class="form-group">
                    <label class="form-label">Observações</label>
                    <textarea id="c-observacoes" class="form-control" placeholder="Anotações sobre o cliente..."></textarea>
                </div>
                <button type="submit" class="btn-block">Salvar Cliente</button>
                <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
            </form>
        </div>

        <div class="modal-overlay" id="overlay-imovel"></div>
        <div class="modal-sheet" id="sheet-imovel">
            <div class="sheet-handle"></div>
            <h3 class="section-title" id="title-imovel">Novo Imóvel</h3>
            <form id="form-imovel" onsubmit="App.imovel.save(event)">
                <input type="hidden" id="i-id">
                
                <div class="form-group">
                    <label class="form-label">Fotos do Imóvel (Máx. 15)</label>
                    <div class="image-counter">Fotos adicionadas: <span id="image-counter">0</span>/15</div>
                    <div class="image-gallery" id="image-gallery">
                        <div class="image-gallery-item add-image-btn" onclick="document.getElementById('i-imagem-input').click()">
                            <i class="fas fa-plus"></i>
                            <span>Adicionar Foto</span>
                        </div>
                    </div>
                    <input type="file" id="i-imagem-input" accept="image/*" multiple style="display: none;" onchange="App.imovel.handleMultipleImages(this)">
                    <input type="hidden" id="i-imagens-data">
                </div>

                <div class="form-group">
                    <label class="form-label">Vídeos do Imóvel (Links do YouTube/Vimeo)</label>
                    <div class="image-counter">Vídeos adicionados: <span id="video-counter">0</span>/5</div>
                    <div id="videos-container">
                        <div class="form-group" id="video-input-group">
                            <div class="form-row">
                                <input type="url" id="i-video-url" class="form-control" placeholder="https://youtube.com/watch?v=..." style="flex: 1;">
                                <button type="button" class="btn-sm btn-video" onclick="App.imovel.addVideo()">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            </div>
                        </div>
                        <div id="videos-list"></div>
                    </div>
                    <input type="hidden" id="i-videos-data">
                </div>

                <div class="form-group">
                    <label class="form-label">Título do Anúncio</label>
                    <input type="text" id="i-titulo" class="form-control" placeholder="Ex: Apartamento 3 quartos com vista..." required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tipo</label>
                        <select id="i-tipo" class="form-control" required>
                            <option value="apartamento">Apartamento</option>
                            <option value="casa">Casa</option>
                            <option value="terreno">Terreno</option>
                            <option value="comercial">Comercial</option>
                            <option value="kitnet">Kitnet</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Transação</label>
                        <select id="i-transacao" class="form-control" required onchange="App.imovel.toggleAluguelFields()">
                            <option value="venda">Venda</option>
                            <option value="aluguel">Aluguel</option>
                            <option value="ambos">Venda/Aluguel</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Preço de Venda (R$)</label>
                        <input type="text" id="i-preco-venda" class="form-control" placeholder="0,00" oninput="Utils.maskMoney(this)">
                    </div>
                    <div class="form-group" id="i-aluguel-group" style="display: none;">
                        <label class="form-label">Preço de Aluguel (R$)</label>
                        <input type="text" id="i-preco-aluguel" class="form-control" placeholder="0,00" oninput="Utils.maskMoney(this)">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Data de Entrega</label>
                    <input type="date" id="i-data-entrega" class="form-control">
                </div>

                <div class="form-group">
                    <label class="form-label">Construtora</label>
                    <input type="text" id="i-construtora" class="form-control" placeholder="Nome da construtora">
                </div>

                <div class="form-group">
                    <label class="form-label">Forma de Pagamento</label>
                    <input type="text" id="i-forma-pagamento" class="form-control" placeholder="Ex: Financiamento, entrada + parcelas, etc.">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Valor do Condomínio (R$)</label>
                        <input type="text" id="i-condominio" class="form-control" placeholder="0,00" oninput="Utils.maskMoney(this)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gás Encanado</label>
                        <select id="i-gas-encanado" class="form-control">
                            <option value="sim">Sim</option>
                            <option value="nao">Não</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Endereço Completo</label>
                    <input type="text" id="i-endereco" class="form-control" placeholder="Rua, número, bairro, cidade" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Área (m²)</label>
                        <input type="number" id="i-area" class="form-control" placeholder="Ex: 120">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quartos</label>
                        <input type="number" id="i-quartos" class="form-control" placeholder="Ex: 3">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Banheiros</label>
                        <input type="number" id="i-banheiros" class="form-control" placeholder="Ex: 2">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Vagas</label>
                        <input type="number" id="i-vagas" class="form-control" placeholder="Ex: 2">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="i-status" class="form-control">
                        <option value="disponivel">Disponível</option>
                        <option value="reservado">Reservado</option>
                        <option value="vendido">Vendido</option>
                        <option value="alugado">Alugado</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descrição</label>
                    <textarea id="i-descricao" class="form-control" placeholder="Descreva o imóvel, comodidades, localização..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Observações Internas</label>
                    <textarea id="i-observacoes" class="form-control" placeholder="Informações privadas sobre o imóvel..."></textarea>
                </div>

                <div class="warning-note">
                    <i class="fas fa-exclamation-triangle"></i> Os valores informados podem sofrer alteração sem aviso prévio.
                </div>

                <button type="submit" class="btn-block">Salvar Imóvel</button>
                <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
            </form>
        </div>

        <div class="modal-overlay" id="overlay-visita"></div>
        <div class="modal-sheet" id="sheet-visita">
            <div class="sheet-handle"></div>
            <h3 class="section-title" id="title-visita">Novo Agendamento</h3>
            <form id="form-visita" onsubmit="App.agenda.save(event)">
                <input type="hidden" id="v-id">
                
                <div class="form-group">
                    <label class="form-label">Tipo de Agendamento</label>
                    <select id="v-tipo" class="form-control" required onchange="UI.toggleVisitaFields()">
                        <option value="visita">Visita ao Imóvel</option>
                        <option value="reuniao-construtor">Reunião com Construtor</option>
                        <option value="reuniao-equipe">Reunião de Equipe</option>
                        <option value="documentacao">Assinatura de Documentos</option>
                        <option value="plantao">Plantão</option>
                        <option value="generico">Agendamento Genérico</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>

                <div class="form-group cliente-dependent-group">
                    <label class="form-label">Cliente</label>
                    <select id="v-cliente" class="form-control">
                        <option value="">Selecione...</option>
                    </select>
                </div>

                <div class="form-group imovel-dependent-group">
                    <label class="form-label">Imóvel</label>
                        <select id="v-imovel" class="form-control">
                        <option value="">Selecione...</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data</label>
                        <input type="date" id="v-data" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Horário</label>
                        <input type="time" id="v-horario" class="form-control" required>
                    </div>
                </div>

                <div class="tipo-specific-group" id="grupo-visita">
                    <div class="form-group">
                        <label class="form-label">Local/Endereço da Visita</label>
                        <input type="text" id="v-local-visita" class="form-control" placeholder="Endereço da visita">
                    </div>
                </div>

                <div class="tipo-specific-group" id="grupo-reuniao-construtor" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Nome do Construtor/Incorporadora</label>
                        <input type="text" id="v-construtor-nome" class="form-control" placeholder="Nome da construtora">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Empreendimento/Lançamento</label>
                        <input type="text" id="v-construtor-empreendimento" class="form-control" placeholder="Nome do empreendimento">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assuntos da Reunião</label>
                        <textarea id="v-construtor-assuntos" class="form-control" placeholder="Ex: Lançamentos, condições comerciais, parcerias..."></textarea>
                    </div>
                </div>

                <div class="tipo-specific-group" id="grupo-reuniao-equipe" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Tipo de Reunião</label>
                        <select id="v-equipe-tipo" class="form-control">
                            <option value="estrategia">Reunião Estratégica</option>
                            <option value="metas">Definição de Metas</option>
                            <option value="resultados">Análise de Resultados</option>
                            <option value="treinamento">Treinamento</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Participantes</label>
                        <input type="text" id="v-equipe-participantes" class="form-control" placeholder="Nomes dos participantes">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pauta/Assuntos</label>
                        <textarea id="v-equipe-assuntos" class="form-control" placeholder="Tópicos da reunião..."></textarea>
                    </div>
                </div>

                <div class="tipo-specific-group" id="grupo-documentacao" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Tipo de Documento</label>
                        <select id="v-documentacao-tipo" class="form-control">
                            <option value="contrato-venda">Contrato de Venda</option>
                            <option value="contrato-aluguel">Contrato de Aluguel</option>
                            <option value="proposta">Proposta</option>
                            <option value="financiamento">Documentos de Financiamento</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Local da Assinatura</label>
                        <input type="text" id="v-documentacao-local" class="form-control" placeholder="Local da assinatura">
                    </div>
                </div>

                <div class="tipo-specific-group" id="grupo-plantao" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Local do Plantão</label>
                        <input type="text" id="v-plantao-local" class="form-control" placeholder="Endereço do plantão">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Detalhes do Plantão</label>
                        <textarea id="v-detalhes-plantoes" class="form-control" placeholder="Descreva as atividades do plantão..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Clientes Atendidos</label>
                        <textarea id="v-clientes-atendidos" class="form-control" placeholder="Liste os clientes atendidos, telefones e situações (separados por linha)">
Exemplo:
João Silva - (11) 99999-9999 - Interessado em apartamento 2 quartos
Maria Santos - (11) 88888-8888 - Agendou visita para amanhã
Pedro Costa - (11) 77777-7777 - Solicitou proposta de financiamento</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Negócios Gerados</label>
                        <input type="text" id="v-negocios-gerados" class="form-control" placeholder="Ex: 2 visitas agendadas, 1 proposta enviada">
                    </div>
                </div>

                <div class="tipo-specific-group" id="grupo-generico" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Título do Agendamento</label>
                        <input type="text" id="v-generico-titulo" class="form-control" placeholder="Título descritivo">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Local</label>
                        <input type="text" id="v-generico-local" class="form-control" placeholder="Local do compromisso">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descrição Detalhada</label>
                        <textarea id="v-generico-descricao" class="form-control" placeholder="Descreva o propósito deste agendamento..."></textarea>
                    </div>
                </div>

                <div class="tipo-specific-group" id="grupo-outro" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Descrição do Compromisso</label>
                        <input type="text" id="v-outro-descricao" class="form-control" placeholder="Descreva brevemente">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Detalhes</label>
                        <textarea id="v-outro-detalhes" class="form-control" placeholder="Informações adicionais..."></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Observações Gerais</label>
                    <textarea id="v-observacoes" class="form-control" placeholder="Observações adicionais..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="v-status" class="form-control">
                        <option value="agendado">Agendado</option>
                        <option value="confirmado">Confirmado</option>
                        <option value="realizado">Realizado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>

                <button type="submit" class="btn-block">Salvar Agendamento</button>
                <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
            </form>
        </div>

        <div class="modal-overlay" id="overlay-settings"></div>
        <div class="modal-sheet" id="sheet-settings">
            <div class="sheet-handle"></div>
            <h3 class="section-title">Configurações</h3>
            <form id="form-settings" onsubmit="App.settings.save(event)">
                
                <div class="form-group">
                    <label class="form-label">Nome do Corretor</label>
                    <input type="text" id="s-nome" class="form-control" placeholder="Alex Peixoto">
                </div>
                <div class="form-group">
                    <label class="form-label">CRECI</label>
                    <input type="text" id="s-creci" class="form-control" placeholder="5794-AL">
                </div>
                <div class="form-group">
                    <label class="form-label">Telefone</label>
                    <input type="tel" id="s-telefone" class="form-control" value="(82) 99662-2036" oninput="Utils.maskPhone(this)">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="s-email" class="form-control" placeholder="alex@resende.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Imobiliária</label>
                    <input type="text" id="s-imobiliaria" class="form-control" placeholder="Resende" value="Resende">
                </div>
                <div class="form-group">
                    <label class="form-label">Taxa de Comissão (%)</label>
                    <input type="number" id="s-comissao" class="form-control" placeholder="5" min="0" max="100" step="0.1">
                </div>

                <hr style="border: 0; border-top: 1px solid var(--border); margin: 16px 0;">
<div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
    <button type="button" class="btn-block" style="background: var(--secondary); margin: 0;" onclick="App.backup.importTrigger()">
        <i class="fas fa-file-import"></i> Importar Backup
    </button>
    <input type="file" id="import-file" style="display: none;" accept=".json" onchange="App.backup.importData(this)">
    <button type="button" class="btn-block" style="background: var(--primary); margin: 0;" onclick="App.backup.exportData()">
        <i class="fas fa-file-export"></i> Exportar Backup
    </button>
    <button type="button" class="btn-block" style="background: var(--accent); margin: 0;" onclick="App.backup.exportIOS()">
        <i class="fab fa-apple"></i> iOS
    </button>
</div>

                <button type="button" class="btn-block" style="background: var(--danger); margin-top: 10px;" onclick="App.backup.clearData()">
                    <i class="fas fa-trash"></i> Resetar Tudo
                </button>
                <button type="submit" class="btn-block" style="background: var(--success); margin-top: 10px;">Salvar Configurações</button>
            </form>
        </div>

        <div class="modal-overlay" id="overlay-funil-settings"></div>
        <div class="modal-sheet" id="sheet-funil-settings">
            <div class="sheet-handle"></div>
            <h3 class="section-title">Configurar Etapas do Funil</h3>
            <div id="funil-etapas-list">
            </div>
            <button class="btn-block" style="background: var(--success); margin-top: 16px;" onclick="UI.addEtapaFunil()">
                <i class="fas fa-plus"></i> Adicionar Etapa
            </button>
            <button class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Fechar</button>
        </div>

        <div class="modal-overlay" id="overlay-link"></div>
        <div class="modal-sheet" id="sheet-link">
            <div class="sheet-handle"></div>
            <h3 class="section-title" id="title-link">Novo Link Útil</h3>
            <form id="form-link" onsubmit="App.link.save(event)">
                <input type="hidden" id="l-id">
                <div class="form-group">
                    <label class="form-label">Título</label>
                    <input type="text" id="l-titulo" class="form-control" placeholder="Ex: Site da Construtora..." required>
                </div>
                <div class="form-group">
                    <label class="form-label">URL</label>
                    <input type="url" id="l-url" class="form-control" placeholder="https://exemplo.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Categoria</label>
                    <select id="l-categoria" class="form-control">
                        <option value="construtora">Construtora</option>
                        <option value="documentos">Documentos</option>
                        <option value="financiamento">Financiamento</option>
                        <option value="noticias">Notícias</option>
                        <option value="ferramentas">Ferramentas</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Descrição</label>
                        <textarea id="l-descricao" class="form-control" placeholder="Descrição do link..."></textarea>
                </div>
                <button type="submit" class="btn-block">Salvar Link</button>
                <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
            </form>
        </div>
    </div>

    <script>
        // Objeto principal do banco de dados IndexedDB
        const DB = {
            name: 'ImobiProDB',
            version: 7,
            db: null,
            
            init: function() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.name, this.version);
                    
                    request.onerror = (event) => {
                        console.error('Erro ao abrir IndexedDB:', event);
                        reject(event);
                    };
                    
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log('IndexedDB aberto com sucesso');
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        const oldVersion = event.oldVersion;
                        
                        console.log(`Atualizando banco de dados da versão ${oldVersion} para ${this.version}`);
                        
                        this.createObjectStores(db);
                        
                        this.migrateDatabase(db, oldVersion);
                    };
                });
            },
            
            createObjectStores: function(db) {
                if (!db.objectStoreNames.contains('clientes')) {
                    const clientesStore = db.createObjectStore('clientes', { keyPath: 'id' });
                    clientesStore.createIndex('nome', 'nome', { unique: false });
                    clientesStore.createIndex('etapaFunil', 'etapaFunil', { unique: false });
                    clientesStore.createIndex('dataEntradaFunil', 'dataEntradaFunil', { unique: false });
                    clientesStore.createIndex('dataCriacao', 'dataCriacao', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('imoveis')) {
                    const imoveisStore = db.createObjectStore('imoveis', { keyPath: 'id' });
                    imoveisStore.createIndex('titulo', 'titulo', { unique: false });
                    imoveisStore.createIndex('tipo', 'tipo', { unique: false });
                    imoveisStore.createIndex('status', 'status', { unique: false });
                    imoveisStore.createIndex('dataCriacao', 'dataCriacao', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('visitas')) {
                    const visitasStore = db.createObjectStore('visitas', { keyPath: 'id' });
                    visitasStore.createIndex('data', 'data', { unique: false });
                    visitasStore.createIndex('tipo', 'tipo', { unique: false });
                    visitasStore.createIndex('status', 'status', { unique: false });
                    visitasStore.createIndex('dataCriacao', 'dataCriacao', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('links')) {
                    const linksStore = db.createObjectStore('links', { keyPath: 'id' });
                    linksStore.createIndex('titulo', 'titulo', { unique: false });
                    linksStore.createIndex('categoria', 'categoria', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('settings')) {
                    db.createObjectStore('settings', { keyPath: 'id' });
                }
                
                if (!db.objectStoreNames.contains('funilEtapas')) {
                    const etapasStore = db.createObjectStore('funilEtapas', { keyPath: 'id' });
                    etapasStore.createIndex('ordem', 'ordem', { unique: false });
                }
            },
            
            migrateDatabase: async function(db, oldVersion) {
                if (oldVersion < 1) {
                    console.log('Migrando para versão 1');
                }
                
                if (oldVersion < 4) {
                    console.log('Migrando para versão 4: Adicionando campo dataEntradaFunil');
                    try {
                        const clientes = await this.getAll('clientes');
                        for (const cliente of clientes) {
                            if (!cliente.dataEntradaFunil) {
                                cliente.dataEntradaFunil = cliente.dataCriacao ? 
                                    cliente.dataCriacao.split('T')[0] : 
                                    new Date().toISOString().split('T')[0];
                                await this.put('clientes', cliente);
                            }
                        }
                    } catch (error) {
                        console.error('Erro na migração:', error);
                    }
                }
                
                if (oldVersion < 5) {
                    console.log('Migrando para versão 5: Adicionando etapas padrão do funil');
                    try {
                        const etapas = await this.getAll('funilEtapas');
                        if (etapas.length === 0) {
                            const etapasPadrao = [
                                { id: 'lead', nome: 'Lead', cor: '#93c5fd', ordem: 1 },
                                { id: 'contato', nome: 'Contato Realizado', cor: '#60a5fa', ordem: 2 },
                                { id: 'cpf', nome: 'CPF em Análise', cor: '#3b82f6', ordem: 3 },
                                { id: 'sem-restricao', nome: 'Sem Restrição', cor: '#1d4ed8', ordem: 4 },
                                { id: 'documentacao', nome: 'Documentação', cor: '#7c3aed', ordem: 5 },
                                { id: 'aprovado', nome: 'Aprovado', cor: '#10b981', ordem: 6 },
                                { id: 'contrato', nome: 'Contrato Assinado', cor: '#059669', ordem: 7 },
                                { id: 'venda', nome: 'Venda Concluída', cor: '#047857', ordem: 8 }
                            ];
                            
                            for (const etapa of etapasPadrao) {
                                await this.add('funilEtapas', etapa);
                            }
                        }
                    } catch (error) {
                        console.error('Erro ao adicionar etapas padrão:', error);
                    }
                }
                
                if (oldVersion < 6) {
                    console.log('Migrando para versão 6: Configurações padrão');
                    try {
                        const settings = await this.get('settings', 'main');
                        if (!settings) {
                            const defaultSettings = {
                                id: 'main',
                                nome: 'Alex Peixoto',
                                creci: '5794-AL',
                                telefone: '(82) 99662-2036',
                                email: '',
                                imobiliaria: 'Resende',
                                comissao: 5
                            };
                            await this.put('settings', defaultSettings);
                        }
                    } catch (error) {
                        console.error('Erro ao adicionar configurações padrão:', error);
                    }
                }
                
                if (oldVersion < 7) {
                    console.log('Migrando para versão 7: Adicionando campo vídeos aos imóveis');
                    try {
                        const imoveis = await this.getAll('imoveis');
                        for (const imovel of imoveis) {
                            if (!imovel.videos) {
                                imovel.videos = [];
                                await this.put('imoveis', imovel);
                            }
                        }
                    } catch (error) {
                        console.error('Erro na migração para versão 7:', error);
                    }
                }
            },
            
            getAll: function(storeName) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('Banco de dados não inicializado'));
                        return;
                    }
                    
                    try {
                        const transaction = this.db.transaction([storeName], 'readonly');
                        const store = transaction.objectStore(storeName);
                        const request = store.getAll();
                        
                        request.onsuccess = (event) => resolve(event.target.result || []);
                        request.onerror = (event) => reject(event);
                    } catch (error) {
                        reject(error);
                    }
                });
            },
            
            get: function(storeName, key) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('Banco de dados não inicializado'));
                        return;
                    }
                    
                    try {
                        const transaction = this.db.transaction([storeName], 'readonly');
                        const store = transaction.objectStore(storeName);
                        const request = store.get(key);
                        
                        request.onsuccess = (event) => resolve(event.target.result || null);
                        request.onerror = (event) => reject(event);
                    } catch (error) {
                        reject(error);
                    }
                });
            },
            
            add: function(storeName, data) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('Banco de dados não inicializado'));
                        return;
                    }
                    
                    try {
                        const transaction = this.db.transaction([storeName], 'readwrite');
                        const store = transaction.objectStore(storeName);
                        const request = store.add(data);
                        
                        request.onsuccess = () => resolve(data);
                        request.onerror = (event) => reject(event);
                    } catch (error) {
                        reject(error);
                    }
                });
            },
            
            put: function(storeName, data) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('Banco de dados não inicializado'));
                        return;
                    }
                    
                    try {
                        const transaction = this.db.transaction([storeName], 'readwrite');
                        const store = transaction.objectStore(storeName);
                        const request = store.put(data);
                        
                        request.onsuccess = () => resolve(data);
                        request.onerror = (event) => reject(event);
                    } catch (error) {
                        reject(error);
                    }
                });
            },
            
            delete: function(storeName, key) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('Banco de dados não inicializado'));
                        return;
                    }
                    
                    try {
                        const transaction = this.db.transaction([storeName], 'readwrite');
                        const store = transaction.objectStore(storeName);
                        const request = store.delete(key);
                        
                        request.onsuccess = () => resolve(true);
                        request.onerror = (event) => reject(event);
                    } catch (error) {
                        reject(error);
                    }
                });
            },
            
            clear: function(storeName) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('Banco de dados não inicializado'));
                        return;
                    }
                    
                    try {
                        const transaction = this.db.transaction([storeName], 'readwrite');
                        const store = transaction.objectStore(storeName);
                        const request = store.clear();
                        
                        request.onsuccess = () => resolve(true);
                        request.onerror = (event) => reject(event);
                    } catch (error) {
                        reject(error);
                    }
                });
            },
            
            migrateFromLocalStorage: async function() {
                console.log('Verificando migração do localStorage...');
                
                try {
                    const existingData = await this.getAll('clientes');
                    if (existingData.length > 0) {
                        console.log('Dados já existem no IndexedDB, pulando migração');
                        return;
                    }
                    
                    const localStorageKeys = [
                        'imobipro_clientes', 'clientes',
                        'imobipro_imoveis', 'imoveis',
                        'imobipro_visitas', 'visitas',
                        'imobipro_links', 'links',
                        'imobipro_settings', 'settings',
                        'imobipro_funil_etapas', 'funil_etapas'
                    ];
                    
                    let migrated = false;
                    
                    for (const key of localStorageKeys) {
                        const data = localStorage.getItem(key);
                        if (data) {
                            try {
                                const parsedData = JSON.parse(data);
                                
                                if (key.includes('clientes') && Array.isArray(parsedData)) {
                                    for (const cliente of parsedData) {
                                        if (!cliente.dataEntradaFunil) {
                                            cliente.dataEntradaFunil = cliente.dataCriacao ? 
                                                cliente.dataCriacao.split('T')[0] : 
                                                new Date().toISOString().split('T')[0];
                                        }
                                        await this.put('clientes', cliente);
                                    }
                                    migrated = true;
                                    console.log('Clientes migrados do localStorage');
                                }
                                
                                if (key.includes('imoveis') && Array.isArray(parsedData)) {
                                    for (const imovel of parsedData) {
                                        if (!imovel.videos) {
                                            imovel.videos = [];
                                        }
                                        await this.put('imoveis', imovel);
                                    }
                                    migrated = true;
                                    console.log('Imóveis migrados do localStorage');
                                }
                                
                                if (key.includes('visitas') && Array.isArray(parsedData)) {
                                    for (const visita of parsedData) {
                                        await this.put('visitas', visita);
                                    }
                                    migrated = true;
                                    console.log('Visitas migradas do localStorage');
                                }
                                
                                if (key.includes('links') && Array.isArray(parsedData)) {
                                    for (const link of parsedData) {
                                        await this.put('links', link);
                                    }
                                    migrated = true;
                                    console.log('Links migrados do localStorage');
                                }
                                
                                if (key.includes('settings') && typeof parsedData === 'object') {
                                    await this.put('settings', { id: 'main', ...parsedData });
                                    migrated = true;
                                    console.log('Settings migrados do localStorage');
                                }
                                
                                if (key.includes('funil_etapas') && Array.isArray(parsedData)) {
                                    for (const etapa of parsedData) {
                                        await this.put('funilEtapas', etapa);
                                    }
                                    migrated = true;
                                    console.log('Etapas do funil migradas do localStorage');
                                }
                                
                            } catch (error) {
                                console.error(`Erro ao processar ${key}:`, error);
                            }
                        }
                    }
                    
                    if (migrated) {
                        localStorageKeys.forEach(key => localStorage.removeItem(key));
                        console.log('Migração concluída e localStorage limpo');
                    } else {
                        console.log('Nenhum dado encontrado no localStorage para migrar');
                    }
                    
                } catch (error) {
                    console.error('Erro durante migração:', error);
                }
            }
        };

        // Utilitários
        const Utils = {
            id: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            
            formatCurrency: (val) => {
                if (val === null || val === undefined) return 'R$ 0,00';
                const num = typeof val === 'string' ? parseFloat(val.replace(/[^\d,]/g, '').replace(',', '.')) : val;
                if (isNaN(num)) return 'R$ 0,00';
                return 'R$ ' + num.toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
            },
            
            parseCurrency: (str) => {
                if (!str || str.trim() === '') return 0;
                const cleaned = str.replace(/[^\d,]/g, '').replace(',', '.');
                return parseFloat(cleaned) || 0;
            },
            
            formatDate: (dateStr) => {
                if(!dateStr) return '-';
                const [y, m, d] = dateStr.split('-');
                return `${d}/${m}/${y}`;
            },
            
            formatDateTime: (dateStr, timeStr) => {
                if(!dateStr) return '-';
                const date = new Date(`${dateStr}T${timeStr || '00:00'}`);
                return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            },
            
            maskPhone: (input) => {
                let v = input.value.replace(/\D/g, "");
                if (v.length <= 10) {
                    v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
                    v = v.replace(/(\d)(\d{4})$/, "$1-$2");
                } else {
                    v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
                    v = v.replace(/(\d)(\d{4})$/, "$1-$2");
                }
                input.value = v.substring(0, 15);
            },
            
            formatPhone: (phone) => {
                if(!phone) return '';
                const nums = phone.replace(/\D/g, "");
                if(nums.length === 10) {
                    return `(${nums.substring(0,2)}) ${nums.substring(2,6)}-${nums.substring(6)}`;
                } else if(nums.length === 11) {
                    return `(${nums.substring(0,2)}) ${nums.substring(2,7)}-${nums.substring(7)}`;
                }
                return phone;
            },
            
            maskMoney: (input) => {
                let v = input.value.replace(/\D/g, "");
                
                if (v === "") {
                    input.value = "";
                    return;
                }
                
                v = v.replace(/^0+/, '') || '0';
                
                if (v.length === 1) v = '0' + v;
                if (v.length === 2) v = '0' + v;
                
                const reais = v.slice(0, -2);
                const centavos = v.slice(-2);
                
                let reaisFormatado = '';
                if (reais === '' || reais === '0') {
                    reaisFormatado = '0';
                } else {
                    reaisFormatado = parseInt(reais).toLocaleString('pt-BR');
                }
                
                const resultado = reaisFormatado + ',' + centavos;
                input.value = resultado;
                
                setTimeout(() => {
                    input.selectionStart = input.selectionEnd = resultado.length;
                }, 0);
            },
            
            toast: (msg, type = 'success') => {
                const t = document.getElementById('toast');
                if (!t) return;
                
                const icon = type === 'success' ? 'check-circle' : 'exclamation-circle';
                const bgColor = type === 'success' ? 'var(--dark)' : 'var(--danger)';
                
                t.innerHTML = `<i class="fas fa-${icon}"></i> <span>${msg}</span>`;
                t.style.background = bgColor;
                t.classList.add('show');
                
                setTimeout(() => {
                    t.classList.remove('show');
                }, 3000);
            },
            
            readImage: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },
            
            compressImage: (base64, quality = 0.7, maxWidth = 1200) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = base64;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = () => resolve(base64);
                });
            },
            
            getToday: () => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },
            
            getTodayTime: () => {
                const today = new Date();
                const hours = String(today.getHours()).padStart(2, '0');
                const minutes = String(today.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            },
            
            isToday: (dateStr) => {
                if(!dateStr) return false;
                return dateStr === Utils.getToday();
            },
            
            getTipoText: (tipo) => {
                const tipos = {
                    'apartamento': 'Apartamento',
                    'casa': 'Casa',
                    'terreno': 'Terreno',
                    'comercial': 'Comercial',
                    'kitnet': 'Kitnet'
                };
                return tipos[tipo] || tipo;
            },
            
            getStatusText: (status) => {
                const statuses = {
                    'disponivel': 'Disponível',
                    'reservado': 'Reservado',
                    'vendido': 'Vendido',
                    'alugado': 'Alugado'
                };
                return statuses[status] || status;
            },
            
            getTipoClienteText: (tipo) => {
                const tipos = {
                    'comprador': 'Comprador',
                    'vendedor': 'Vendedor',
                    'ambos': 'Comprador/Vendedor'
                };
                return tipos[tipo] || tipo;
            },
            
            getTipoVisitaText: (tipo) => {
                const tipos = {
                    'visita': 'Visita ao Imóvel',
                    'reuniao-construtor': 'Reunião com Construtor',
                    'reuniao-equipe': 'Reunião de Equipe',
                    'documentacao': 'Assinatura de Documentos',
                    'plantao': 'Plantão',
                    'generico': 'Agendamento Genérico',
                    'outro': 'Outro'
                };
                return tipos[tipo] || tipo;
            },
            
            getStatusVisitaText: (status) => {
                const statuses = {
                    'agendado': 'Agendado',
                    'confirmado': 'Confirmado',
                    'realizado': 'Realizado',
                    'cancelado': 'Cancelado'
                };
                return statuses[status] || status;
            },
            
            getEtapaFunilText: (etapa) => {
                return etapa?.nome || etapa;
            },
            
            getEtapaFunilColor: (etapa) => {
                return etapa?.cor || '#93c5fd';
            },
            
            isBirthdayToday: (birthdate) => {
                if (!birthdate) return false;
                const today = new Date();
                const birth = new Date(birthdate);
                return today.getDate() === birth.getDate() && today.getMonth() === birth.getMonth();
            },
            
            calculateAge: (birthdate) => {
                if (!birthdate) return null;
                const today = new Date();
                const birth = new Date(birthdate);
                let age = today.getFullYear() - birth.getFullYear();
                const m = today.getMonth() - birth.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            },
            
            calculateDaysInStage: (dataEntrada) => {
                if (!dataEntrada) return 0;
                const entrada = new Date(dataEntrada);
                const hoje = new Date();
                const diffTime = Math.abs(hoje - entrada);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            },
            
            generatePDF: async (imovel) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 15;
                    let yPos = 20;

                    doc.setFillColor(37, 99, 235);
                    doc.rect(0, 0, pageWidth, 30, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(22);
                    doc.setFont("helvetica", "bold");
                    doc.text("FICHA DO IMÓVEL", pageWidth / 2, 18, { align: "center" });
                    
                    const settings = await DB.get('settings', 'main') || {};
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text(`${settings.imobiliaria || "ImobiPro"} | ${settings.telefone || ""}`, pageWidth / 2, 25, { align: "center" });

                    yPos = 45;

                    doc.setTextColor(30, 41, 59);
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    const tituloSplit = doc.splitTextToSize(imovel.titulo.toUpperCase(), pageWidth - (margin * 2));
                    doc.text(tituloSplit, margin, yPos);
                    yPos += (tituloSplit.length * 6) + 5;

                    doc.setFontSize(18);
                    doc.setTextColor(37, 99, 235);
                    let precoTexto = imovel.precoVenda ? Utils.formatCurrency(imovel.precoVenda) : 
                                     (imovel.precoAluguel ? Utils.formatCurrency(imovel.precoAluguel) + "/mês" : "Consulte");
                    doc.text(precoTexto, margin, yPos);
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Ref: ${imovel.id.substring(0,6).toUpperCase()}`, pageWidth - margin, yPos, { align: "right" });
                    
                    yPos += 8;
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin, yPos, pageWidth - margin, yPos);
                    yPos += 10;

                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    
                    const detalhes = [
                        `Endereço: ${imovel.endereco}`,
                        `Bairro/Cidade: (Ver localização)`, 
                        `Tipo: ${Utils.getTipoText(imovel.tipo)}`,
                        `Área: ${imovel.area || '-'} m²`,
                        `Quartos: ${imovel.quartos || '-'}`,
                        `Banheiros: ${imovel.banheiros || '-'}`,
                        `Vagas: ${imovel.vagas || '-'}`,
                        `Condomínio: ${imovel.condominio ? Utils.formatCurrency(imovel.condominio) : '-'}`,
                        `Status: ${Utils.getStatusText(imovel.status)}`,
                        `Construtora: ${imovel.construtora || '-'}`
                    ];

                    let col = 0;
                    detalhes.forEach((detalhe) => {
                        if (col === 0) {
                            doc.text("• " + detalhe, margin, yPos);
                            col = 1;
                        } else {
                            doc.text("• " + detalhe, pageWidth / 2 + 5, yPos);
                            col = 0;
                            yPos += 6;
                        }
                    });
                    if (col === 1) yPos += 6; 
                    yPos += 5;

                    if (imovel.descricao) {
                        yPos += 5;
                        doc.setFont("helvetica", "bold");
                        doc.setTextColor(37, 99, 235);
                        doc.text("DESCRIÇÃO", margin, yPos);
                        yPos += 6;
                        
                        doc.setFont("helvetica", "normal");
                        doc.setTextColor(50, 50, 50);
                        doc.setFontSize(9);
                        
                        const descSplit = doc.splitTextToSize(imovel.descricao, pageWidth - (margin * 2));
                        doc.text(descSplit, margin, yPos);
                        yPos += (descSplit.length * 4) + 10;
                    }

                    if (imovel.imagens && imovel.imagens.length > 0) {
                        if (yPos > pageHeight - 60) {
                            doc.addPage();
                            yPos = 20;
                        }

                        doc.setFontSize(12);
                        doc.setFont("helvetica", "bold");
                        doc.setTextColor(37, 99, 235);
                        doc.text("GALERIA DE FOTOS", margin, yPos);
                        yPos += 10;

                        const imgWidth = 85; 
                        const imgHeight = 55; 
                        const xGap = 10; 
                        const yGap = 10; 
                        
                        let xPos = margin;
                        
                        for (let i = 0; i < imovel.imagens.length; i++) {
                            if (yPos + imgHeight > pageHeight - margin) {
                                doc.addPage();
                                yPos = 20;
                            }

                            try {
                                doc.addImage(imovel.imagens[i], 'JPEG', xPos, yPos, imgWidth, imgHeight);
                                doc.setDrawColor(220, 220, 220);
                                doc.rect(xPos, yPos, imgWidth, imgHeight);
                            } catch (e) {
                                // Ignora erro de imagem
                            }

                            if (xPos === margin) {
                                xPos = margin + imgWidth + xGap; 
                            } else {
                                xPos = margin; 
                                yPos += imgHeight + yGap; 
                            }
                        }
                    }

                    const pageCount = doc.getNumberOfPages();
                    for(let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        doc.text(`Página ${i} de ${pageCount} - Gerado por ImobiPro`, pageWidth / 2, pageHeight - 10, { align: "center" });
                    }

                    doc.save(`Ficha_${imovel.titulo.substring(0,10).replace(/[^a-z0-9]/gi, '_')}.pdf`);
                    Utils.toast("PDF gerado com sucesso!");

                } catch (err) {
                    console.error(err);
                    Utils.toast("Erro ao gerar PDF.", "error");
                }
            },

            generatePlantaoPDF: async (dateStr) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    let yPos = 20;

                    doc.setFillColor(124, 58, 237); 
                    doc.rect(0, 0, pageWidth, 25, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont("helvetica", "bold");
                    doc.text("RELATÓRIO DE PLANTÃO", pageWidth/2, 12, {align: "center"});
                    doc.setFontSize(11);
                    doc.text(`Data: ${Utils.formatDate(dateStr)}`, pageWidth/2, 20, {align: "center"});

                    yPos = 40;

                    const clientes = UI.data.clientes.filter(c => c.dataCriacao && c.dataCriacao.startsWith(dateStr));

                    if (clientes.length === 0) {
                        doc.setTextColor(0,0,0);
                        doc.text("Nenhum atendimento registrado nesta data.", 15, yPos);
                    } else {
                        const bodyData = clientes.map(c => [
                            c.nome,
                            c.telefone,
                            c.faixaPreco || "-",
                            c.observacoes || ""
                        ]);

                        doc.autoTable({
                            startY: yPos,
                            head: [["Nome", "Telefone", "Interesse", "Observações"]],
                            body: bodyData,
                            theme: 'grid',
                            headStyles: { fillColor: [124, 58, 237] },
                            styles: { fontSize: 9, cellPadding: 3 },
                            columnStyles: {
                                0: { cellWidth: 40 }, 
                                1: { cellWidth: 35 }, 
                                2: { cellWidth: 30 }, 
                                3: { cellWidth: 'auto' } 
                            }
                        });
                        
                        const finalY = doc.lastAutoTable.finalY + 10;
                        doc.setFontSize(10);
                        doc.setTextColor(50, 50, 50);
                        doc.text(`Total de Atendimentos: ${clientes.length}`, 15, finalY);
                    }

                    doc.setDrawColor(0,0,0);
                    doc.setLineWidth(0.5);
                    doc.line(15, 270, 80, 270);
                    doc.setFontSize(8);
                    doc.text("Assinatura do Corretor", 15, 275);

                    doc.save(`Plantao_${dateStr}.pdf`);
                    Utils.toast("PDF do Plantão baixado!");

                } catch (e) {
                    console.error(e);
                    Utils.toast("Erro ao gerar PDF de Plantão", "error");
                }
            },
           
            generateReportPDF: async (reportData, reportType) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const margin = 15;
                    let yPos = margin;
                    
                    const settings = await DB.get('settings', 'main') || {};
                    
                    doc.setFillColor(37, 99, 235);
                    doc.rect(0, 0, pageWidth, 25, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(20);
                    doc.setFont("helvetica", "bold");
                    
                    let reportTitle = "RELATÓRIO DE ";
                    switch(reportType) {
                        case 'clientes': reportTitle += "CLIENTES"; break;
                        case 'agendamentos': reportTitle += "AGENDAMENTOS"; break;
                        case 'vendas': reportTitle += "VENDAS"; break;
                        case 'performance': reportTitle += "PERFORMANCE"; break;
                        default: reportTitle += "GERAL";
                    }
                    
                    doc.text(reportTitle, pageWidth/2, 15, {align: "center"});
                    
                    doc.setFontSize(10);
                    doc.text(`${settings.imobiliaria || "Imobiliária"} | ${new Date().toLocaleDateString("pt-BR")}`, pageWidth/2, 22, {align: "center"});
                    
                    yPos = 35;
                    
                    doc.setFontSize(12);
                    doc.setTextColor(30, 41, 59);
                    doc.text(`Período: ${reportData.periodo}`, margin, yPos);
                    yPos += 8;
                    doc.text(`Total: ${reportData.total} registros`, margin, yPos);
                    yPos += 12;
                    
                    if (reportData.dados && reportData.dados.length > 0) {
                        doc.setFontSize(14);
                        doc.setTextColor(37, 99, 235);
                        doc.setFont("helvetica", "bold");
                        doc.text("DETALHES", margin, yPos);
                        yPos += 10;
                        
                        doc.setFontSize(10);
                        doc.setTextColor(30, 41, 59);
                        doc.setFont("helvetica", "normal");
                        
                        const headers = reportData.headers || [];
                        const rows = reportData.dados.map(item => 
                            headers.map(header => item[header] || '')
                        );
                        
                        doc.autoTable({
                            startY: yPos,
                            head: [headers],
                            body: rows,
                            margin: { left: margin, right: margin },
                            styles: { fontSize: 9, cellPadding: 3 },
                            headStyles: { fillColor: [37, 99, 235] }
                        });
                    }
                    
                    if (reportData.resumo) {
                        yPos = doc.lastAutoTable.finalY + 10;
                        
                        if (yPos > doc.internal.pageSize.getHeight() - 20) {
                            doc.addPage();
                            yPos = margin;
                        }
                        
                        doc.setFontSize(14);
                        doc.setTextColor(37, 99, 235);
                        doc.setFont("helvetica", "bold");
                        doc.text("RESUMO ESTATÍSTICO", margin, yPos);
                        yPos += 10;
                        
                        doc.setFontSize(10);
                        doc.setTextColor(30, 41, 59);
                        
                        for (const [key, value] of Object.entries(reportData.resumo)) {
                            doc.text(`${key}: ${value}`, margin, yPos);
                            yPos += 6;
                        }
                    }
                    
                    const finalY = doc.internal.pageSize.getHeight() - 10;
                    doc.setFontSize(9);
                    doc.setTextColor(100, 116, 139);
                    doc.text(`Gerado por ${settings.nome || "ImobiPro"} - ${settings.creci || ""}`, pageWidth/2, finalY, {align: "center"});
                    
                    const fileName = `relatorio_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);
                    
                    Utils.toast("Relatório PDF gerado com sucesso!");
                    
                } catch(err) {
                    console.error("Erro ao gerar relatório PDF:", err);
                    Utils.toast("Erro ao gerar relatório PDF", "error");
                }
            },
            
            getGreeting: () => {
                const hour = new Date().getHours();
                if (hour >= 5 && hour < 12) return "Bom dia";
                if (hour >= 12 && hour < 18) return "Boa tarde";
                return "Boa noite";
            },
            
            cleanPhoneNumber: (phone) => {
                if(!phone) return '';
                let clean = phone.replace(/\D/g, '');
                if(clean.startsWith('0')) {
                    clean = clean.substring(1);
                }
                if(clean.startsWith('55')) {
                    clean = clean.substring(2);
                }
                return clean;
            },
            
            generateWhatsAppMessage: async (cliente, imovel = null) => {
                const hour = new Date().getHours();
                let greeting = "Boa noite";
                if (hour >= 5 && hour < 12) greeting = "Bom dia";
                if (hour >= 12 && hour < 18) greeting = "Boa tarde";
                
                const clienteFirstName = cliente.nome.split(' ')[0];
                let message = `${greeting}, ${clienteFirstName}! Tudo bem? 😊\n\n`;
                message += `Me chamo ${(await DB.get('settings', 'main')).nome || 'Alex Peixoto'} sou do time de vendas da  ${(await DB.get('settings', 'main')).imobiliaria || 'Resende'}.\n\n`;
                
                if (imovel) {
                    message += `Vi que seu interesse inicial foi no *${imovel.titulo}*.\n\n`;
                    
                    message += `*🏠 Sobre o imóvel:*\n`;
                    message += `📍 *Endereço:* ${imovel.endereco}\n`;
                    message += `🏠 *Tipo:* ${Utils.getTipoText(imovel.tipo)}\n`;
                    if (imovel.area) message += `📐 *Área:* ${imovel.area}m²\n`;
                    if (imovel.quartos) message += `🛏️ *Quartos:* ${imovel.quartos}\n`;
                    if (imovel.banheiros) message += `🛁 *Banheiros:* ${imovel.banheiros}\n`;
                    if (imovel.vagas) message += `🚗 *Vagas:* ${imovel.vagas}\n`;
                    if (imovel.gasEncanado === 'sim') message += `🔥 *Gás Encanado:* Sim\n`;
                    if (imovel.condominio) message += `💰 *Condomínio:* ${Utils.formatCurrency(imovel.condominio)}/mês\n\n`;
                    
                    if (imovel.precoVenda) {
                        message += `💰 *Preço de Venda:* ${Utils.formatCurrency(imovel.precoVenda)}\n`;
                    } else if (imovel.precoAluguel) {
                        message += `💰 *Preço de Aluguel:* ${Utils.formatCurrency(imovel.precoAluguel)}/mês\n`;
                    }
                    
                    if (imovel.formaPagamento) {
                        message += `\n💳 *Forma de Pagamento:*\n${imovel.formaPagamento}\n`;
                    }
                    
                    if (imovel.dataEntrega) {
                        message += `\n📅 *Data de Entrega:* ${Utils.formatDate(imovel.dataEntrega)}\n`;
                    }
                    
                    if (imovel.construtora) {
                        message += `\n🏗️ *Construtora:* ${imovel.construtora}\n`;
                    }
                    
                    if (imovel.videos && imovel.videos.length > 0) {
                        message += `\n🎥 *Vídeos disponíveis:*\n`;
                        imovel.videos.forEach((video, index) => {
                            message += `• Vídeo ${index + 1}: ${video.url}\n`;
                        });
                        message += `\n`;
                    }
                    
                    if (imovel.descricao) {
                        message += `\n📝 *Descrição:*\n${imovel.descricao.substring(0, 150)}${imovel.descricao.length > 150 ? '...' : ''}\n`;
                    }
                } else {
                    message += `Estou entrando em contato porque recebi a informaçāo que deseja comprar um imóvel, ainda tem interesse?  🤝\n`;

                    
                }
                
                const settings = await DB.get('settings', 'main');
                
                return message;
            },
            
            prepareWhatsAppUrl: async (clienteId, imovelId = null) => {
    const cliente = UI.data.clientes.find(x => x.id === clienteId);
    if(!cliente || !cliente.telefone) {
        Utils.toast('Cliente sem número de telefone', 'error');
        return null;
    }
    
    const imovel = imovelId ? UI.data.imoveis.find(i => i.id === imovelId) : null;
    
    // Limpar e formatar o número
    let phoneNumber = cliente.telefone.replace(/\D/g, '');
    
    // Remover o 0 no início se existir
    if (phoneNumber.startsWith('0')) {
        phoneNumber = phoneNumber.substring(1);
    }
    
    // Adicionar código do Brasil (55) se não tiver
    if (!phoneNumber.startsWith('55')) {
        phoneNumber = '55' + phoneNumber;
    }
    
    // Verificar se é dispositivo iOS
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    // Preparar a mensagem
    const message = await Utils.generateWhatsAppMessage(cliente, imovel);
    const encodedMessage = encodeURIComponent(message);
    
    // URL específica para iOS
    if (isIOS) {
        // Para iOS, usar o esquema de URL do WhatsApp
        return `whatsapp://send?phone=${phoneNumber}&text=${encodedMessage}`;
    } else {
        // Para Android e outros dispositivos
        return `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
    }
},
            
            extractVideoId: (url) => {
                if (!url) return null;
                
                if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                    const match = url.match(youtubeRegex);
                    return match ? match[1] : null;
                }
                
                if (url.includes('vimeo.com')) {
                    const vimeoRegex = /vimeo\.com\/(?:channels\/(?:\w+\/)?|groups\/([^\/]*)\/videos\/|)(\d+)(?:|\/\?)/;
                    const match = url.match(vimeoRegex);
                    return match ? match[2] : null;
                }
                
                return null;
            },
            
            generateVideoThumbnail: (url) => {
                const videoId = Utils.extractVideoId(url);
                if (!videoId) return null;
                
                if (url.includes('youtube') || url.includes('youtu.be')) {
                    return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                } else if (url.includes('vimeo')) {
                    return `https://vumbnail.com/${videoId}.jpg`;
                }
                
                return null;
            },
            
            isValidVideoUrl: (url) => {
                if (!url) return false;
                return url.includes('youtube.com') || 
                       url.includes('youtu.be') || 
                       url.includes('vimeo.com');
            }
        };

        // Camada de armazenamento
        const Storage = {
            async getClientes() {
                return await DB.getAll('clientes');
            },
            
            async getImoveis() {
                return await DB.getAll('imoveis');
            },
            
            async getVisitas() {
                return await DB.getAll('visitas');
            },
            
            async getLinks() {
                return await DB.getAll('links');
            },
            
            async getSettings() {
                const settings = await DB.get('settings', 'main');
                return settings || { 
                    id: 'main',
                    nome: 'Alex Peixoto',
                    creci: '5794-AL',
                    telefone: '(82) 99662-2036',
                    email: '',
                    imobiliaria: 'Resende',
                    comissao: 5
                };
            },
            
            async getFunilEtapas() {
                const etapas = await DB.getAll('funilEtapas');
                if (etapas.length === 0) {
                    const etapasPadrao = [
                        { id: 'lead', nome: 'Lead', cor: '#93c5fd', ordem: 1 },
                        { id: 'contato', nome: 'Contato Realizado', cor: '#60a5fa', ordem: 2 },
                        { id: 'cpf', nome: 'CPF em Análise', cor: '#3b82f6', ordem: 3 },
                        { id: 'sem-restricao', nome: 'Sem Restrição', cor: '#1d4ed8', ordem: 4 },
                        { id: 'documentacao', nome: 'Documentação', cor: '#7c3aed', ordem: 5 },
                        { id: 'aprovado', nome: 'Aprovado', cor: '#10b981', ordem: 6 },
                        { id: 'contrato', nome: 'Contrato Assinado', cor: '#059669', ordem: 7 },
                        { id: 'venda', nome: 'Venda Concluída', cor: '#047857', ordem: 8 }
                    ];
                    
                    for (const etapa of etapasPadrao) {
                        await DB.put('funilEtapas', etapa);
                    }
                    
                    return etapasPadrao;
                }
                
                return etapas.sort((a, b) => a.ordem - b.ordem);
            }
        };

        // Interface do usuário
        const UI = {
            data: { 
                clientes: [], 
                imoveis: [], 
                visitas: [],
                links: [],
                funilEtapas: []
            },
            currentCarouselIndex: 0,
            currentCarouselImages: [],
            fullscreenImages: [],
            fullscreenCurrentIndex: 0,
            currentAgendaFilter: 'todos',
            draggingClient: null,
            currentReport: null,
            
            init: async () => {
                try {
                    console.log('Inicializando sistema...');
                    
                    await DB.init();
                    
                    await DB.migrateFromLocalStorage();
                    
                    UI.data.clientes = await Storage.getClientes();
                    UI.data.imoveis = await Storage.getImoveis();
                    UI.data.visitas = await Storage.getVisitas();
                    UI.data.links = await Storage.getLinks();
                    UI.data.funilEtapas = await Storage.getFunilEtapas();
                    
                    console.log('Dados carregados:', {
                        clientes: UI.data.clientes.length,
                        imoveis: UI.data.imoveis.length,
                        visitas: UI.data.visitas.length,
                        links: UI.data.links.length,
                        etapas: UI.data.funilEtapas.length
                    });
                    
                    const today = new Date();
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                    
                    document.getElementById('report-date-start').value = firstDay.toISOString().split('T')[0];
                    document.getElementById('report-date-end').value = today.toISOString().split('T')[0];
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('app').style.display = 'flex';
                    
                    UI.renderDashboard();
                    UI.renderFunil();
                    
                    console.log('Sistema inicializado com sucesso');
                    
                } catch (error) {
                    console.error('Erro ao inicializar:', error);
                    Utils.toast('Erro ao inicializar o sistema', 'error');
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('app').style.display = 'flex';
                }
            },

            switchTab: (el) => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                
                el.classList.add('active');
                const target = el.getAttribute('data-target');
                document.getElementById(target).classList.add('active');

                const fab = document.getElementById('main-fab');
                if(target === 'dashboard-view' || target === 'imoveis-view') {
                    fab.style.display = 'flex';
                    fab.onclick = UI.openNewImovel;
                } else if (target === 'clientes-view') {
                    fab.style.display = 'flex';
                    fab.onclick = () => UI.openNewCliente(false);
                } else if (target === 'agenda-view') {
                    fab.style.display = 'flex';
                    fab.onclick = UI.openNewVisita;
                } else if (target === 'links-view') {
                    fab.style.display = 'flex';
                    fab.onclick = UI.openNewLink;
                } else if (target === 'funil-view') {
                    fab.style.display = 'none';
                    UI.renderFunil();
                } else {
                    fab.style.display = 'none';
                }

                if(target === 'clientes-view') UI.renderClientes();
                if(target === 'imoveis-view') UI.renderImoveis();
                if(target === 'agenda-view') UI.renderAgenda();
                if(target === 'relatorios-view') UI.renderReport();
                if(target === 'links-view') UI.renderLinks();
                
                document.querySelector('main').scrollTop = 0;
            },

            navigate: (tabName) => {
                const el = document.querySelector(`.nav-item[data-target="${tabName}-view"]`);
                if(el) UI.switchTab(el);
            },

            searchImoveis: function(searchTerm) {
                const tipoFilter = document.querySelector('#imoveis-view select').value;
                const statusFilter = document.getElementById('filter-status').value;
                UI.renderImoveis(searchTerm, tipoFilter, statusFilter);
            },

            renderDashboard: () => {
                const { clientes, imoveis, visitas } = UI.data;
                
                document.getElementById('dash-total-clientes').innerText = clientes.length;
                document.getElementById('dash-total-imoveis').innerText = imoveis.length;
                
                const hoje = Utils.getToday();
                const visitasHoje = visitas.filter(v => v.data === hoje && v.status !== 'cancelado');
                document.getElementById('dash-visitas').innerText = visitasHoje.length;
                
                const hojeObj = new Date();
                const mesAtual = hojeObj.getMonth();
                const anoAtual = hojeObj.getFullYear();
                
                const vendasMes = imoveis.filter(i => {
                    if (!i.dataVenda) return false;
                    const dataVenda = new Date(i.dataVenda);
                    return dataVenda.getMonth() === mesAtual && 
                           dataVenda.getFullYear() === anoAtual && 
                           i.status === 'vendido';
                });
                
                const totalVendas = vendasMes.reduce((acc, i) => acc + (i.precoVenda || 0), 0);
                document.getElementById('dash-vendas').innerText = Utils.formatCurrency(totalVendas);
                
                const negociacoes = imoveis.filter(i => i.status === 'reservado').length;
                document.getElementById('dash-negociacoes').innerText = negociacoes;
                
                const destaques = imoveis.filter(i => i.destaque).length;
                document.getElementById('dash-destaques').innerText = destaques;
                
                UI.renderAniversariantes();
                
                const visitasList = document.getElementById('visitas-list');
                if(visitasHoje.length === 0) {
                    visitasList.innerHTML = `<div class="empty-state"><i class="fas fa-calendar-check"></i><p>Nenhuma visita agendada para hoje!</p></div>`;
                } else {
                    visitasList.innerHTML = visitasHoje.map(v => UI.createVisitaCard(v)).join('');
                }
                
                const negociacoesList = document.getElementById('negociacoes-list');
                const imoveisReservados = imoveis.filter(i => i.status === 'reservado').slice(0, 3);
                
                if(imoveisReservados.length === 0) {
                    negociacoesList.innerHTML = `<div class="empty-state"><i class="fas fa-handshake"></i><p>Nenhuma negociação ativa!</p></div>`;
                } else {
                    negociacoesList.innerHTML = imoveisReservados.map(i => UI.createNegociacaoCard(i)).join('');
                }
                
                document.getElementById('visitas-badge').style.display = visitasHoje.length > 0 ? 'inline-block' : 'none';
                document.getElementById('negociacoes-badge').style.display = imoveisReservados.length > 0 ? 'inline-block' : 'none';
            },

            renderAniversariantes: () => {
                const hoje = new Date();
                const diaHoje = hoje.getDate();
                const mesHoje = hoje.getMonth() + 1;
                
                const aniversariantes = UI.data.clientes.filter(cliente => {
                    if (!cliente.dataNascimento) return false;
                    const nascimento = new Date(cliente.dataNascimento);
                    return nascimento.getDate() === diaHoje && (nascimento.getMonth() + 1) === mesHoje;
                });
                
                const aniversariantesList = document.getElementById('aniversariantes-list');
                const badge = document.getElementById('aniversariantes-badge');
                
                if (aniversariantes.length === 0) {
                    aniversariantesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-birthday-cake"></i>
                            <p>Nenhum aniversariante hoje</p>
                        </div>
                    `;
                    badge.style.display = 'none';
                } else {
                    aniversariantesList.innerHTML = aniversariantes.map(cliente => {
                        const idade = Utils.calculateAge(cliente.dataNascimento);
                        return `
                            <div class="client-card" onclick="App.cliente.edit('${cliente.id}')">
                                <div class="client-header">
                                    <div class="client-name">${cliente.nome} <span class="badge badge-pink">🎂 ${idade ? idade + ' anos' : 'Aniversário'}</span></div>
                                    <span class="client-type type-${cliente.tipo}">${Utils.getTipoClienteText(cliente.tipo)}</span>
                                </div>
                                <div class="client-info">
                                    <div class="client-row"><i class="fas fa-phone"></i> ${cliente.telefone}</div>
                                    ${cliente.email ? `<div class="client-row"><i class="fas fa-envelope"></i> ${cliente.email}</div>` : ''}
                                    ${cliente.dataNascimento ? `<div class="client-row"><i class="fas fa-birthday-cake"></i> ${Utils.formatDate(cliente.dataNascimento)}</div>` : ''}
                                </div>
                                <div class="client-actions">
                                    <button class="btn-whatsapp-client" onclick="event.stopPropagation(); App.cliente.whatsappPersonalizado('${cliente.id}')">
                                        <i class="fab fa-whatsapp"></i> Parabéns!
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    badge.style.display = 'inline-block';
                    badge.innerText = aniversariantes.length.toString();
                }
            },

            renderFunil: async () => {
                const etapas = UI.data.funilEtapas.sort((a, b) => a.ordem - b.ordem);
                
                const totalClientes = UI.data.clientes.length;
                const clientesPorEtapa = {};
                let totalVendas = 0;
                let totalDias = 0;
                let clientesComData = 0;
                
                etapas.forEach(etapa => {
                    const clientes = UI.data.clientes.filter(c => c.etapaFunil === etapa.id);
                    clientesPorEtapa[etapa.id] = clientes;
                    
                    if (etapa.id === 'venda') {
                        totalVendas = clientes.length;
                    }
                    
                    clientes.forEach(cliente => {
                        if (cliente.dataEntradaFunil) {
                            const dias = Utils.calculateDaysInStage(cliente.dataEntradaFunil);
                            totalDias += dias;
                            clientesComData++;
                        }
                    });
                });
                
                document.getElementById('funil-lead').textContent = clientesPorEtapa['lead']?.length || 0;
                document.getElementById('funil-venda').textContent = totalVendas;
                document.getElementById('funil-total').textContent = `${totalClientes} clientes`;
                
                const taxaConversao = totalClientes > 0 ? ((totalVendas / totalClientes) * 100).toFixed(1) : 0;
                document.getElementById('funil-taxa').textContent = `${taxaConversao}%`;
                
                const tempoMedio = clientesComData > 0 ? Math.round(totalDias / clientesComData) : 0;
                document.getElementById('funil-tempo').textContent = `${tempoMedio}d`;
                
                const container = document.getElementById('funil-stages-container');
                let html = '<div class="funnel-stages">';
                
                etapas.forEach(etapa => {
                    const clientes = clientesPorEtapa[etapa.id] || [];
                    const porcentagem = totalClientes > 0 ? Math.round((clientes.length / totalClientes) * 100) : 0;
                    
                    html += `
                        <div class="funnel-stage stage-${etapa.id}" 
                             onclick="UI.toggleFunnelStage('${etapa.id}')" 
                             ondragover="event.preventDefault(); event.currentTarget.classList.add('drop-zone');" 
                             ondragleave="event.currentTarget.classList.remove('drop-zone');"
                             ondrop="UI.dropOnStage(event, '${etapa.id}'); event.currentTarget.classList.remove('drop-zone');">
                            <div class="funnel-stage-header">
                                <div class="funnel-stage-title">
                                    <i class="fas fa-${UI.getFunnelIcon(etapa.id)}"></i>
                                    ${etapa.nome}
                                </div>
                                <span class="funnel-stage-count" style="background: ${etapa.cor}; color: white;">${clientes.length}</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${porcentagem}%; background: ${etapa.cor};"></div>
                            </div>
                            <div class="funnel-stage-clients" id="funnel-clients-${etapa.id}">
                                ${clientes.map(cliente => `
                                    <div class="funnel-client-item" 
                                         draggable="true" 
                                         data-cliente-id="${cliente.id}"
                                         ondragstart="UI.startDrag(event, '${cliente.id}')"
                                         onclick="event.stopPropagation(); App.cliente.edit('${cliente.id}')">
                                        <div class="funnel-client-name">${cliente.nome}</div>
                                        <div class="funnel-client-days">
                                            ${cliente.dataEntradaFunil ? `${Utils.calculateDaysInStage(cliente.dataEntradaFunil)} dias` : 'Novo'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                UI.renderClientesFunil();
                
                const select = document.querySelector('#funil-view select');
                if (select) {
                    select.innerHTML = '<option value="todos">Todos os estágios</option>';
                    etapas.forEach(etapa => {
                        select.innerHTML += `<option value="${etapa.id}">${etapa.nome}</option>`;
                    });
                }
            },
            
            getFunnelIcon: (etapaId) => {
                const icons = {
                    'lead': 'user-plus',
                    'contato': 'phone-alt',
                    'cpf': 'search',
                    'sem-restricao': 'check-circle',
                    'documentacao': 'file-contract',
                    'aprovado': 'thumbs-up',
                    'contrato': 'pen-fancy',
                    'venda': 'trophy'
                };
                return icons[etapaId] || 'circle';
            },
            
            toggleFunnelStage: (etapaId) => {
                const stage = document.querySelector(`.stage-${etapaId}`);
                if (!stage) return;
                
                const clientsContainer = document.getElementById(`funnel-clients-${etapaId}`);
                if (!clientsContainer) return;
                
                if (stage.classList.contains('expanded')) {
                    stage.classList.remove('expanded');
                    clientsContainer.style.maxHeight = '0';
                } else {
                    document.querySelectorAll('.funnel-stage.expanded').forEach(s => {
                        s.classList.remove('expanded');
                        const id = s.className.match(/stage-(\w+)/);
                        if (id && id[1]) {
                            const container = document.getElementById(`funnel-clients-${id[1]}`);
                            if (container) container.style.maxHeight = '0';
                        }
                    });
                    
                    stage.classList.add('expanded');
                    clientsContainer.style.maxHeight = `${clientsContainer.scrollHeight}px`;
                }
            },
            
            startDrag: (event, clienteId) => {
                event.dataTransfer.setData('text/plain', clienteId);
                UI.draggingClient = clienteId;
                event.currentTarget.classList.add('dragging');
            },
            
            dropOnStage: async (event, etapaId) => {
                event.preventDefault();
                const clienteId = event.dataTransfer.getData('text/plain');
                
                if (clienteId) {
                    const cliente = UI.data.clientes.find(c => c.id === clienteId);
                    if (cliente && cliente.etapaFunil !== etapaId) {
                        cliente.etapaFunil = etapaId;
                        cliente.dataEntradaFunil = new Date().toISOString().split('T')[0];
                        await DB.put('clientes', cliente);
                        UI.data.clientes = await Storage.getClientes();
                        UI.renderFunil();
                        UI.renderClientes();
                        Utils.toast(`${cliente.nome} movido para ${Utils.getEtapaFunilText(etapaId)}`);
                    }
                }
                
                document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
                UI.draggingClient = null;
            },
            
            renderClientesFunil: (filterEtapa = 'todos') => {
                const container = document.getElementById('funil-clientes-list');
                let clientes = UI.data.clientes;
                
                if (filterEtapa !== 'todos') {
                    clientes = clientes.filter(c => c.etapaFunil === filterEtapa);
                }
                
                if (clientes.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>Nenhum cliente neste estágio do funil</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = clientes.map(cliente => {
                    const etapa = UI.data.funilEtapas.find(e => e.id === cliente.etapaFunil);
                    const dias = cliente.dataEntradaFunil ? Utils.calculateDaysInStage(cliente.dataEntradaFunil) : 0;
                    
                    return `
                        <div class="client-card" onclick="App.cliente.edit('${cliente.id}')">
                            <div class="client-header">
                                <div class="client-name">${cliente.nome}</div>
                                <span class="client-type" style="background: ${etapa?.cor || '#93c5fd'}; color: white;">
                                    ${etapa?.nome || 'Lead'}
                                </span>
                            </div>
                            <div class="client-info">
                                <div class="client-row"><i class="fas fa-phone"></i> ${cliente.telefone}</div>
                                ${cliente.email ? `<div class="client-row"><i class="fas fa-envelope"></i> ${cliente.email}</div>` : ''}
                                <div class="client-row"><i class="fas fa-calendar"></i> ${dias} dias nesta etapa</div>
                                ${cliente.faixaPreco ? `<div class="client-row"><i class="fas fa-search-dollar"></i> ${cliente.faixaPreco}</div>` : ''}
                            </div>
                            <div class="client-actions">
                                <button class="btn-whatsapp-client" onclick="event.stopPropagation(); App.cliente.whatsappPersonalizado('${cliente.id}')">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </button>
                                <button class="btn-email-client" onclick="event.stopPropagation(); App.cliente.email('${cliente.id}')">
                                    <i class="fas fa-envelope"></i> Email
                                </button>
                                <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.cliente.edit('${cliente.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            filterClientesFunil: (etapaId) => {
                UI.renderClientesFunil(etapaId);
            },
            
            filterFunil: (etapaId) => {
                UI.filterClientesFunil(etapaId);
                const element = document.getElementById('funil-clientes-list');
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth' });
                }
            },
            
            openFunilSettings: () => {
                const container = document.getElementById('funil-etapas-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                UI.data.funilEtapas.sort((a, b) => a.ordem - b.ordem).forEach((etapa, index) => {
                    const etapaEl = document.createElement('div');
                    etapaEl.className = 'form-group';
                    etapaEl.innerHTML = `
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                            <div style="width: 30px; height: 30px; border-radius: 6px; background: ${etapa.cor}; display: flex; align-items: center; justify-content: center; color: white;">
                                <i class="fas fa-${UI.getFunnelIcon(etapa.id)}"></i>
                            </div>
                            <input type="text" class="form-control" value="${etapa.nome}" 
                                   onchange="UI.updateEtapaFunil(${index}, 'nome', this.value)" 
                                   style="flex: 1;">
                            <input type="color" value="${etapa.cor}" 
                                   onchange="UI.updateEtapaFunil(${index}, 'cor', this.value)"
                                   style="width: 40px; height: 40px; padding: 0; border: none;">
                            <button class="icon-btn" onclick="UI.moveEtapaFunil(${index}, 'up')" ${index === 0 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="icon-btn" onclick="UI.moveEtapaFunil(${index}, 'down')" ${index === UI.data.funilEtapas.length - 1 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button class="icon-btn" style="color: var(--danger);" onclick="UI.removeEtapaFunil(${index})" ${UI.data.funilEtapas.length <= 1 ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(etapaEl);
                });
                
                UI.openModal('funil-settings');
            },
            
            updateEtapaFunil: async (index, campo, valor) => {
                UI.data.funilEtapas[index][campo] = valor;
                await DB.put('funilEtapas', UI.data.funilEtapas[index]);
                UI.data.funilEtapas = await Storage.getFunilEtapas();
                UI.renderFunil();
            },
            
            moveEtapaFunil: async (index, direcao) => {
                if (direcao === 'up' && index > 0) {
                    const temp = UI.data.funilEtapas[index];
                    UI.data.funilEtapas[index] = UI.data.funilEtapas[index - 1];
                    UI.data.funilEtapas[index - 1] = temp;
                } else if (direcao === 'down' && index < UI.data.funilEtapas.length - 1) {
                    const temp = UI.data.funilEtapas[index];
                    UI.data.funilEtapas[index] = UI.data.funilEtapas[index + 1];
                    UI.data.funilEtapas[index + 1] = temp;
                }
                
                UI.data.funilEtapas.forEach((etapa, idx) => {
                    etapa.ordem = idx + 1;
                });
                
                for (const etapa of UI.data.funilEtapas) {
                    await DB.put('funilEtapas', etapa);
                }
                
                UI.data.funilEtapas = await Storage.getFunilEtapas();
                UI.openFunilSettings();
                UI.renderFunil();
            },
            
            addEtapaFunil: async () => {
                const novaEtapa = {
                    id: `etapa-${Date.now()}`,
                    nome: 'Nova Etapa',
                    cor: '#6b7280',
                    ordem: UI.data.funilEtapas.length + 1
                };
                
                UI.data.funilEtapas.push(novaEtapa);
                await DB.put('funilEtapas', novaEtapa);
                UI.data.funilEtapas = await Storage.getFunilEtapas();
                UI.openFunilSettings();
                UI.renderFunil();
            },
            
            removeEtapaFunil: async (index) => {
                if (UI.data.funilEtapas.length <= 1) {
                    Utils.toast('O funil deve ter pelo menos uma etapa', 'error');
                    return;
                }
                
                const etapaRemovida = UI.data.funilEtapas[index];
                
                for (const cliente of UI.data.clientes) {
                    if (cliente.etapaFunil === etapaRemovida.id) {
                        cliente.etapaFunil = UI.data.funilEtapas[0].id;
                        await DB.put('clientes', cliente);
                    }
                }
                
                UI.data.funilEtapas.splice(index, 1);
                await DB.delete('funilEtapas', etapaRemovida.id);
                
                UI.data.funilEtapas = await Storage.getFunilEtapas();
                UI.data.clientes = await Storage.getClientes();
                
                UI.openFunilSettings();
                UI.renderFunil();
                UI.renderClientes();
                Utils.toast('Etapa removida! Clientes movidos para a primeira etapa.');
            },
            
            renderLinks: (filter = '') => {
                const container = document.getElementById('links-grid');
                if (!container) return;
                
                let links = UI.data.links;
                
                if (filter) {
                    const termo = filter.toLowerCase();
                    links = links.filter(link => 
                        link.titulo.toLowerCase().includes(termo) ||
                        link.descricao?.toLowerCase().includes(termo) ||
                        link.categoria?.toLowerCase().includes(termo) ||
                        link.url.toLowerCase().includes(termo)
                    );
                }
                
                if (links.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <i class="fas fa-link"></i>
                            <p>${filter ? 'Nenhum link encontrado' : 'Nenhum link salvo ainda'}</p>
                            ${!filter ? '<button class="btn-block" onclick="UI.openNewLink()" style="margin-top: 16px;">Adicionar Primeiro Link</button>' : ''}
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = links.map(link => {
                    const categoriaIcon = {
                        'construtora': 'building',
                        'documentos': 'file-contract',
                        'financiamento': 'hand-holding-usd',
                        'noticias': 'newspaper',
                        'ferramentas': 'tools',
                        'outros': 'link'
                    }[link.categoria] || 'link';
                    
                    return `
                        <div class="link-card" onclick="App.link.open('${link.id}')">
                            <div class="link-icon">
                                <i class="fas fa-${categoriaIcon}"></i>
                            </div>
                            <div class="link-title">${link.titulo}</div>
                            <div class="link-url">${link.url.replace(/^https?:\/\//, '').substring(0, 30)}...</div>
                            ${link.descricao ? `<div style="font-size: 0.8rem; color: var(--secondary); margin-top: 4px;">${link.descricao.substring(0, 50)}...</div>` : ''}
                            <div class="link-actions">
                                <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.link.edit('${link.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.link.copy('${link.id}')">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="btn-sm btn-light" style="color: var(--danger);" onclick="event.stopPropagation(); App.link.delete('${link.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            openNewLink: () => {
                const form = document.getElementById('form-link');
                if (!form) return;
                
                form.reset();
                document.getElementById('l-id').value = '';
                document.getElementById('title-link').innerText = 'Novo Link';
                UI.openModal('link');
            },

            createVisitaCard: (v) => {
                const cliente = UI.data.clientes.find(c => c.id === v.clienteId) || { nome: 'Cliente não encontrado' };
                const imovel = UI.data.imoveis.find(i => i.id === v.imovelId) || { titulo: 'Imóvel não especificado' };
                
                const isUrgent = v.status === 'agendado' && v.data === Utils.getToday();
                const tipoClass = v.tipo || 'visita';
                
                let additionalInfo = '';
                if(v.tipo === 'plantao' && v.detalhesPlantoes) {
                    additionalInfo = `<div class="plantoes-summary">${v.detalhesPlantoes.substring(0, 60)}${v.detalhesPlantoes.length > 60 ? '...' : ''}</div>`;
                } else if(v.tipo === 'reuniao-construtor' && v.construtorNome) {
                    additionalInfo = `<div class="schedule-notes">Com: ${v.construtorNome}</div>`;
                } else if(v.tipo === 'reuniao-equipe' && v.equipeTipo) {
                    additionalInfo = `<div class="schedule-notes">${v.equipeTipo}</div>`;
                } else if(v.tipo === 'generico' && v.genericoTitulo) {
                    additionalInfo = `<div class="schedule-notes">${v.genericoTitulo}</div>`;
                }
                
                return `
                    <div class="schedule-card ${tipoClass} ${isUrgent ? 'schedule-urgent' : ''}" onclick="App.agenda.edit('${v.id}')">
                        <div class="schedule-header">
                            <div class="schedule-type ${tipoClass}">${Utils.getTipoVisitaText(v.tipo)}</div>
                            <span class="badge ${v.status === 'realizado' ? 'badge-success' : v.status === 'cancelado' ? 'badge-danger' : v.status === 'confirmado' ? 'badge-cyan' : 'badge-primary'}">
                                ${Utils.getStatusVisitaText(v.status)}
                            </span>
                        </div>
                        <div class="schedule-time">
                            <i class="far fa-calendar"></i> ${Utils.formatDate(v.data)} <i class="far fa-clock"></i> ${v.horario}
                        </div>
                        <div class="schedule-title">
                            ${v.tipo === 'visita' ? cliente.nome : 
                              v.tipo === 'reuniao-construtor' ? (v.construtorNome || 'Reunião Construtor') :
                              v.tipo === 'reuniao-equipe' ? 'Reunião de Equipe' :
                              v.tipo === 'plantao' ? 'PLANTÃO' :
                              v.tipo === 'generico' ? (v.genericoTitulo || 'Agendamento Genérico') :
                              v.tipo === 'outro' ? (v.outroDescricao || 'Outro') :
                              'Agendamento'}
                        </div>
                        ${additionalInfo}
                        <div class="schedule-notes">
                            ${v.tipo === 'visita' ? `Visita: ${imovel.titulo.substring(0, 30)}...` : 
                             v.observacoes ? v.observacoes.substring(0, 50) + (v.observacoes.length > 50 ? '...' : '') : ''}
                        </div>
                    </div>
                `;
            },

            createNegociacaoCard: (i) => {
                const preco = i.precoVenda ? Utils.formatCurrency(i.precoVenda) : Utils.formatCurrency(i.precoAluguel) + '/mês';
                
                return `
                    <div class="property-card" onclick="UI.showImovelDetails('${i.id}')">
                        <div class="property-image">
                            ${i.imagens && i.imagens.length > 0 ? 
                                `<img src="${i.imagens[0]}" style="width:100%;height:100%;object-fit:cover; cursor: pointer;" onclick="event.stopPropagation(); UI.openFullscreen('${i.id}', 0)">` : 
                                `<i class="fas fa-home" style="font-size:3rem;"></i>`
                            }
                            <div class="property-badge badge-warning">RESERVADO</div>
                        </div>
                        <div class="property-content">
                            <div class="property-title">${i.titulo}</div>
                            <div class="property-address">
                                <i class="fas fa-map-marker-alt"></i> ${i.endereco.substring(0, 40)}...
                            </div>
                            <div class="property-price">${preco}</div>
                        </div>
                    </div>
                `;
            },

            renderClientes: (filter = '') => {
                const list = document.getElementById('clientes-list');
                if (!list) return;
                
                let filtered = UI.data.clientes;
                
                if(filter) {
                    const termo = filter.toLowerCase();
                    filtered = filtered.filter(c => 
                        c.nome.toLowerCase().includes(termo) ||
                        (c.email && c.email.toLowerCase().includes(termo)) ||
                        c.telefone.toLowerCase().includes(termo)
                    );
                }
                
                if(filtered.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-user-plus"></i><p>Nenhum cliente encontrado.</p></div>`;
                    return;
                }

                list.innerHTML = filtered.map(c => {
                    const hoje = new Date();
                    const nascimento = c.dataNascimento ? new Date(c.dataNascimento) : null;
                    const isAniversario = nascimento && 
                                         nascimento.getDate() === hoje.getDate() && 
                                         (nascimento.getMonth() + 1) === (hoje.getMonth() + 1);
                    
                    const idade = Utils.calculateAge(c.dataNascimento);
                    const imovelInteresse = c.imovelInteresseId ? 
                        UI.data.imoveis.find(i => i.id === c.imovelInteresseId) : null;
                    
                    const etapa = UI.data.funilEtapas.find(e => e.id === c.etapaFunil) || UI.data.funilEtapas[0];
                    
                    return `
                        <div class="client-card" onclick="App.cliente.edit('${c.id}')">
                            ${isAniversario ? `<div class="property-badge badge-pink" style="top: 12px; right: 12px; left: auto;">🎂</div>` : ''}
                            <div class="client-header">
                                <div class="client-name">${c.nome} ${idade ? `(${idade} anos)` : ''}</div>
                                <span class="client-type" style="background: ${etapa.cor}; color: white;">${etapa.nome}</span>
                            </div>
                            <div class="client-info">
                                <div class="client-row"><i class="fas fa-phone"></i> ${c.telefone}</div>
                                ${c.email ? `<div class="client-row"><i class="fas fa-envelope"></i> ${c.email}</div>` : ''}
                                ${c.dataNascimento ? `<div class="client-row"><i class="fas fa-birthday-cake"></i> ${Utils.formatDate(c.dataNascimento)}</div>` : ''}
                                ${imovelInteresse ? `<div class="client-row"><i class="fas fa-home"></i> Interesse: ${imovelInteresse.titulo.substring(0, 30)}...</div>` : ''}
                                ${c.faixaPreco ? `<div class="client-row"><i class="fas fa-search-dollar"></i> ${c.faixaPreco}</div>` : ''}
                                <div class="client-row"><i class="fas fa-filter"></i> Funil: ${etapa.nome} (${c.dataEntradaFunil ? Utils.calculateDaysInStage(c.dataEntradaFunil) : '0'} dias)</div>
                            </div>
                            <div class="client-actions">
                                <button class="btn-whatsapp-client" onclick="event.stopPropagation(); App.cliente.whatsappPersonalizado('${c.id}')">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </button>
                                <button class="btn-email-client" onclick="event.stopPropagation(); App.cliente.email('${c.id}')">
                                    <i class="fas fa-envelope"></i> Email
                                </button>
                                <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.cliente.edit('${c.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderImoveis: (filter = '', tipoFilter = '', statusFilter = '') => {
                const list = document.getElementById('imoveis-list');
                if (!list) return;
                
                let filtered = UI.data.imoveis;
                
                if(filter) {
                    const termo = filter.toLowerCase();
                    filtered = filtered.filter(i => 
                        i.titulo.toLowerCase().includes(termo) ||
                        i.endereco.toLowerCase().includes(termo) ||
                        (i.construtora && i.construtora.toLowerCase().includes(termo)) ||
                        (i.dataEntrega && Utils.formatDate(i.dataEntrega).toLowerCase().includes(termo)) ||
                        (i.dataEntrega && i.dataEntrega.toLowerCase().includes(termo))
                    );
                }
                
                if(tipoFilter) {
                    filtered = filtered.filter(i => i.tipo === tipoFilter);
                }
                
                if(statusFilter) {
                    filtered = filtered.filter(i => i.status === statusFilter);
                }
                
                filtered.sort((a,b) => new Date(b.dataCriacao) - new Date(a.dataCriacao));

                if(filtered.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-home"></i><p>Nenhum imóvel encontrado.</p></div>`;
                    return;
                }

                list.innerHTML = filtered.map(i => UI.createImovelCard(i)).join('');
            },

            filterImoveis: (tipo, status) => {
                const searchInput = document.querySelector('#imoveis-view .search-input');
                if (searchInput) {
                    UI.renderImoveis(searchInput.value, tipo, status);
                }
            },

            createImovelCard: (i) => {
                let badgeClass = 'badge-sale';
                let badgeText = 'VENDA';
                
                if(i.transacao === 'aluguel') {
                    badgeClass = 'badge-rent';
                    badgeText = 'ALUGUEL';
                } else if(i.transacao === 'ambos') {
                    badgeClass = 'badge-featured';
                    badgeText = 'VENDA/ALUG';
                }
                
                if(i.status === 'vendido' || i.status === 'alugado') {
                    badgeClass = 'badge-success';
                    badgeText = i.status === 'vendido' ? 'VENDIDO' : 'ALUGADO';
                } else if(i.status === 'reservado') {
                    badgeClass = 'badge-warning';
                    badgeText = 'RESERVADO';
                }
                
                const preco = i.precoVenda ? 
                    Utils.formatCurrency(i.precoVenda) : 
                    Utils.formatCurrency(i.precoAluguel) + ' <span class="period">/mês</span>';
                
                const mainImageClick = i.imagens && i.imagens.length > 0 ? 
                    `onclick="event.stopPropagation(); UI.openFullscreen('${i.id}', 0)"` : '';
                
                const dataEntregaInfo = i.dataEntrega ? 
                    `<div style="font-size: 0.75rem; color: var(--secondary); margin-top: 4px;">
                        <i class="far fa-calendar"></i> Entrega: ${Utils.formatDate(i.dataEntrega)}
                    </div>` : '';
                
                const hasVideos = i.videos && i.videos.length > 0;
                const videoBadge = hasVideos ? `<div class="property-badge" style="top: 40px; left: 12px; background: #8b5cf6;">🎥 VÍDEO</div>` : '';
                
                return `
                    <div class="property-card" onclick="UI.showImovelDetails('${i.id}')">
                        <div class="property-image">
                            ${i.imagens && i.imagens.length > 0 ? 
                                `<img src="${i.imagens[0]}" style="width:100%;height:100%;object-fit:cover; cursor: pointer;" ${mainImageClick}>` : 
                                `<i class="fas fa-home" style="font-size:3rem;"></i>`
                            }
                            <div class="property-badge ${badgeClass}">${badgeText}</div>
                            ${videoBadge}
                        </div>
                        <div class="property-content">
                            <div class="property-title">${i.titulo}</div>
                            <div class="property-address">
                                <i class="fas fa-map-marker-alt"></i> ${i.endereco.substring(0, 40)}...
                            </div>
                            <div class="property-features">
                                <div class="feature">
                                    <i class="fas fa-bed"></i>
                                    <span>${i.quartos || 0} quarto${i.quartos !== 1 ? 's' : ''}</span>
                                </div>
                                <div class="feature">
                                    <i class="fas fa-bath"></i>
                                    <span>${i.banheiros || 0} banheiro${i.banheiros !== 1 ? 's' : ''}</span>
                                </div>
                                <div class="feature">
                                    <i class="fas fa-car"></i>
                                    <span>${i.vagas || 0} vaga${i.vagas !== 1 ? 's' : ''}</span>
                                </div>
                                <div class="feature">
                                    <i class="fas fa-ruler-combined"></i>
                                    <span>${i.area || 0}m²</span>
                                </div>
                            </div>
                            ${dataEntregaInfo}
                            <div class="property-price">${preco}</div>
                            <div class="property-actions">
                                <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.imovel.edit('${i.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn-sm btn-primary-soft" onclick="event.stopPropagation(); UI.openNewVisitaFromImovel('${i.id}')">
                                    <i class="fas fa-calendar-plus"></i> Visita
                                </button>
                                <button class="btn-sm btn-whatsapp" onclick="event.stopPropagation(); App.whatsapp.shareImovel('${i.id}')">
                                    <i class="fab fa-whatsapp"></i> Compartilhar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            showImovelDetails: (id) => {
                const i = UI.data.imoveis.find(x => x.id === id);
                if(!i) return;
                
                let statusBadge = '';
                if(i.status === 'disponivel') statusBadge = `<span class="badge badge-success">DISPONÍVEL</span>`;
                if(i.status === 'reservado') statusBadge = `<span class="badge badge-warning">RESERVADO</span>`;
                if(i.status === 'vendido') statusBadge = `<span class="badge badge-primary">VENDIDO</span>`;
                if(i.status === 'alugado') statusBadge = `<span class="badge badge-primary">ALUGADO</span>`;
                
                const precoVenda = i.precoVenda ? Utils.formatCurrency(i.precoVenda) : '-';
                const precoAluguel = i.precoAluguel ? Utils.formatCurrency(i.precoAluguel) + '/mês' : '-';
                const condominio = i.condominio ? Utils.formatCurrency(i.condominio) + '/mês' : '-';
                const dataEntrega = i.dataEntrega ? Utils.formatDate(i.dataEntrega) : '-';
                const gasEncanado = i.gasEncanado === 'sim' ? 'Sim' : 'Não';
                
                let carouselHTML = '';
                if(i.imagens && i.imagens.length > 0) {
                    UI.currentCarouselImages = i.imagens;
                    UI.currentCarouselIndex = 0;
                    
                    carouselHTML = `
                        <div class="carousel-container">
                            ${i.imagens.map((img, index) => `
                                <img src="${img}" class="carousel-slide ${index === 0 ? 'active' : ''}" id="slide-${index}" onclick="UI.openFullscreen('${i.id}', ${index})">
                            `).join('')}
                            
                            ${i.imagens.length > 1 ? `
                                <button class="carousel-arrow prev" onclick="UI.prevSlide()">‹</button>
                                <button class="carousel-arrow next" onclick="UI.nextSlide()">›</button>
                                <div class="carousel-nav">
                                    ${i.imagens.map((_, index) => `
                                        <div class="carousel-dot ${index === 0 ? 'active' : ''}" onclick="UI.goToSlide(${index})"></div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                let videosHTML = '';
                if(i.videos && i.videos.length > 0) {
                    videosHTML = `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-video"></i> VÍDEOS DO IMÓVEL</div>
                            <div class="image-gallery">
                                ${i.videos.map((video, index) => {
                                    const thumbnail = Utils.generateVideoThumbnail(video.url);
                                    return `
                                        <div class="video-thumbnail" onclick="window.open('${video.url}', '_blank')">
                                            <i class="fas fa-play-circle"></i>
                                            <span>Vídeo ${index + 1}</span>
                                            <div class="video-url-display">${video.url.substring(0, 30)}...</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                
                const safeImovel = {
                    ...i,
                    titulo: i.titulo || '',
                    endereco: i.endereco || '',
                    tipo: i.tipo || '',
                    transacao: i.transacao || '',
                    status: i.status || '',
                    descricao: i.descricao || '',
                    precoVenda: i.precoVenda || 0,
                    precoAluguel: i.precoAluguel || 0,
                    condominio: i.condominio || 0,
                    area: i.area || 0,
                    quartos: i.quartos || 0,
                    banheiros: i.banheiros || 0,
                    vagas: i.vagas || 0,
                    gasEncanado: i.gasEncanado || 'nao',
                    dataEntrega: i.dataEntrega || '',
                    construtora: i.construtora || '',
                    formaPagamento: i.formaPagamento || '',
                    videos: i.videos || []
                };
                
                const detailsContent = `
                    <div class="details-card">
                        <div class="details-header">
                            <div class="details-title">${i.titulo}</div>
                            ${statusBadge}
                        </div>
                        
                        ${carouselHTML}
                        ${videosHTML}
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-money-bill-wave"></i> VALORES</div>
                            <div class="details-info-grid">
                                <div class="info-item">
                                    <div class="info-label">Preço de Venda</div>
                                    <div class="info-value">${precoVenda}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Preço de Aluguel</div>
                                    <div class="info-value">${precoAluguel}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Condomínio</div>
                                    <div class="info-value">${condominio}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Transação</div>
                                    <div class="info-value">${i.transacao === 'venda' ? 'Venda' : i.transacao === 'aluguel' ? 'Aluguel' : 'Venda/Aluguel'}</div>
                                </div>
                                ${i.dataVenda ? `
                                <div class="info-item">
                                    <div class="info-label">Data da Venda</div>
                                    <div class="info-value">${Utils.formatDate(i.dataVenda)}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-info-circle"></i> INFORMAÇÕES DO IMÓVEL</div>
                            <div class="details-info-grid">
                                <div class="info-item">
                                    <div class="info-label">Tipo</div>
                                    <div class="info-value">${Utils.getTipoText(i.tipo)}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Área</div>
                                    <div class="info-value">${i.area || 0}m²</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Quartos</div>
                                    <div class="info-value">${i.quartos || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Banheiros</div>
                                    <div class="info-value">${i.banheiros || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Vagas</div>
                                    <div class="info-value">${i.vagas || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Status</div>
                                    <div class="info-value">${Utils.getStatusText(i.status)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-building"></i> INFORMAÇÕES ADICIONAIS</div>
                            <div class="details-info-grid">
                                ${i.dataEntrega ? `
                                <div class="info-item">
                                    <div class="info-label">Data de Entrega</div>
                                    <div class="info-value">${dataEntrega}</div>
                                </div>
                                ` : ''}
                                ${i.construtora ? `
                                <div class="info-item">
                                    <div class="info-label">Construtora</div>
                                    <div class="info-value">${i.construtora}</div>
                                </div>
                                ` : ''}
                                ${i.formaPagamento ? `
                                <div class="info-item">
                                    <div class="info-label">Forma de Pagamento</div>
                                    <div class="info-value">${i.formaPagamento}</div>
                                </div>
                                ` : ''}
                                <div class="info-item">
                                    <div class="info-label">Gás Encanado</div>
                                    <div class="info-value">${gasEncanado}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-map-marker-alt"></i> LOCALIZAÇÃO</div>
                            <div class="info-item">
                                <div class="info-label">Endereço</div>
                                <div class="info-value">${i.endereco}</div>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-align-left"></i> DESCRIÇÃO</div>
                            <div class="info-item">
                                <div class="info-label">Detalhes</div>
                                <div class="info-value">${i.descricao || 'Sem descrição'}</div>
                            </div>
                        </div>
                        
                        ${i.observacoes ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-eye-slash"></i> OBSERVAÇÕES INTERNAS</div>
                            <div class="info-item">
                                <div class="info-label">Anotações</div>
                                <div class="info-value">${i.observacoes}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="warning-note">
                            <i class="fas fa-exclamation-triangle"></i> Os valores informados podem sofrer alteração sem aviso prévio.
                        </div>
                        
                        <div class="details-actions">
                            <button class="btn-details btn-details-primary" onclick="App.imovel.edit('${i.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-details btn-details-whatsapp" onclick="App.whatsapp.shareImovel('${i.id}')">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="btn-details btn-details-secondary" onclick="UI.openNewVisitaFromImovel('${i.id}')">
                                <i class="fas fa-calendar-plus"></i> Agendar Visita
                            </button>
                            <button class="btn-details btn-pdf" onclick="Utils.generatePDF(${JSON.stringify(safeImovel).replace(/"/g, '\"')})">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                    <button class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Fechar</button>
                `;
                
                document.getElementById('imovel-details-content').innerHTML = detailsContent;
                UI.openModal('imovel-details');
            },

            nextSlide: () => {
                if(UI.currentCarouselImages.length <= 1) return;
                UI.currentCarouselIndex = (UI.currentCarouselIndex + 1) % UI.currentCarouselImages.length;
                UI.updateCarousel();
            },

            prevSlide: () => {
                if(UI.currentCarouselImages.length <= 1) return;
                UI.currentCarouselIndex = (UI.currentCarouselIndex - 1 + UI.currentCarouselImages.length) % UI.currentCarouselImages.length;
                UI.updateCarousel();
            },

            goToSlide: (index) => {
                UI.currentCarouselIndex = index;
                UI.updateCarousel();
            },

            updateCarousel: () => {
                document.querySelectorAll('.carousel-slide').forEach((slide, index) => {
                    slide.classList.toggle('active', index === UI.currentCarouselIndex);
                });
                document.querySelectorAll('.carousel-dot').forEach((dot, index) => {
                    dot.classList.toggle('active', index === UI.currentCarouselIndex);
                });
            },

            openFullscreen: (imovelId, imageIndex) => {
                const imovel = UI.data.imoveis.find(x => x.id === imovelId);
                if(!imovel || !imovel.imagens || imovel.imagens.length === 0) return;
                
                UI.fullscreenImages = imovel.imagens;
                UI.fullscreenCurrentIndex = imageIndex;
                
                const fullscreenImage = document.getElementById('fullscreen-current-image');
                if (!fullscreenImage) return;
                
                fullscreenImage.src = UI.fullscreenImages[UI.fullscreenCurrentIndex];
                fullscreenImage.className = 'image-fullscreen';
                
                document.getElementById('fullscreen-counter').textContent = UI.fullscreenCurrentIndex + 1;
                document.getElementById('fullscreen-total').textContent = UI.fullscreenImages.length;
                
                const thumbnailsContainer = document.getElementById('fullscreen-thumbnails');
                if (thumbnailsContainer) {
                    thumbnailsContainer.innerHTML = '';
                    
                    UI.fullscreenImages.forEach((img, index) => {
                        const thumbnail = document.createElement('div');
                        thumbnail.className = `fullscreen-thumbnail ${index === UI.fullscreenCurrentIndex ? 'active' : ''}`;
                        thumbnail.onclick = () => UI.goToFullscreenImage(index);
                        
                        const thumbnailImg = document.createElement('img');
                        thumbnailImg.src = img;
                        thumbnail.appendChild(thumbnailImg);
                        
                        thumbnailsContainer.appendChild(thumbnail);
                    });
                }
                
                const viewer = document.getElementById('fullscreen-viewer');
                if (viewer) {
                    viewer.classList.add('active');
                }
            },

            closeFullscreen: () => {
                const viewer = document.getElementById('fullscreen-viewer');
                if (viewer) {
                    viewer.classList.remove('active');
                }
                UI.fullscreenImages = [];
                UI.fullscreenCurrentIndex = 0;
                
                const fullscreenImage = document.getElementById('fullscreen-current-image');
                if (fullscreenImage) {
                    fullscreenImage.className = 'fullscreen-image';
                }
            },

            nextFullscreenImage: () => {
                if(UI.fullscreenImages.length <= 1) return;
                UI.fullscreenCurrentIndex = (UI.fullscreenCurrentIndex + 1) % UI.fullscreenImages.length;
                UI.updateFullscreenViewer();
            },

            prevFullscreenImage: () => {
                if(UI.fullscreenImages.length <= 1) return;
                UI.fullscreenCurrentIndex = (UI.fullscreenCurrentIndex - 1 + UI.fullscreenImages.length) % UI.fullscreenImages.length;
                UI.updateFullscreenViewer();
            },

            goToFullscreenImage: (index) => {
                UI.fullscreenCurrentIndex = index;
                UI.updateFullscreenViewer();
            },

            updateFullscreenViewer: () => {
                const fullscreenImage = document.getElementById('fullscreen-current-image');
                if (!fullscreenImage) return;
                
                fullscreenImage.src = UI.fullscreenImages[UI.fullscreenCurrentIndex];
                fullscreenImage.className = 'image-fullscreen';
                
                const counter = document.getElementById('fullscreen-counter');
                if (counter) {
                    counter.textContent = UI.fullscreenCurrentIndex + 1;
                }
                
                document.querySelectorAll('.fullscreen-thumbnail').forEach((thumb, index) => {
                    thumb.classList.toggle('active', index === UI.fullscreenCurrentIndex);
                });
            },

            renderAgenda: (filterType = null) => {
                const list = document.getElementById('agenda-list');
                if (!list) return;
                
                const hoje = Utils.getToday();
                
                let visitasFiltradas = UI.data.visitas;
                if(filterType && filterType !== 'todos') {
                    visitasFiltradas = visitasFiltradas.filter(v => v.tipo === filterType);
                }
                
                const visitasFuturas = visitasFiltradas.filter(v => 
                    v.data >= hoje && v.status !== 'cancelado'
                ).sort((a,b) => {
                    if(a.data === b.data) return a.horario.localeCompare(b.horario);
                    return a.data.localeCompare(b.data);
                });
                
                if(visitasFuturas.length === 0) {
                    const filterText = filterType && filterType !== 'todos' ? ` de ${Utils.getTipoVisitaText(filterType).toLowerCase()}` : '';
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-calendar-alt"></i><p>Nenhum agendamento${filterText} encontrado!</p></div>`;
                    return;
                }

                const visitasPorData = {};
                visitasFuturas.forEach(v => {
                    if(!visitasPorData[v.data]) visitasPorData[v.data] = [];
                    visitasPorData[v.data].push(v);
                });

                let html = '';
                Object.keys(visitasPorData).sort().forEach(data => {
                    const dataFormatada = Utils.formatDate(data);
                    const isToday = Utils.isToday(data);
                    
                    html += `<div class="section-title" style="margin-top: 20px;">${dataFormatada} ${isToday ? '<span class="badge badge-primary">HOJE</span>' : ''}</div>`;
                    
                    visitasPorData[data].forEach(v => {
                        html += UI.createVisitaCard(v);
                    });
                });
                
                list.innerHTML = html;
            },

            filterAgenda: (type) => {
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.classList.remove('active');
                });
                
                const activeChip = document.querySelector(`.filter-chip[data-type="${type}"]`);
                if(activeChip) {
                    activeChip.classList.add('active');
                }
                
                UI.currentAgendaFilter = type;
                UI.renderAgenda(type === 'todos' ? null : type);
            },

            renderReport: () => {
                const container = document.getElementById('report-content');
                if (!container) return;
                
                if (!UI.currentReport) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-chart-line"></i>
                            <p>Selecione um período e tipo de relatório para gerar</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = UI.currentReport.html;
            },

            generateReport: () => {
                const startDate = document.getElementById('report-date-start').value;
                const endDate = document.getElementById('report-date-end').value;
                const reportType = document.getElementById('report-type').value;
                
                if (!startDate || !endDate) {
                    Utils.toast('Selecione um período válido', 'error');
                    return;
                }
                
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                if (start > end) {
                    Utils.toast('Data inicial não pode ser maior que data final', 'error');
                    return;
                }
                
                let reportData = null;
                
                switch(reportType) {
                    case 'clientes':
                        reportData = UI.generateClientReport(start, end);
                        break;
                    case 'agendamentos':
                        reportData = UI.generateAgendaReport(start, end);
                        break;
                    case 'vendas':
                        reportData = UI.generateSalesReport(start, end);
                        break;
                    case 'performance':
                        reportData = UI.generatePerformanceReport(start, end);
                        break;
                    case 'plantao':
                        reportData = UI.generatePlantaoReport(start);
                        break;
                }
                
                if (reportData) {
                    UI.currentReport = reportData;
                    UI.renderReport();
                    Utils.toast('Relatório gerado com sucesso!');
                }
            },
            
            generateClientReport: (start, end) => {
                const clientesFiltrados = UI.data.clientes.filter(cliente => {
                    const dataCriacao = new Date(cliente.dataCriacao);
                    return dataCriacao >= start && dataCriacao <= end;
                });
                
                const clientesPorData = {};
                clientesFiltrados.forEach(cliente => {
                    const data = cliente.dataCriacao.split('T')[0];
                    if (!clientesPorData[data]) {
                        clientesPorData[data] = [];
                    }
                    clientesPorData[data].push(cliente);
                });
                
                const datasOrdenadas = Object.keys(clientesPorData).sort();
                
                let html = `
                    <div class="report-summary">
                        <h3>Relatório de Clientes</h3>
                        <p><strong>Período:</strong> ${Utils.formatDate(start.toISOString().split('T')[0])} a ${Utils.formatDate(end.toISOString().split('T')[0])}</p>
                        <p><strong>Total de Clientes:</strong> ${clientesFiltrados.length}</p>
                        <p><strong>Dias com cadastros:</strong> ${datasOrdenadas.length}</p>
                    </div>
                `;
                
                if (datasOrdenadas.length > 0) {
                    html += `
                        <div class="section-title">Cadastros por Data</div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Novos Clientes</th>
                                    <th>Detalhes</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    datasOrdenadas.forEach(data => {
                        const clientesDoDia = clientesPorData[data];
                        const compradores = clientesDoDia.filter(c => c.tipo === 'comprador').length;
                        const vendedores = clientesDoDia.filter(c => c.tipo === 'vendedor').length;
                        const ambos = clientesDoDia.filter(c => c.tipo === 'ambos').length;
                        
                        html += `
                            <tr>
                                <td>${Utils.formatDate(data)}</td>
                                <td>${clientesDoDia.length}</td>
                                <td>Compradores: ${compradores} | Vendedores: ${vendedores} | Ambos: ${ambos}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                }
                
                const compradoresTotal = clientesFiltrados.filter(c => c.tipo === 'comprador').length;
                const vendedoresTotal = clientesFiltrados.filter(c => c.tipo === 'vendedor').length;
                const ambosTotal = clientesFiltrados.filter(c => c.tipo === 'ambos').length;
                
                html += `
                    <div class="section-title">Resumo Estatístico</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon bg-blue"><i class="fas fa-shopping-cart"></i></div>
                            <div class="stat-value">${compradoresTotal}</div>
                            <div class="stat-label">Compradores</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-green"><i class="fas fa-home"></i></div>
                            <div class="stat-value">${vendedoresTotal}</div>
                            <div class="stat-label">Vendedores</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-purple"><i class="fas fa-exchange-alt"></i></div>
                            <div class="stat-value">${ambosTotal}</div>
                            <div class="stat-label">Ambos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-cyan"><i class="fas fa-percentage"></i></div>
                            <div class="stat-value">${clientesFiltrados.length > 0 ? ((compradoresTotal / clientesFiltrados.length) * 100).toFixed(1) : 0}%</div>
                            <div class="stat-label">% Compradores</div>
                        </div>
                    </div>
                `;
                
                return {
                    html,
                    data: {
                        periodo: `${Utils.formatDate(start.toISOString().split('T')[0])} a ${Utils.formatDate(end.toISOString().split('T')[0])}`,
                        total: clientesFiltrados.length,
                        dados: datasOrdenadas.map(data => ({
                            data: Utils.formatDate(data),
                            total: clientesPorData[data].length,
                            compradores: clientesPorData[data].filter(c => c.tipo === 'comprador').length,
                            vendedores: clientesPorData[data].filter(c => c.tipo === 'vendedor').length,
                            ambos: clientesPorData[data].filter(c => c.tipo === 'ambos').length
                        })),
                        headers: ['Data', 'Total', 'Compradores', 'Vendedores', 'Ambos'],
                        resumo: {
                            'Total de Clientes': clientesFiltrados.length,
                            'Compradores': compradoresTotal,
                            'Vendedores': vendedoresTotal,
                            'Ambos': ambosTotal,
                            'Média por Dia': (clientesFiltrados.length / datasOrdenadas.length).toFixed(1)
                        }
                    },
                    type: 'clientes'
                };
            },
            
            generateAgendaReport: (start, end) => {
                const visitasFiltradas = UI.data.visitas.filter(visita => {
                    const dataVisita = new Date(visita.data);
                    return dataVisita >= start && dataVisita <= end;
                });
                
                const visitasPorTipo = {};
                const tipos = ['visita', 'reuniao-construtor', 'reuniao-equipe', 'documentacao', 'plantao', 'generico', 'outro'];
                
                tipos.forEach(tipo => {
                    visitasPorTipo[tipo] = visitasFiltradas.filter(v => v.tipo === tipo);
                });
                
                const visitasPorStatus = {
                    'agendado': visitasFiltradas.filter(v => v.status === 'agendado').length,
                    'confirmado': visitasFiltradas.filter(v => v.status === 'confirmado').length,
                    'realizado': visitasFiltradas.filter(v => v.status === 'realizado').length,
                    'cancelado': visitasFiltradas.filter(v => v.status === 'cancelado').length
                };
                
                let html = `
                    <div class="report-summary">
                        <h3>Relatório de Agendamentos</h3>
                        <p><strong>Período:</strong> ${Utils.formatDate(start.toISOString().split('T')[0])} a ${Utils.formatDate(end.toISOString().split('T')[0])}</p>
                        <p><strong>Total de Agendamentos:</strong> ${visitasFiltradas.length}</p>
                        <p><strong>Taxa de Realização:</strong> ${visitasFiltradas.length > 0 ? ((visitasPorStatus.realizado / visitasFiltradas.length) * 100).toFixed(1) : 0}%</p>
                    </div>
                `;
                
                html += `
                    <div class="section-title">Distribuição por Tipo</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--type-visita, 0.1); color: var(--type-visita);">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="stat-value">${visitasPorTipo.visita.length}</div>
                            <div class="stat-label">Visitas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--type-reuniao-construtor, 0.1); color: var(--type-reuniao-construtor);">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="stat-value">${visitasPorTipo['reuniao-construtor'].length}</div>
                            <div class="stat-label">Reuniões Construtor</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--type-reuniao-equipe, 0.1); color: var(--type-reuniao-equipe);">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-value">${visitasPorTipo['reuniao-equipe'].length}</div>
                            <div class="stat-label">Reuniões Equipe</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--type-plantao, 0.1); color: var(--type-plantao);">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-value">${visitasPorTipo.plantao.length}</div>
                            <div class="stat-label">Plantões</div>
                        </div>
                    </div>
                `;
                
                html += `
                    <div class="section-title">Distribuição por Status</div>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Quantidade</th>
                                <th>Porcentagem</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                Object.entries(visitasPorStatus).forEach(([status, quantidade]) => {
                    const porcentagem = visitasFiltradas.length > 0 ? ((quantidade / visitasFiltradas.length) * 100).toFixed(1) : 0;
                    html += `
                        <tr>
                            <td>${Utils.getStatusVisitaText(status)}</td>
                            <td>${quantidade}</td>
                            <td>${porcentagem}%</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                const ultimosAgendamentos = visitasFiltradas
                    .sort((a, b) => new Date(b.data) - new Date(a.data))
                    .slice(0, 10);
                
                if (ultimosAgendamentos.length > 0) {
                    html += `
                        <div class="section-title">Últimos Agendamentos</div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th>Cliente/Descrição</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    ultimosAgendamentos.forEach(visita => {
                        const cliente = UI.data.clientes.find(c => c.id === visita.clienteId);
                        html += `
                            <tr>
                                <td>${Utils.formatDate(visita.data)} ${visita.horario}</td>
                                <td>${Utils.getTipoVisitaText(visita.tipo)}</td>
                                <td><span class="badge ${visita.status === 'realizado' ? 'badge-success' : visita.status === 'cancelado' ? 'badge-danger' : visita.status === 'confirmado' ? 'badge-cyan' : 'badge-primary'}">${Utils.getStatusVisitaText(visita.status)}</span></td>
                                <td>${cliente ? cliente.nome : (visita.genericoTitulo || visita.outroDescricao || '-')}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                }
                
                return {
                    html,
                    data: {
                        periodo: `${Utils.formatDate(start.toISOString().split('T')[0])} a ${Utils.formatDate(end.toISOString().split('T')[0])}`,
                        total: visitasFiltradas.length,
                        dados: tipos.map(tipo => ({
                            tipo: Utils.getTipoVisitaText(tipo),
                            quantidade: visitasPorTipo[tipo].length,
                            porcentagem: visitasFiltradas.length > 0 ? ((visitasPorTipo[tipo].length / visitasFiltradas.length) * 100).toFixed(1) + '%' : '0%'
                        })),
                        headers: ['Tipo', 'Quantidade', 'Porcentagem'],
                        resumo: {
                            'Total de Agendamentos': visitasFiltradas.length,
                            'Visitas': visitasPorTipo.visita.length,
                            'Reuniões Construtor': visitasPorTipo['reuniao-construtor'].length,
                            'Plantões': visitasPorTipo.plantao.length,
                            'Taxa de Realização': visitasFiltradas.length > 0 ? ((visitasPorStatus.realizado / visitasFiltradas.length) * 100).toFixed(1) + '%' : '0%'
                        }
                    },
                    type: 'agendamentos'
                };
            },
            
            generateSalesReport: (start, end) => {
                const imoveisVendidos = UI.data.imoveis.filter(imovel => {
                    if (!imovel.dataVenda) return false;
                    const dataVenda = new Date(imovel.dataVenda);
                    return dataVenda >= start && dataVenda <= end && (imovel.status === 'vendido' || imovel.status === 'alugado');
                });
                
                const vendas = imoveisVendidos.filter(i => i.status === 'vendido');
                const alugueis = imoveisVendidos.filter(i => i.status === 'alugado');
                
                const totalVendas = vendas.reduce((acc, i) => acc + (i.precoVenda || 0), 0);
                const totalAlugueis = alugueis.reduce((acc, i) => acc + (i.precoAluguel || 0), 0);
                const totalGeral = totalVendas + totalAlugueis;
                
                const vendasPorTipo = {};
                imoveisVendidos.forEach(imovel => {
                    const tipo = imovel.tipo;
                    if (!vendasPorTipo[tipo]) {
                        vendasPorTipo[tipo] = { quantidade: 0, valor: 0 };
                    }
                    vendasPorTipo[tipo].quantidade++;
                    vendasPorTipo[tipo].valor += (imovel.precoVenda || imovel.precoAluguel || 0);
                });
                
                let html = `
                    <div class="report-summary">
                        <h3>Relatório de Vendas</h3>
                        <p><strong>Período:</strong> ${Utils.formatDate(start.toISOString().split('T')[0])} a ${Utils.formatDate(end.toISOString().split('T')[0])}</p>
                        <p><strong>Total de Transações:</strong> ${imoveisVendidos.length}</p>
                        <p><strong>Valor Total:</strong> ${Utils.formatCurrency(totalGeral)}</p>
                    </div>
                `;
                
                html += `
                    <div class="section-title">Resumo Financeiro</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon bg-green"><i class="fas fa-money-bill-wave"></i></div>
                            <div class="stat-value">${Utils.formatCurrency(totalVendas)}</div>
                            <div class="stat-label">Vendas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-blue"><i class="fas fa-hand-holding-usd"></i></div>
                            <div class="stat-value">${Utils.formatCurrency(totalAlugueis)}</div>
                            <div class="stat-label">Aluguéis</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-orange"><i class="fas fa-chart-pie"></i></div>
                            <div class="stat-value">${Utils.formatCurrency(totalGeral)}</div>
                            <div class="stat-label">Total Geral</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-purple"><i class="fas fa-bullseye"></i></div>
                            <div class="stat-value">${imoveisVendidos.length}</div>
                            <div class="stat-label">Transações</div>
                        </div>
                    </div>
                `;
                
                html += `
                    <div class="section-title">Vendas por Tipo de Imóvel</div>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>Valor Total</th>
                                <th>Valor Médio</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                Object.entries(vendasPorTipo).forEach(([tipo, dados]) => {
                    const valorMedio = dados.quantidade > 0 ? dados.valor / dados.quantidade : 0;
                    html += `
                        <tr>
                            <td>${Utils.getTipoText(tipo)}</td>
                            <td>${dados.quantidade}</td>
                            <td>${Utils.formatCurrency(dados.valor)}</td>
                            <td>${Utils.formatCurrency(valorMedio)}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                const ultimasVendas = imoveisVendidos
                    .sort((a, b) => new Date(b.dataVenda) - new Date(a.dataVenda))
                    .slice(0, 10);
                
                if (ultimasVendas.length > 0) {
                    html += `
                        <div class="section-title">Últimas Transações</div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Imóvel</th>
                                    <th>Tipo</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    ultimasVendas.forEach(imovel => {
                        html += `
                            <tr>
                                <td>${Utils.formatDate(imovel.dataVenda)}</td>
                                <td>${imovel.titulo.substring(0, 30)}...</td>
                                <td>${Utils.getTipoText(imovel.tipo)}</td>
                                <td>${Utils.formatCurrency(imovel.precoVenda || imovel.precoAluguel || 0)}</td>
                                <td><span class="badge ${imovel.status === 'vendido' ? 'badge-success' : 'badge-primary'}">${Utils.getStatusText(imovel.status)}</span></td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                }
                
                Storage.getSettings().then(settings => {
                    const taxaComissao = settings.comissao || 5;
                    const comissao = (totalGeral * taxaComissao) / 100;
                    
                    html += `
                        <div class="section-title">Projeção de Comissão</div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon bg-cyan"><i class="fas fa-percentage"></i></div>
                                <div class="stat-value">${taxaComissao}%</div>
                                <div class="stat-label">Taxa</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon bg-teal"><i class="fas fa-calculator"></i></div>
                                <div class="stat-value">${Utils.formatCurrency(comissao)}</div>
                                <div class="stat-label">Comissão</div>
                            </div>
                        </div>
                    `;
                });
                
                return {
                    html,
                    data: {
                        periodo: `${Utils.formatDate(start.toISOString().split('T')[0])} a ${Utils.formatDate(end.toISOString().split('T')[0])}`,
                        total: imoveisVendidos.length,
                        dados: Object.entries(vendasPorTipo).map(([tipo, dados]) => ({
                            tipo: Utils.getTipoText(tipo),
                            quantidade: dados.quantidade,
                            valor: Utils.formatCurrency(dados.valor),
                            valorMedio: Utils.formatCurrency(dados.quantidade > 0 ? dados.valor / dados.quantidade : 0)
                        })),
                        headers: ['Tipo', 'Quantidade', 'Valor Total', 'Valor Médio'],
                        resumo: {
                            'Total de Transações': imoveisVendidos.length,
                            'Vendas': Utils.formatCurrency(totalVendas),
                            'Aluguéis': Utils.formatCurrency(totalAlugueis),
                            'Total Geral': Utils.formatCurrency(totalGeral),
                            'Média por Transação': imoveisVendidos.length > 0 ? Utils.formatCurrency(totalGeral / imoveisVendidos.length) : 'R$ 0,00'
                        }
                    },
                    type: 'vendas'
                };
            },
            
            generatePerformanceReport: (start, end) => {
                const clientes = UI.data.clientes.filter(c => {
                    const dataCriacao = new Date(c.dataCriacao);
                    return dataCriacao >= start && dataCriacao <= end;
                }).length;
                
                const visitas = UI.data.visitas.filter(v => {
                    const dataVisita = new Date(v.data);
                    return dataVisita >= start && dataVisita <= end;
                }).length;
                
                const imoveisVendidos = UI.data.imoveis.filter(i => {
                    if (!i.dataVenda) return false;
                    const dataVenda = new Date(i.dataVenda);
                    return dataVenda >= start && dataVenda <= end && (i.status === 'vendido' || i.status === 'alugado');
                }).length;
                
                const imoveisCadastrados = UI.data.imoveis.filter(i => {
                    const dataCriacao = new Date(i.dataCriacao);
                    return dataCriacao >= start && dataCriacao <= end;
                }).length;
                
                const taxaConversao = clientes > 0 ? ((imoveisVendidos / clientes) * 100).toFixed(1) : 0;
                const taxaVisitas = clientes > 0 ? ((visitas / clientes) * 100).toFixed(1) : 0;
                
                let html = `
                    <div class="report-summary">
                        <h3>Relatório de Performance</h3>
                        <p><strong>Período:</strong> ${Utils.formatDate(start.toISOString().split('T')[0])} a ${Utils.formatDate(end.toISOString().split('T')[0])}</p>
                        <p><strong>Visão Geral:</strong> Análise completa do desempenho no período</p>
                    </div>
                `;
                
                html += `
                    <div class="section-title">KPIs Principais</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon bg-blue"><i class="fas fa-users"></i></div>
                            <div class="stat-value">${clientes}</div>
                            <div class="stat-label">Novos Clientes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-green"><i class="fas fa-calendar-alt"></i></div>
                            <div class="stat-value">${visitas}</div>
                            <div class="stat-label">Agendamentos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-orange"><i class="fas fa-home"></i></div>
                            <div class="stat-value">${imoveisCadastrados}</div>
                            <div class="stat-label">Imóveis Cadastrados</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-red"><i class="fas fa-handshake"></i></div>
                            <div class="stat-value">${imoveisVendidos}</div>
                            <div class="stat-label">Transações</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-purple"><i class="fas fa-percentage"></i></div>
                            <div class="stat-value">${taxaConversao}%</div>
                            <div class="stat-label">Conversão</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-cyan"><i class="fas fa-chart-line"></i></div>
                            <div class="stat-value">${taxaVisitas}%</div>
                            <div class="stat-label">Visitas/Cliente</div>
                        </div>
                    </div>
                `;
                
                const meses = [];
                const clientesPorMes = [];
                const visitasPorMes = [];
                const vendasPorMes = [];
                
                const dataAtual = new Date(start);
                while (dataAtual <= end) {
                    const mes = dataAtual.toLocaleString('pt-BR', { month: 'short' });
                    const ano = dataAtual.getFullYear();
                    const mesAno = `${mes}/${ano}`;
                    
                    const inicioMes = new Date(dataAtual.getFullYear(), dataAtual.getMonth(), 1);
                    const fimMes = new Date(dataAtual.getFullYear(), dataAtual.getMonth() + 1, 0);
                    
                    const clientesMes = UI.data.clientes.filter(c => {
                        const dataCriacao = new Date(c.dataCriacao);
                        return dataCriacao >= inicioMes && dataCriacao <= fimMes;
                    }).length;
                    
                    const visitasMes = UI.data.visitas.filter(v => {
                        const dataVisita = new Date(v.data);
                        return dataVisita >= inicioMes && dataVisita <= fimMes;
                    }).length;
                    
                    const vendasMes = UI.data.imoveis.filter(i => {
                        if (!i.dataVenda) return false;
                        const dataVenda = new Date(i.dataVenda);
                        return dataVenda >= inicioMes && dataVenda <= fimMes && (i.status === 'vendido' || i.status === 'alugado');
                    }).length;
                    
                    meses.push(mesAno);
                    clientesPorMes.push(clientesMes);
                    visitasPorMes.push(visitasMes);
                    vendasPorMes.push(vendasMes);
                    
                    dataAtual.setMonth(dataAtual.getMonth() + 1);
                }
                
                if (meses.length > 0) {
                    html += `
                        <div class="section-title">Evolução Mensal</div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Mês</th>
                                    <th>Clientes</th>
                                    <th>Agendamentos</th>
                                    <th>Transações</th>
                                    <th>Taxa Conversão</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    meses.forEach((mes, index) => {
                        const taxa = clientesPorMes[index] > 0 ? ((vendasPorMes[index] / clientesPorMes[index]) * 100).toFixed(1) : 0;
                        html += `
                            <tr>
                                <td>${mes}</td>
                                <td>${clientesPorMes[index]}</td>
                                <td>${visitasPorMes[index]}</td>
                                <td>${vendasPorMes[index]}</td>
                                <td>${taxa}%</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                }
                
                const mediaClientesPorMes = clientesPorMes.length > 0 ? 
                    (clientesPorMes.reduce((a, b) => a + b, 0) / clientesPorMes.length).toFixed(1) : 0;
                const mediaVendasPorMes = vendasPorMes.length > 0 ? 
                    (vendasPorMes.reduce((a, b) => a + b, 0) / vendasPorMes.length).toFixed(1) : 0;
                
                html += `
                    <div class="section-title">Análise e Recomendações</div>
                    <div class="report-summary">
                        <p><strong>Média Mensal:</strong> ${mediaClientesPorMes} clientes novos, ${mediaVendasPorMes} transações</p>
                        <p><strong>Taxa de Conversão:</strong> ${taxaConversao}% (${imoveisVendidos} transações / ${clientes} clientes)</p>
                        <p><strong>Eficiência de Visitas:</strong> ${(visitas / clientes).toFixed(1)} visitas por cliente</p>
                        ${taxaConversao < 10 ? '<p class="warning-note"><i class="fas fa-exclamation-triangle"></i> Taxa de conversão baixa. Considere melhorar o acompanhamento pós-visita.</p>' : ''}
                        ${mediaClientesPorMes < 5 ? '<p class="warning-note"><i class="fas fa-exclamation-triangle"></i> Captação de clientes abaixo do ideal. Considere aumentar ações de marketing.</p>' : ''}
                        ${(visitas / clientes) < 1.5 ? '<p class="warning-note"><i class="fas fa-exclamation-triangle"></i> Poucas visitas por cliente. Considere melhorar o processo de agendamento.</p>' : ''}
                    </div>
                `;
                
                return {
                    html,
                    data: {
                        periodo: `${Utils.formatDate(start.toISOString().split('T')[0])} a ${Utils.formatDate(end.toISOString().split('T')[0])}`,
                        total: clientes + visitas + imoveisVendidos + imoveisCadastrados,
                        dados: meses.map((mes, index) => ({
                            mes,
                            clientes: clientesPorMes[index],
                            visitas: visitasPorMes[index],
                            transacoes: vendasPorMes[index],
                            taxaConversao: clientesPorMes[index] > 0 ? ((vendasPorMes[index] / clientesPorMes[index]) * 100).toFixed(1) + '%' : '0%'
                        })),
                        headers: ['Mês', 'Clientes', 'Agendamentos', 'Transações', 'Taxa Conversão'],
                        resumo: {
                            'Clientes Novos': clientes,
                            'Agendamentos': visitas,
                            'Imóveis Cadastrados': imoveisCadastrados,
                            'Transações': imoveisVendidos,
                            'Taxa de Conversão': taxaConversao + '%',
                            'Média de Clientes/Mês': mediaClientesPorMes,
                            'Média de Vendas/Mês': mediaVendasPorMes
                        }
                    },
                    type: 'performance'
                };
            },
            
            generatePlantaoReport: (date) => {
                const selectedDateStr = date.toISOString().split('T')[0];
                
                const clientesPlantao = UI.data.clientes.filter(c => {
                    return c.dataCriacao && c.dataCriacao.startsWith(selectedDateStr);
                });

                let html = `
                    <div class="report-summary" style="border-left: 4px solid #7c3aed; background: #f3e8ff;">
                        <h3 style="color: #5b21b6;">📋 Relatório de Plantão</h3>
                        <p><strong>Data:</strong> ${Utils.formatDate(selectedDateStr)}</p>
                        <p><strong>Total de atendimentos:</strong> ${clientesPlantao.length}</p>
                    </div>
                    
                    <div class="section-title" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <span>Clientes Cadastrados</span>
                        <button class="btn-sm" style="background: #7c3aed; color: white;" onclick="Utils.generatePlantaoPDF('${selectedDateStr}')">
                            <i class="fas fa-file-pdf"></i> Baixar PDF
                        </button>
                    </div>
                `;

                if (clientesPlantao.length === 0) {
                    html += `<div class="empty-state"><i class="fas fa-user-clock"></i><p>Nenhum cliente cadastrado nesta data.</p></div>`;
                } else {
                    html += `<div style="display: flex; flex-direction: column; gap: 10px;">`;
                    
                    clientesPlantao.forEach(c => {
                        html += `
                            <div class="client-card" style="border-left: 4px solid ${Utils.getEtapaFunilColor(c.etapaFunil)}">
                                <div class="client-header">
                                    <div class="client-name">${c.nome}</div>
                                    <div style="display:flex; gap: 8px;">
                                        <button class="icon-btn" style="color: var(--primary);" title="Editar Observação" onclick="UI.editPlantaoObs('${c.id}')">
                                            <i class="fas fa-pen"></i>
                                        </button>
                                        <button class="icon-btn" style="color: var(--danger);" title="Excluir Cliente" onclick="UI.deletePlantaoClient('${c.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="client-info">
                                    <div class="client-row"><strong>Tel:</strong> ${c.telefone}</div>
                                    <div class="client-row"><strong>Interesse:</strong> ${c.faixaPreco || 'Não inf.'}</div>
                                    <div style="margin-top: 8px; background: #f8fafc; padding: 10px; border-radius: 6px; font-size: 0.9rem; border: 1px dashed #cbd5e1;">
                                        <strong>Observações:</strong><br>
                                        <span style="color: #334155;">${c.observacoes || '<em>Clique no lápis para adicionar observações...</em>'}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }

                return {
                    html: html,
                    type: 'plantao',
                    data: clientesPlantao
                };
            },

            editPlantaoObs: async (id) => {
                const cliente = UI.data.clientes.find(c => c.id === id);
                if (!cliente) return;

                const novaObs = prompt("Editar Observações para " + cliente.nome + ":", cliente.observacoes || "");
                
                if (novaObs !== null) {
                    cliente.observacoes = novaObs;
                    await DB.put('clientes', cliente);
                    
                    const dateInput = document.getElementById('report-date-start').value;
                    const parts = dateInput.split('-');
                    const dateObj = new Date(parts[0], parts[1]-1, parts[2]);
                    
                    const report = UI.generatePlantaoReport(dateObj);
                    UI.currentReport = report;
                    UI.renderReport();
                    Utils.toast("Observação atualizada!");
                }
            },

            deletePlantaoClient: async (id) => {
                if(confirm("Tem certeza que deseja excluir este cliente?")) {
                    UI.data.clientes = UI.data.clientes.filter(c => c.id !== id);
                    await DB.delete('clientes', id);
                    
                    const dateInput = document.getElementById('report-date-start').value;
                    const parts = dateInput.split('-');
                    const dateObj = new Date(parts[0], parts[1]-1, parts[2]);

                    const report = UI.generatePlantaoReport(dateObj);
                    UI.currentReport = report;
                    UI.renderReport(); 
                    
                    Utils.toast("Cliente removido.");
                }
            },

            exportReport: () => {
                if (!UI.currentReport) {
                    Utils.toast('Gere um relatório primeiro', 'error');
                    return;
                }
                
                Utils.generateReportPDF(UI.currentReport.data, UI.currentReport.type);
            },

            openModal: (type) => {
                const overlay = document.getElementById(`overlay-${type}`);
                if (overlay) {
                    overlay.classList.add('active');
                }
            },
            
            closeModals: () => {
                document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
            },

            openNewCliente: (fromVisita = false) => {
                const form = document.getElementById('form-cliente');
                if (!form) return;
                
                form.reset();
                document.getElementById('c-id').value = '';
                document.getElementById('title-cliente').innerText = 'Novo Cliente';
                
                const imovelSelect = document.getElementById('c-imovel-interesse');
                if (imovelSelect) {
                    imovelSelect.innerHTML = '<option value="">Selecione um imóvel...</option>';
                    UI.data.imoveis.forEach(i => {
                        imovelSelect.innerHTML += `<option value="${i.id}">${i.titulo.substring(0, 40)}...</option>`;
                    });
                }
                
                const etapaSelect = document.getElementById('c-etapa-funil');
                if (etapaSelect) {
                    etapaSelect.innerHTML = '';
                    UI.data.funilEtapas.sort((a, b) => a.ordem - b.ordem).forEach(etapa => {
                        etapaSelect.innerHTML += `<option value="${etapa.id}">${etapa.nome}</option>`;
                    });
                }
                
                UI.openModal('cliente');
            },

            openNewImovel: () => {
                const form = document.getElementById('form-imovel');
                if (!form) return;
                
                form.reset();
                document.getElementById('i-id').value = '';
                document.getElementById('title-imovel').innerText = 'Novo Imóvel';
                
                const gallery = document.getElementById('image-gallery');
                if (gallery) {
                    gallery.innerHTML = `
                        <div class="image-gallery-item add-image-btn" onclick="document.getElementById('i-imagem-input').click()">
                            <i class="fas fa-plus"></i>
                            <span>Adicionar Foto</span>
                        </div>
                    `;
                }
                
                document.getElementById('videos-list').innerHTML = '';
                document.getElementById('i-videos-data').value = '[]';
                document.getElementById('video-counter').innerText = '0';
                document.getElementById('i-video-url').value = '';
                
                document.getElementById('image-counter').innerText = '0';
                document.getElementById('i-imagens-data').value = '[]';
                
                UI.openModal('imovel');
            },

            openNewVisita: () => {
                const clienteSelect = document.getElementById('v-cliente');
                const imovelSelect = document.getElementById('v-imovel');
                
                if (clienteSelect) {
                    clienteSelect.innerHTML = '<option value="">Selecione...</option>';
                    UI.data.clientes.forEach(c => {
                        clienteSelect.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                    });
                }
                
                if (imovelSelect) {
                    imovelSelect.innerHTML = '<option value="">Selecione...</option>';
                    UI.data.imoveis.filter(i => i.status === 'disponivel').forEach(i => {
                        imovelSelect.innerHTML += `<option value="${i.id}">${i.titulo.substring(0, 30)}...</option>`;
                    });
                }
                
                const form = document.getElementById('form-visita');
                if (!form) return;
                
                form.reset();
                document.getElementById('v-id').value = '';
                document.getElementById('title-visita').innerText = 'Novo Agendamento';
                
                document.getElementById('v-data').value = Utils.getToday();
                document.getElementById('v-horario').value = Utils.getTodayTime();
                
                document.querySelectorAll('.tipo-specific-group').forEach(group => {
                    group.style.display = 'none';
                    group.querySelectorAll('input, textarea, select').forEach(input => {
                        input.value = '';
                    });
                });
                
                UI.toggleVisitaFields();
                
                UI.openModal('visita');
            },

            toggleVisitaFields: () => {
                const tipoSelect = document.getElementById('v-tipo');
                if (!tipoSelect) return;
                
                const tipo = tipoSelect.value;
                
                document.querySelectorAll('.tipo-specific-group').forEach(group => {
                    group.style.display = 'none';
                });
                
                const grupoId = `grupo-${tipo}`;
                const grupoEspecifico = document.getElementById(grupoId);
                if(grupoEspecifico) {
                    grupoEspecifico.style.display = 'block';
                }
                
                const tiposComCliente = ['visita', 'documentacao'];
                const tiposComImovel = ['visita'];
                
                document.querySelectorAll('.cliente-dependent-group').forEach(el => {
                    el.style.display = tiposComCliente.includes(tipo) ? 'block' : 'none';
                });
                
                document.querySelectorAll('.imovel-dependent-group').forEach(el => {
                    el.style.display = tiposComImovel.includes(tipo) ? 'block' : 'none';
                });
                
                const clienteField = document.getElementById('v-cliente');
                const imovelField = document.getElementById('v-imovel');
                
                if (clienteField) clienteField.required = tiposComCliente.includes(tipo);
                if (imovelField) imovelField.required = tiposComImovel.includes(tipo);
            },

            openNewVisitaFromImovel: (imovelId) => {
                UI.openNewVisita();
                setTimeout(() => {
                    const imovelSelect = document.getElementById('v-imovel');
                    const tipoSelect = document.getElementById('v-tipo');
                    
                    if (imovelSelect) imovelSelect.value = imovelId;
                    if (tipoSelect) {
                        tipoSelect.value = 'visita';
                        UI.toggleVisitaFields();
                    }
                }, 100);
            },

            openSettings: async () => {
                const s = await Storage.getSettings();
                document.getElementById('s-nome').value = s.nome || '';
                document.getElementById('s-creci').value = s.creci || '';
                document.getElementById('s-telefone').value = s.telefone || '';
                document.getElementById('s-email').value = s.email || '';
                document.getElementById('s-imobiliaria').value = s.imobiliaria || '';
                document.getElementById('s-comissao').value = s.comissao || 5;
                
                UI.openModal('settings');
            },

            toggleReportInputs: (type) => {
                const endInput = document.getElementById('report-date-end');
                if(type === 'plantao') {
                    endInput.style.display = 'none';
                    if(!document.getElementById('report-date-start').value) {
                        document.getElementById('report-date-start').value = Utils.getToday();
                    }
                } else {
                    endInput.style.display = 'block';
                }
            }

        };

        // Aplicação principal
        const App = {
            cliente: {
                save: async (e) => {
                    e.preventDefault();
                    const id = document.getElementById('c-id').value || Utils.id();
                    const nome = document.getElementById('c-nome').value;
                    const tipo = document.getElementById('c-tipo').value;
                    const etapaFunil = document.getElementById('c-etapa-funil').value || 'lead';
                    const telefone = document.getElementById('c-telefone').value;
                    const email = document.getElementById('c-email').value;
                    const imovelInteresseId = document.getElementById('c-imovel-interesse').value || null;
                    const dataNascimento = document.getElementById('c-data-nascimento').value || null;
                    const faixaPreco = document.getElementById('c-faixa-preco').value;
                    const observacoes = document.getElementById('c-observacoes').value;

                    const newClient = { 
                        id, nome, tipo, etapaFunil, telefone, email, 
                        imovelInteresseId, dataNascimento,
                        faixaPreco, observacoes,
                        dataCriacao: new Date().toISOString(),
                        dataEntradaFunil: new Date().toISOString().split('T')[0]
                    };
                    
                    const existingIdx = UI.data.clientes.findIndex(c => c.id === id);
                    if(existingIdx >= 0) {
                        if(UI.data.clientes[existingIdx].dataEntradaFunil && UI.data.clientes[existingIdx].etapaFunil === etapaFunil) {
                            newClient.dataEntradaFunil = UI.data.clientes[existingIdx].dataEntradaFunil;
                        }
                        UI.data.clientes[existingIdx] = newClient;
                        await DB.put('clientes', newClient);
                    } else {
                        UI.data.clientes.push(newClient);
                        await DB.add('clientes', newClient);
                    }

                    UI.data.clientes = await Storage.getClientes();
                    
                                        Utils.toast('Cliente salvo com sucesso!');
                    
                    UI.closeModals();
                    UI.renderClientes();
                    UI.renderDashboard();
                    UI.renderFunil();
                },
                
                edit: async (id) => {
                    const cliente = UI.data.clientes.find(x => x.id === id);
                    if(!cliente) return;
                    
                    document.getElementById('c-id').value = cliente.id;
                    document.getElementById('c-nome').value = cliente.nome || '';
                    document.getElementById('c-tipo').value = cliente.tipo || 'comprador';
                    document.getElementById('c-telefone').value = cliente.telefone || '';
                    document.getElementById('c-email').value = cliente.email || '';
                    document.getElementById('c-imovel-interesse').value = cliente.imovelInteresseId || '';
                    document.getElementById('c-data-nascimento').value = cliente.dataNascimento || '';
                    document.getElementById('c-faixa-preco').value = cliente.faixaPreco || '';
                    document.getElementById('c-observacoes').value = cliente.observacoes || '';
                    document.getElementById('title-cliente').innerText = 'Editar Cliente';
                    
                    const imovelSelect = document.getElementById('c-imovel-interesse');
                    if (imovelSelect) {
                        imovelSelect.innerHTML = '<option value="">Selecione um imóvel...</option>';
                        UI.data.imoveis.forEach(i => {
                            imovelSelect.innerHTML += `<option value="${i.id}">${i.titulo.substring(0, 40)}...</option>`;
                        });
                        imovelSelect.value = cliente.imovelInteresseId || '';
                    }
                    
                    const etapaSelect = document.getElementById('c-etapa-funil');
                    if (etapaSelect) {
                        etapaSelect.innerHTML = '';
                        UI.data.funilEtapas.sort((a, b) => a.ordem - b.ordem).forEach(etapa => {
                            etapaSelect.innerHTML += `<option value="${etapa.id}">${etapa.nome}</option>`;
                        });
                        etapaSelect.value = cliente.etapaFunil || 'lead';
                    }
                    
                    UI.openModal('cliente');
                },
                
                delete: async (id) => {
                    if(!confirm('Tem certeza que deseja excluir este cliente?')) return;
                    
                    UI.data.clientes = UI.data.clientes.filter(x => x.id !== id);
                    await DB.delete('clientes', id);
                    
                    Utils.toast('Cliente excluído');
                    UI.renderClientes();
                    UI.renderDashboard();
                    UI.renderFunil();
                },
                
                whatsappPersonalizado: async (clienteId) => {
    const cliente = UI.data.clientes.find(x => x.id === clienteId);
    if(!cliente) return;
    
    const settings = await Storage.getSettings();
    let message = '';
    
    const hour = new Date().getHours();
    let greeting = "Boa noite";
    if (hour >= 5 && hour < 12) greeting = "Bom dia";
    if (hour >= 12 && hour < 18) greeting = "Boa tarde";
    
    const clienteFirstName = cliente.nome.split(' ')[0];
    
    if (Utils.isBirthdayToday(cliente.dataNascimento)) {
        const idade = Utils.calculateAge(cliente.dataNascimento);
        message = `${greeting}, ${clienteFirstName}! 🎉🎂\n\n`;
        message += `Me chamo ${settings.nome || 'Alex Peixoto'} sou do time de vendas da  ${settings.imobiliaria || 'Resende'}.\n`;
        message += `Gostaria de parabenizá-lo pelos seus ${idade} anos! 🎊\n\n`;
        message += `Desejo muita saúde, felicidade e sucesso! ✨\n`;
        message += `Que este novo ano de vida seja repleto de conquistas! 🏆\n\n`;
        message += `Fico à disposição para ajudá-lo(a) na realização do sonho da casa própria! 🏠\n\n`;
        message += `📞 *Contato:* ${settings.telefone || '(82) 99662-2036'}\n`;
        message += `🏢 *Imobiliária:* ${settings.imobiliaria || 'Resende'}`;
    } else {
        const imovel = cliente.imovelInteresseId ? 
            UI.data.imoveis.find(i => i.id === cliente.imovelInteresseId) : null;
        
        message = await Utils.generateWhatsAppMessage(cliente, imovel);
    }
    
    // Limpar e formatar o número
    let phoneNumber = cliente.telefone.replace(/\D/g, '');
    
    // Remover o 0 no início se existir
    if (phoneNumber.startsWith('0')) {
        phoneNumber = phoneNumber.substring(1);
    }
    
    // Adicionar código do Brasil (55) se não tiver
    if (!phoneNumber.startsWith('55')) {
        phoneNumber = '55' + phoneNumber;
    }
    
    // Verificar se é dispositivo iOS
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    const encodedMessage = encodeURIComponent(message);
    
    // Para iOS, tentar abrir no app primeiro
    if (isIOS) {
        // Tentar abrir diretamente no app do WhatsApp
        const appUrl = `whatsapp://send?phone=${phoneNumber}&text=${encodedMessage}`;
        
        // Tentar abrir o app
        window.location.href = appUrl;
        
        // Se não abrir em 500ms, abrir na web
        setTimeout(() => {
            // Verificar se ainda estamos na mesma página (app não abriu)
            if (document.hasFocus()) {
                const webUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
                window.open(webUrl, '_blank');
            }
        }, 500);
    } else {
        // Para outros dispositivos
        const webUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
        window.open(webUrl, '_blank');
    }
},
                
                email: (clienteId) => {
                    const cliente = UI.data.clientes.find(x => x.id === clienteId);
                    if(!cliente || !cliente.email) {
                        Utils.toast('Cliente sem email', 'error');
                        return;
                    }
                    
                    const hour = new Date().getHours();
                    let greeting = "Boa noite";
                    if (hour >= 5 && hour < 12) greeting = "Bom dia";
                    if (hour >= 12 && hour < 18) greeting = "Boa tarde";
                    
                    const clienteFirstName = cliente.nome.split(' ')[0];
                    const imovel = cliente.imovelInteresseId ? 
                        UI.data.imoveis.find(i => i.id === cliente.imovelInteresseId) : null;
                    
                    let subject = `ImobiPro - ${imovel ? `Informações sobre ${imovel.titulo.substring(0, 30)}...` : 'Contato Imobiliário'}`;
                    let body = `${greeting}, ${clienteFirstName}!\n\n`;
                    
                    if (imovel) {
                        body += `Segue mais informações sobre o imóvel de seu interesse:\n\n`;
                        body += `*${imovel.titulo}*\n`;
                        body += `📍 ${imovel.endereco}\n`;
                        body += `🏠 Tipo: ${Utils.getTipoText(imovel.tipo)}\n`;
                        if (imovel.area) body += `📐 Área: ${imovel.area}m²\n`;
                        if (imovel.quartos) body += `🛏️ Quartos: ${imovel.quartos}\n`;
                        if (imovel.banheiros) body += `🛁 Banheiros: ${imovel.banheiros}\n`;
                        if (imovel.vagas) body += `🚗 Vagas: ${imovel.vagas}\n`;
                        if (imovel.gasEncanado === 'sim') body += `🔥 Gás Encanado: Sim\n`;
                        if (imovel.condominio) body += `💰 Condomínio: ${Utils.formatCurrency(imovel.condominio)}/mês\n\n`;
                        
                        if (imovel.precoVenda) {
                            body += `💰 *Preço de Venda:* ${Utils.formatCurrency(imovel.precoVenda)}\n`;
                        } else if (imovel.precoAluguel) {
                            body += `💰 *Preço de Aluguel:* ${Utils.formatCurrency(imovel.precoAluguel)}/mês\n`;
                        }
                        
                        if (imovel.dataEntrega) {
                            body += `\n📅 *Data de Entrega:* ${Utils.formatDate(imovel.dataEntrega)}\n`;
                        }
                        
                        if (imovel.construtora) {
                            body += `\n🏗️ *Construtora:* ${imovel.construtora}\n`;
                        }
                        
                        if (imovel.descricao) {
                            body += `\n📝 *Descrição:*\n${imovel.descricao}\n`;
                        }
                        
                        if (imovel.videos && imovel.videos.length > 0) {
                            body += `\n🎥 *Vídeos disponíveis:*\n`;
                            imovel.videos.forEach((video, index) => {
                                body += `• Vídeo ${index + 1}: ${video.url}\n`;
                            });
                        }
                    } else {
                        body += `Gostaria de agendar uma conversa para entendermos melhor suas necessidades e apresentar algumas opções de imóveis que podem te interessar.\n\n`;
                    }
                    
                    const settings = Storage.getSettings();
                    body += `\n📞 *Contato:* ${settings.telefone || '(82) 99662-2036'}\n`;
                    body += `🏢 *Imobiliária:* ${settings.imobiliaria || 'Resende'}\n`;
                    body += `👨‍💼 *Corretor:* ${settings.nome || 'Alex Peixoto'}\n`;
                    body += `📋 *CRECI:* ${settings.creci || '5794-AL'}`;
                    
                    const mailtoLink = `mailto:${cliente.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    window.location.href = mailtoLink;
                }
            },
            
            imovel: {
                save: async (e) => {
                    e.preventDefault();
                    
                    try {
                        const id = document.getElementById('i-id').value || Utils.id();
                        const titulo = document.getElementById('i-titulo').value;
                        const tipo = document.getElementById('i-tipo').value;
                        const transacao = document.getElementById('i-transacao').value;
                        const precoVenda = document.getElementById('i-preco-venda').value ? Utils.parseCurrency(document.getElementById('i-preco-venda').value) : 0;
                        const precoAluguel = document.getElementById('i-preco-aluguel').value ? Utils.parseCurrency(document.getElementById('i-preco-aluguel').value) : 0;
                        const endereco = document.getElementById('i-endereco').value;
                        const area = parseFloat(document.getElementById('i-area').value) || 0;
                        const quartos = parseInt(document.getElementById('i-quartos').value) || 0;
                        const banheiros = parseInt(document.getElementById('i-banheiros').value) || 0;
                        const vagas = parseInt(document.getElementById('i-vagas').value) || 0;
                        const status = document.getElementById('i-status').value;
                        const gasEncanado = document.getElementById('i-gas-encanado').value;
                        const condominio = document.getElementById('i-condominio').value ? Utils.parseCurrency(document.getElementById('i-condominio').value) : 0;
                        const descricao = document.getElementById('i-descricao').value;
                        const observacoes = document.getElementById('i-observacoes').value;
                        const construtora = document.getElementById('i-construtora').value;
                        const formaPagamento = document.getElementById('i-forma-pagamento').value;
                        const dataEntrega = document.getElementById('i-data-entrega').value;
                        
                        const imagensData = document.getElementById('i-imagens-data').value;
                        const imagens = imagensData ? JSON.parse(imagensData) : [];
                        
                        const videosData = document.getElementById('i-videos-data').value;
                        const videos = videosData ? JSON.parse(videosData) : [];
                        
                        const newImovel = {
                            id,
                            titulo,
                            tipo,
                            transacao,
                            precoVenda,
                            precoAluguel,
                            endereco,
                            area,
                            quartos,
                            banheiros,
                            vagas,
                            status,
                            gasEncanado,
                            condominio,
                            descricao,
                            observacoes,
                            construtora,
                            formaPagamento,
                            dataEntrega,
                            imagens,
                            videos,
                            dataCriacao: new Date().toISOString(),
                            dataAtualizacao: new Date().toISOString()
                        };
                        
                        if (status === 'vendido' || status === 'alugado') {
                            newImovel.dataVenda = new Date().toISOString().split('T')[0];
                        }
                        
                        const existingIdx = UI.data.imoveis.findIndex(i => i.id === id);
                        if (existingIdx >= 0) {
                            UI.data.imoveis[existingIdx] = newImovel;
                            await DB.put('imoveis', newImovel);
                        } else {
                            UI.data.imoveis.push(newImovel);
                            await DB.add('imoveis', newImovel);
                        }
                        
                        UI.data.imoveis = await Storage.getImoveis();
                        
                        Utils.toast('Imóvel salvo com sucesso!');
                        
                        UI.closeModals();
                        UI.renderImoveis();
                        UI.renderDashboard();
                        
                    } catch (error) {
                        console.error('Erro ao salvar imóvel:', error);
                        Utils.toast('Erro ao salvar imóvel', 'error');
                    }
                },
                
                edit: async (id) => {
                    try {
                        const imovel = UI.data.imoveis.find(x => x.id === id);
                        if (!imovel) return;
                        
                        document.getElementById('i-id').value = imovel.id;
                        document.getElementById('i-titulo').value = imovel.titulo || '';
                        document.getElementById('i-tipo').value = imovel.tipo || 'apartamento';
                        document.getElementById('i-transacao').value = imovel.transacao || 'venda';
                        document.getElementById('i-preco-venda').value = imovel.precoVenda ? imovel.precoVenda.toString() : '';
                        document.getElementById('i-preco-aluguel').value = imovel.precoAluguel ? imovel.precoAluguel.toString() : '';
                        document.getElementById('i-endereco').value = imovel.endereco || '';
                        document.getElementById('i-area').value = imovel.area || '';
                        document.getElementById('i-quartos').value = imovel.quartos || '';
                        document.getElementById('i-banheiros').value = imovel.banheiros || '';
                        document.getElementById('i-vagas').value = imovel.vagas || '';
                        document.getElementById('i-status').value = imovel.status || 'disponivel';
                        document.getElementById('i-gas-encanado').value = imovel.gasEncanado || 'nao';
                        document.getElementById('i-condominio').value = imovel.condominio ? imovel.condominio.toString() : '';
                        document.getElementById('i-descricao').value = imovel.descricao || '';
                        document.getElementById('i-observacoes').value = imovel.observacoes || '';
                        document.getElementById('i-construtora').value = imovel.construtora || '';
                        document.getElementById('i-forma-pagamento').value = imovel.formaPagamento || '';
                        document.getElementById('i-data-entrega').value = imovel.dataEntrega || '';
                        
                        document.getElementById('title-imovel').innerText = 'Editar Imóvel';
                        
                        const imagens = imovel.imagens || [];
                        document.getElementById('i-imagens-data').value = JSON.stringify(imagens);
                        document.getElementById('image-counter').innerText = imagens.length;
                        
                        App.imovel.renderImageGallery(imagens);
                        
                        const videos = imovel.videos || [];
                        document.getElementById('i-videos-data').value = JSON.stringify(videos);
                        document.getElementById('video-counter').innerText = videos.length;
                        
                        App.imovel.renderVideoList(videos);
                        
                        App.imovel.toggleAluguelFields();
                        
                        UI.openModal('imovel');
                        
                    } catch (error) {
                        console.error('Erro ao editar imóvel:', error);
                        Utils.toast('Erro ao carregar imóvel', 'error');
                    }
                },
                
                toggleAluguelFields: () => {
                    const transacao = document.getElementById('i-transacao').value;
                    const aluguelGroup = document.getElementById('i-aluguel-group');
                    
                    if (transacao === 'aluguel' || transacao === 'ambos') {
                        aluguelGroup.style.display = 'block';
                    } else {
                        aluguelGroup.style.display = 'none';
                    }
                },
                
                handleMultipleImages: async function(input) {
                    const files = Array.from(input.files || []);
                    if (files.length === 0) return;
                    
                    const existingImages = JSON.parse(document.getElementById('i-imagens-data').value || '[]');
                    const remainingSlots = 15 - existingImages.length;
                    
                    if (files.length > remainingSlots) {
                        Utils.toast(`Máximo de 15 imagens. Você pode adicionar mais ${remainingSlots} imagens.`, 'error');
                        return;
                    }
                    
                    try {
                        const newImages = [];
                        
                        for (const file of files) {
                            if (file.size > 10 * 1024 * 1024) {
                                Utils.toast(`Imagem ${file.name} muito grande. Máximo 10MB.`, 'error');
                                continue;
                            }
                            
                            try {
                                const base64 = await Utils.readImage(file);
                                const compressed = await Utils.compressImage(base64, 0.7, 1200);
                                newImages.push(compressed);
                            } catch (error) {
                                console.error('Erro ao processar imagem:', error);
                                Utils.toast(`Erro ao processar ${file.name}`, 'error');
                            }
                        }
                        
                        const allImages = [...existingImages, ...newImages];
                        document.getElementById('i-imagens-data').value = JSON.stringify(allImages);
                        document.getElementById('image-counter').innerText = allImages.length;
                        
                        App.imovel.renderImageGallery(allImages);
                        
                        input.value = '';
                        
                    } catch (error) {
                        console.error('Erro ao processar imagens:', error);
                        Utils.toast('Erro ao processar imagens', 'error');
                    }
                },
                
                renderImageGallery: function(images) {
                    const gallery = document.getElementById('image-gallery');
                    if (!gallery) return;
                    
                    let html = '';
                    
                    images.forEach((img, index) => {
                        html += `
                            <div class="image-gallery-item">
                                <img src="${img}" class="image-gallery-img" onclick="event.stopPropagation(); UI.openFullscreenFromGallery(${index})">
                                <button class="remove-image-btn" onclick="event.stopPropagation(); App.imovel.removeImage(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                    });
                    
                    if (images.length < 15) {
                        html += `
                            <div class="image-gallery-item add-image-btn" onclick="document.getElementById('i-imagem-input').click()">
                                <i class="fas fa-plus"></i>
                                <span>Adicionar Foto</span>
                            </div>
                        `;
                    }
                    
                    gallery.innerHTML = html;
                },
                
                removeImage: function(index) {
                    const images = JSON.parse(document.getElementById('i-imagens-data').value || '[]');
                    images.splice(index, 1);
                    
                    document.getElementById('i-imagens-data').value = JSON.stringify(images);
                    document.getElementById('image-counter').innerText = images.length;
                    
                    App.imovel.renderImageGallery(images);
                },
                
                addVideo: function() {
                    const urlInput = document.getElementById('i-video-url');
                    const url = urlInput.value.trim();
                    
                    if (!url) {
                        Utils.toast('Digite uma URL válida', 'error');
                        return;
                    }
                    
                    if (!Utils.isValidVideoUrl(url)) {
                        Utils.toast('URL inválida. Use YouTube ou Vimeo.', 'error');
                        return;
                    }
                    
                    const videos = JSON.parse(document.getElementById('i-videos-data').value || '[]');
                    
                    if (videos.length >= 5) {
                        Utils.toast('Máximo de 5 vídeos por imóvel', 'error');
                        return;
                    }
                    
                    if (videos.some(v => v.url === url)) {
                        Utils.toast('Vídeo já adicionado', 'error');
                        return;
                    }
                    
                    videos.push({ url, dateAdded: new Date().toISOString() });
                    
                    document.getElementById('i-videos-data').value = JSON.stringify(videos);
                    document.getElementById('video-counter').innerText = videos.length;
                    
                    App.imovel.renderVideoList(videos);
                    
                    urlInput.value = '';
                },
                
                renderVideoList: function(videos) {
                    const container = document.getElementById('videos-list');
                    if (!container) return;
                    
                    let html = '';
                    
                    videos.forEach((video, index) => {
                        const thumbnail = Utils.generateVideoThumbnail(video.url);
                        html += `
                            <div class="form-group" style="border: 1px solid var(--border); padding: 10px; border-radius: 8px; margin-top: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    ${thumbnail ? `
                                        <img src="${thumbnail}" style="width: 60px; height: 40px; border-radius: 4px; object-fit: cover;">
                                    ` : `
                                        <div style="width: 60px; height: 40px; background: #f1f5f9; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-video" style="color: var(--secondary);"></i>
                                        </div>
                                    `}
                                    <div style="flex: 1; font-size: 0.8rem;">
                                        <div style="word-break: break-all;">${video.url.substring(0, 50)}...</div>
                                        <button class="btn-sm" style="color: var(--danger); padding: 4px 8px; margin-top: 4px;" onclick="App.imovel.removeVideo(${index})">
                                            <i class="fas fa-trash"></i> Remover
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                },
                
                removeVideo: function(index) {
                    const videos = JSON.parse(document.getElementById('i-videos-data').value || '[]');
                    videos.splice(index, 1);
                    
                    document.getElementById('i-videos-data').value = JSON.stringify(videos);
                    document.getElementById('video-counter').innerText = videos.length;
                    
                    App.imovel.renderVideoList(videos);
                },
                
                delete: async (id) => {
                    if(!confirm('Tem certeza que deseja excluir este imóvel? Esta ação não pode ser desfeita.')) return;
                    
                    UI.data.imoveis = UI.data.imoveis.filter(x => x.id !== id);
                    await DB.delete('imoveis', id);
                    
                    Utils.toast('Imóvel excluído');
                    UI.renderImoveis();
                    UI.renderDashboard();
                }
            },
            
            agenda: {
                save: async (e) => {
                    e.preventDefault();
                    
                    try {
                        const id = document.getElementById('v-id').value || Utils.id();
                        const tipo = document.getElementById('v-tipo').value;
                        const clienteId = document.getElementById('v-cliente').value;
                        const imovelId = document.getElementById('v-imovel').value;
                        const data = document.getElementById('v-data').value;
                        const horario = document.getElementById('v-horario').value;
                        const observacoes = document.getElementById('v-observacoes').value;
                        const status = document.getElementById('v-status').value;
                        
                        const newVisita = {
                            id,
                            tipo,
                            clienteId: clienteId || null,
                            imovelId: imovelId || null,
                            data,
                            horario,
                            observacoes,
                            status,
                            dataCriacao: new Date().toISOString()
                        };
                        
                        if (tipo === 'visita') {
                            newVisita.localVisita = document.getElementById('v-local-visita').value;
                        } else if (tipo === 'reuniao-construtor') {
                            newVisita.construtorNome = document.getElementById('v-construtor-nome').value;
                            newVisita.construtorEmpreendimento = document.getElementById('v-construtor-empreendimento').value;
                            newVisita.construtorAssuntos = document.getElementById('v-construtor-assuntos').value;
                        } else if (tipo === 'reuniao-equipe') {
                            newVisita.equipeTipo = document.getElementById('v-equipe-tipo').value;
                            newVisita.equipeParticipantes = document.getElementById('v-equipe-participantes').value;
                            newVisita.equipeAssuntos = document.getElementById('v-equipe-assuntos').value;
                        } else if (tipo === 'documentacao') {
                            newVisita.documentacaoTipo = document.getElementById('v-documentacao-tipo').value;
                            newVisita.documentacaoLocal = document.getElementById('v-documentacao-local').value;
                        } else if (tipo === 'plantao') {
                            newVisita.plantaoLocal = document.getElementById('v-plantao-local').value;
                            newVisita.detalhesPlantoes = document.getElementById('v-detalhes-plantoes').value;
                            newVisita.clientesAtendidos = document.getElementById('v-clientes-atendidos').value;
                            newVisita.negociosGerados = document.getElementById('v-negocios-gerados').value;
                        } else if (tipo === 'generico') {
                            newVisita.genericoTitulo = document.getElementById('v-generico-titulo').value;
                            newVisita.genericoLocal = document.getElementById('v-generico-local').value;
                            newVisita.genericoDescricao = document.getElementById('v-generico-descricao').value;
                        } else if (tipo === 'outro') {
                            newVisita.outroDescricao = document.getElementById('v-outro-descricao').value;
                            newVisita.outroDetalhes = document.getElementById('v-outro-detalhes').value;
                        }
                        
                        const existingIdx = UI.data.visitas.findIndex(v => v.id === id);
                        if (existingIdx >= 0) {
                            UI.data.visitas[existingIdx] = newVisita;
                            await DB.put('visitas', newVisita);
                        } else {
                            UI.data.visitas.push(newVisita);
                            await DB.add('visitas', newVisita);
                        }
                        
                        UI.data.visitas = await Storage.getVisitas();
                        
                        Utils.toast('Agendamento salvo com sucesso!');
                        
                        UI.closeModals();
                        UI.renderAgenda();
                        UI.renderDashboard();
                        
                    } catch (error) {
                        console.error('Erro ao salvar agendamento:', error);
                        Utils.toast('Erro ao salvar agendamento', 'error');
                    }
                },
                
                edit: async (id) => {
                    try {
                        const visita = UI.data.visitas.find(x => x.id === id);
                        if (!visita) return;
                        
                        document.getElementById('v-id').value = visita.id;
                        document.getElementById('v-tipo').value = visita.tipo || 'visita';
                        document.getElementById('v-cliente').value = visita.clienteId || '';
                        document.getElementById('v-imovel').value = visita.imovelId || '';
                        document.getElementById('v-data').value = visita.data || '';
                        document.getElementById('v-horario').value = visita.horario || '';
                        document.getElementById('v-observacoes').value = visita.observacoes || '';
                        document.getElementById('v-status').value = visita.status || 'agendado';
                        
                        document.getElementById('title-visita').innerText = 'Editar Agendamento';
                        
                        const clienteSelect = document.getElementById('v-cliente');
                        const imovelSelect = document.getElementById('v-imovel');
                        
                        if (clienteSelect) {
                            clienteSelect.innerHTML = '<option value="">Selecione...</option>';
                            UI.data.clientes.forEach(c => {
                                clienteSelect.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                            });
                            clienteSelect.value = visita.clienteId || '';
                        }
                        
                        if (imovelSelect) {
                            imovelSelect.innerHTML = '<option value="">Selecione...</option>';
                            UI.data.imoveis.forEach(i => {
                                imovelSelect.innerHTML += `<option value="${i.id}">${i.titulo.substring(0, 30)}...</option>`;
                            });
                            imovelSelect.value = visita.imovelId || '';
                        }
                        
                        document.querySelectorAll('.tipo-specific-group').forEach(group => {
                            group.style.display = 'none';
                        });
                        
                        const tipo = visita.tipo || 'visita';
                        const grupoId = `grupo-${tipo}`;
                        const grupoEspecifico = document.getElementById(grupoId);
                        if (grupoEspecifico) {
                            grupoEspecifico.style.display = 'block';
                            
                            if (tipo === 'visita') {
                                document.getElementById('v-local-visita').value = visita.localVisita || '';
                            } else if (tipo === 'reuniao-construtor') {
                                document.getElementById('v-construtor-nome').value = visita.construtorNome || '';
                                document.getElementById('v-construtor-empreendimento').value = visita.construtorEmpreendimento || '';
                                document.getElementById('v-construtor-assuntos').value = visita.construtorAssuntos || '';
                            } else if (tipo === 'reuniao-equipe') {
                                document.getElementById('v-equipe-tipo').value = visita.equipeTipo || '';
                                document.getElementById('v-equipe-participantes').value = visita.equipeParticipantes || '';
                                document.getElementById('v-equipe-assuntos').value = visita.equipeAssuntos || '';
                            } else if (tipo === 'documentacao') {
                                document.getElementById('v-documentacao-tipo').value = visita.documentacaoTipo || '';
                                document.getElementById('v-documentacao-local').value = visita.documentacaoLocal || '';
                            } else if (tipo === 'plantao') {
                                document.getElementById('v-plantao-local').value = visita.plantaoLocal || '';
                                document.getElementById('v-detalhes-plantoes').value = visita.detalhesPlantoes || '';
                                document.getElementById('v-clientes-atendidos').value = visita.clientesAtendidos || '';
                                document.getElementById('v-negocios-gerados').value = visita.negociosGerados || '';
                            } else if (tipo === 'generico') {
                                document.getElementById('v-generico-titulo').value = visita.genericoTitulo || '';
                                document.getElementById('v-generico-local').value = visita.genericoLocal || '';
                                document.getElementById('v-generico-descricao').value = visita.genericoDescricao || '';
                            } else if (tipo === 'outro') {
                                document.getElementById('v-outro-descricao').value = visita.outroDescricao || '';
                                document.getElementById('v-outro-detalhes').value = visita.outroDetalhes || '';
                            }
                        }
                        
                        UI.toggleVisitaFields();
                        
                        UI.openModal('visita');
                        
                    } catch (error) {
                        console.error('Erro ao editar agendamento:', error);
                        Utils.toast('Erro ao carregar agendamento', 'error');
                    }
                },
                
                delete: async (id) => {
                    if(!confirm('Tem certeza que deseja excluir este agendamento?')) return;
                    
                    UI.data.visitas = UI.data.visitas.filter(x => x.id !== id);
                    await DB.delete('visitas', id);
                    
                    Utils.toast('Agendamento excluído');
                    UI.renderAgenda();
                    UI.renderDashboard();
                }
            },
            
            whatsapp: {
                shareImovel: async (imovelId) => {
                    const imovel = UI.data.imoveis.find(x => x.id === imovelId);
                    if (!imovel) return;
                    
                    const settings = await Storage.getSettings();
                    let message = `*🏠 ${imovel.titulo}*\n\n`;
                    
                    message += `📍 *Endereço:* ${imovel.endereco}\n`;
                    message += `🏠 *Tipo:* ${Utils.getTipoText(imovel.tipo)}\n`;
                    
                    if (imovel.precoVenda) {
                        message += `💰 *Preço de Venda:* ${Utils.formatCurrency(imovel.precoVenda)}\n`;
                    }
                    if (imovel.precoAluguel) {
                        message += `💰 *Preço de Aluguel:* ${Utils.formatCurrency(imovel.precoAluguel)}/mês\n`;
                    }
                    
                    if (imovel.area) message += `📐 *Área:* ${imovel.area}m²\n`;
                    if (imovel.quartos) message += `🛏️ *Quartos:* ${imovel.quartos}\n`;
                    if (imovel.banheiros) message += `🛁 *Banheiros:* ${imovel.banheiros}\n`;
                    if (imovel.vagas) message += `🚗 *Vagas:* ${imovel.vagas}\n`;
                    if (imovel.condominio) message += `🏢 *Condomínio:* ${Utils.formatCurrency(imovel.condominio)}/mês\n`;
                    
                    if (imovel.dataEntrega) {
                        message += `\n📅 *Data de Entrega:* ${Utils.formatDate(imovel.dataEntrega)}\n`;
                    }
                    
                    if (imovel.construtora) {
                        message += `\n🏗️ *Construtora:* ${imovel.construtora}\n`;
                    }
                    
                    if (imovel.formaPagamento) {
                        message += `\n💳 *Forma de Pagamento:*\n${imovel.formaPagamento}\n`;
                    }
                    
                    if (imovel.descricao) {
                        message += `\n📝 *Descrição:*\n${imovel.descricao.substring(0, 200)}${imovel.descricao.length > 200 ? '...' : ''}\n`;
                    }
                    
                    message += `\n📞 *Contato:* ${settings.telefone || '(82) 99662-2036'}\n`;
                    message += `🏢 *Imobiliária:* ${settings.imobiliaria || 'Resende'}\n`;
                    message += `👨‍💼 *Corretor:* ${settings.nome || 'Alex Peixoto'}\n`;
                    message += `📋 *CRECI:* ${settings.creci || '5794-AL'}`;
                    
                    const encodedMessage = encodeURIComponent(message);
                    const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
                    
                    window.open(whatsappUrl, '_blank');
                }
            },
            
            link: {
                save: async (e) => {
                    e.preventDefault();
                    
                    const id = document.getElementById('l-id').value || Utils.id();
                    const titulo = document.getElementById('l-titulo').value;
                    const url = document.getElementById('l-url').value;
                    const categoria = document.getElementById('l-categoria').value;
                    const descricao = document.getElementById('l-descricao').value;
                    
                    const newLink = {
                        id,
                        titulo,
                        url,
                        categoria,
                        descricao,
                        dataCriacao: new Date().toISOString()
                    };
                    
                    const existingIdx = UI.data.links.findIndex(l => l.id === id);
                    if (existingIdx >= 0) {
                        UI.data.links[existingIdx] = newLink;
                        await DB.put('links', newLink);
                    } else {
                        UI.data.links.push(newLink);
                        await DB.add('links', newLink);
                    }
                    
                    UI.data.links = await Storage.getLinks();
                    
                    Utils.toast('Link salvo com sucesso!');
                    
                    UI.closeModals();
                    UI.renderLinks();
                },
                
                edit: async (id) => {
                    const link = UI.data.links.find(x => x.id === id);
                    if (!link) return;
                    
                    document.getElementById('l-id').value = link.id;
                    document.getElementById('l-titulo').value = link.titulo;
                    document.getElementById('l-url').value = link.url;
                    document.getElementById('l-categoria').value = link.categoria || 'outros';
                    document.getElementById('l-descricao').value = link.descricao || '';
                    document.getElementById('title-link').innerText = 'Editar Link';
                    
                    UI.openModal('link');
                },
                
                delete: async (id) => {
                    if(!confirm('Tem certeza que deseja excluir este link?')) return;
                    
                    UI.data.links = UI.data.links.filter(x => x.id !== id);
                    await DB.delete('links', id);
                    
                    Utils.toast('Link excluído');
                    UI.renderLinks();
                },
                
                open: (id) => {
                    const link = UI.data.links.find(x => x.id === id);
                    if (link && link.url) {
                        window.open(link.url, '_blank');
                    }
                },
                
                copy: (id) => {
                    const link = UI.data.links.find(x => x.id === id);
                    if (link && link.url) {
                        navigator.clipboard.writeText(link.url).then(() => {
                            Utils.toast('Link copiado para a área de transferência');
                        });
                    }
                }
            },
            
            settings: {
                save: async (e) => {
                    e.preventDefault();
                    
                    const settings = {
                        id: 'main',
                        nome: document.getElementById('s-nome').value,
                        creci: document.getElementById('s-creci').value,
                        telefone: document.getElementById('s-telefone').value,
                        email: document.getElementById('s-email').value,
                        imobiliaria: document.getElementById('s-imobiliaria').value,
                        comissao: parseFloat(document.getElementById('s-comissao').value) || 5
                    };
                    
                    await DB.put('settings', settings);
                    
                    Utils.toast('Configurações salvas!');
                    
                    UI.closeModals();
                }
            },
            
            backup: {
                exportData: () => {
                    try {
                        const data = {
                            clientes: UI.data.clientes,
                            imoveis: UI.data.imoveis,
                            visitas: UI.data.visitas,
                            links: UI.data.links,
                            settings: Storage.getSettings().then(s => s),
                            funilEtapas: UI.data.funilEtapas,
                            exportDate: new Date().toISOString(),
                            version: '1.0',
                            app: 'ImobiPro'
                        };
                        
                        Storage.getSettings().then(settings => {
                            data.settings = settings;
                            
                            const dataStr = JSON.stringify(data, null, 2);
                            const dataBlob = new Blob([dataStr], { type: 'application/json' });
                            const url = URL.createObjectURL(dataBlob);
                            
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `imobipro_backup_${new Date().toISOString().split('T')[0]}.json`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            
                            Utils.toast('Backup exportado com sucesso!');
                        });
                        
                    } catch (error) {
                        console.error('Erro ao exportar backup:', error);
                        Utils.toast('Erro ao exportar backup', 'error');
                    }
                },
                
                importTrigger: () => {
                    document.getElementById('import-file').click();
                },
                
                importData: async (input) => {
                    const file = input.files[0];
                    if (!file) return;
                    
                    if (!confirm('⚠️ ATENÇÃO: Importar backup irá SOBRESCREVER todos os dados atuais. Deseja continuar?')) {
                        input.value = '';
                        return;
                    }
                    
                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        
                        if (!data.app || data.app !== 'ImobiPro') {
                            throw new Error('Arquivo de backup inválido');
                        }
                        
                        if (data.clientes && Array.isArray(data.clientes)) {
                            await DB.clear('clientes');
                            for (const cliente of data.clientes) {
                                await DB.add('clientes', cliente);
                            }
                        }
                        
                        if (data.imoveis && Array.isArray(data.imoveis)) {
                            await DB.clear('imoveis');
                            for (const imovel of data.imoveis) {
                                await DB.add('imoveis', imovel);
                            }
                        }
                        
                        if (data.visitas && Array.isArray(data.visitas)) {
                            await DB.clear('visitas');
                            for (const visita of data.visitas) {
                                await DB.add('visitas', visita);
                            }
                        }
                        
                        if (data.links && Array.isArray(data.links)) {
                            await DB.clear('links');
                            for (const link of data.links) {
                                await DB.add('links', link);
                            }
                        }
                        
                        if (data.settings) {
                            await DB.put('settings', data.settings);
                        }
                        
                        if (data.funilEtapas && Array.isArray(data.funilEtapas)) {
                            await DB.clear('funilEtapas');
                            for (const etapa of data.funilEtapas) {
                                await DB.add('funilEtapas', etapa);
                            }
                        }
                        
                        UI.data.clientes = await Storage.getClientes();
                        UI.data.imoveis = await Storage.getImoveis();
                        UI.data.visitas = await Storage.getVisitas();
                        UI.data.links = await Storage.getLinks();
                        UI.data.funilEtapas = await Storage.getFunilEtapas();
                        
                        UI.renderClientes();
                        UI.renderImoveis();
                        UI.renderAgenda();
                        UI.renderLinks();
                        UI.renderDashboard();
                        UI.renderFunil();
                        
                        Utils.toast('Backup importado com sucesso!');
                        
                    } catch (error) {
                        console.error('Erro ao importar backup:', error);
                        Utils.toast('Erro ao importar backup. Arquivo inválido.', 'error');
                    }
                    
                    input.value = '';
                },
                
                exportIOS: () => {
                    try {
                        const data = {
                            clientes: UI.data.clientes,
                            imoveis: UI.data.imoveis,
                            visitas: UI.data.visitas,
                            links: UI.data.links,
                            settings: Storage.getSettings().then(s => s),
                            funilEtapas: UI.data.funilEtapas,
                            exportDate: new Date().toISOString(),
                            version: '1.0',
                            app: 'ImobiPro'
                        };
                        
                        Storage.getSettings().then(settings => {
                            data.settings = settings;
                            
                            const dataStr = JSON.stringify(data, null, 2);
                            
                            const blob = new Blob([dataStr], { type: 'application/json' });
                            const reader = new FileReader();
                            
                            reader.onload = function(e) {
                                const text = e.target.result;
                                const compressed = LZString.compressToEncodedURIComponent(text);
                                
                                const downloadLink = document.createElement('a');
                                downloadLink.href = 'data:application/octet-stream,' + compressed;
                                downloadLink.download = `imobipro_ios_backup_${new Date().toISOString().split('T')[0]}.txt`;
                                downloadLink.click();
                            };
                            
                            reader.readAsText(blob);
                            
                            Utils.toast('Backup para iOS gerado com sucesso!');
                        });
                        
                    } catch (error) {
                        console.error('Erro ao exportar backup iOS:', error);
                        Utils.toast('Erro ao exportar backup iOS', 'error');
                    }
                },
                
                clearData: async () => {
                    if(!confirm('🚨🚨🚨 ATENÇÃO 🚨🚨🚨\n\nIsso apagará TODOS os dados do aplicativo:\n- Todos os clientes\n- Todos os imóveis\n- Todos os agendamentos\n- Todos os links\n- Todas as configurações\n\nEsta ação NÃO pode ser desfeita!\n\nTem certeza absoluta?')) return;
                    
                    try {
                        await DB.clear('clientes');
                        await DB.clear('imoveis');
                        await DB.clear('visitas');
                        await DB.clear('links');
                        await DB.clear('funilEtapas');
                        
                        const defaultSettings = {
                            id: 'main',
                            nome: 'Alex Peixoto',
                            creci: '5794-AL',
                            telefone: '(82) 99662-2036',
                            email: '',
                            imobiliaria: 'Resende',
                            comissao: 5
                        };
                        await DB.put('settings', defaultSettings);
                        
                        const etapasPadrao = [
                            { id: 'lead', nome: 'Lead', cor: '#93c5fd', ordem: 1 },
                            { id: 'contato', nome: 'Contato Realizado', cor: '#60a5fa', ordem: 2 },
                            { id: 'cpf', nome: 'CPF em Análise', cor: '#3b82f6', ordem: 3 },
                            { id: 'sem-restricao', nome: 'Sem Restrição', cor: '#1d4ed8', ordem: 4 },
                            { id: 'documentacao', nome: 'Documentação', cor: '#7c3aed', ordem: 5 },
                            { id: 'aprovado', nome: 'Aprovado', cor: '#10b981', ordem: 6 },
                            { id: 'contrato', nome: 'Contrato Assinado', cor: '#059669', ordem: 7 },
                            { id: 'venda', nome: 'Venda Concluída', cor: '#047857', ordem: 8 }
                        ];
                        
                        for (const etapa of etapasPadrao) {
                            await DB.put('funilEtapas', etapa);
                        }
                        
                        UI.data.clientes = await Storage.getClientes();
                        UI.data.imoveis = await Storage.getImoveis();
                        UI.data.visitas = await Storage.getVisitas();
                        UI.data.links = await Storage.getLinks();
                        UI.data.funilEtapas = await Storage.getFunilEtapas();
                        
                        UI.renderClientes();
                        UI.renderImoveis();
                        UI.renderAgenda();
                        UI.renderLinks();
                        UI.renderDashboard();
                        UI.renderFunil();
                        
                        Utils.toast('Todos os dados foram resetados!', 'success');
                        
                    } catch (error) {
                        console.error('Erro ao resetar dados:', error);
                        Utils.toast('Erro ao resetar dados', 'error');
                    }
                }
            }
        };

        // Inicialização da aplicação
        document.addEventListener('DOMContentLoaded', () => {
            UI.init();
        });

        // PWA - Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado com sucesso:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Falha ao registrar ServiceWorker:', error);
                    });
            });
        }

        // Evento de fechamento do modal ao clicar no overlay
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                UI.closeModals();
            }
        });

        // Evento para fechar teclado virtual ao clicar fora de inputs
        document.addEventListener('touchstart', (e) => {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'SELECT') {
                document.activeElement.blur();
            }
        });

        // Prevenir zoom em inputs no iOS
        document.addEventListener('touchmove', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                e.preventDefault();
            }
        }, { passive: false });

        // Função auxiliar para abrir fullscreen da galeria
        UI.openFullscreenFromGallery = function(index) {
            const currentSheet = document.querySelector('.modal-sheet[style*="transform: translateY(0px)"]');
            if (!currentSheet) return;
            
            const imovelId = document.getElementById('i-id')?.value;
            if (!imovelId) return;
            
            UI.openFullscreen(imovelId, index);
        };

    </script>

    <!-- LZString para compressão (necessário para export iOS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
</body>
</html>
