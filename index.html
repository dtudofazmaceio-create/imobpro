<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0d4a2d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ImobiManager Pro - Gestão Completa</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ESTILOS COMPLETOS - MESMOS DO ARQUIVO ORIGINAL */
        :root {
            --primary: #0d4a2d;
            --primary-light: #0f6d3e;
            --primary-dark: #0a361f;
            --secondary: #2a5c8b;
            --secondary-light: #4a7fb8;
            --secondary-dark: #1a3a5f;
            --accent: #d4af37;
            --accent-light: #e8c96a;
            --accent-dark: #b8941f;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #e74c3c;
            --dark: #1a202c;
            --light: #f8f9fa;
            --surface: #ffffff;
            --border: #e2e8f0;
            
            --funnel-stage1: #0d4a2d;
            --funnel-stage2: #0f6d3e;
            --funnel-stage3: #2a5c8b;
            --funnel-stage4: #4a7fb8;
            --funnel-stage5: #d4af37;
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --header-height: calc(60px + var(--safe-top));
            --nav-height: calc(70px + var(--safe-bottom));
            --radius-lg: 20px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.15);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: var(--dark);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            font-size: 14px;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: var(--safe-top) 16px 12px;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
            color: white;
        }

        .brand {
            font-size: 1.1rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .brand i { font-size: 1.3rem; }
        
        .header-actions { 
            display: flex; 
            gap: 12px; 
        }
        
        .icon-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 1.1rem;
            color: white;
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .icon-btn:active { 
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }

        /* --- Main Content --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding: calc(var(--header-height) + 16px) 16px calc(var(--nav-height) + 20px);
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .view { 
            display: none; 
            animation: fadeIn 0.3s ease; 
        }
        
        .view.active { 
            display: block; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* --- Dashboard Stats --- */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .dashboard-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quick-actions {
            display: flex;
            gap: 8px;
        }
        
        .quick-action-btn {
            padding: 10px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--dark);
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .quick-action-btn:active {
            transform: scale(0.98);
            background: var(--light);
        }
        
        .quick-action-btn.primary {
            background: var(--primary);
            color: white;
            border: none;
        }
        
        .quick-action-btn.secondary {
            background: var(--secondary);
            color: white;
            border: none;
        }
        
        .quick-action-btn.accent {
            background: var(--accent);
            color: white;
            border: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--surface);
            padding: 16px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.2s ease;
            border: 1px solid var(--border);
            cursor: pointer;
        }
        
        .stat-card:active { 
            transform: scale(0.98); 
            box-shadow: var(--shadow-sm); 
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        
        .stat-value { 
            font-size: 1.6rem; 
            font-weight: 800; 
            color: var(--dark); 
            line-height: 1; 
        }
        
        .stat-label { 
            font-size: 0.75rem; 
            color: var(--secondary); 
            font-weight: 600; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* --- Dashboard Sections --- */
        .dashboard-section {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-action {
            font-size: 0.8rem;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .section-action:active {
            opacity: 0.7;
        }

        /* --- Funil Personalizável --- */
        .funnel-config {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        
        .funnel-stages-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }
        
        .funnel-stage-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--light);
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--primary);
            flex-wrap: nowrap;
        }
        
        .stage-color-picker {
            width: 30px;
            height: 30px;
            min-width: 30px;
            border-radius: 6px;
            border: 2px solid var(--border);
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .stage-name-input {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .stage-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        
        .stage-btn {
            width: 36px;
            height: 36px;
            min-width: 36px;
            border-radius: 8px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .stage-btn:active {
            transform: scale(0.95);
        }
        
        .stage-btn-remove {
            background: #fee2e2;
            color: var(--danger);
        }
        
        .stage-btn-move {
            background: #e0f2fe;
            color: var(--primary);
        }
        
        .add-stage-btn {
            width: 100%;
            padding: 12px;
            background: var(--light);
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            color: var(--secondary);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .add-stage-btn:active {
            background: var(--border);
            transform: scale(0.98);
        }

        /* --- Funnel Visualization --- */
        .funnel-visual {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 20px 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        
        .funnel-bar {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .funnel-level {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .funnel-level:hover {
            background: #f8fafc;
        }
        
        .level-label {
            min-width: 100px;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .level-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        .level-bar-container {
            flex: 1;
            height: 30px;
            background: var(--light);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .level-bar {
            height: 100%;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 12px;
            font-size: 0.8rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: width 0.5s ease;
        }
        
        .level-stats {
            min-width: 70px;
            text-align: right;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--secondary);
        }

        /* --- Metas Mensais --- */
        .metas-container {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        
        .meta-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .meta-item:last-child {
            border-bottom: none;
        }
        
        .meta-label {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .meta-value {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .meta-input {
            width: 100px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            text-align: right;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .meta-progress {
            margin-top: 4px;
            height: 6px;
            background: var(--light);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .meta-progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .edit-meta-btn {
            padding: 6px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .edit-meta-btn:active {
            transform: scale(0.95);
        }

        /* --- Cards & Lists --- */
        .search-container {
            position: relative;
            margin-bottom: 16px;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 14px 14px 44px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--surface);
            font-size: 1rem;
            outline: none;
            -webkit-appearance: none;
            box-shadow: var(--shadow-sm);
        }
        
        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(13, 74, 45, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary);
            font-size: 1.1rem;
        }

        .list-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .list-card:active {
            transform: scale(0.98);
            box-shadow: var(--shadow-sm);
        }
        
        .list-card.birthday {
            border-left: 4px solid #d4af37;
            background: linear-gradient(90deg, #fef7e6 0%, white 100%);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .card-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--dark);
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .card-subtitle {
            font-size: 0.85rem;
            color: var(--secondary);
            display: flex;
            gap: 6px;
            align-items: center;
            margin-bottom: 4px;
            flex-wrap: wrap;
        }

        .tag {
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .tag-primary { background: #d4edda; color: var(--primary); }
        .tag-secondary { background: #dbeafe; color: var(--secondary); }
        .tag-accent { background: #fef3c7; color: var(--accent-dark); }
        .tag-success { background: #d1fae5; color: var(--success); }
        .tag-warning { background: #fef3c7; color: #b45309; }
        .tag-danger { background: #fee2e2; color: var(--danger); }
        .tag-purple { background: #f3e8ff; color: #7c3aed; }
        .tag-cyan { background: #cffafe; color: #0e7490; }

        .action-row {
            display: flex;
            gap: 6px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            flex-wrap: wrap;
        }
        
        .btn-sm {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            border-radius: 10px;
            border: none;
            font-size: 0.85rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .btn-sm:active {
            transform: scale(0.95);
        }
        
        .btn-primary { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 2px 4px rgba(13, 74, 45, 0.3);
        }
        .btn-secondary { 
            background: var(--secondary); 
            color: white;
            box-shadow: 0 2px 4px rgba(42, 92, 139, 0.3);
        }
        .btn-accent { 
            background: var(--accent); 
            color: white;
            box-shadow: 0 2px 4px rgba(212, 175, 55, 0.3);
        }
        .btn-success { 
            background: var(--success); 
            color: white;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }
        .btn-warning { 
            background: var(--warning); 
            color: white;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        .btn-danger { 
            background: var(--danger); 
            color: white;
            box-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);
        }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding-bottom: var(--safe-bottom);
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.7rem;
            font-weight: 600;
            gap: 4px;
            transition: 0.2s;
            padding: 8px 4px;
        }
        
        .nav-item i {
            font-size: 1.3rem;
            margin-bottom: 2px;
        }
        
        .nav-item.active {
            color: var(--primary);
            background: linear-gradient(0deg, rgba(13, 74, 45, 0.1) 0%, transparent 100%);
        }

        /* --- Floating Action Button --- */
        .fab-container {
            position: fixed;
            bottom: calc(var(--nav-height) + 20px);
            right: 20px;
            z-index: 90;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }
        
        .fab {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-lg);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .fab:active {
            transform: scale(0.9) rotate(90deg);
            box-shadow: var(--shadow-md);
        }
        
        .fab-submenu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            pointer-events: none;
        }
        
        .fab-submenu.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        
        .fab-sub-btn {
            width: 48px;
            height: 48px;
            background: var(--surface);
            color: var(--dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: var(--shadow-md);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .fab-sub-btn:active {
            transform: scale(0.95);
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
            padding: 16px;
        }
        
        .modal-overlay.active {
            display: flex;
            opacity: 1;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: var(--surface);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlideUp 0.3s ease;
        }
        
        @keyframes modalSlideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px 20px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--light);
            color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .modal-close:active {
            transform: scale(0.95);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }

        /* --- Forms --- */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        .form-label.required::after {
            content: " *";
            color: var(--danger);
        }
        
        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            background: #f8fafc;
            -webkit-appearance: none;
        }
        
        .form-control:focus {
            background: white;
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(13, 74, 45, 0.1);
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: none;
        }
        
        select.form-control {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000 16 16' fill='%232a5c8b' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        .form-control.money {
            text-align: right;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.5px;
        }

        .btn-block {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(13, 74, 45, 0.3);
        }
        
        .btn-block:active {
            transform: scale(0.98);
        }
        
        .btn-block-secondary {
            background: var(--light);
            color: var(--secondary);
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-block-accent {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(212, 175, 55, 0.3);
        }

        /* --- Foto em Tela Cheia --- */
        .photo-viewer {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.98);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0;
            touch-action: pan-y pinch-zoom;
        }
        
        .photo-viewer.active {
            display: flex;
            flex-direction: column;
        }
        
        .photo-viewer img {
            width: 100%;
            height: 100%;
            max-width: 100vw;
            max-height: 100vh;
            border-radius: 0;
            object-fit: contain;
            transition: transform 0.3s ease;
            cursor: grab;
        }
        
        .photo-viewer img:active {
            cursor: grabbing;
        }
        
        .photo-nav {
            position: absolute;
            bottom: calc(20px + var(--safe-bottom));
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        
        .photo-nav-btn {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .photo-nav-btn:active {
            background: rgba(255,255,255,0.3);
            transform: scale(0.95);
        }
        
        .photo-close {
            position: absolute;
            top: calc(20px + var(--safe-top));
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 2001;
        }
        
        .photo-close:active {
            background: rgba(255,255,255,0.2);
            transform: scale(0.95);
        }
        
        .photo-counter {
            position: absolute;
            top: calc(20px + var(--safe-top));
            left: 20px;
            color: white;
            font-size: 0.9rem;
            background: rgba(0,0,0,0.5);
            padding: 8px 16px;
            border-radius: 20px;
            z-index: 2001;
        }
        
        .photo-zoom-info {
            position: absolute;
            bottom: calc(80px + var(--safe-bottom));
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 0.8rem;
            background: rgba(0,0,0,0.5);
            padding: 6px 12px;
            border-radius: 20px;
            display: none;
        }
        
        .photo-viewer.zoomed .photo-zoom-info {
            display: block;
        }

        /* --- Imóveis com Fotos --- */
        .imovel-photos {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .imovel-photo {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .imovel-photo:active {
            transform: scale(1.05);
        }

        /* --- Aniversários --- */
        .birthday-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #d4af37 0%, #f59e0b 100%);
            color: white;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            white-space: nowrap;
        }
        
        .birthday-today {
            background: linear-gradient(135deg, #e74c3c 0%, #f97316 100%);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* --- Empty State --- */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--secondary);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        
        .empty-state p {
            font-size: 0.95rem;
        }

        /* --- Toast --- */
        .toast {
            position: fixed;
            top: var(--header-height);
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--dark);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(20px);
        }

        /* --- Responsive --- */
        @media (max-width: 360px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-item span {
                font-size: 0.65rem;
            }
            
            .photo-nav-btn {
                width: 40px;
                height: 40px;
            }
            
            .quick-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .quick-action-btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .quick-actions {
                width: 100%;
                overflow-x: auto;
                padding-bottom: 8px;
            }
        }

        /* --- Loading Spinner --- */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* --- File Input --- */
        .file-input-container {
            position: relative;
            margin-top: 10px;
        }
        
        .file-input-label {
            display: block;
            padding: 12px;
            background: var(--light);
            border: 2px dashed var(--border);
            border-radius: 12px;
            text-align: center;
            color: var(--secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .file-input-label:active {
            background: var(--border);
            transform: scale(0.98);
        }
        
        .file-input {
            display: none;
        }
        
        /* --- Accordion --- */
        .accordion {
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .accordion-header {
            padding: 16px;
            background: var(--light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        
        .accordion-header:active {
            background: #e2e8f0;
        }
        
        .accordion-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .accordion.active .accordion-content {
            padding: 16px;
            max-height: 1000px;
            overflow-y: auto;
        }
        
        /* --- Badges --- */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .badge-primary {
            background: #d4edda;
            color: var(--primary);
        }
        
        .badge-secondary {
            background: #dbeafe;
            color: var(--secondary);
        }
        
        .badge-accent {
            background: #fef3c7;
            color: var(--accent-dark);
        }
        
        .badge-success {
            background: #d1fae5;
            color: var(--success);
        }
        
        /* --- Calendário Agenda --- */
        .calendar {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .calendar-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--dark);
        }
        
        .calendar-nav {
            display: flex;
            gap: 8px;
        }
        
        .calendar-nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--light);
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .calendar-nav-btn:active {
            background: var(--border);
            transform: scale(0.95);
        }
        
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 0.8rem;
            color: var(--secondary);
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .calendar-day:active {
            background: var(--light);
            transform: scale(0.95);
        }
        
        .calendar-day.today {
            background: var(--primary);
            color: white;
            font-weight: 700;
        }
        
        .calendar-day.has-event {
            background: var(--warning);
            color: white;
            font-weight: 700;
        }
        
        .calendar-day.other-month {
            color: #cbd5e1;
        }
        
        .calendar-day.selected {
            background: var(--primary);
            color: white;
            font-weight: 700;
        }
        
        .calendar-events {
            margin-top: 20px;
        }
        
        .calendar-event-item {
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary);
            transition: all 0.2s ease;
        }
        
        .calendar-event-item:active {
            transform: scale(0.98);
        }
        
        .calendar-event-time {
            font-size: 0.8rem;
            color: var(--secondary);
            margin-bottom: 4px;
        }
        
        .calendar-event-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--dark);
        }
        
        /* --- Links Importantes --- */
        .links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        
        .link-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .link-card:active {
            transform: scale(0.98);
        }
        
        .link-icon {
            width: 40px;
            height: 40px;
            background: var(--light);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 12px;
        }
        
        .link-title {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--dark);
            margin-bottom: 4px;
            word-break: break-word;
        }
        
        .link-url {
            font-size: 0.75rem;
            color: var(--secondary);
            word-break: break-all;
        }
        
        /* --- Logo Upload --- */
        .logo-upload-container {
            margin-bottom: 20px;
        }
        
        .logo-preview {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            border: 2px dashed var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 12px;
            background: var(--light);
        }
        
        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* --- Dashboard Quick Stats --- */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .quick-stat {
            background: var(--surface);
            padding: 16px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quick-stat:active {
            transform: scale(0.98);
        }
        
        .quick-stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary);
            line-height: 1;
            margin-bottom: 4px;
        }
        
        .quick-stat-label {
            font-size: 0.7rem;
            color: var(--secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* --- Color Theme Variations --- */
        .theme-primary {
            color: var(--primary);
        }
        
        .theme-secondary {
            color: var(--secondary);
        }
        
        .theme-accent {
            color: var(--accent);
        }
        
        .bg-primary {
            background-color: var(--primary);
        }
        
        .bg-secondary {
            background-color: var(--secondary);
        }
        
        .bg-accent {
            background-color: var(--accent);
        }
        
        /* --- Progress Bars --- */
        .progress-bar {
            height: 8px;
            background: var(--light);
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .progress-fill.primary {
            background: var(--primary);
        }
        
        .progress-fill.secondary {
            background: var(--secondary);
        }
        
        .progress-fill.accent {
            background: var(--accent);
        }
        
        /* --- Import Progress --- */
        .import-progress {
            margin: 20px 0;
            padding: 16px;
            background: var(--light);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .progress-percentage {
            font-weight: 700;
            color: var(--primary);
        }
        
        /* --- Painel de Relatórios --- */
        .reports-panel {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .reports-panel::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        
        .reports-panel::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -30%;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
        }
        
        .reports-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            position: relative;
            z-index: 1;
        }
        
        .reports-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
        }
        
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            position: relative;
            z-index: 1;
        }
        
        .report-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-sm);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .report-card:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .report-card:active {
            transform: scale(0.98);
        }
        
        .report-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            color: var(--secondary);
            font-size: 1.2rem;
        }
        
        .report-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
            color: white;
        }
        
        .report-desc {
            font-size: 0.7rem;
            opacity: 0.9;
            color: rgba(255, 255, 255, 0.9);
        }
    </style>
</head>
<body>

    <header>
        <div class="brand" id="brand-logo">
            <i class="fas fa-home"></i>
            <span>ImobiManager Pro</span>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="App.backup.exportData()" title="Backup">
                <i class="fas fa-cloud-download-alt"></i>
            </button>
            <button class="icon-btn" onclick="UI.showSettings()" title="Configurações">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </header>

    <div id="toast" class="toast"></div>

    <main>
        <!-- Dashboard View -->
        <div id="dashboard-view" class="view active">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                    <span class="badge badge-primary" id="birthday-count" style="display:none">0</span>
                </div>
                <div class="quick-actions">
                    <button class="quick-action-btn primary" onclick="UI.showModal('cliente', 'new')">
                        <i class="fas fa-user-plus"></i> Cliente
                    </button>
                    <button class="quick-action-btn secondary" onclick="UI.showModal('imovel', 'new')">
                        <i class="fas fa-home"></i> Imóvel
                    </button>
                    <button class="quick-action-btn accent" onclick="UI.showAgendaModalForDate(null)">
                        <i class="fas fa-calendar-plus"></i> Agendar
                    </button>
                </div>
            </div>
            
            <!-- Stats rápidas -->
            <div class="quick-stats" id="quick-stats">
                <!-- Stats rápidas dinâmicas -->
            </div>
            
            <div class="dashboard-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-birthday-cake"></i> Aniversários do Mês
                    </div>
                    <div class="section-action" onclick="UI.showBirthdaysList()">
                        Ver todos <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                <div id="birthday-list"></div>
            </div>
            
            <div class="dashboard-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-calendar-day"></i> Agenda de Hoje
                    </div>
                    <div class="section-action" onclick="UI.switchTab(document.querySelector('[data-target=\"agenda-view\"]'))">
                        Ver agenda <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                <div id="agenda-today-list"></div>
            </div>
            
            <div class="dashboard-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-filter"></i> Funil de Vendas
                    </div>
                    <div class="section-action" onclick="UI.switchTab(document.querySelector('[data-target=\"funil-view\"]'))">
                        Ver funil <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                <div id="funnel-overview"></div>
            </div>
        </div>

        <!-- Clientes View -->
        <div id="clientes-view" class="view">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar clientes..." 
                       oninput="UI.searchClientes(this.value)">
            </div>
            
            <div id="clientes-list"></div>
        </div>

        <!-- Imóveis View -->
        <div id="imoveis-view" class="view">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar imóveis..." 
                       oninput="UI.searchImoveis(this.value)">
            </div>
            
            <div id="imoveis-list"></div>
        </div>

        <!-- Funil View -->
        <div id="funil-view" class="view">
            <div class="section-title" style="margin-bottom: 20px;">
                <i class="fas fa-filter"></i> Funil de Vendas
            </div>
            
            <div class="funnel-config">
                <div class="section-title" style="font-size: 1rem; margin-bottom: 12px;">
                    Configurar Etapas do Funil
                </div>
                <div class="funnel-stages-container" id="funnel-stages-container">
                    <!-- Etapas dinâmicas -->
                </div>
                <button class="add-stage-btn" onclick="Funnel.addStage()">
                    <i class="fas fa-plus"></i> Adicionar Etapa
                </button>
            </div>
            
            <div class="funnel-visual" id="funnel-visual">
                <!-- Visualização do funil -->
            </div>
            
            <div class="metas-container" id="metas-container">
                <!-- Metas mensais -->
            </div>
        </div>

        <!-- Agenda View (Calendário) -->
        <div id="agenda-view" class="view">
            <div class="calendar" id="calendar-container">
                <!-- Calendário dinâmico -->
            </div>
            
            <div id="agenda-list"></div>
        </div>

        <!-- Relatórios View -->
        <div id="relatorios-view" class="view">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <i class="fas fa-chart-bar"></i> Relatórios
                </div>
                <button class="quick-action-btn primary" onclick="Relatorios.exportAllReports()">
                    <i class="fas fa-download"></i> Exportar Todos
                </button>
            </div>
            
            <!-- PAINEL DE RELATÓRIOS MOVIDO PARA AQUI -->
            <div class="reports-panel">
                <div class="reports-header">
                    <div class="reports-title">
                        <i class="fas fa-chart-bar"></i> Painel de Relatórios
                    </div>
                </div>
                <div class="reports-grid">
                    <div class="report-card" onclick="Relatorios.gerarRelatorioVendas()">
                        <div class="report-icon">
                            <i class="fas fa-handshake"></i>
                        </div>
                        <div class="report-name">Vendas</div>
                        <div class="report-desc">Relatório completo</div>
                    </div>
                    <div class="report-card" onclick="Relatorios.gerarRelatorioClientes()">
                        <div class="report-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="report-name">Clientes</div>
                        <div class="report-desc">Lista completa</div>
                    </div>
                    <div class="report-card" onclick="Relatorios.gerarRelatorioImoveis()">
                        <div class="report-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="report-name">Imóveis</div>
                        <div class="report-desc">Inventário</div>
                    </div>
                    <div class="report-card" onclick="Relatorios.gerarRelatorioAgenda()">
                        <div class="report-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="report-name">Agenda</div>
                        <div class="report-desc">Agendamentos</div>
                    </div>
                    <div class="report-card" onclick="Relatorios.gerarRelatorioFunil()">
                        <div class="report-icon">
                            <i class="fas fa-filter"></i>
                        </div>
                        <div class="report-name">Funil</div>
                        <div class="report-desc">Análise</div>
                    </div>
                    <div class="report-card" onclick="Relatorios.gerarRelatorioPlantao()">
                        <div class="report-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="report-name">Plantão</div>
                        <div class="report-desc">Relatório</div>
                    </div>
                </div>
            </div>
            
            <div class="section-title" style="margin: 20px 0 12px;">
                <i class="fas fa-file-pdf"></i> Gerar Fichas
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                <button class="btn-block btn-secondary" onclick="Relatorios.gerarFichaClientePrompt()">
                    <i class="fas fa-user"></i> Ficha do Cliente
                </button>
                <button class="btn-block btn-secondary" onclick="Relatorios.gerarFichaImovelPrompt()">
                    <i class="fas fa-home"></i> Ficha do Imóvel
                </button>
            </div>
            
            <div class="chart-container" style="height: 300px; margin-bottom: 20px;">
                <canvas id="performance-chart"></canvas>
            </div>
        </div>
    </main>

    <!-- FAB Container -->
    <div class="fab-container">
        <div class="fab-submenu" id="fab-submenu">
            <!-- Submenu dinâmico -->
        </div>
        <button class="fab" id="main-fab" onclick="UI.toggleFabMenu()">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-target="dashboard-view" onclick="UI.switchTab(this)">
            <i class="fas fa-home"></i>
            <span>Início</span>
        </a>
        <a href="#" class="nav-item" data-target="clientes-view" onclick="UI.switchTab(this)">
            <i class="fas fa-users"></i>
            <span>Clientes</span>
        </a>
        <a href="#" class="nav-item" data-target="imoveis-view" onclick="UI.switchTab(this)">
            <i class="fas fa-building"></i>
            <span>Imóveis</span>
        </a>
        <a href="#" class="nav-item" data-target="funil-view" onclick="UI.switchTab(this)">
            <i class="fas fa-filter"></i>
            <span>Funil</span>
        </a>
        <a href="#" class="nav-item" data-target="agenda-view" onclick="UI.switchTab(this)">
            <i class="fas fa-calendar-alt"></i>
            <span>Agenda</span>
        </a>
        <a href="#" class="nav-item" data-target="relatorios-view" onclick="UI.switchTab(this)">
            <i class="fas fa-chart-bar"></i>
            <span>Relatórios</span>
        </a>
    </nav>

    <!-- Modal de Cliente -->
    <div class="modal-overlay" id="modal-cliente">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-cliente-title">
                    <i class="fas fa-user-plus"></i> Novo Cliente
                </h3>
                <button class="modal-close" onclick="UI.closeModal('cliente')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-cliente" onsubmit="App.cliente.save(event)">
                    <input type="hidden" id="c-id">
                    <div class="accordion active" id="cliente-dados-pessoais">
                        <div class="accordion-header" onclick="UI.toggleAccordion('cliente-dados-pessoais')">
                            <span><i class="fas fa-user-circle"></i> Dados Pessoais</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="accordion-content">
                            <div class="form-group">
                                <label class="form-label required">Nome Completo</label>
                                <input type="text" id="c-nome" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">CPF</label>
                                <input type="text" id="c-cpf" class="form-control" placeholder="000.000.000-00">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data de Nascimento</label>
                                <input type="date" id="c-nascimento" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">E-mail</label>
                                <input type="email" id="c-email" class="form-control" placeholder="exemplo@email.com">
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion" id="cliente-contato">
                        <div class="accordion-header" onclick="UI.toggleAccordion('cliente-contato')">
                            <span><i class="fas fa-phone"></i> Contato</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="accordion-content">
                            <div class="form-group">
                                <label class="form-label required">Telefone Principal (WhatsApp)</label>
                                <input type="tel" id="c-telefone" class="form-control" required placeholder="(11) 99999-9999">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Telefone Secundário</label>
                                <input type="tel" id="c-telefone2" class="form-control" placeholder="(11) 99999-9999">
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion" id="cliente-endereco">
                        <div class="accordion-header" onclick="UI.toggleAccordion('cliente-endereco')">
                            <span><i class="fas fa-map-marker-alt"></i> Endereço (Opcional)</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="accordion-content">
                            <div class="form-group">
                                <label class="form-label">Logradouro</label>
                                <input type="text" id="c-logradouro" class="form-control" placeholder="Rua, Avenida, etc.">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Número</label>
                                <input type="text" id="c-numero" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Complemento</label>
                                <input type="text" id="c-complemento" class="form-control" placeholder="Apto, Bloco, etc.">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Bairro</label>
                                <input type="text" id="c-bairro" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cidade</label>
                                <input type="text" id="c-cidade" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estado</label>
                                <select id="c-estado" class="form-control">
                                    <option value="">Selecione...</option>
                                    <option value="AC">Acre</option>
                                    <option value="AL">Alagoas</option>
                                    <option value="AP">Amapá</option>
                                    <option value="AM">Amazonas</option>
                                    <option value="BA">Bahia</option>
                                    <option value="CE">Ceará</option>
                                    <option value="DF">Distrito Federal</option>
                                    <option value="ES">Espírito Santo</option>
                                    <option value="GO">Goiás</option>
                                    <option value="MA">Maranhão</option>
                                    <option value="MT">Mato Grosso</option>
                                    <option value="MS">Mato Grosso do Sul</option>
                                    <option value="MG">Minas Gerais</option>
                                    <option value="PA">Pará</option>
                                    <option value="PB">Paraíba</option>
                                    <option value="PR">Paraná</option>
                                    <option value="PE">Pernambuco</option>
                                    <option value="PI">Piauí</option>
                                    <option value="RJ">Rio de Janeiro</option>
                                    <option value="RN">Rio Grande do Norte</option>
                                    <option value="RS">Rio Grande do Sul</option>
                                    <option value="RO">Rondônia</option>
                                    <option value="RR">Roraima</option>
                                    <option value="SC">Santa Catarina</option>
                                    <option value="SP">São Paulo</option>
                                    <option value="SE">Sergipe</option>
                                    <option value="TO">Tocantins</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">CEP</label>
                                <input type="text" id="c-cep" class="form-control" placeholder="00000-000">
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion" id="cliente-interesses">
                        <div class="accordion-header" onclick="UI.toggleAccordion('cliente-interesses')">
                            <span><i class="fas fa-home"></i> Interesses (Opcional)</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="accordion-content">
                            <div class="form-group">
                                <label class="form-label">Tipo de Imóvel</label>
                                <select id="c-tipo-interesse" class="form-control">
                                    <option value="">Todos</option>
                                    <option value="casa">Casa</option>
                                    <option value="apartamento">Apartamento</option>
                                    <option value="terreno">Terreno</option>
                                    <option value="comercial">Comercial</option>
                                    <option value="rural">Rural</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Faixa de Valor</label>
                                <div style="display: flex; gap: 12px;">
                                    <input type="text" id="c-valor-min" class="form-control money" placeholder="Mínimo" 
                                           oninput="Utils.formatMoney(this)" data-money>
                                    <input type="text" id="c-valor-max" class="form-control money" placeholder="Máximo" 
                                           oninput="Utils.formatMoney(this)" data-money>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Bairros de Interesse</label>
                                <textarea id="c-bairros-interesse" class="form-control" placeholder="Digite os bairros separados por vírgula"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion" id="cliente-outros">
                        <div class="accordion-header" onclick="UI.toggleAccordion('cliente-outros')">
                            <span><i class="fas fa-sticky-note"></i> Outras Informações (Opcional)</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="accordion-content">
                            <div class="form-group">
                                <label class="form-label">Fonte do Lead</label>
                                <select id="c-fonte" class="form-control">
                                    <option value="">Selecione...</option>
                                    <option value="indicacao">Indicação</option>
                                    <option value="site">Site</option>
                                    <option value="whatsapp">WhatsApp</option>
                                    <option value="instagram">Instagram</option>
                                    <option value="facebook">Facebook</option>
                                    <option value="placa">Placa</option>
                                    <option value="outro">Outro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select id="c-status" class="form-control">
                                    <option value="lead">Lead</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Observações</label>
                                <textarea id="c-observacoes" class="form-control" rows="4" placeholder="Anotações importantes sobre o cliente..."></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-block btn-block-secondary" onclick="UI.closeModal('cliente')">
                    Cancelar
                </button>
                <button type="submit" form="form-cliente" class="btn-block">
                    Salvar Cliente
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Imóvel -->
    <div class="modal-overlay" id="modal-imovel">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-imovel-title">
                    <i class="fas fa-home"></i> Novo Imóvel
                </h3>
                <button class="modal-close" onclick="UI.closeModal('imovel')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-imovel" onsubmit="App.imovel.save(event)">
                    <input type="hidden" id="i-id">
                    
                    <div class="accordion active" id="imovel-basico">
                        <div class="accordion-header" onclick="UI.toggleAccordion('imovel-basico')">
                            <span><i class="fas fa-info-circle"></i> Informações Básicas</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="accordion-content">
                            <div class="form-group">
                                <label class="form-label required">Nome/Descrição</label>
                                <input type="text" id="i-nome" class="form-control" required placeholder="Ex: Apartamento 3 quartos Centro">
                            </div>
                            <div class="form-group">
                                <label class="form-label required">Valor</label>
                                <input type="text" id="i-valor" class="form-control money" required 
                                       oninput="Utils.formatMoney(this)" placeholder="0,00" data-money>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">Data de Entrega/Disponibilidade</label>
                                <input type="date" id="i-data-entrega" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tipo (Opcional)</label>
                                <select id="i-tipo" class="form-control">
                                    <option value="">Selecione...</option>
                                    <option value="casa">Casa</option>
                                    <option value="apartamento">Apartamento</option>
                                    <option value="kitnet">Kitnet</option>
                                    <option value="sobrado">Sobrado</option>
                                    <option value="terreno">Terreno</option>
                                    <option value="comercial">Comercial</option>
                                    <option value="rural">Rural</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Finalidade (Opcional)</label>
                                <select id="i-finalidade" class="form-control">
                                    <option value="">Selecione...</option>
                                    <option value="venda">Venda</option>
                                    <option value="aluguel">Aluguel</option>
                                    <option value="venda-aluguel">Venda ou Aluguel</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion" id="imovel-valor">
                        <div class="accordion-header" onclick="UI.toggleAccordion('imovel-valor')">
                            <span><i class="fas fa-dollar-sign"></i> Valores (Opcional)</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="accordion-content">
                            <div class="form-group">
                                <label class="form-label">Valor do Condomínio</label>
                                <input type="text" id="i-condominio" class="form-control money" 
                                       oninput="Utils.formatMoney(this)" placeholder="0,00" data-money>
                            </div>
                            <div class="form-group">
                                <label class="form-label">IPTU</label>
                                <input type="text" id="i-iptu" class="form-control money" 
                                       oninput="Utils.formatMoney(this)" placeholder="0,00" data-money>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion" id="imovel-endereco">
                        <div class="accordion-header" onclick="UI.toggleAccordion('imovel-endereco')">
                            <span><i class="fas fa-map-marker-alt"></i> Endereço (Opcional)</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="accordion-content">
                            <div class="form-group">
                                <label class="form-label">Logradouro</label>
                                <input type="text" id="i-logradouro" class="form-control" placeholder="Rua, Avenida, etc.">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Número</label>
                                <input type="text" id="i-numero" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Complemento</label>
                                <input type="text" id="i-complemento" class="form-control" placeholder="Apto, Bloco, etc.">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Bairro</label>
                                <input type="text" id="i-bairro" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cidade</label>
                                <input type="text" id="i-cidade" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estado</label>
                                <select id="i-estado" class="form-control">
                                    <option value="">Selecione...</option>
                                    <option value="AC">Acre</option>
                                    <option value="AL">Alagoas</option>
                                    <option value="AP">Amapá</option>
                                    <option value="AM">Amazonas</option>
                                    <option value="BA">Bahia</option>
                                    <option value="CE">Ceará</option>
                                    <option value="DF">Distrito Federal</option>
                                    <option value="ES">Espírito Santo</option>
                                    <option value="GO">Goiás</option>
                                    <option value="MA">Maranhão</option>
                                    <option value="MT">Mato Grosso</option>
                                    <option value="MS">Mato Grosso do Sul</option>
                                    <option value="MG">Minas Gerais</option>
                                    <option value="PA">Pará</option>
                                    <option value="PB">Paraíba</option>
                                    <option value="PR">Paraná</option>
                                    <option value="PE">Pernambuco</option>
                                    <option value="PI">Piauí</option>
                                    <option value="RJ">Rio de Janeiro</option>
                                    <option value="RN">Rio Grande do Norte</option>
                                    <option value="RS">Rio Grande do Sul</option>
                                    <option value="RO">Rondônia</option>
                                    <option value="RR">Roraima</option>
                                    <option value="SC">Santa Catarina</option>
                                    <option value="SP">São Paulo</option>
                                    <option value="SE">Sergipe</option>
                                    <option value="TO">Tocantins</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">CEP</label>
                                <input type="text" id="i-cep" class="form-control" placeholder="00000-000">
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion" id="imovel-caracteristicas">
                        <div class="accordion-header" onclick="UI.toggleAccordion('imovel-caracteristicas')">
                            <span><i class="fas fa-clipboard-list"></i> Características (Opcional)</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="accordion-content">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                <div class="form-group">
                                    <label class="form-label">Área Total (m²)</label>
                                    <input type="number" id="i-area-total" class="form-control" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Área Construída (m²)</label>
                                    <input type="number" id="i-area-construida" class="form-control" min="0">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                <div class="form-group">
                                    <label class="form-label">Quartos</label>
                                    <input type="number" id="i-quartos" class="form-control" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Suítes</label>
                                    <input type="number" id="i-suites" class="form-control" min="0">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                <div class="form-group">
                                    <label class="form-label">Banheiros</label>
                                    <input type="number" id="i-banheiros" class="form-control" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Vagas</label>
                                    <input type="number" id="i-vagas" class="form-control" min="0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Mobiliado</label>
                                <select id="i-mobiliado" class="form-control">
                                    <option value="">Não informado</option>
                                    <option value="sim">Sim</option>
                                    <option value="nao">Não</option>
                                    <option value="parcial">Parcialmente</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion" id="imovel-fotos">
                        <div class="accordion-header" onclick="UI.toggleAccordion('imovel-fotos')">
                            <span><i class="fas fa-camera"></i> Fotos</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="accordion-content">
                            <div class="form-group">
                                <label class="form-label required">Fotos do Imóvel</label>
                                <div class="imovel-photos" id="imovel-photos-preview">
                                    <!-- Fotos prévias -->
                                </div>
                                <div class="file-input-container">
                                    <label for="i-fotos" class="file-input-label">
                                        <i class="fas fa-cloud-upload-alt"></i> Selecionar Fotos
                                        <span style="display: block; font-size: 0.8rem; margin-top: 4px;">Máximo 20 fotos</span>
                                    </label>
                                    <input type="file" id="i-fotos" class="file-input" accept="image/*" multiple 
                                           onchange="App.imovel.handleFotos(this)">
                                </div>
                                <small style="color: var(--secondary); font-size: 0.8rem;">Clique nas fotos para visualizar em tela cheia</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion" id="imovel-outros">
                        <div class="accordion-header" onclick="UI.toggleAccordion('imovel-outros')">
                            <span><i class="fas fa-sticky-note"></i> Outras Informações (Opcional)</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="accordion-content">
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select id="i-status" class="form-control">
                                    <option value="disponivel">Disponível</option>
                                    <option value="reservado">Reservado</option>
                                    <option value="vendido">Vendido</option>
                                    <option value="alugado">Alugado</option>
                                    <option value="inativo">Inativo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Observações</label>
                                <textarea id="i-observacoes" class="form-control" rows="4" placeholder="Informações adicionais sobre o imóvel..."></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-block btn-block-secondary" onclick="UI.closeModal('imovel')">
                    Cancelar
                </button>
                <button type="submit" form="form-imovel" class="btn-block">
                    Salvar Imóvel
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Agendamento -->
    <div class="modal-overlay" id="modal-agenda-generico">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-agenda-title">
                    <i class="fas fa-calendar-plus"></i> Novo Agendamento
                </h3>
                <button class="modal-close" onclick="UI.closeModal('agenda-generico')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modal-agenda-body">
                <!-- Conteúdo dinâmico -->
            </div>
        </div>
    </div>

    <!-- Modal de Metas -->
    <div class="modal-overlay" id="modal-metas">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-bullseye"></i> Metas Mensais
                </h3>
                <button class="modal-close" onclick="UI.closeModal('metas')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-metas" onsubmit="Metas.save(event)">
                    <div class="form-group">
                        <label class="form-label">Meta de Leads</label>
                        <input type="number" id="meta-leads" class="form-control" min="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Meta de Vendas</label>
                        <input type="number" id="meta-vendas" class="form-control" min="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Meta de Receita</label>
                        <input type="text" id="meta-receita" class="form-control money" required 
                               oninput="Utils.formatMoney(this)" placeholder="0,00" data-money>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-block btn-block-secondary" onclick="UI.closeModal('metas')">
                    Cancelar
                </button>
                <button type="submit" form="form-metas" class="btn-block">
                    Salvar Metas
                </button>
            </div>
        </div>
    </div>

    <!-- Photo Viewer -->
    <div class="photo-viewer" id="photo-viewer">
        <button class="photo-close" onclick="UI.closePhotoViewer()">
            <i class="fas fa-times"></i>
        </button>
        <div class="photo-counter" id="photo-counter">1/1</div>
        <div class="photo-zoom-info">Toque duas vezes para zoom</div>
        <img id="fullscreen-photo" src="" alt="">
        <div class="photo-nav">
            <button class="photo-nav-btn" onclick="UI.prevPhoto()">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="photo-nav-btn" onclick="UI.nextPhoto()">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Modal de Configurações -->
    <div class="modal-overlay" id="modal-settings">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-cog"></i> Configurações
                </h3>
                <button class="modal-close" onclick="UI.closeModal('settings')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-settings" onsubmit="Settings.save(event)">
                    <div class="form-group">
                        <label class="form-label required">Nome do Corretor</label>
                        <input type="text" id="s-nome" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">CRECI</label>
                        <input type="text" id="s-creci" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Telefone para Contato</label>
                        <input type="text" id="s-telefone" class="form-control" required placeholder="(11) 99999-9999">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">E-mail</label>
                        <input type="email" id="s-email" class="form-control" required placeholder="seu@email.com">
                    </div>
                    
                    <div class="section-title" style="font-size: 1rem; margin: 24px 0 12px;">
                        <i class="fas fa-database"></i> Backup e Restauração
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <button type="button" class="btn-block btn-secondary" onclick="App.backup.exportData()">
                            <i class="fas fa-download"></i> Exportar Backup
                        </button>
                        <button type="button" class="btn-block btn-secondary" onclick="App.backup.exportImoveis()">
                            <i class="fas fa-home"></i> Backup Imóveis
                        </button>
                    </div>
                    
                    <div class="file-input-container">
                        <label for="backup-file" class="file-input-label">
                            <i class="fas fa-upload"></i> Importar Backup Universal
                            <span style="display: block; font-size: 0.8rem; margin-top: 4px;">Arquivo JSON de qualquer versão</span>
                        </label>
                        <input type="file" id="backup-file" class="file-input" accept=".json" onchange="App.backup.importUniversalData(this)">
                    </div>
                    
                    <button type="button" class="btn-block btn-danger" onclick="App.backup.clearData()" style="margin-top: 24px;">
                        <i class="fas fa-trash"></i> Limpar Todos os Dados
                    </button>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button type="button" class="btn-block btn-block-secondary" onclick="UI.closeModal('settings')">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-block">
                            Salvar Configurações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Seleção para Fichas PDF -->
    <div class="modal-overlay" id="modal-select-pdf">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="pdf-modal-title">
                    <i class="fas fa-file-pdf"></i> Selecionar
                </h3>
                <button class="modal-close" onclick="UI.closeModal('select-pdf')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="pdf-select-list">
                <!-- Lista dinâmica -->
            </div>
        </div>
    </div>

    <script>
        // --- INDEXEDDB CONFIGURAÇÃO ---
        const Database = {
            name: 'ImobiManagerPro',
            version: 4,
            db: null,
            
            init: async function() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.name, this.version);
                    
                    request.onerror = (event) => {
                        console.error('Erro ao abrir IndexedDB:', event.target.error);
                        reject(event.target.error);
                    };
                    
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log('IndexedDB conectado com sucesso');
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // Criar object stores se não existirem
                        if (!db.objectStoreNames.contains('clientes')) {
                            db.createObjectStore('clientes', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('imoveis')) {
                            db.createObjectStore('imoveis', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('agenda')) {
                            db.createObjectStore('agenda', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('plantoes')) {
                            db.createObjectStore('plantoes', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('funnel')) {
                            db.createObjectStore('funnel', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'id' });
                        }
                        
                        console.log('Object stores criados com sucesso');
                    };
                });
            },
            
            // Salvar dados
            save: async function(storeName, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    // Se for array, salvar múltiplos itens
                    if (Array.isArray(data)) {
                        const promises = data.map(item => {
                            return new Promise((resolveItem, rejectItem) => {
                                const request = store.put(item);
                                request.onsuccess = () => resolveItem();
                                request.onerror = () => rejectItem(request.error);
                            });
                        });
                        
                        Promise.all(promises)
                            .then(() => resolve())
                            .catch(error => reject(error));
                    } else {
                        // Salvar item único
                        const request = store.put(data);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    }
                });
            },
            
            // Carregar dados
            load: async function(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = (event) => {
                        resolve(event.target.result);
                    };
                    
                    request.onerror = () => {
                        reject(request.error);
                    };
                });
            },
            
            // Limpar store
            clear: async function(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Excluir item
            delete: async function(storeName, id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(id);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        };

        // --- UTILIDADES ---
        const Utils = {
            formatMoney: function(input) {
                if (!input) return;
                
                let value = input.value.replace(/\D/g, '');
                if (value === '') {
                    input.value = '';
                    return;
                }
                
                while (value.length < 3) {
                    value = '0' + value;
                }
                
                const reais = value.slice(0, -2);
                const centavos = value.slice(-2);
                
                let formatted = '';
                if (reais.length > 0) {
                    const reaisFormatado = parseInt(reais).toLocaleString('pt-BR');
                    formatted = reaisFormatado;
                } else {
                    formatted = '0';
                }
                
                input.value = formatted + ',' + centavos;
            },
            
            unformatMoney: function(str) {
                if (!str) return 0;
                let value = str.replace(/\./g, '')
                               .replace(',', '.')
                               .trim();
                return parseFloat(value) || 0;
            },
            
            formatCurrency: function(num) {
                if (typeof num !== 'number') num = 0;
                return num.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            },
            
            isBirthdayToday: function(birthdate) {
                if (!birthdate) return false;
                const hoje = new Date();
                const nascimento = new Date(birthdate);
                return nascimento.getMonth() === hoje.getMonth() && 
                       nascimento.getDate() === hoje.getDate();
            },
            
            generateId: function(prefix = '') {
                return prefix + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            },
            
            initMoneyFields: function() {
                document.querySelectorAll('input[data-money]').forEach(input => {
                    input.addEventListener('blur', function() {
                        if (this.value && !this.value.includes(',')) {
                            Utils.formatMoney(this);
                        }
                    });
                    
                    input.addEventListener('input', function() {
                        Utils.formatMoney(this);
                    });
                });
            },
            
            normalizeNumber: function(num) {
                if (typeof num === 'string') {
                    return parseFloat(num.replace(/\./g, '').replace(',', '.'));
                }
                return num;
            }
        };

        // --- SISTEMA PRINCIPAL ---
        const Sistema = {
            data: {
                clientes: [],
                imoveis: [],
                agenda: [],
                plantoes: [],
                funnel: {
                    stages: [
                        { id: 'lead', name: 'Lead', color: '#0d4a2d', order: 1, icon: 'fas fa-user' },
                        { id: 'prospect', name: 'Prospect', color: '#0f6d3e', order: 2, icon: 'fas fa-user-check' },
                        { id: 'visita', name: 'Visita', color: '#2a5c8b', order: 3, icon: 'fas fa-eye' },
                        { id: 'proposta', name: 'Proposta', color: '#4a7fb8', order: 4, icon: 'fas fa-file-contract' },
                        { id: 'fechado', name: 'Fechado', color: '#d4af37', order: 5, icon: 'fas fa-handshake' }
                    ],
                    metas: {
                        leads: 50,
                        vendas: 5,
                        receita: 500000
                    }
                },
                settings: {
                    id: 'settings',
                    nome: 'Corretor',
                    creci: '00000',
                    telefone: '',
                    email: '',
                    logo: ''
                }
            },
            
            // Inicialização
            init: async function() {
                try {
                    // Inicializar IndexedDB
                    await Database.init();
                    
                    // Verificar e migrar dados do localStorage
                    await this.migrateFromLocalStorage();
                    
                    // Carregar dados do IndexedDB
                    await this.loadDataFromIndexedDB();
                    
                    // Inicializar interface
                    UI.init();
                    this.checkBirthdays();
                    this.updateDashboard();
                    Utils.initMoneyFields();
                    
                    // Atualizar logo se existir
                    if (this.data.settings.logo) {
                        document.getElementById('brand-logo').innerHTML = `
                            <img src="${this.data.settings.logo}" style="height: 32px; width: auto; border-radius: 6px;">
                            <span>ImobiManager Pro</span>
                        `;
                    }
                    
                    // Verificar aniversários hoje
                    const birthdaysToday = this.checkBirthdaysToday();
                    if (birthdaysToday.length > 0) {
                        setTimeout(() => {
                            UI.showToast(`🎉 Hoje é aniversário de ${birthdaysToday.length} cliente(s)! Clique para ver detalhes.`, 'success');
                        }, 1000);
                    }
                    
                } catch (error) {
                    console.error('Erro na inicialização:', error);
                    UI.showToast('Erro ao carregar dados do sistema', 'error');
                }
            },
            
            // Migrar dados do localStorage para IndexedDB
            migrateFromLocalStorage: async function() {
                try {
                    const saved = localStorage.getItem('imobimanager_pro_v3');
                    if (!saved) return;
                    
                    const oldData = JSON.parse(saved);
                    
                    // Migrar clientes
                    if (oldData.clientes && oldData.clientes.length > 0) {
                        await Database.save('clientes', oldData.clientes);
                        console.log(`Migrados ${oldData.clientes.length} clientes do localStorage`);
                    }
                    
                    // Migrar imóveis (com fotos)
                    if (oldData.imoveis && oldData.imoveis.length > 0) {
                        await Database.save('imoveis', oldData.imoveis);
                        console.log(`Migrados ${oldData.imoveis.length} imóveis do localStorage`);
                    }
                    
                    // Migrar agenda
                    if (oldData.agenda && oldData.agenda.length > 0) {
                        await Database.save('agenda', oldData.agenda);
                        console.log(`Migrados ${oldData.agenda.length} agendamentos do localStorage`);
                    }
                    
                    // Migrar plantões
                    if (oldData.plantoes && oldData.plantoes.length > 0) {
                        await Database.save('plantoes', oldData.plantoes);
                        console.log(`Migrados ${oldData.plantoes.length} plantões do localStorage`);
                    }
                    
                    // Migrar funnel
                    if (oldData.funnel) {
                        const funnelData = {
                            id: 'funnel',
                            stages: oldData.funnel.stages || this.data.funnel.stages,
                            metas: oldData.funnel.metas || this.data.funnel.metas
                        };
                        await Database.save('funnel', funnelData);
                        console.log('Configurações do funil migradas do localStorage');
                    }
                    
                    // Migrar settings
                    if (oldData.settings) {
                        const settingsData = {
                            id: 'settings',
                            nome: oldData.settings.nome || 'Corretor',
                            creci: oldData.settings.creci || '00000',
                            telefone: oldData.settings.telefone || '',
                            email: oldData.settings.email || '',
                            logo: oldData.settings.logo || ''
                        };
                        await Database.save('settings', settingsData);
                        console.log('Configurações migradas do localStorage');
                    }
                    
                    // Limpar localStorage após migração
                    localStorage.removeItem('imobimanager_pro_v3');
                    console.log('Dados migrados do localStorage para IndexedDB com sucesso');
                    
                } catch (error) {
                    console.error('Erro na migração do localStorage:', error);
                }
            },
            
            // Carregar dados do IndexedDB
            loadDataFromIndexedDB: async function() {
                try {
                    // Carregar todos os dados
                    const [
                        clientes,
                        imoveis,
                        agenda,
                        plantoes,
                        funnelData,
                        settingsData
                    ] = await Promise.all([
                        Database.load('clientes'),
                        Database.load('imoveis'),
                        Database.load('agenda'),
                        Database.load('plantoes'),
                        Database.load('funnel'),
                        Database.load('settings')
                    ]);
                    
                    // Atualizar dados do sistema
                    this.data.clientes = clientes || [];
                    this.data.imoveis = imoveis || [];
                    this.data.agenda = agenda || [];
                    this.data.plantoes = plantoes || [];
                    
                    // Configurações do funil
                    if (funnelData && funnelData.length > 0) {
                        const funnel = funnelData[0];
                        this.data.funnel.stages = funnel.stages || this.data.funnel.stages;
                        this.data.funnel.metas = funnel.metas || this.data.funnel.metas;
                    }
                    
                    // Configurações gerais
                    if (settingsData && settingsData.length > 0) {
                        this.data.settings = settingsData[0];
                    }
                    
                    // Normalizar valores monetários
                    this.normalizeMoneyValues();
                    
                    console.log('Dados carregados do IndexedDB com sucesso');
                    
                } catch (error) {
                    console.error('Erro ao carregar dados do IndexedDB:', error);
                    throw error;
                }
            },
            
            // Normalizar valores monetários
            normalizeMoneyValues: function() {
                this.data.imoveis.forEach(imovel => {
                    if (typeof imovel.valor === 'string') {
                        imovel.valor = Utils.normalizeNumber(imovel.valor);
                    }
                    if (imovel.condominio && typeof imovel.condominio === 'string') {
                        imovel.condominio = Utils.normalizeNumber(imovel.condominio);
                    }
                    if (imovel.iptu && typeof imovel.iptu === 'string') {
                        imovel.iptu = Utils.normalizeNumber(imovel.iptu);
                    }
                });
                
                this.data.clientes.forEach(cliente => {
                    if (cliente.interesses) {
                        if (cliente.interesses.valorMin && typeof cliente.interesses.valorMin === 'string') {
                            cliente.interesses.valorMin = Utils.normalizeNumber(cliente.interesses.valorMin);
                        }
                        if (cliente.interesses.valorMax && typeof cliente.interesses.valorMax === 'string') {
                            cliente.interesses.valorMax = Utils.normalizeNumber(cliente.interesses.valorMax);
                        }
                    }
                    if (cliente.valorVenda && typeof cliente.valorVenda === 'string') {
                        cliente.valorVenda = Utils.normalizeNumber(cliente.valorVenda);
                    }
                });
                
                if (this.data.funnel && this.data.funnel.metas) {
                    if (typeof this.data.funnel.metas.receita === 'string') {
                        this.data.funnel.metas.receita = Utils.normalizeNumber(this.data.funnel.metas.receita);
                    }
                }
            },
            
            // Salvar dados no IndexedDB
            saveData: async function(dataType, data) {
                try {
                    switch(dataType) {
                        case 'cliente':
                            await Database.save('clientes', data);
                            break;
                        case 'imovel':
                            await Database.save('imoveis', data);
                            break;
                        case 'agenda':
                            await Database.save('agenda', data);
                            break;
                        case 'plantao':
                            await Database.save('plantoes', data);
                            break;
                        case 'funnel':
                            const funnelData = { id: 'funnel', ...data };
                            await Database.save('funnel', funnelData);
                            break;
                        case 'settings':
                            const settingsData = { id: 'settings', ...data };
                            await Database.save('settings', settingsData);
                            break;
                    }
                } catch (error) {
                    console.error('Erro ao salvar dados no IndexedDB:', error);
                    throw error;
                }
            },
            
            // Verificar aniversários do mês
            checkBirthdays: function() {
                const hoje = new Date();
                const mesAtual = hoje.getMonth() + 1;
                
                return this.data.clientes.filter(cliente => {
                    if (!cliente.nascimento) return false;
                    const [ano, mes, dia] = cliente.nascimento.split('-');
                    return parseInt(mes) === mesAtual;
                });
            },
            
            // Verificar aniversários hoje
            checkBirthdaysToday: function() {
                const hoje = new Date();
                return this.data.clientes.filter(cliente => {
                    if (!cliente.nascimento) return false;
                    const [ano, mes, dia] = cliente.nascimento.split('-');
                    return parseInt(mes) === hoje.getMonth() + 1 && 
                           parseInt(dia) === hoje.getDate();
                });
            },
            
            // Atualizar dashboard
            updateDashboard: function() {
                const hoje = new Date();
                const mesAtual = hoje.getMonth() + 1;
                const anoAtual = hoje.getFullYear();
                
                const stats = {
                    totalClientes: this.data.clientes.length,
                    totalImoveis: this.data.imoveis.length,
                    vendasMes: this.data.clientes.filter(c => 
                        c.status === 'fechado' && 
                        c.dataFechamento &&
                        c.dataFechamento.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                    ).length,
                    receitaMes: this.data.clientes
                        .filter(c => c.status === 'fechado' && c.valorVenda && c.dataFechamento && 
                        c.dataFechamento.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`))
                        .reduce((acc, c) => acc + (c.valorVenda || 0), 0),
                    agendaHoje: this.data.agenda.filter(a => 
                        a.data === hoje.toISOString().split('T')[0]
                    ).length,
                    leadsAtivos: this.data.clientes.filter(c => 
                        c.status === 'lead' || c.status === 'prospect'
                    ).length,
                    aniversariosMes: this.checkBirthdays().length,
                    aniversariosHoje: this.checkBirthdaysToday().length,
                    plantoesMes: this.data.plantoes.filter(p => {
                        const data = new Date(p.data);
                        return data.getMonth() === hoje.getMonth() && data.getFullYear() === hoje.getFullYear();
                    }).length
                };
                
                return stats;
            }
        };

        // --- INTERFACE DO USUÁRIO ---
        const UI = {
            currentView: 'dashboard',
            fabOpen: false,
            currentPhotoIndex: 0,
            currentPhotoImovelId: null,
            calendarDate: new Date(),
            selectedClientesPlantao: [],
            isPhotoZoomed: false,
            
            init: function() {
                this.renderDashboard();
                this.setupEventListeners();
                this.setupAccordions();
            },
            
            setupEventListeners: function() {
                document.querySelectorAll('.bottom-nav a').forEach(link => {
                    link.addEventListener('click', e => e.preventDefault());
                });
                
                document.addEventListener('keydown', (e) => {
                    const photoViewer = document.getElementById('photo-viewer');
                    if (photoViewer.classList.contains('active')) {
                        if (e.key === 'ArrowLeft') {
                            this.prevPhoto();
                        } else if (e.key === 'ArrowRight') {
                            this.nextPhoto();
                        } else if (e.key === 'Escape') {
                            this.closePhotoViewer();
                        }
                    }
                });
                
                const photoViewer = document.getElementById('photo-viewer');
                let touchStartX = 0;
                
                photoViewer.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                });
                
                photoViewer.addEventListener('touchend', (e) => {
                    const touchEndX = e.changedTouches[0].screenX;
                    const diffX = touchStartX - touchEndX;
                    
                    if (Math.abs(diffX) > 50) {
                        if (diffX > 0) {
                            this.nextPhoto();
                        } else {
                            this.prevPhoto();
                        }
                    }
                });
                
                const fullscreenPhoto = document.getElementById('fullscreen-photo');
                fullscreenPhoto.addEventListener('dblclick', (e) => {
                    this.togglePhotoZoom();
                });
            },
            
            setupAccordions: function() {
                document.querySelectorAll('.accordion').forEach(accordion => {
                    const header = accordion.querySelector('.accordion-header');
                    const icon = header.querySelector('.fa-chevron-down, .fa-chevron-up');
                    
                    if (accordion.classList.contains('active')) {
                        if (icon) {
                            icon.classList.remove('fa-chevron-down');
                            icon.classList.add('fa-chevron-up');
                        }
                        const content = accordion.querySelector('.accordion-content');
                        if (content) {
                            content.style.maxHeight = '1000px';
                            content.style.padding = '16px';
                        }
                    }
                    
                    header.onclick = (e) => {
                        e.stopPropagation();
                        this.toggleAccordion(accordion.id);
                    };
                });
            },
            
            switchTab: function(element) {
                document.querySelectorAll('.nav-item').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.querySelectorAll('.view').forEach(view => {
                    view.classList.remove('active');
                });
                
                element.classList.add('active');
                const target = element.getAttribute('data-target');
                document.getElementById(target).classList.add('active');
                this.currentView = target;
                this.updateView(target);
                this.updateFab();
            },
            
            updateView: function(viewId) {
                switch(viewId) {
                    case 'dashboard-view':
                        this.renderDashboard();
                        break;
                    case 'clientes-view':
                        this.renderClientes();
                        break;
                    case 'imoveis-view':
                        this.renderImoveis();
                        break;
                    case 'funil-view':
                        Funnel.render();
                        break;
                    case 'agenda-view':
                        this.renderCalendar();
                        break;
                    case 'relatorios-view':
                        Relatorios.render();
                        break;
                }
            },
            
            updateFab: function() {
                const fab = document.getElementById('main-fab');
                const submenu = document.getElementById('fab-submenu');
                
                submenu.classList.remove('active');
                this.fabOpen = false;
                
                let html = '';
                
                switch(this.currentView) {
                    case 'dashboard-view':
                        html = `
                            <button class="fab-sub-btn" onclick="UI.showModal('cliente', 'new')" title="Novo Cliente">
                                <i class="fas fa-user-plus"></i>
                            </button>
                            <button class="fab-sub-btn" onclick="UI.showModal('imovel', 'new')" title="Novo Imóvel">
                                <i class="fas fa-home"></i>
                            </button>
                            <button class="fab-sub-btn" onclick="UI.showModal('metas')" title="Metas">
                                <i class="fas fa-bullseye"></i>
                            </button>
                        `;
                        break;
                    case 'clientes-view':
                        html = `
                            <button class="fab-sub-btn" onclick="UI.showModal('cliente', 'new')" title="Novo Cliente">
                                <i class="fas fa-user-plus"></i>
                            </button>
                        `;
                        break;
                    case 'imoveis-view':
                        html = `
                            <button class="fab-sub-btn" onclick="UI.showModal('imovel', 'new')" title="Novo Imóvel">
                                <i class="fas fa-home"></i>
                            </button>
                        `;
                        break;
                    case 'agenda-view':
                        html = `
                            <button class="fab-sub-btn" onclick="UI.showAgendaModalForDate(null)" title="Novo Agendamento">
                                <i class="fas fa-calendar-plus"></i>
                            </button>
                        `;
                        break;
                }
                
                submenu.innerHTML = html;
            },
            
            toggleFabMenu: function() {
                const submenu = document.getElementById('fab-submenu');
                this.fabOpen = !this.fabOpen;
                
                if (this.fabOpen) {
                    submenu.classList.add('active');
                } else {
                    submenu.classList.remove('active');
                }
            },
            
            // Renderização de Views
            renderDashboard: function() {
                const stats = Sistema.updateDashboard();
                
                document.getElementById('quick-stats').innerHTML = `
                    <div class="quick-stat" onclick="UI.switchTab(document.querySelector('[data-target=\\'clientes-view\\']'))">
                        <div class="quick-stat-value" style="color: var(--primary);">${stats.totalClientes}</div>
                        <div class="quick-stat-label">Clientes</div>
                    </div>
                    <div class="quick-stat" onclick="UI.switchTab(document.querySelector('[data-target=\\'imoveis-view\\']'))">
                        <div class="quick-stat-value" style="color: var(--secondary);">${stats.totalImoveis}</div>
                        <div class="quick-stat-label">Imóveis</div>
                    </div>
                    <div class="quick-stat" onclick="UI.switchTab(document.querySelector('[data-target=\\'funil-view\\']'))">
                        <div class="quick-stat-value" style="color: var(--accent);">${stats.vendasMes}</div>
                        <div class="quick-stat-label">Vendas</div>
                    </div>
                    <div class="quick-stat" onclick="UI.switchTab(document.querySelector('[data-target=\\'agenda-view\\']'))">
                        <div class="quick-stat-value" style="color: var(--primary);">${stats.agendaHoje}</div>
                        <div class="quick-stat-label">Agenda</div>
                    </div>
                `;
                
                const birthdays = Sistema.checkBirthdays();
                const birthdayList = document.getElementById('birthday-list');
                const birthdayCount = document.getElementById('birthday-count');
                
                if (birthdays.length > 0) {
                    birthdayCount.style.display = 'inline-block';
                    birthdayCount.textContent = birthdays.length;
                    
                    const birthdaysToday = Sistema.checkBirthdaysToday();
                    const todayCount = birthdaysToday.length;
                    
                    if (todayCount > 0) {
                        birthdayList.innerHTML = `
                            <div class="list-card birthday" style="border-left-color: #e74c3c; cursor: pointer;" onclick="UI.showBirthdaysList()">
                                <div class="card-header">
                                    <div class="card-title">🎉 ${todayCount} Aniversário(s) Hoje!</div>
                                    <span class="birthday-badge birthday-today">HOJE!</span>
                                </div>
                                <div class="card-subtitle">
                                    <i class="fas fa-birthday-cake"></i> Clique para ver detalhes
                                </div>
                            </div>
                        `;
                    } else {
                        birthdayList.innerHTML = birthdays.slice(0, 2).map(cliente => `
                            <div class="list-card birthday" onclick="App.cliente.showDetails('${cliente.id}')">
                                <div class="card-header">
                                    <div class="card-title">${cliente.nome}</div>
                                    ${Utils.isBirthdayToday(cliente.nascimento) ? 
                                        `<span class="birthday-badge birthday-today">HOJE!</span>` : 
                                        `<span class="birthday-badge">Aniversário</span>`
                                    }
                                </div>
                                <div class="card-subtitle">
                                    <i class="fas fa-phone"></i> ${cliente.telefone}
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    birthdayList.innerHTML = '<div class="empty-state"><p>Nenhum aniversário este mês</p></div>';
                    birthdayCount.style.display = 'none';
                }
                
                const hoje = new Date().toISOString().split('T')[0];
                const agendaHoje = Sistema.data.agenda.filter(a => a.data === hoje);
                const agendaList = document.getElementById('agenda-today-list');
                
                if (agendaHoje.length > 0) {
                    agendaList.innerHTML = agendaHoje.slice(0, 3).map(agenda => {
                        const cliente = Sistema.data.clientes.find(c => c.id === agenda.clienteId) || { nome: 'Cliente' };
                        return `
                            <div class="list-card" onclick="App.agenda.showDetails('${agenda.id}')">
                                <div class="card-header">
                                    <div class="card-title">${agenda.tipo} - ${cliente.nome}</div>
                                    <span class="tag tag-primary">${agenda.horario}</span>
                                </div>
                                <div class="card-subtitle">
                                    <i class="fas fa-map-marker-alt"></i> ${agenda.local || 'Local não informado'}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    agendaList.innerHTML = '<div class="empty-state"><p>Nenhum agendamento para hoje</p></div>';
                }
                
                Funnel.renderOverview();
            },
            
            showBirthdaysList: function() {
                const birthdays = Sistema.checkBirthdays();
                const birthdaysToday = Sistema.checkBirthdaysToday();
                
                let html = '<div style="padding: 20px;">';
                html += '<h3 style="margin-bottom: 16px;">🎂 Aniversários do Mês</h3>';
                
                if (birthdaysToday.length > 0) {
                    html += '<h4 style="color: #e74c3c; margin-bottom: 12px;">🎉 Aniversariantes de Hoje</h4>';
                    html += birthdaysToday.map(cliente => `
                        <div class="list-card birthday" style="margin-bottom: 12px; border-left-color: #e74c3c;">
                            <div class="card-header">
                                <div class="card-title">${cliente.nome}</div>
                                <span class="birthday-badge birthday-today">HOJE!</span>
                            </div>
                            <div class="card-subtitle">
                                <i class="fas fa-phone"></i> ${cliente.telefone}
                            </div>
                            <div class="action-row">
                                <button class="btn-sm btn-warning" onclick="App.whatsapp.sendBirthdayMessage('${cliente.id}')">
                                    <i class="fab fa-whatsapp"></i> Parabéns
                                </button>
                                <button class="btn-sm btn-primary" onclick="App.cliente.showDetails('${cliente.id}')">
                                    <i class="fas fa-eye"></i> Detalhes
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
                
                if (birthdays.length > birthdaysToday.length) {
                    html += '<h4 style="margin-top: 20px; margin-bottom: 12px;">Outros Aniversários do Mês</h4>';
                    const outrosAniversarios = birthdays.filter(c => !Utils.isBirthdayToday(c.nascimento));
                    html += outrosAniversarios.map(cliente => {
                        const nascimento = new Date(cliente.nascimento);
                        const dia = nascimento.getDate();
                        return `
                            <div class="list-card" style="margin-bottom: 12px;">
                                <div class="card-header">
                                    <div class="card-title">${cliente.nome}</div>
                                    <span class="tag tag-warning">Dia ${dia}</span>
                                </div>
                                <div class="card-subtitle">
                                    <i class="fas fa-phone"></i> ${cliente.telefone}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                html += '</div>';
                
                const tempModal = document.createElement('div');
                tempModal.className = 'modal-overlay active';
                tempModal.innerHTML = `
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">
                                <i class="fas fa-birthday-cake"></i> Aniversários
                            </h3>
                            <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.classList.remove('active')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            ${html}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(tempModal);
                document.body.style.overflow = 'hidden';
            },
            
            renderClientes: function(filter = '') {
                let clientes = Sistema.data.clientes;
                
                if (filter) {
                    clientes = clientes.filter(c => 
                        c.nome.toLowerCase().includes(filter.toLowerCase()) ||
                        c.telefone.includes(filter) ||
                        (c.email && c.email.toLowerCase().includes(filter.toLowerCase()))
                    );
                }
                
                const clientesList = document.getElementById('clientes-list');
                
                if (clientes.length === 0) {
                    clientesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-user-plus"></i>
                            <p>Nenhum cliente cadastrado</p>
                            <button class="btn-block" onclick="UI.showModal('cliente', 'new')" style="margin-top: 20px;">
                                <i class="fas fa-plus"></i> Adicionar Primeiro Cliente
                            </button>
                        </div>
                    `;
                } else {
                    clientesList.innerHTML = clientes.map(cliente => {
                        const isBirthdayToday = Utils.isBirthdayToday(cliente.nascimento);
                        
                        return `
                            <div class="list-card ${isBirthdayToday ? 'birthday' : ''}" onclick="App.cliente.showDetails('${cliente.id}')">
                                <div class="card-header">
                                    <div class="card-title">${cliente.nome}</div>
                                    ${isBirthdayToday ? `
                                        <span class="birthday-badge birthday-today">
                                            <i class="fas fa-birthday-cake"></i> Hoje!
                                        </span>
                                    ` : ''}
                                </div>
                                <div class="card-subtitle">
                                    <i class="fas fa-phone"></i> ${cliente.telefone}
                                </div>
                                <div class="action-row">
                                    <button class="btn-sm btn-primary" onclick="event.stopPropagation(); App.cliente.edit('${cliente.id}')">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button class="btn-sm btn-success" onclick="event.stopPropagation(); App.whatsapp.openConversa('${cliente.id}')">
                                        <i class="fab fa-whatsapp"></i> WhatsApp
                                    </button>
                                    <button class="btn-sm btn-secondary" onclick="event.stopPropagation(); App.cliente.generatePDF('${cliente.id}')">
                                        <i class="fas fa-file-pdf"></i> PDF
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            },
            
            renderImoveis: function(filter = '') {
                let imoveis = Sistema.data.imoveis;
                
                if (filter) {
                    imoveis = imoveis.filter(i => 
                        i.nome.toLowerCase().includes(filter.toLowerCase()) ||
                        (i.logradouro && i.logradouro.toLowerCase().includes(filter.toLowerCase())) ||
                        (i.bairro && i.bairro.toLowerCase().includes(filter.toLowerCase()))
                    );
                }
                
                const imoveisList = document.getElementById('imoveis-list');
                
                if (imoveis.length === 0) {
                    imoveisList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-home"></i>
                            <p>Nenhum imóvel cadastrado</p>
                            <button class="btn-block" onclick="UI.showModal('imovel', 'new')" style="margin-top: 20px;">
                                <i class="fas fa-plus"></i> Adicionar Primeiro Imóvel
                            </button>
                        </div>
                    `;
                } else {
                    imoveisList.innerHTML = imoveis.map(imovel => `
                        <div class="list-card" onclick="App.imovel.showDetails('${imovel.id}')">
                            <div class="card-header">
                                <div class="card-title">${imovel.nome}</div>
                                <span class="tag tag-success">${Utils.formatCurrency(imovel.valor)}</span>
                            </div>
                            ${imovel.fotos && imovel.fotos.length > 0 ? `
                                <div class="imovel-photos">
                                    ${imovel.fotos.slice(0, 3).map((foto, index) => `
                                        <img src="${foto}" class="imovel-photo" onclick="event.stopPropagation(); UI.viewPhoto('${imovel.id}', ${index})">
                                    `).join('')}
                                </div>
                            ` : ''}
                            <div class="action-row">
                                <button class="btn-sm btn-primary" onclick="event.stopPropagation(); App.imovel.edit('${imovel.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn-sm btn-success" onclick="event.stopPropagation(); App.whatsapp.shareImovel('${imovel.id}')">
                                    <i class="fab fa-whatsapp"></i> Compartilhar
                                </button>
                                <button class="btn-sm btn-secondary" onclick="event.stopPropagation(); App.imovel.generatePDF('${imovel.id}')">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            },
            
            renderCalendar: function() {
                const hoje = new Date();
                const year = this.calendarDate.getFullYear();
                const month = this.calendarDate.getMonth();
                
                const monthNames = [
                    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const firstDayWeekday = firstDay.getDay();
                const totalDays = lastDay.getDate();
                
                let calendarHTML = `
                    <div class="calendar-header">
                        <div class="calendar-title">${monthNames[month]} ${year}</div>
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" onclick="UI.prevMonth()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="calendar-nav-btn" onclick="UI.todayCalendar()">
                                Hoje
                            </button>
                            <button class="calendar-nav-btn" onclick="UI.nextMonth()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="calendar-weekdays">
                        <div>Dom</div>
                        <div>Seg</div>
                        <div>Ter</div>
                        <div>Qua</div>
                        <div>Qui</div>
                        <div>Sex</div>
                        <div>Sáb</div>
                    </div>
                    
                    <div class="calendar-days">
                `;
                
                for (let i = 0; i < firstDayWeekday; i++) {
                    calendarHTML += `<div class="calendar-day other-month"></div>`;
                }
                
                for (let day = 1; day <= totalDays; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const events = Sistema.data.agenda.filter(a => a.data === dateStr);
                    const hasEvent = events.length > 0;
                    const isToday = hoje.getDate() === day && hoje.getMonth() === month && hoje.getFullYear() === year;
                    const classes = ['calendar-day'];
                    
                    if (isToday) classes.push('today');
                    if (hasEvent) classes.push('has-event');
                    
                    calendarHTML += `
                        <div class="${classes.join(' ')}" onclick="UI.selectDateAndOpenModal('${dateStr}')">
                            ${day}
                            ${hasEvent ? `<div style="position: absolute; bottom: 2px; width: 4px; height: 4px; background: var(--primary); border-radius: 50%;"></div>` : ''}
                        </div>
                    `;
                }
                
                const totalCells = 42;
                const usedCells = firstDayWeekday + totalDays;
                for (let i = usedCells; i < totalCells; i++) {
                    calendarHTML += `<div class="calendar-day other-month"></div>`;
                }
                
                calendarHTML += `</div>`;
                
                document.getElementById('calendar-container').innerHTML = calendarHTML;
                this.showDayEvents(hoje.toISOString().split('T')[0]);
            },
            
            selectDateAndOpenModal: function(dateStr) {
                this.selectDate(dateStr);
                this.showAgendaModalForDate(dateStr);
            },
            
            showDayEvents: function(dateStr) {
                const events = Sistema.data.agenda.filter(a => a.data === dateStr);
                const date = new Date(dateStr);
                const formattedDate = date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
                
                let eventsHTML = '';
                
                if (events.length === 0) {
                    eventsHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-day"></i>
                            <p>Nenhum agendamento para ${formattedDate}</p>
                            <button class="btn-block" onclick="UI.showAgendaModalForDate('${dateStr}')" style="margin-top: 20px;">
                                <i class="fas fa-plus"></i> Novo Agendamento
                            </button>
                        </div>
                    `;
                } else {
                    eventsHTML = `
                        <div class="section-title">
                            <i class="fas fa-calendar-day"></i> Agendamentos para ${formattedDate}
                            <button class="btn-sm btn-primary" onclick="UI.showAgendaModalForDate('${dateStr}')">
                                <i class="fas fa-plus"></i> Novo
                            </button>
                        </div>
                    `;
                    
                    events.forEach(event => {
                        const cliente = Sistema.data.clientes.find(c => c.id === event.clienteId) || { nome: 'Cliente' };
                        const imovel = event.imovelId ? Sistema.data.imoveis.find(i => i.id === event.imovelId) : null;
                        
                        eventsHTML += `
                            <div class="calendar-event-item" onclick="App.agenda.showDetails('${event.id}')">
                                <div class="calendar-event-time">
                                    <i class="fas fa-clock"></i> ${event.horario}
                                </div>
                                <div class="calendar-event-title">${event.tipo} - ${cliente.nome}</div>
                                ${imovel ? `
                                    <div style="font-size: 0.8rem; color: var(--secondary); margin-top: 4px;">
                                        <i class="fas fa-home"></i> ${imovel.nome}
                                    </div>
                                ` : ''}
                                <div style="margin-top: 8px;">
                                    <span class="badge ${event.status === 'confirmado' ? 'badge-success' : event.status === 'cancelado' ? 'badge-danger' : 'badge-primary'}">
                                        ${event.status}
                                    </span>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('agenda-list').innerHTML = eventsHTML;
            },
            
            selectDate: function(dateStr) {
                document.querySelectorAll('.calendar-day.selected').forEach(day => {
                    day.classList.remove('selected');
                });
                
                const dayElement = document.querySelector(`.calendar-day[onclick*="${dateStr}"]`);
                if (dayElement) {
                    dayElement.classList.add('selected');
                }
                
                this.showDayEvents(dateStr);
            },
            
            prevMonth: function() {
                this.calendarDate.setMonth(this.calendarDate.getMonth() - 1);
                this.renderCalendar();
            },
            
            nextMonth: function() {
                this.calendarDate.setMonth(this.calendarDate.getMonth() + 1);
                this.renderCalendar();
            },
            
            todayCalendar: function() {
                this.calendarDate = new Date();
                this.renderCalendar();
            },
            
            showAgendaModalForDate: function(dateStr) {
                this.showModal('agenda-generico');
                setTimeout(() => {
                    if (dateStr) {
                        const dateInput = document.getElementById('a-data');
                        if (dateInput) {
                            dateInput.value = dateStr;
                        }
                    }
                }, 100);
            },
            
            searchClientes: function(term) {
                this.renderClientes(term);
            },
            
            searchImoveis: function(term) {
                this.renderImoveis(term);
            },
            
            // Modais
            showModal: function(type, action = 'new', id = null) {
                const modal = document.getElementById(`modal-${type}`);
                
                switch(type) {
                    case 'cliente':
                        if (action === 'new') {
                            document.getElementById('modal-cliente-title').innerHTML = '<i class="fas fa-user-plus"></i> Novo Cliente';
                            this.resetClienteForm();
                        } else if (action === 'edit' && id) {
                            App.cliente.edit(id);
                        }
                        break;
                        
                    case 'imovel':
                        if (action === 'new') {
                            document.getElementById('modal-imovel-title').innerHTML = '<i class="fas fa-home"></i> Novo Imóvel';
                            this.resetImovelForm();
                            
                            const hoje = new Date().toISOString().split('T')[0];
                            document.getElementById('i-data-entrega').value = hoje;
                        } else if (action === 'edit' && id) {
                            App.imovel.edit(id);
                        }
                        break;
                        
                    case 'agenda-generico':
                        this.showAgendaModal();
                        break;
                        
                    case 'metas':
                        document.getElementById('meta-leads').value = Sistema.data.funnel.metas.leads;
                        document.getElementById('meta-vendas').value = Sistema.data.funnel.metas.vendas;
                        document.getElementById('meta-receita').value = Utils.formatCurrency(Sistema.data.funnel.metas.receita);
                        break;
                }
                
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                setTimeout(() => {
                    this.setupAccordionsForModal(modal);
                    Utils.initMoneyFields();
                }, 10);
            },
            
            setupAccordionsForModal: function(modal) {
                const accordions = modal.querySelectorAll('.accordion');
                accordions.forEach(accordion => {
                    const header = accordion.querySelector('.accordion-header');
                    const icon = header.querySelector('.fa-chevron-down, .fa-chevron-up');
                    
                    header.onclick = (e) => {
                        e.stopPropagation();
                        this.toggleAccordion(accordion.id);
                    };
                    
                    if (accordion.classList.contains('active')) {
                        if (icon) {
                            icon.classList.remove('fa-chevron-down');
                            icon.classList.add('fa-chevron-up');
                        }
                        const content = accordion.querySelector('.accordion-content');
                        if (content) {
                            content.style.maxHeight = '1000px';
                            content.style.padding = '16px';
                        }
                    }
                });
            },
            
            resetClienteForm: function() {
                const fields = [
                    'c-id', 'c-nome', 'c-cpf', 'c-nascimento', 'c-email',
                    'c-telefone', 'c-telefone2', 'c-logradouro', 'c-numero',
                    'c-complemento', 'c-bairro', 'c-cidade', 'c-cep',
                    'c-tipo-interesse', 'c-valor-min', 'c-valor-max',
                    'c-bairros-interesse', 'c-fonte', 'c-observacoes'
                ];
                
                fields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = false;
                        } else if (element.tagName === 'SELECT') {
                            element.selectedIndex = 0;
                        } else {
                            element.value = '';
                        }
                    }
                });
                
                document.getElementById('c-estado').value = '';
                document.getElementById('c-status').value = 'lead';
                
                document.querySelectorAll('#modal-cliente .accordion').forEach(acc => {
                    acc.classList.remove('active');
                    const icon = acc.querySelector('.fa-chevron-down, .fa-chevron-up');
                    if (icon) {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                    const content = acc.querySelector('.accordion-content');
                    if (content) {
                        content.style.maxHeight = '0';
                        content.style.padding = '0';
                    }
                });
                
                const firstAccordion = document.getElementById('cliente-dados-pessoais');
                firstAccordion.classList.add('active');
                const firstIcon = firstAccordion.querySelector('.fa-chevron-down');
                if (firstIcon) {
                    firstIcon.classList.remove('fa-chevron-down');
                    firstIcon.classList.add('fa-chevron-up');
                }
                const firstContent = firstAccordion.querySelector('.accordion-content');
                if (firstContent) {
                    firstContent.style.maxHeight = '1000px';
                    firstContent.style.padding = '16px';
                }
            },
            
            resetImovelForm: function() {
                const fields = [
                    'i-id', 'i-nome', 'i-tipo', 'i-finalidade', 'i-valor',
                    'i-condominio', 'i-iptu', 'i-logradouro', 'i-numero',
                    'i-complemento', 'i-bairro', 'i-cidade', 'i-cep',
                    'i-area-total', 'i-area-construida', 'i-quartos',
                    'i-suites', 'i-banheiros', 'i-vagas', 'i-mobiliado',
                    'i-status', 'i-observacoes', 'i-data-entrega'
                ];
                
                fields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = false;
                        } else if (element.tagName === 'SELECT') {
                            element.selectedIndex = 0;
                        } else {
                            element.value = '';
                        }
                    }
                });
                
                document.getElementById('i-estado').value = '';
                document.getElementById('i-status').value = 'disponivel';
                
                App.imovel.fotosTemporarias = [];
                document.getElementById('imovel-photos-preview').innerHTML = '';
                
                document.querySelectorAll('#modal-imovel .accordion').forEach(acc => {
                    acc.classList.remove('active');
                    const icon = acc.querySelector('.fa-chevron-down, .fa-chevron-up');
                    if (icon) {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                    const content = acc.querySelector('.accordion-content');
                    if (content) {
                        content.style.maxHeight = '0';
                        content.style.padding = '0';
                    }
                });
                
                const firstAccordion = document.getElementById('imovel-basico');
                firstAccordion.classList.add('active');
                const firstIcon = firstAccordion.querySelector('.fa-chevron-down');
                if (firstIcon) {
                    firstIcon.classList.remove('fa-chevron-down');
                    firstIcon.classList.add('fa-chevron-up');
                }
                const firstContent = firstAccordion.querySelector('.accordion-content');
                if (firstContent) {
                    firstContent.style.maxHeight = '1000px';
                    firstContent.style.padding = '16px';
                }
            },
            
            showAgendaModal: function() {
                const modalBody = document.getElementById('modal-agenda-body');
                modalBody.innerHTML = `
                    <form id="form-agenda" onsubmit="App.agenda.save(event)">
                        <input type="hidden" id="a-id">
                        <div class="form-group">
                            <label class="form-label required">Tipo de Agendamento</label>
                            <select id="a-tipo" class="form-control" required onchange="UI.updateAgendaFields()">
                                <option value="">Selecione...</option>
                                <option value="visita">Visita ao Imóvel</option>
                                <option value="reuniao">Reunião</option>
                                <option value="assinatura">Assinatura de Contrato</option>
                                <option value="plantao">Plantão</option>
                                <option value="followup">Follow-up</option>
                                <option value="proposta">Apresentação de Proposta</option>
                                <option value="negociacao">Negociação</option>
                                <option value="captacao">Captação de Imóvel</option>
                                <option value="vistoria">Vistoria</option>
                                <option value="entrega">Entrega de Chaves</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                        
                        <div id="agenda-fields">
                            <!-- Campos específicos serão carregados aqui -->
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">Data</label>
                            <input type="date" id="a-data" class="form-control" required value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Horário</label>
                            <input type="time" id="a-horario" class="form-control" required value="14:00">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Local</label>
                            <input type="text" id="a-local" class="form-control" required placeholder="Endereço ou local do agendamento">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Observações</label>
                            <textarea id="a-observacoes" class="form-control" rows="3" placeholder="Detalhes importantes sobre o agendamento..."></textarea>
                        </div>
                    </form>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button type="button" class="btn-block btn-block-secondary" onclick="UI.closeModal('agenda-generico')">
                            Cancelar
                        </button>
                        <button type="submit" form="form-agenda" class="btn-block">
                            Salvar Agendamento
                        </button>
                    </div>
                `;
                
                this.updateAgendaFields();
                
                setTimeout(() => {
                    this.setupAccordionsForModal(document.getElementById('modal-agenda-generico'));
                }, 10);
            },
            
            updateAgendaFields: function() {
                const tipo = document.getElementById('a-tipo')?.value;
                const fieldsDiv = document.getElementById('agenda-fields');
                
                if (!fieldsDiv) return;
                
                let fieldsHTML = '';
                
                switch(tipo) {
                    case 'visita':
                        fieldsHTML = `
                            <div class="form-group">
                                <label class="form-label required">Cliente</label>
                                <select id="a-cliente" class="form-control" required>
                                    <option value="">Selecione...</option>
                                    ${Sistema.data.clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">Imóvel para Visita</label>
                                <select id="a-imovel" class="form-control" required>
                                    <option value="">Selecione...</option>
                                    ${Sistema.data.imoveis.map(i => `<option value="${i.id}">${i.nome}</option>`).join('')}
                                </select>
                            </div>
                        `;
                        break;
                        
                    case 'plantao':
                        this.selectedClientesPlantao = [];
                        
                        fieldsHTML = `
                            <div class="form-group">
                                <label class="form-label required">Empreendimento</label>
                                <input type="text" id="a-empreendimento" class="form-control" required placeholder="Nome do empreendimento...">
                            </div>
                            <div class="form-group">
                                <label class="form-label required">Período</label>
                                <select id="a-periodo" class="form-control" required>
                                    <option value="">Selecione...</option>
                                    <option value="manha">Manhã (08:00 - 12:00)</option>
                                    <option value="tarde">Tarde (13:00 - 18:00)</option>
                                    <option value="noite">Noite (18:00 - 22:00)</option>
                                    <option value="integral">Integral (08:00 - 18:00)</option>
                                </select>
                            </div>
                        `;
                        break;
                        
                    default:
                        fieldsHTML = `
                            <div class="form-group">
                                <label class="form-label required">Cliente</label>
                                <select id="a-cliente" class="form-control" required>
                                    <option value="">Selecione...</option>
                                    ${Sistema.data.clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('')}
                                </select>
                            </div>
                        `;
                        break;
                }
                
                fieldsDiv.innerHTML = fieldsHTML;
            },
            
            closeModal: function(type) {
                const modal = document.getElementById(`modal-${type}`);
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
                
                if (type === 'agenda-generico') {
                    this.selectedClientesPlantao = [];
                }
            },
            
            toggleAccordion: function(id) {
                const accordion = document.getElementById(id);
                if (!accordion) return;
                
                const icon = accordion.querySelector('.accordion-header .fa-chevron-down, .accordion-header .fa-chevron-up');
                const content = accordion.querySelector('.accordion-content');
                
                if (accordion.classList.contains('active')) {
                    accordion.classList.remove('active');
                    if (icon) {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                    if (content) {
                        content.style.maxHeight = '0';
                        content.style.padding = '0';
                    }
                } else {
                    accordion.classList.add('active');
                    if (icon) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    }
                    if (content) {
                        content.style.maxHeight = '1000px';
                        content.style.padding = '16px';
                    }
                }
            },
            
            // Visualizador de fotos
            viewPhoto: function(imovelId, photoIndex) {
                const imovel = Sistema.data.imoveis.find(i => i.id === imovelId);
                if (imovel && imovel.fotos && imovel.fotos[photoIndex]) {
                    this.currentPhotoImovelId = imovelId;
                    this.currentPhotoIndex = photoIndex;
                    this.isPhotoZoomed = false;
                    
                    const viewer = document.getElementById('photo-viewer');
                    const img = document.getElementById('fullscreen-photo');
                    const counter = document.getElementById('photo-counter');
                    
                    img.src = imovel.fotos[photoIndex];
                    counter.textContent = `${photoIndex + 1}/${imovel.fotos.length}`;
                    
                    img.style.transform = 'scale(1)';
                    img.style.cursor = 'grab';
                    viewer.classList.remove('zoomed');
                    
                    viewer.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    document.body.style.position = 'fixed';
                }
            },
            
            togglePhotoZoom: function() {
                const img = document.getElementById('fullscreen-photo');
                const viewer = document.getElementById('photo-viewer');
                
                this.isPhotoZoomed = !this.isPhotoZoomed;
                
                if (this.isPhotoZoomed) {
                    img.style.transform = 'scale(2)';
                    img.style.cursor = 'grabbing';
                    viewer.classList.add('zoomed');
                } else {
                    img.style.transform = 'scale(1)';
                    img.style.cursor = 'grab';
                    viewer.classList.remove('zoomed');
                }
            },
            
            nextPhoto: function() {
                if (this.currentPhotoImovelId === null) return;
                
                const imovel = Sistema.data.imoveis.find(i => i.id === this.currentPhotoImovelId);
                if (!imovel || !imovel.fotos) return;
                
                this.currentPhotoIndex = (this.currentPhotoIndex + 1) % imovel.fotos.length;
                this.updatePhotoViewer();
            },
            
            prevPhoto: function() {
                if (this.currentPhotoImovelId === null) return;
                
                const imovel = Sistema.data.imoveis.find(i => i.id === this.currentPhotoImovelId);
                if (!imovel || !imovel.fotos) return;
                
                this.currentPhotoIndex = this.currentPhotoIndex === 0 ? 
                    imovel.fotos.length - 1 : this.currentPhotoIndex - 1;
                this.updatePhotoViewer();
            },
            
            updatePhotoViewer: function() {
                const imovel = Sistema.data.imoveis.find(i => i.id === this.currentPhotoImovelId);
                if (!imovel || !imovel.fotos[this.currentPhotoIndex]) return;
                
                const img = document.getElementById('fullscreen-photo');
                const counter = document.getElementById('photo-counter');
                
                img.src = imovel.fotos[this.currentPhotoIndex];
                counter.textContent = `${this.currentPhotoIndex + 1}/${imovel.fotos.length}`;
                
                this.isPhotoZoomed = false;
                img.style.transform = 'scale(1)';
                img.style.cursor = 'grab';
                document.getElementById('photo-viewer').classList.remove('zoomed');
            },
            
            closePhotoViewer: function() {
                document.getElementById('photo-viewer').classList.remove('active');
                document.body.style.overflow = 'auto';
                document.body.style.position = '';
                this.currentPhotoImovelId = null;
                this.currentPhotoIndex = 0;
                this.isPhotoZoomed = false;
            },
            
            // Configurações
            showSettings: function() {
                document.getElementById('s-nome').value = Sistema.data.settings.nome;
                document.getElementById('s-creci').value = Sistema.data.settings.creci;
                document.getElementById('s-telefone').value = Sistema.data.settings.telefone || '';
                document.getElementById('s-email').value = Sistema.data.settings.email || '';
                
                document.getElementById('modal-settings').classList.add('active');
                document.body.style.overflow = 'hidden';
            },
            
            // Toast
            showToast: function(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                `;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        };

        // --- FUNIL ---
        const Funnel = {
            render: function() {
                this.renderStages();
                this.renderVisualization();
                this.renderMetas();
            },
            
            renderStages: function() {
                const container = document.getElementById('funnel-stages-container');
                const stages = [...Sistema.data.funnel.stages].sort((a, b) => a.order - b.order);
                
                container.innerHTML = stages.map(stage => `
                    <div class="funnel-stage-item" style="border-left-color: ${stage.color}">
                        <input type="color" class="stage-color-picker" value="${stage.color}" 
                               onchange="Funnel.updateStageColor('${stage.id}', this.value)">
                        <input type="text" class="stage-name-input" value="${stage.name}"
                               onchange="Funnel.updateStageName('${stage.id}', this.value)">
                        <div class="stage-actions">
                            <button class="stage-btn stage-btn-move" onclick="Funnel.moveStageUp('${stage.id}')" ${stage.order === 1 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="stage-btn stage-btn-move" onclick="Funnel.moveStageDown('${stage.id}')" ${stage.order === stages.length ? 'disabled' : ''}>
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button class="stage-btn stage-btn-remove" onclick="Funnel.removeStage('${stage.id}')" ${stages.length <= 2 ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            },
            
            renderVisualization: function() {
                const container = document.getElementById('funnel-visual');
                const stages = [...Sistema.data.funnel.stages].sort((a, b) => a.order - b.order);
                const totalClientes = Sistema.data.clientes.length;
                
                let html = '<div class="funnel-bar">';
                
                stages.forEach(stage => {
                    const clientesNaEtapa = Sistema.data.clientes.filter(c => c.status === stage.id).length;
                    const porcentagem = totalClientes > 0 ? (clientesNaEtapa / totalClientes * 100) : 0;
                    const icon = stage.icon || 'fas fa-circle';
                    
                    html += `
                        <div class="funnel-level" onclick="Funnel.filterByStage('${stage.id}')">
                            <div class="level-label">
                                <div class="level-icon">
                                    <i class="${icon}" style="color: ${stage.color}"></i>
                                </div>
                                ${stage.name}
                            </div>
                            <div class="level-bar-container">
                                <div class="level-bar" style="width: ${porcentagem}%; background: ${stage.color};">
                                    ${clientesNaEtapa}
                                </div>
                            </div>
                            <div class="level-stats">
                                ${clientesNaEtapa} (${porcentagem.toFixed(1)}%)
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            },
            
            filterByStage: function(stageId) {
                UI.switchTab(document.querySelector('[data-target="clientes-view"]'));
                setTimeout(() => {
                    const clientesFiltrados = Sistema.data.clientes.filter(c => c.status === stageId);
                    if (clientesFiltrados.length === 0) {
                        document.getElementById('clientes-list').innerHTML = `
                            <div class="empty-state">
                                <p>Nenhum cliente nesta etapa</p>
                            </div>
                        `;
                    } else {
                        document.getElementById('clientes-list').innerHTML = clientesFiltrados.map(cliente => `
                            <div class="list-card" onclick="App.cliente.showDetails('${cliente.id}')">
                                <div class="card-header">
                                    <div class="card-title">${cliente.nome}</div>
                                </div>
                                <div class="card-subtitle">
                                    <i class="fas fa-phone"></i> ${cliente.telefone}
                                </div>
                                <div class="action-row">
                                    <button class="btn-sm btn-primary" onclick="event.stopPropagation(); App.cliente.edit('${cliente.id}')">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button class="btn-sm btn-success" onclick="event.stopPropagation(); App.whatsapp.openConversa('${cliente.id}')">
                                        <i class="fab fa-whatsapp"></i> WhatsApp
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    }
                }, 100);
            },
            
            renderMetas: function() {
                const container = document.getElementById('metas-container');
                const metas = Sistema.data.funnel.metas;
                const hoje = new Date();
                const diaAtual = hoje.getDate();
                const diasNoMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).getDate();
                
                const progressoLeads = Sistema.data.clientes.filter(c => c.status === 'lead' || c.status === 'prospect').length;
                const progressoVendas = Sistema.data.clientes.filter(c => c.status === 'fechado').length;
                const progressoReceita = Sistema.data.clientes
                    .filter(c => c.status === 'fechado' && c.valorVenda)
                    .reduce((acc, c) => acc + (c.valorVenda || 0), 0);
                
                const porcentagemLeads = metas.leads > 0 ? Math.min((progressoLeads / metas.leads) * 100, 100) : 0;
                const porcentagemVendas = metas.vendas > 0 ? Math.min((progressoVendas / metas.vendas) * 100, 100) : 0;
                const porcentagemReceita = metas.receita > 0 ? Math.min((progressoReceita / metas.receita) * 100, 100) : 0;
                
                container.innerHTML = `
                    <div class="section-title" style="font-size: 1rem; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <i class="fas fa-bullseye"></i> Metas Mensais
                        </div>
                        <button class="edit-meta-btn" onclick="UI.showModal('metas')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                    </div>
                    
                    <div class="meta-item">
                        <div class="meta-label">
                            <i class="fas fa-users" style="color: var(--primary);"></i> Leads
                        </div>
                        <div class="meta-value">
                            <span>${progressoLeads} / ${metas.leads}</span>
                        </div>
                    </div>
                    <div class="meta-progress">
                        <div class="meta-progress-bar" style="width: ${porcentagemLeads}%; background: var(--primary);"></div>
                    </div>
                    
                    <div class="meta-item">
                        <div class="meta-label">
                            <i class="fas fa-handshake" style="color: var(--success);"></i> Vendas
                        </div>
                        <div class="meta-value">
                            <span>${progressoVendas} / ${metas.vendas}</span>
                        </div>
                    </div>
                    <div class="meta-progress">
                        <div class="meta-progress-bar" style="width: ${porcentagemVendas}%; background: var(--success);"></div>
                    </div>
                    
                    <div class="meta-item">
                        <div class="meta-label">
                            <i class="fas fa-money-bill-wave" style="color: var(--accent);"></i> Receita
                        </div>
                        <div class="meta-value">
                            <span>${Utils.formatCurrency(progressoReceita)} / ${Utils.formatCurrency(metas.receita)}</span>
                        </div>
                    </div>
                    <div class="meta-progress">
                        <div class="meta-progress-bar" style="width: ${porcentagemReceita}%; background: var(--accent);"></div>
                    </div>
                    
                    <div style="margin-top: 16px; text-align: center; font-size: 0.8rem; color: var(--secondary);">
                        <i class="fas fa-calendar"></i> Dia ${diaAtual} de ${diasNoMes} deste mês
                    </div>
                `;
            },
            
            renderOverview: function() {
                const container = document.getElementById('funnel-overview');
                const resumo = {
                    leads: Sistema.data.clientes.filter(c => c.status === 'lead' || c.status === 'prospect').length,
                    visitas: Sistema.data.clientes.filter(c => c.status === 'visita').length,
                    propostas: Sistema.data.clientes.filter(c => c.status === 'proposta').length,
                    fechados: Sistema.data.clientes.filter(c => c.status === 'fechado').length
                };
                
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div class="stat-card" style="padding: 12px;" onclick="Funnel.filterByStage('lead')">
                            <div class="stat-value" style="color: var(--primary);">${resumo.leads}</div>
                            <div class="stat-label">Leads Ativos</div>
                        </div>
                        <div class="stat-card" style="padding: 12px;" onclick="Funnel.filterByStage('fechado')">
                            <div class="stat-value" style="color: var(--accent);">${resumo.fechados}</div>
                            <div class="stat-label">Vendas/Mês</div>
                        </div>
                    </div>
                `;
            },
            
            addStage: function() {
                const stages = Sistema.data.funnel.stages;
                const newId = Utils.generateId('stage');
                const newOrder = stages.length + 1;
                const colors = ['#0d4a2d', '#0f6d3e', '#2a5c8b', '#4a7fb8', '#d4af37', '#f59e0b', '#e74c3c', '#8b5cf6'];
                const icons = ['fas fa-user', 'fas fa-user-check', 'fas fa-eye', 'fas fa-file-contract', 'fas fa-handshake', 'fas fa-comment', 'fas fa-chart-line', 'fas fa-star'];
                const newColor = colors[stages.length % colors.length];
                const newIcon = icons[stages.length % icons.length];
                
                stages.push({
                    id: newId,
                    name: 'Nova Etapa',
                    color: newColor,
                    icon: newIcon,
                    order: newOrder
                });
                
                Sistema.saveData('funnel', Sistema.data.funnel);
                this.render();
                UI.showToast('Nova etapa adicionada');
            },
            
            removeStage: function(stageId) {
                if (Sistema.data.funnel.stages.length <= 2) {
                    UI.showToast('O funil deve ter pelo menos 2 etapas', 'error');
                    return;
                }
                
                Sistema.data.funnel.stages = Sistema.data.funnel.stages.filter(s => s.id !== stageId);
                
                Sistema.data.funnel.stages.forEach((stage, index) => {
                    stage.order = index + 1;
                });
                
                Sistema.saveData('funnel', Sistema.data.funnel);
                this.render();
                UI.showToast('Etapa removida');
            },
            
            updateStageColor: function(stageId, color) {
                const stage = Sistema.data.funnel.stages.find(s => s.id === stageId);
                if (stage) {
                    stage.color = color;
                    Sistema.saveData('funnel', Sistema.data.funnel);
                    this.renderVisualization();
                }
            },
            
            updateStageName: function(stageId, name) {
                const stage = Sistema.data.funnel.stages.find(s => s.id === stageId);
                if (stage) {
                    stage.name = name;
                    Sistema.saveData('funnel', Sistema.data.funnel);
                    this.renderVisualization();
                }
            },
            
            moveStageUp: function(stageId) {
                const stages = Sistema.data.funnel.stages;
                const index = stages.findIndex(s => s.id === stageId);
                
                if (index > 0) {
                    const tempOrder = stages[index].order;
                    stages[index].order = stages[index - 1].order;
                    stages[index - 1].order = tempOrder;
                    
                    stages.sort((a, b) => a.order - b.order);
                    Sistema.saveData('funnel', Sistema.data.funnel);
                    this.render();
                }
            },
            
            moveStageDown: function(stageId) {
                const stages = Sistema.data.funnel.stages;
                const index = stages.findIndex(s => s.id === stageId);
                
                if (index < stages.length - 1) {
                    const tempOrder = stages[index].order;
                    stages[index].order = stages[index + 1].order;
                    stages[index + 1].order = tempOrder;
                    
                    stages.sort((a, b) => a.order - b.order);
                    Sistema.saveData('funnel', Sistema.data.funnel);
                    this.render();
                }
            }
        };

        // --- METAS ---
        const Metas = {
            save: async function(event) {
                event.preventDefault();
                
                Sistema.data.funnel.metas = {
                    leads: parseInt(document.getElementById('meta-leads').value) || 0,
                    vendas: parseInt(document.getElementById('meta-vendas').value) || 0,
                    receita: Utils.unformatMoney(document.getElementById('meta-receita').value) || 0
                };
                
                try {
                    await Sistema.saveData('funnel', Sistema.data.funnel);
                    UI.closeModal('metas');
                    UI.showToast('Metas salvas com sucesso');
                    Funnel.renderMetas();
                    UI.renderDashboard();
                } catch (error) {
                    UI.showToast('Erro ao salvar metas', 'error');
                }
            }
        };

        // --- CONFIGURAÇÕES ---
        const Settings = {
            save: async function(event) {
                event.preventDefault();
                
                Sistema.data.settings = {
                    id: 'settings',
                    nome: document.getElementById('s-nome').value,
                    creci: document.getElementById('s-creci').value,
                    telefone: document.getElementById('s-telefone').value,
                    email: document.getElementById('s-email').value,
                    logo: Sistema.data.settings.logo
                };
                
                try {
                    await Sistema.saveData('settings', Sistema.data.settings);
                    UI.closeModal('settings');
                    UI.showToast('Configurações salvas com sucesso');
                    
                    if (Sistema.data.settings.logo) {
                        document.getElementById('brand-logo').innerHTML = `
                            <img src="${Sistema.data.settings.logo}" style="height: 32px; width: auto; border-radius: 6px;">
                            <span>ImobiManager Pro</span>
                        `;
                    }
                } catch (error) {
                    UI.showToast('Erro ao salvar configurações', 'error');
                }
            }
        };

        // --- APLICAÇÃO PRINCIPAL ---
        const App = {
            cliente: {
                save: async function(event) {
                    event.preventDefault();
                    
                    const id = document.getElementById('c-id').value || Utils.generateId('cliente');
                    const nome = document.getElementById('c-nome').value;
                    const cpf = document.getElementById('c-cpf').value;
                    const nascimento = document.getElementById('c-nascimento').value;
                    const email = document.getElementById('c-email').value;
                    const telefone = document.getElementById('c-telefone').value;
                    const telefone2 = document.getElementById('c-telefone2').value;
                    const logradouro = document.getElementById('c-logradouro').value;
                    const numero = document.getElementById('c-numero').value;
                    const complemento = document.getElementById('c-complemento').value;
                    const bairro = document.getElementById('c-bairro').value;
                    const cidade = document.getElementById('c-cidade').value;
                    const estado = document.getElementById('c-estado').value;
                    const cep = document.getElementById('c-cep').value;
                    const tipoInteresse = document.getElementById('c-tipo-interesse').value;
                    const valorMin = Utils.unformatMoney(document.getElementById('c-valor-min').value);
                    const valorMax = Utils.unformatMoney(document.getElementById('c-valor-max').value);
                    const bairrosInteresse = document.getElementById('c-bairros-interesse').value;
                    const fonte = document.getElementById('c-fonte').value;
                    const status = document.getElementById('c-status').value;
                    const observacoes = document.getElementById('c-observacoes').value;
                    
                    const cliente = {
                        id,
                        nome,
                        cpf,
                        nascimento,
                        email,
                        telefone,
                        telefone2,
                        endereco: { logradouro, numero, complemento, bairro, cidade, estado, cep },
                        interesses: {
                            tipo: tipoInteresse,
                            valorMin: valorMin || null,
                            valorMax: valorMax || null,
                            bairros: bairrosInteresse ? bairrosInteresse.split(',').map(b => b.trim()) : []
                        },
                        fonte,
                        status: status || 'lead',
                        observacoes,
                        dataCadastro: new Date().toISOString().split('T')[0]
                    };
                    
                    try {
                        await Sistema.saveData('cliente', cliente);
                        
                        // Atualizar dados locais
                        const index = Sistema.data.clientes.findIndex(c => c.id === id);
                        if (index >= 0) {
                            Sistema.data.clientes[index] = cliente;
                        } else {
                            Sistema.data.clientes.push(cliente);
                        }
                        
                        UI.closeModal('cliente');
                        UI.showToast('Cliente salvo com sucesso');
                        UI.renderClientes();
                        UI.renderDashboard();
                    } catch (error) {
                        UI.showToast('Erro ao salvar cliente', 'error');
                    }
                },
                
                edit: function(clienteId) {
                    const cliente = Sistema.data.clientes.find(c => c.id === clienteId);
                    if (!cliente) return;
                    
                    document.getElementById('c-id').value = cliente.id;
                    document.getElementById('c-nome').value = cliente.nome;
                    document.getElementById('c-cpf').value = cliente.cpf || '';
                    document.getElementById('c-nascimento').value = cliente.nascimento || '';
                    document.getElementById('c-email').value = cliente.email || '';
                    document.getElementById('c-telefone').value = cliente.telefone;
                    document.getElementById('c-telefone2').value = cliente.telefone2 || '';
                    
                    if (cliente.endereco) {
                        document.getElementById('c-logradouro').value = cliente.endereco.logradouro || '';
                        document.getElementById('c-numero').value = cliente.endereco.numero || '';
                        document.getElementById('c-complemento').value = cliente.endereco.complemento || '';
                        document.getElementById('c-bairro').value = cliente.endereco.bairro || '';
                        document.getElementById('c-cidade').value = cliente.endereco.cidade || '';
                        document.getElementById('c-estado').value = cliente.endereco.estado || '';
                        document.getElementById('c-cep').value = cliente.endereco.cep || '';
                    }
                    
                    if (cliente.interesses) {
                        document.getElementById('c-tipo-interesse').value = cliente.interesses.tipo || '';
                        document.getElementById('c-valor-min').value = cliente.interesses.valorMin ? Utils.formatCurrency(cliente.interesses.valorMin) : '';
                        document.getElementById('c-valor-max').value = cliente.interesses.valorMax ? Utils.formatCurrency(cliente.interesses.valorMax) : '';
                        document.getElementById('c-bairros-interesse').value = cliente.interesses.bairros ? cliente.interesses.bairros.join(', ') : '';
                    }
                    
                    document.getElementById('c-fonte').value = cliente.fonte || '';
                    document.getElementById('c-status').value = cliente.status || 'lead';
                    document.getElementById('c-observacoes').value = cliente.observacoes || '';
                    
                    document.getElementById('modal-cliente-title').innerHTML = '<i class="fas fa-user-edit"></i> Editar Cliente';
                    UI.showModal('cliente', 'edit');
                },
                
                showDetails: function(clienteId) {
                    const cliente = Sistema.data.clientes.find(c => c.id === clienteId);
                    if (!cliente) return;
                    
                    const stage = Sistema.data.funnel.stages.find(s => s.id === cliente.status) || { name: 'Não definido', color: '#64748b' };
                    
                    const modalBody = `
                        <div style="padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                                <div style="width: 60px; height: 60px; background: ${stage.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <h3 style="color: var(--dark); margin: 0;">${cliente.nome}</h3>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                                        <span class="badge" style="background: ${stage.color}; color: white;">${stage.name}</span>
                                        ${cliente.nascimento ? `
                                            <span style="font-size: 0.8rem; color: var(--secondary);">
                                                <i class="fas fa-birthday-cake"></i> ${new Date(cliente.nascimento).toLocaleDateString('pt-BR')}
                                            </span>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion" style="margin-bottom: 12px;">
                                <div class="accordion-header" onclick="UI.toggleAccordion('cliente-detalhes-contato')">
                                    <span><i class="fas fa-phone"></i> Contato</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="accordion-content" id="cliente-detalhes-contato-content">
                                    <div style="display: grid; gap: 12px; padding: 16px;">
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Telefone Principal</div>
                                            <div style="font-weight: 600; font-size: 1.1rem;">
                                                <a href="tel:${cliente.telefone}" style="color: var(--primary); text-decoration: none;">${cliente.telefone}</a>
                                            </div>
                                        </div>
                                        ${cliente.telefone2 ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Telefone Secundário</div>
                                            <div style="font-weight: 600;">
                                                <a href="tel:${cliente.telefone2}" style="color: var(--primary); text-decoration: none;">${cliente.telefone2}</a>
                                            </div>
                                        </div>
                                        ` : ''}
                                        ${cliente.email ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">E-mail</div>
                                            <div style="font-weight: 600;">
                                                <a href="mailto:${cliente.email}" style="color: var(--primary); text-decoration: none;">${cliente.email}</a>
                                            </div>
                                        </div>
                                        ` : ''}
                                        ${cliente.cpf ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">CPF</div>
                                            <div style="font-weight: 600;">${cliente.cpf}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            ${cliente.endereco && cliente.endereco.logradouro ? `
                            <div class="accordion" style="margin-bottom: 12px;">
                                <div class="accordion-header" onclick="UI.toggleAccordion('cliente-detalhes-endereco')">
                                    <span><i class="fas fa-map-marker-alt"></i> Endereço</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="accordion-content" id="cliente-detalhes-endereco-content">
                                    <div style="display: grid; gap: 8px; padding: 16px;">
                                        <div>${cliente.endereco.logradouro}, ${cliente.endereco.numero}</div>
                                        ${cliente.endereco.complemento ? `<div>${cliente.endereco.complemento}</div>` : ''}
                                        <div>${cliente.endereco.bairro}</div>
                                        <div>${cliente.endereco.cidade} - ${cliente.endereco.estado}</div>
                                        ${cliente.endereco.cep ? `<div>CEP: ${cliente.endereco.cep}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${cliente.interesses && (cliente.interesses.tipo || cliente.interesses.bairros.length > 0) ? `
                            <div class="accordion" style="margin-bottom: 12px;">
                                <div class="accordion-header" onclick="UI.toggleAccordion('cliente-detalhes-interesses')">
                                    <span><i class="fas fa-home"></i> Interesses</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="accordion-content" id="cliente-detalhes-interesses-content">
                                    <div style="display: grid; gap: 12px; padding: 16px;">
                                        ${cliente.interesses.tipo ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Tipo de Imóvel</div>
                                            <div style="font-weight: 600;">${cliente.interesses.tipo}</div>
                                        </div>
                                        ` : ''}
                                        ${cliente.interesses.valorMin || cliente.interesses.valorMax ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Faixa de Valor</div>
                                            <div style="font-weight: 600;">
                                                ${cliente.interesses.valorMin ? Utils.formatCurrency(cliente.interesses.valorMin) : ''} 
                                                ${cliente.interesses.valorMin && cliente.interesses.valorMax ? ' - ' : ''}
                                                ${cliente.interesses.valorMax ? Utils.formatCurrency(cliente.interesses.valorMax) : ''}
                                            </div>
                                        </div>
                                        ` : ''}
                                        ${cliente.interesses.bairros && cliente.interesses.bairros.length > 0 ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Bairros de Interesse</div>
                                            <div>${cliente.interesses.bairros.join(', ')}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${cliente.observacoes || cliente.fonte ? `
                            <div class="accordion" style="margin-bottom: 12px;">
                                <div class="accordion-header" onclick="UI.toggleAccordion('cliente-detalhes-outros')">
                                    <span><i class="fas fa-sticky-note"></i> Outras Informações</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="accordion-content" id="cliente-detalhes-outros-content">
                                    <div style="display: grid; gap: 12px; padding: 16px;">
                                        ${cliente.fonte ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Fonte do Lead</div>
                                            <div style="font-weight: 600;">${cliente.fonte}</div>
                                        </div>
                                        ` : ''}
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Data de Cadastro</div>
                                            <div style="font-weight: 600;">${new Date(cliente.dataCadastro).toLocaleDateString('pt-BR')}</div>
                                        </div>
                                        ${cliente.observacoes ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Observações</div>
                                            <div>${cliente.observacoes}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 24px;">
                                <button class="btn-block" onclick="App.cliente.edit('${cliente.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn-block btn-block-secondary" onclick="App.whatsapp.openConversa('${cliente.id}')">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </button>
                                <button class="btn-block" onclick="App.cliente.generatePDF('${cliente.id}')" style="grid-column: 1 / -1;">
                                    <i class="fas fa-file-pdf"></i> Gerar Ficha PDF
                                </button>
                                <button class="btn-block btn-block-secondary" onclick="this.parentElement.parentElement.parentElement.classList.remove('active')">
                                    Fechar
                                </button>
                            </div>
                        </div>
                    `;
                    
                    const tempModal = document.createElement('div');
                    tempModal.className = 'modal-overlay active';
                    tempModal.innerHTML = `
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">
                                    <i class="fas fa-user"></i> Detalhes do Cliente
                                </h3>
                                <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.classList.remove('active')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                ${modalBody}
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(tempModal);
                    document.body.style.overflow = 'hidden';
                    
                    setTimeout(() => {
                        const accordions = tempModal.querySelectorAll('.accordion');
                        accordions.forEach(accordion => {
                            accordion.classList.remove('active');
                            const header = accordion.querySelector('.accordion-header');
                            const content = accordion.querySelector('.accordion-content');
                            
                            header.onclick = () => {
                                accordion.classList.toggle('active');
                                const icon = header.querySelector('.fa-chevron-down, .fa-chevron-up');
                                if (icon) {
                                    if (accordion.classList.contains('active')) {
                                        icon.classList.remove('fa-chevron-down');
                                        icon.classList.add('fa-chevron-up');
                                    } else {
                                        icon.classList.remove('fa-chevron-up');
                                        icon.classList.add('fa-chevron-down');
                                    }
                                }
                                if (content) {
                                    if (accordion.classList.contains('active')) {
                                        content.style.maxHeight = '1000px';
                                        content.style.padding = '16px';
                                    } else {
                                        content.style.maxHeight = '0';
                                        content.style.padding = '0';
                                    }
                                }
                            };
                        });
                    }, 10);
                },
                
                generatePDF: function(clienteId) {
                    const cliente = Sistema.data.clientes.find(c => c.id === clienteId);
                    if (!cliente) return;
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    const settings = Sistema.data.settings;
                    const hoje = new Date().toLocaleDateString('pt-BR');
                    
                    doc.setFontSize(16);
                    doc.text('FICHA DO CLIENTE', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.text(`Emitido por: ${settings.nome} - CRECI: ${settings.creci}`, 20, 30);
                    doc.text(`Data: ${hoje}`, 20, 36);
                    
                    let y = 50;
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('DADOS PESSOAIS', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Nome: ${cliente.nome}`, 20, y);
                    y += 7;
                    doc.text(`Telefone: ${cliente.telefone}`, 20, y);
                    y += 7;
                    
                    if (cliente.email) {
                        doc.text(`E-mail: ${cliente.email}`, 20, y);
                        y += 7;
                    }
                    
                    if (cliente.cpf) {
                        doc.text(`CPF: ${cliente.cpf}`, 20, y);
                        y += 7;
                    }
                    
                    if (cliente.nascimento) {
                        doc.text(`Data de Nascimento: ${cliente.nascimento}`, 20, y);
                        y += 7;
                    }
                    
                    if (cliente.telefone2) {
                        doc.text(`Telefone Secundário: ${cliente.telefone2}`, 20, y);
                        y += 7;
                    }
                    
                    if (cliente.endereco && cliente.endereco.logradouro) {
                        y += 5;
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text('ENDEREÇO', 20, y);
                        y += 10;
                        
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        doc.text(`${cliente.endereco.logradouro}, ${cliente.endereco.numero}`, 20, y);
                        y += 7;
                        
                        if (cliente.endereco.complemento) {
                            doc.text(`Complemento: ${cliente.endereco.complemento}`, 20, y);
                            y += 7;
                        }
                        
                        doc.text(`Bairro: ${cliente.endereco.bairro}`, 20, y);
                        y += 7;
                        doc.text(`Cidade: ${cliente.endereco.cidade} - ${cliente.endereco.estado}`, 20, y);
                        y += 7;
                        
                        if (cliente.endereco.cep) {
                            doc.text(`CEP: ${cliente.endereco.cep}`, 20, y);
                            y += 7;
                        }
                    }
                    
                    if (cliente.interesses) {
                        y += 5;
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text('INTERESSES', 20, y);
                        y += 10;
                        
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        
                        if (cliente.interesses.tipo) {
                            doc.text(`Tipo de Imóvel: ${cliente.interesses.tipo}`, 20, y);
                            y += 7;
                        }
                        
                        if (cliente.interesses.valorMin || cliente.interesses.valorMax) {
                            const valorStr = `${cliente.interesses.valorMin ? Utils.formatCurrency(cliente.interesses.valorMin) : ''} ${cliente.interesses.valorMin && cliente.interesses.valorMax ? ' - ' : ''} ${cliente.interesses.valorMax ? Utils.formatCurrency(cliente.interesses.valorMax) : ''}`;
                            doc.text(`Faixa de Valor: ${valorStr}`, 20, y);
                            y += 7;
                        }
                        
                        if (cliente.interesses.bairros && cliente.interesses.bairros.length > 0) {
                            doc.text(`Bairros: ${cliente.interesses.bairros.join(', ')}`, 20, y);
                            y += 7;
                        }
                    }
                    
                    y += 5;
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('OUTRAS INFORMAÇÕES', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    
                    const stage = Sistema.data.funnel.stages.find(s => s.id === cliente.status) || { name: 'Não definido' };
                    doc.text(`Status: ${stage.name}`, 20, y);
                    y += 7;
                    
                    if (cliente.fonte) {
                        doc.text(`Fonte: ${cliente.fonte}`, 20, y);
                        y += 7;
                    }
                    
                    doc.text(`Data de Cadastro: ${cliente.dataCadastro}`, 20, y);
                    y += 7;
                    
                    if (cliente.observacoes) {
                        y += 5;
                        doc.setFont(undefined, 'bold');
                        doc.text('OBSERVAÇÕES:', 20, y);
                        y += 7;
                        doc.setFont(undefined, 'normal');
                        const observacoesLines = doc.splitTextToSize(cliente.observacoes, 170);
                        observacoesLines.forEach(line => {
                            if (y < 270) {
                                doc.text(line, 20, y);
                                y += 7;
                            }
                        });
                    }
                    
                    doc.save(`Ficha_Cliente_${cliente.nome.replace(/\s/g, '_')}_${hoje.replace(/\//g, '-')}.pdf`);
                    UI.showToast('Ficha do cliente gerada em PDF');
                }
            },
            
            imovel: {
                fotosTemporarias: [],
                
                save: async function(event) {
                    event.preventDefault();
                    
                    const id = document.getElementById('i-id').value || Utils.generateId('imovel');
                    const nome = document.getElementById('i-nome').value;
                    const tipo = document.getElementById('i-tipo').value;
                    const finalidade = document.getElementById('i-finalidade').value;
                    const valor = Utils.unformatMoney(document.getElementById('i-valor').value) || 0;
                    const dataEntrega = document.getElementById('i-data-entrega').value;
                    const condominio = Utils.unformatMoney(document.getElementById('i-condominio').value) || null;
                    const iptu = Utils.unformatMoney(document.getElementById('i-iptu').value) || null;
                    const logradouro = document.getElementById('i-logradouro').value;
                    const numero = document.getElementById('i-numero').value;
                    const complemento = document.getElementById('i-complemento').value;
                    const bairro = document.getElementById('i-bairro').value;
                    const cidade = document.getElementById('i-cidade').value;
                    const estado = document.getElementById('i-estado').value;
                    const cep = document.getElementById('i-cep').value;
                    const areaTotal = parseFloat(document.getElementById('i-area-total').value) || null;
                    const areaConstruida = parseFloat(document.getElementById('i-area-construida').value) || null;
                    const quartos = parseInt(document.getElementById('i-quartos').value) || null;
                    const suites = parseInt(document.getElementById('i-suites').value) || null;
                    const banheiros = parseInt(document.getElementById('i-banheiros').value) || null;
                    const vagas = parseInt(document.getElementById('i-vagas').value) || null;
                    const mobiliado = document.getElementById('i-mobiliado').value;
                    const status = document.getElementById('i-status').value;
                    const observacoes = document.getElementById('i-observacoes').value;
                    
                    const imovel = {
                        id,
                        nome,
                        tipo: tipo || 'casa',
                        finalidade: finalidade || 'venda',
                        valor,
                        dataEntrega,
                        condominio,
                        iptu,
                        endereco: { logradouro, numero, complemento, bairro, cidade, estado, cep },
                        caracteristicas: {
                            areaTotal,
                            areaConstruida,
                            quartos,
                            suites,
                            banheiros,
                            vagas,
                            mobiliado
                        },
                        fotos: this.fotosTemporarias,
                        status: status || 'disponivel',
                        observacoes,
                        dataCadastro: new Date().toISOString().split('T')[0]
                    };
                    
                    try {
                        await Sistema.saveData('imovel', imovel);
                        
                        const index = Sistema.data.imoveis.findIndex(i => i.id === id);
                        if (index >= 0) {
                            Sistema.data.imoveis[index] = imovel;
                        } else {
                            Sistema.data.imoveis.push(imovel);
                        }
                        
                        UI.closeModal('imovel');
                        UI.showToast('Imóvel salvo com sucesso');
                        UI.renderImoveis();
                        UI.renderDashboard();
                        
                        this.fotosTemporarias = [];
                    } catch (error) {
                        UI.showToast('Erro ao salvar imóvel', 'error');
                    }
                },
                
                edit: function(imovelId) {
                    const imovel = Sistema.data.imoveis.find(i => i.id === imovelId);
                    if (!imovel) return;
                    
                    document.getElementById('i-id').value = imovel.id;
                    document.getElementById('i-nome').value = imovel.nome;
                    document.getElementById('i-tipo').value = imovel.tipo;
                    document.getElementById('i-finalidade').value = imovel.finalidade;
                    document.getElementById('i-valor').value = Utils.formatCurrency(imovel.valor);
                    document.getElementById('i-data-entrega').value = imovel.dataEntrega || new Date().toISOString().split('T')[0];
                    document.getElementById('i-condominio').value = imovel.condominio ? Utils.formatCurrency(imovel.condominio) : '';
                    document.getElementById('i-iptu').value = imovel.iptu ? Utils.formatCurrency(imovel.iptu) : '';
                    
                    if (imovel.endereco) {
                        document.getElementById('i-logradouro').value = imovel.endereco.logradouro;
                        document.getElementById('i-numero').value = imovel.endereco.numero;
                        document.getElementById('i-complemento').value = imovel.endereco.complemento || '';
                        document.getElementById('i-bairro').value = imovel.endereco.bairro;
                        document.getElementById('i-cidade').value = imovel.endereco.cidade;
                        document.getElementById('i-estado').value = imovel.endereco.estado;
                        document.getElementById('i-cep').value = imovel.endereco.cep;
                    }
                    
                    if (imovel.caracteristicas) {
                        document.getElementById('i-area-total').value = imovel.caracteristicas.areaTotal || '';
                        document.getElementById('i-area-construida').value = imovel.caracteristicas.areaConstruida || '';
                        document.getElementById('i-quartos').value = imovel.caracteristicas.quartos || '';
                        document.getElementById('i-suites').value = imovel.caracteristicas.suites || '';
                        document.getElementById('i-banheiros').value = imovel.caracteristicas.banheiros || '';
                        document.getElementById('i-vagas').value = imovel.caracteristicas.vagas || '';
                        document.getElementById('i-mobiliado').value = imovel.caracteristicas.mobiliado || '';
                    }
                    
                    document.getElementById('i-status').value = imovel.status;
                    document.getElementById('i-observacoes').value = imovel.observacoes || '';
                    
                    this.fotosTemporarias = imovel.fotos || [];
                    this.renderFotosPreview();
                    
                    document.getElementById('modal-imovel-title').innerHTML = '<i class="fas fa-home"></i> Editar Imóvel';
                    UI.showModal('imovel', 'edit');
                },
                
                handleFotos: function(input) {
                    const files = Array.from(input.files);
                    const maxFotos = 20;
                    
                    if (this.fotosTemporarias.length + files.length > maxFotos) {
                        UI.showToast(`Máximo de ${maxFotos} fotos permitido`, 'error');
                        return;
                    }
                    
                    files.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.fotosTemporarias.push(e.target.result);
                            this.renderFotosPreview();
                        };
                        reader.readAsDataURL(file);
                    });
                },
                
                renderFotosPreview: function() {
                    const container = document.getElementById('imovel-photos-preview');
                    
                    if (this.fotosTemporarias.length === 0) {
                        container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--secondary); font-size: 0.9rem; padding: 20px;">Nenhuma foto adicionada</div>';
                    } else {
                        container.innerHTML = this.fotosTemporarias.map((foto, index) => `
                            <img src="${foto}" class="imovel-photo" onclick="event.stopPropagation(); UI.viewPhoto('temp', ${index})">
                        `).join('');
                    }
                },
                
                showDetails: function(imovelId) {
                    const imovel = Sistema.data.imoveis.find(i => i.id === imovelId);
                    if (!imovel) return;
                    
                    const modalBody = `
                        <div style="padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                                <div style="width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                    <i class="fas fa-home"></i>
                                </div>
                                <div>
                                    <h3 style="color: var(--dark); margin: 0;">${imovel.nome}</h3>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                                        <span class="badge badge-primary">${imovel.tipo}</span>
                                        <span class="badge badge-success">${imovel.finalidade}</span>
                                        <span class="badge" style="background: ${imovel.status === 'disponivel' ? '#10b981' : imovel.status === 'vendido' ? '#0d4a2d' : '#f59e0b'}; color: white;">${imovel.status}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion" style="margin-bottom: 12px;">
                                <div class="accordion-header" onclick="UI.toggleAccordion('imovel-detalhes-valores')">
                                    <span><i class="fas fa-dollar-sign"></i> Valores</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="accordion-content" id="imovel-detalhes-valores-content">
                                    <div style="display: grid; gap: 12px; padding: 16px;">
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Valor</div>
                                            <div style="font-weight: 600; font-size: 1.2rem; color: var(--primary);">
                                                ${Utils.formatCurrency(imovel.valor)}
                                            </div>
                                        </div>
                                        ${imovel.condominio ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Condomínio</div>
                                            <div style="font-weight: 600;">
                                                ${Utils.formatCurrency(imovel.condominio)}
                                            </div>
                                        </div>
                                        ` : ''}
                                        ${imovel.iptu ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">IPTU</div>
                                            <div style="font-weight: 600;">
                                                ${Utils.formatCurrency(imovel.iptu)}
                                            </div>
                                        </div>
                                        ` : ''}
                                        ${imovel.dataEntrega ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Data de Entrega</div>
                                            <div style="font-weight: 600;">${imovel.dataEntrega}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            ${imovel.endereco && imovel.endereco.logradouro ? `
                            <div class="accordion" style="margin-bottom: 12px;">
                                <div class="accordion-header" onclick="UI.toggleAccordion('imovel-detalhes-endereco')">
                                    <span><i class="fas fa-map-marker-alt"></i> Endereço</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="accordion-content" id="imovel-detalhes-endereco-content">
                                    <div style="display: grid; gap: 8px; padding: 16px;">
                                        <div style="font-weight: 600;">${imovel.endereco.logradouro}, ${imovel.endereco.numero}</div>
                                        ${imovel.endereco.complemento ? `<div>${imovel.endereco.complemento}</div>` : ''}
                                        <div>${imovel.endereco.bairro}</div>
                                        <div>${imovel.endereco.cidade} - ${imovel.endereco.estado}</div>
                                        <div>CEP: ${imovel.endereco.cep}</div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${imovel.caracteristicas && (imovel.caracteristicas.areaTotal || imovel.caracteristicas.quartos) ? `
                            <div class="accordion" style="margin-bottom: 12px;">
                                <div class="accordion-header" onclick="UI.toggleAccordion('imovel-detalhes-caracteristicas')">
                                    <span><i class="fas fa-clipboard-list"></i> Características</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="accordion-content" id="imovel-detalhes-caracteristicas-content">
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 16px;">
                                        ${imovel.caracteristicas.areaTotal ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Área Total</div>
                                            <div style="font-weight: 600;">${imovel.caracteristicas.areaTotal} m²</div>
                                        </div>
                                        ` : ''}
                                        ${imovel.caracteristicas.areaConstruida ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Área Construída</div>
                                            <div style="font-weight: 600;">${imovel.caracteristicas.areaConstruida} m²</div>
                                        </div>
                                        ` : ''}
                                        ${imovel.caracteristicas.quartos ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Quartos</div>
                                            <div style="font-weight: 600;">${imovel.caracteristicas.quartos}</div>
                                        </div>
                                        ` : ''}
                                        ${imovel.caracteristicas.suites ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Suítes</div>
                                            <div style="font-weight: 600;">${imovel.caracteristicas.suites}</div>
                                        </div>
                                        ` : ''}
                                        ${imovel.caracteristicas.banheiros ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Banheiros</div>
                                            <div style="font-weight: 600;">${imovel.caracteristicas.banheiros}</div>
                                        </div>
                                        ` : ''}
                                        ${imovel.caracteristicas.vagas ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Vagas</div>
                                            <div style="font-weight: 600;">${imovel.caracteristicas.vagas}</div>
                                        </div>
                                        ` : ''}
                                        ${imovel.caracteristicas.mobiliado ? `
                                        <div>
                                            <div style="font-size: 0.8rem; color: var(--secondary);">Mobiliado</div>
                                            <div style="font-weight: 600;">${imovel.caracteristicas.mobiliado}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${imovel.fotos && imovel.fotos.length > 0 ? `
                            <div class="accordion" style="margin-bottom: 12px;">
                                <div class="accordion-header" onclick="UI.toggleAccordion('imovel-detalhes-fotos')">
                                    <span><i class="fas fa-camera"></i> Fotos (${imovel.fotos.length})</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="accordion-content" id="imovel-detalhes-fotos-content">
                                    <div style="padding: 16px;">
                                        <div class="imovel-photos">
                                            ${imovel.fotos.map((foto, index) => `
                                                <img src="${foto}" class="imovel-photo" onclick="UI.viewPhoto('${imovel.id}', ${index})">
                                            `).join('')}
                                        </div>
                                        <div style="text-align: center; margin-top: 12px; font-size: 0.8rem; color: var(--secondary);">
                                            Clique nas fotos para visualizar em tela cheia
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${imovel.observacoes ? `
                            <div class="accordion" style="margin-bottom: 12px;">
                                <div class="accordion-header" onclick="UI.toggleAccordion('imovel-detalhes-observacoes')">
                                    <span><i class="fas fa-sticky-note"></i> Observações</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="accordion-content" id="imovel-detalhes-observacoes-content">
                                    <div style="padding: 16px;">
                                        <div>${imovel.observacoes}</div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 24px;">
                                <button class="btn-block" onclick="App.imovel.edit('${imovel.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn-block btn-block-secondary" onclick="App.whatsapp.shareImovel('${imovel.id}')">
                                    <i class="fab fa-whatsapp"></i> Compartilhar
                                </button>
                                <button class="btn-block" onclick="App.imovel.generatePDF('${imovel.id}')" style="grid-column: 1 / -1;">
                                    <i class="fas fa-file-pdf"></i> Gerar Ficha PDF
                                </button>
                                <button class="btn-block btn-block-secondary" onclick="this.parentElement.parentElement.parentElement.classList.remove('active')">
                                    Fechar
                                </button>
                            </div>
                        </div>
                    `;
                    
                    const tempModal = document.createElement('div');
                    tempModal.className = 'modal-overlay active';
                    tempModal.innerHTML = `
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">
                                    <i class="fas fa-home"></i> Detalhes do Imóvel
                                </h3>
                                <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.classList.remove('active')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                ${modalBody}
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(tempModal);
                    document.body.style.overflow = 'hidden';
                    
                    setTimeout(() => {
                        const accordions = tempModal.querySelectorAll('.accordion');
                        accordions.forEach(accordion => {
                            accordion.classList.remove('active');
                            const header = accordion.querySelector('.accordion-header');
                            const content = accordion.querySelector('.accordion-content');
                            
                            header.onclick = () => {
                                accordion.classList.toggle('active');
                                const icon = header.querySelector('.fa-chevron-down, .fa-chevron-up');
                                if (icon) {
                                    if (accordion.classList.contains('active')) {
                                        icon.classList.remove('fa-chevron-down');
                                        icon.classList.add('fa-chevron-up');
                                    } else {
                                        icon.classList.remove('fa-chevron-up');
                                        icon.classList.add('fa-chevron-down');
                                    }
                                }
                                if (content) {
                                    if (accordion.classList.contains('active')) {
                                        content.style.maxHeight = '1000px';
                                        content.style.padding = '16px';
                                    } else {
                                        content.style.maxHeight = '0';
                                        content.style.padding = '0';
                                    }
                                }
                            };
                        });
                    }, 10);
                },
                
                generatePDF: function(imovelId) {
                    const imovel = Sistema.data.imoveis.find(i => i.id === imovelId);
                    if (!imovel) return;
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    
                    const settings = Sistema.data.settings;
                    const hoje = new Date().toLocaleDateString('pt-BR');
                    
                    const pageWidth = doc.internal.pageSize.width;
                    const margin = 20;
                    const contentWidth = pageWidth - (margin * 2);
                    
                    doc.setFontSize(18);
                    doc.text('FICHA DO IMÓVEL', pageWidth / 2, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.text(`Emitido por: ${settings.nome} - CRECI: ${settings.creci}`, margin, 30);
                    doc.text(`Data: ${hoje}`, margin, 36);
                    
                    let y = 50;
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('DADOS DO IMÓVEL', margin, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Nome/Descrição: ${imovel.nome}`, margin, y);
                    y += 7;
                    doc.text(`Tipo: ${imovel.tipo}`, margin, y);
                    y += 7;
                    doc.text(`Finalidade: ${imovel.finalidade}`, margin, y);
                    y += 7;
                    doc.text(`Status: ${imovel.status}`, margin, y);
                    y += 7;
                    doc.text(`Valor: ${Utils.formatCurrency(imovel.valor)}`, margin, y);
                    y += 7;
                    
                    if (imovel.dataEntrega) {
                        doc.text(`Data de Entrega: ${imovel.dataEntrega}`, margin, y);
                        y += 7;
                    }
                    
                    if (imovel.condominio) {
                        doc.text(`Condomínio: ${Utils.formatCurrency(imovel.condominio)}`, margin, y);
                        y += 7;
                    }
                    
                    if (imovel.iptu) {
                        doc.text(`IPTU: ${Utils.formatCurrency(imovel.iptu)}`, margin, y);
                        y += 7;
                    }
                    
                    doc.text(`Data de Cadastro: ${imovel.dataCadastro}`, margin, y);
                    y += 10;
                    
                    if (imovel.endereco && imovel.endereco.logradouro) {
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text('ENDEREÇO', margin, y);
                        y += 10;
                        
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        doc.text(`${imovel.endereco.logradouro}, ${imovel.endereco.numero}`, margin, y);
                        y += 7;
                        
                        if (imovel.endereco.complemento) {
                            doc.text(`Complemento: ${imovel.endereco.complemento}`, margin, y);
                            y += 7;
                        }
                        
                        doc.text(`Bairro: ${imovel.endereco.bairro}`, margin, y);
                        y += 7;
                        doc.text(`Cidade: ${imovel.endereco.cidade} - ${imovel.endereco.estado}`, margin, y);
                        y += 7;
                        doc.text(`CEP: ${imovel.endereco.cep}`, margin, y);
                        y += 10;
                    }
                    
                    if (imovel.caracteristicas) {
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text('CARACTERÍSTICAS', margin, y);
                        y += 10;
                        
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        
                        if (imovel.caracteristicas.areaTotal) {
                            doc.text(`Área Total: ${imovel.caracteristicas.areaTotal} m²`, margin, y);
                            y += 7;
                        }
                        
                        if (imovel.caracteristicas.areaConstruida) {
                            doc.text(`Área Construída: ${imovel.caracteristicas.areaConstruida} m²`, margin, y);
                            y += 7;
                        }
                        
                        if (imovel.caracteristicas.quartos) {
                            doc.text(`Quartos: ${imovel.caracteristicas.quartos}`, margin, y);
                            y += 7;
                        }
                        
                        if (imovel.caracteristicas.suites) {
                            doc.text(`Suítes: ${imovel.caracteristicas.suites}`, margin, y);
                            y += 7;
                        }
                        
                        if (imovel.caracteristicas.banheiros) {
                            doc.text(`Banheiros: ${imovel.caracteristicas.banheiros}`, margin, y);
                            y += 7;
                        }
                        
                        if (imovel.caracteristicas.vagas) {
                            doc.text(`Vagas: ${imovel.caracteristicas.vagas}`, margin, y);
                            y += 7;
                        }
                        
                        if (imovel.caracteristicas.mobiliado) {
                            doc.text(`Mobiliado: ${imovel.caracteristicas.mobiliado}`, margin, y);
                            y += 7;
                        }
                        y += 10;
                    }
                    
                    if (imovel.fotos && imovel.fotos.length > 0) {
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text('FOTOS DO IMÓVEL', margin, y);
                        y += 10;
                        
                        const photoWidth = (contentWidth - 10) / 2;
                        const photoHeight = photoWidth * 0.75;
                        
                        for (let i = 0; i < imovel.fotos.length; i += 2) {
                            if (y + photoHeight > doc.internal.pageSize.height - margin) {
                                doc.addPage();
                                y = margin;
                                doc.setFontSize(12);
                                doc.setFont(undefined, 'bold');
                                doc.text('FOTOS DO IMÓVEL (continuação)', margin, y);
                                y += 10;
                            }
                            
                            if (i < imovel.fotos.length) {
                                try {
                                    doc.addImage(imovel.fotos[i], 'JPEG', margin, y, photoWidth, photoHeight);
                                    doc.setFontSize(8);
                                    doc.text(`Foto ${i + 1}`, margin + 5, y + photoHeight + 5);
                                } catch (e) {
                                    console.error('Erro ao adicionar imagem:', e);
                                    doc.text(`Foto ${i + 1}: Erro ao carregar`, margin, y);
                                }
                            }
                            
                            if (i + 1 < imovel.fotos.length) {
                                try {
                                    doc.addImage(imovel.fotos[i + 1], 'JPEG', margin + photoWidth + 10, y, photoWidth, photoHeight);
                                    doc.setFontSize(8);
                                    doc.text(`Foto ${i + 2}`, margin + photoWidth + 15, y + photoHeight + 5);
                                } catch (e) {
                                    console.error('Erro ao adicionar imagem:', e);
                                    doc.text(`Foto ${i + 2}: Erro ao carregar`, margin + photoWidth + 10, y);
                                }
                            }
                            
                            y += photoHeight + 15;
                        }
                        
                        y += 10;
                    }
                    
                    if (imovel.observacoes) {
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text('OBSERVAÇÕES', margin, y);
                        y += 10;
                        
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        const observacoesLines = doc.splitTextToSize(imovel.observacoes, contentWidth);
                        observacoesLines.forEach(line => {
                            if (y < doc.internal.pageSize.height - margin) {
                                doc.text(line, margin, y);
                                y += 7;
                            }
                        });
                    }
                    
                    doc.save(`Ficha_Imovel_${imovel.nome.replace(/\s/g, '_')}_${hoje.replace(/\//g, '-')}.pdf`);
                    UI.showToast('Ficha do imóvel gerada em PDF');
                }
            },
            
            agenda: {
                save: async function(event) {
                    event.preventDefault();
                    
                    const id = Utils.generateId('agenda');
                    const tipo = document.getElementById('a-tipo').value;
                    const data = document.getElementById('a-data').value;
                    const horario = document.getElementById('a-horario').value;
                    const local = document.getElementById('a-local').value;
                    const observacoes = document.getElementById('a-observacoes').value;
                    
                    let camposEspecificos = {};
                    
                    switch(tipo) {
                        case 'visita':
                            camposEspecificos = {
                                clienteId: document.getElementById('a-cliente').value,
                                imovelId: document.getElementById('a-imovel').value
                            };
                            break;
                            
                        case 'plantao':
                            camposEspecificos = {
                                empreendimento: document.getElementById('a-empreendimento').value,
                                periodo: document.getElementById('a-periodo').value
                            };
                            
                            const plantao = {
                                id: Utils.generateId('plantao'),
                                data: data,
                                periodo: document.getElementById('a-periodo').value,
                                empreendimento: document.getElementById('a-empreendimento').value,
                                tipo: 'plantao'
                            };
                            
                            try {
                                await Sistema.saveData('plantao', plantao);
                                Sistema.data.plantoes.push(plantao);
                            } catch (error) {
                                UI.showToast('Erro ao salvar plantão', 'error');
                            }
                            break;
                            
                        default:
                            camposEspecificos = {
                                clienteId: document.getElementById('a-cliente').value
                            };
                            break;
                    }
                    
                    const agenda = {
                        id,
                        tipo,
                        data,
                        horario,
                        local,
                        observacoes,
                        ...camposEspecificos,
                        status: 'agendado'
                    };
                    
                    try {
                        await Sistema.saveData('agenda', agenda);
                        Sistema.data.agenda.push(agenda);
                        UI.closeModal('agenda-generico');
                        UI.showToast('Agendamento salvo com sucesso');
                        UI.renderCalendar();
                        UI.showDayEvents(data);
                        UI.renderDashboard();
                    } catch (error) {
                        UI.showToast('Erro ao salvar agendamento', 'error');
                    }
                },
                
                confirmar: async function(agendaId) {
                    const agenda = Sistema.data.agenda.find(a => a.id === agendaId);
                    if (agenda) {
                        agenda.status = 'confirmado';
                        try {
                            await Sistema.saveData('agenda', agenda);
                            UI.showDayEvents(agenda.data);
                            UI.showToast('Agendamento confirmado');
                        } catch (error) {
                            UI.showToast('Erro ao confirmar agendamento', 'error');
                        }
                    }
                },
                
                cancelar: async function(agendaId) {
                    if (confirm('Cancelar este agendamento?')) {
                        const agenda = Sistema.data.agenda.find(a => a.id === agendaId);
                        if (agenda) {
                            agenda.status = 'cancelado';
                            try {
                                await Sistema.saveData('agenda', agenda);
                                UI.showDayEvents(agenda.data);
                                UI.showToast('Agendamento cancelado');
                            } catch (error) {
                                UI.showToast('Erro ao cancelar agendamento', 'error');
                            }
                        }
                    }
                },
                
                showDetails: function(agendaId) {
                    const agenda = Sistema.data.agenda.find(a => a.id === agendaId);
                    if (!agenda) return;
                    
                    const cliente = agenda.clienteId ? Sistema.data.clientes.find(c => c.id === agenda.clienteId) : null;
                    const imovel = agenda.imovelId ? Sistema.data.imoveis.find(i => i.id === agenda.imovelId) : null;
                    
                    let detalhes = '';
                    
                    switch(agenda.tipo) {
                        case 'visita':
                            detalhes = `
                                <div>
                                    <div style="font-size: 0.8rem; color: var(--secondary);">Cliente</div>
                                    <div style="font-weight: 600;">${cliente ? cliente.nome : 'Não informado'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.8rem; color: var(--secondary);">Imóvel</div>
                                    <div style="font-weight: 600;">${imovel ? imovel.nome : 'Não informado'}</div>
                                </div>
                            `;
                            break;
                        case 'plantao':
                            detalhes = `
                                ${agenda.empreendimento ? `
                                <div>
                                    <div style="font-size: 0.8rem; color: var(--secondary);">Empreendimento</div>
                                    <div style="font-weight: 600;">${agenda.empreendimento}</div>
                                </div>
                                ` : ''}
                                ${agenda.periodo ? `
                                <div>
                                    <div style="font-size: 0.8rem; color: var(--secondary);">Período</div>
                                    <div style="font-weight: 600;">${agenda.periodo}</div>
                                </div>
                                ` : ''}
                            `;
                            break;
                        default:
                            detalhes = `
                                <div>
                                    <div style="font-size: 0.8rem; color: var(--secondary);">Cliente</div>
                                    <div style="font-weight: 600;">${cliente ? cliente.nome : 'Não informado'}</div>
                                </div>
                            `;
                            break;
                    }
                    
                    const modalBody = `
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 16px; color: var(--dark);">
                                ${agenda.tipo.charAt(0).toUpperCase() + agenda.tipo.slice(1)}
                                ${cliente ? ` - ${cliente.nome}` : ''}
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                <div>
                                    <div style="font-size: 0.8rem; color: var(--secondary);">Data e Horário</div>
                                    <div style="font-weight: 600;">${agenda.data} às ${agenda.horario}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.8rem; color: var(--secondary);">Local</div>
                                    <div style="font-weight: 600;">${agenda.local}</div>
                                </div>
                                ${detalhes}
                                ${agenda.observacoes ? `
                                <div>
                                    <div style="font-size: 0.8rem; color: var(--secondary);">Observações</div>
                                    <div>${agenda.observacoes}</div>
                                </div>
                                ` : ''}
                                <div>
                                    <div style="font-size: 0.8rem; color: var(--secondary);">Status</div>
                                    <div>
                                        <span class="badge ${agenda.status === 'confirmado' ? 'badge-success' : agenda.status === 'cancelado' ? 'badge-danger' : 'badge-primary'}">
                                            ${agenda.status}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; margin-top: 24px;">
                                <button class="btn-block" onclick="App.agenda.confirmar('${agenda.id}')" ${agenda.status === 'confirmado' ? 'disabled' : ''}>
                                    <i class="fas fa-check"></i> Confirmar
                                </button>
                                <button class="btn-block btn-danger" onclick="App.agenda.cancelar('${agenda.id}')" ${agenda.status === 'cancelado' ? 'disabled' : ''}>
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    `;
                    
                    const tempModal = document.createElement('div');
                    tempModal.className = 'modal-overlay active';
                    tempModal.innerHTML = `
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">
                                    <i class="fas fa-calendar-alt"></i> Detalhes do Agendamento
                                </h3>
                                <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.classList.remove('active')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                ${modalBody}
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(tempModal);
                    document.body.style.overflow = 'hidden';
                }
            },
            
            whatsapp: {
                openConversa: function(clienteId) {
                    const cliente = Sistema.data.clientes.find(c => c.id === clienteId);
                    if (!cliente || !cliente.telefone) {
                        UI.showToast('Telefone do cliente não encontrado', 'error');
                        return;
                    }
                    
                    const numero = cliente.telefone.replace(/\D/g, '');
                    
                    if (numero.length < 10 || numero.length > 11) {
                        UI.showToast('Número de telefone inválido', 'error');
                        return;
                    }
                    
                    const mensagem = `Olá ${cliente.nome.split(' ')[0]}, tudo bem?`;
                    const url = `https://wa.me/55${numero}?text=${encodeURIComponent(mensagem)}`;
                    
                    window.open(url, '_blank');
                },
                
                shareImovel: function(imovelId) {
                    const imovel = Sistema.data.imoveis.find(i => i.id === imovelId);
                    if (!imovel) {
                        UI.showToast('Imóvel não encontrado', 'error');
                        return;
                    }
                    
                    const settings = Sistema.data.settings;
                    
                    let mensagem = `🏠 *${imovel.nome}*\n\n`;
                    mensagem += `💰 *Valor:* ${Utils.formatCurrency(imovel.valor)}\n`;
                    
                    if (imovel.condominio) {
                        mensagem += `🏢 *Condomínio:* ${Utils.formatCurrency(imovel.condominio)}\n`;
                    }
                    
                    if (imovel.endereco) {
                        mensagem += `📍 *Endereço:* ${imovel.endereco.logradouro}, ${imovel.endereco.numero} - ${imovel.endereco.bairro}\n`;
                    }
                    
                    if (imovel.caracteristicas) {
                        if (imovel.caracteristicas.quartos) {
                            mensagem += `🛏️ *Quartos:* ${imovel.caracteristicas.quartos}\n`;
                        }
                        if (imovel.caracteristicas.suites) {
                            mensagem += `🚿 *Suítes:* ${imovel.caracteristicas.suites}\n`;
                        }
                        if (imovel.caracteristicas.banheiros) {
                            mensagem += `🚽 *Banheiros:* ${imovel.caracteristicas.banheiros}\n`;
                        }
                        if (imovel.caracteristicas.vagas) {
                            mensagem += `🚗 *Vagas:* ${imovel.caracteristicas.vagas}\n`;
                        }
                        if (imovel.caracteristicas.areaTotal) {
                            mensagem += `📐 *Área Total:* ${imovel.caracteristicas.areaTotal}m²\n`;
                        }
                    }
                    
                    mensagem += `\n_Entre em contato para mais informações!_\n\n`;
                    mensagem += `*${settings.nome}*\n`;
                    mensagem += `CRECI: ${settings.creci}\n`;
                    
                    if (settings.telefone) {
                        mensagem += `📱 ${settings.telefone}\n`;
                    }
                    
                    const url = `https://wa.me/?text=${encodeURIComponent(mensagem)}`;
                    window.open(url, '_blank');
                },
                
                sendBirthdayMessage: function(clienteId) {
                    const cliente = Sistema.data.clientes.find(c => c.id === clienteId);
                    if (!cliente || !cliente.telefone) {
                        UI.showToast('Telefone do cliente não encontrado', 'error');
                        return;
                    }
                    
                    const numero = cliente.telefone.replace(/\D/g, '');
                    
                    if (numero.length < 10 || numero.length > 11) {
                        UI.showToast('Número de telefone inválido', 'error');
                        return;
                    }
                    
                    const settings = Sistema.data.settings;
                    const mensagem = `🎉 *Parabéns, ${cliente.nome.split(' ')[0]}!*\n\nDesejo um feliz aniversário cheio de conquistas e realizações! 🎂🎁\n\nQue este novo ano de vida traga muita saúde, felicidade e prosperidade!\n\nAtenciosamente,\n*${settings.nome}*\nCRECI: ${settings.creci}`;
                    
                    const url = `https://wa.me/55${numero}?text=${encodeURIComponent(mensagem)}`;
                    window.open(url, '_blank');
                }
            },
            
            backup: {
                exportData: async function() {
                    try {
                        const data = {
                            clientes: Sistema.data.clientes,
                            imoveis: Sistema.data.imoveis,
                            agenda: Sistema.data.agenda,
                            plantoes: Sistema.data.plantoes,
                            funnel: Sistema.data.funnel,
                            settings: Sistema.data.settings,
                            exportDate: new Date().toISOString(),
                            version: '4.0',
                            appName: 'ImobiManager Pro - IndexedDB'
                        };
                        
                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `backup_imobimanager_indexeddb_${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        UI.showToast('Backup completo exportado com sucesso');
                    } catch (error) {
                        UI.showToast('Erro ao exportar backup', 'error');
                    }
                },
                
                exportImoveis: function() {
                    const data = {
                        imoveis: Sistema.data.imoveis,
                        exportDate: new Date().toISOString(),
                        version: '4.0',
                        type: 'imoveis_only',
                        appName: 'ImobiManager Pro'
                    };
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_imoveis_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    UI.showToast('Backup de imóveis exportado com sucesso');
                },
                
                importUniversalData: function(input) {
                    const file = input.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            const progress = document.createElement('div');
                            progress.className = 'import-progress';
                            progress.innerHTML = `
                                <div class="progress-info">
                                    <span>Importando dados...</span>
                                    <span class="progress-percentage">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill primary" style="width: 0%"></div>
                                </div>
                            `;
                            
                            const modalBody = document.querySelector('#modal-settings .modal-body');
                            modalBody.insertBefore(progress, modalBody.firstChild);
                            
                            setTimeout(async () => {
                                const extractedData = App.backup.processImportData(data, progress);
                                await App.backup.finalizeImport(extractedData, progress);
                            }, 100);
                            
                        } catch (error) {
                            console.error('Erro ao importar:', error);
                            UI.showToast('Erro ao importar backup: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                    
                    input.value = '';
                },
                
                processImportData: function(data, progress) {
                    progress.querySelector('.progress-percentage').textContent = '25%';
                    progress.querySelector('.progress-fill').style.width = '25%';
                    
                    const extractedData = {
                        clientes: data.clientes || data.Clientes || data.clients || data.usuarios || data.contatos || [],
                        imoveis: data.imoveis || data.Imoveis || data.properties || data.imoveis_list || data.propriedades || [],
                        agenda: data.agenda || data.Agenda || data.schedule || data.compromissos || [],
                        plantoes: data.plantoes || data.Plantoes || data.shifts || data.plantao || [],
                        funnel: data.funnel || data.Funnel || data.funil || {
                            stages: data.etapas || data.stages || data.estagios || [
                                { id: 'lead', name: 'Lead', color: '#0d4a2d', order: 1, icon: 'fas fa-user' },
                                { id: 'prospect', name: 'Prospect', color: '#0f6d3e', order: 2, icon: 'fas fa-user-check' },
                                { id: 'visita', name: 'Visita', color: '#2a5c8b', order: 3, icon: 'fas fa-eye' },
                                { id: 'proposta', name: 'Proposta', color: '#4a7fb8', order: 4, icon: 'fas fa-file-contract' },
                                { id: 'fechado', name: 'Fechado', color: '#d4af37', order: 5, icon: 'fas fa-handshake' }
                            ],
                            metas: data.funnel?.metas || data.metas || data.goals || {
                                leads: 50,
                                vendas: 5,
                                receita: 500000
                            }
                        },
                        settings: data.settings || data.Settings || data.config || data.configuracoes || {
                            id: 'settings',
                            nome: 'Corretor',
                            creci: '00000',
                            telefone: '',
                            email: '',
                            logo: ''
                        }
                    };
                    
                    progress.querySelector('.progress-percentage').textContent = '50%';
                    progress.querySelector('.progress-fill').style.width = '50%';
                    
                    const normalizeData = (items) => {
                        return items.map(item => {
                            if (!item.id) {
                                item.id = Utils.generateId('item');
                            }
                            
                            if (item.valor && typeof item.valor === 'string') {
                                item.valor = Utils.normalizeNumber(item.valor);
                            }
                            if (item.valorVenda && typeof item.valorVenda === 'string') {
                                item.valorVenda = Utils.normalizeNumber(item.valorVenda);
                            }
                            if (item.condominio && typeof item.condominio === 'string') {
                                item.condominio = Utils.normalizeNumber(item.condominio);
                            }
                            if (item.iptu && typeof item.iptu === 'string') {
                                item.iptu = Utils.normalizeNumber(item.iptu);
                            }
                            
                            if (item.interesses) {
                                if (item.interesses.valorMin && typeof item.interesses.valorMin === 'string') {
                                    item.interesses.valorMin = Utils.normalizeNumber(item.interesses.valorMin);
                                }
                                if (item.interesses.valorMax && typeof item.interesses.valorMax === 'string') {
                                    item.interesses.valorMax = Utils.normalizeNumber(item.interesses.valorMax);
                                }
                            }
                            
                            if (item.fotos && !Array.isArray(item.fotos)) {
                                item.fotos = [];
                            }
                            
                            return item;
                        });
                    };
                    
                    extractedData.clientes = normalizeData(extractedData.clientes);
                    extractedData.imoveis = normalizeData(extractedData.imoveis);
                    extractedData.agenda = normalizeData(extractedData.agenda);
                    extractedData.plantoes = normalizeData(extractedData.plantoes);
                    
                    progress.querySelector('.progress-percentage').textContent = '75%';
                    progress.querySelector('.progress-fill').style.width = '75%';
                    
                    return extractedData;
                },
                
                finalizeImport: async function(extractedData, progress) {
                    const totalItems = extractedData.clientes.length + extractedData.imoveis.length + 
                                      extractedData.agenda.length + extractedData.plantoes.length;
                    
                    if (totalItems === 0) {
                        progress.remove();
                        UI.showToast('Arquivo não contém dados válidos para importação', 'error');
                        return;
                    }
                    
                    const summary = `
                        Encontrados:
                        • ${extractedData.clientes.length} clientes
                        • ${extractedData.imoveis.length} imóveis (com fotos: ${extractedData.imoveis.filter(i => i.fotos && i.fotos.length > 0).length})
                        • ${extractedData.agenda.length} agendamentos
                        • ${extractedData.plantoes.length} plantões
                        
                        Deseja importar estes dados?
                    `;
                    
                    if (confirm(summary)) {
                        progress.querySelector('.progress-percentage').textContent = '100%';
                        progress.querySelector('.progress-fill').style.width = '100%';
                        
                        try {
                            // Salvar dados no IndexedDB
                            if (extractedData.clientes.length > 0) {
                                await Database.save('clientes', extractedData.clientes);
                            }
                            
                            if (extractedData.imoveis.length > 0) {
                                await Database.save('imoveis', extractedData.imoveis);
                            }
                            
                            if (extractedData.agenda.length > 0) {
                                await Database.save('agenda', extractedData.agenda);
                            }
                            
                            if (extractedData.plantoes.length > 0) {
                                await Database.save('plantoes', extractedData.plantoes);
                            }
                            
                            if (extractedData.funnel.stages && extractedData.funnel.stages.length > 0) {
                                const funnelData = { id: 'funnel', ...extractedData.funnel };
                                await Database.save('funnel', funnelData);
                            }
                            
                            if (extractedData.settings.nome && extractedData.settings.nome !== 'Corretor') {
                                await Database.save('settings', extractedData.settings);
                            }
                            
                            // Recarregar dados do IndexedDB
                            await Sistema.loadDataFromIndexedDB();
                            
                            setTimeout(() => {
                                progress.remove();
                                UI.showToast(`✅ Dados importados com sucesso! ${totalItems} itens processados.`);
                                
                                UI.closeModal('settings');
                                
                                setTimeout(() => {
                                    UI.renderDashboard();
                                    UI.renderClientes();
                                    UI.renderImoveis();
                                    UI.renderCalendar();
                                    Funnel.render();
                                }, 500);
                                
                            }, 500);
                            
                        } catch (error) {
                            progress.remove();
                            UI.showToast('Erro ao salvar dados importados', 'error');
                        }
                    } else {
                        progress.remove();
                    }
                },
                
                importImoveis: function(input) {
                    const file = input.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            const imoveis = data.imoveis || data.Imoveis || data.properties || data.imoveis_list || data.propriedades || [];
                            
                            if (imoveis.length === 0) {
                                throw new Error('Arquivo não contém imóveis válidos');
                            }
                            
                            const normalizedImoveis = imoveis.map(imovel => {
                                if (!imovel.id) {
                                    imovel.id = Utils.generateId('imovel');
                                }
                                if (imovel.valor && typeof imovel.valor === 'string') {
                                    imovel.valor = Utils.normalizeNumber(imovel.valor);
                                }
                                if (imovel.condominio && typeof imovel.condominio === 'string') {
                                    imovel.condominio = Utils.normalizeNumber(imovel.condominio);
                                }
                                if (imovel.iptu && typeof imovel.iptu === 'string') {
                                    imovel.iptu = Utils.normalizeNumber(imovel.iptu);
                                }
                                if (imovel.fotos && !Array.isArray(imovel.fotos)) {
                                    imovel.fotos = [];
                                }
                                return imovel;
                            });
                            
                            if (confirm(`Importar ${normalizedImoveis.length} imóveis?`)) {
                                await Database.save('imoveis', normalizedImoveis);
                                Sistema.data.imoveis = [...Sistema.data.imoveis, ...normalizedImoveis];
                                UI.showToast('Imóveis importados com sucesso');
                                UI.renderImoveis();
                                UI.renderDashboard();
                            }
                        } catch (error) {
                            UI.showToast('Erro ao importar backup de imóveis: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                    
                    input.value = '';
                },
                
                clearData: async function() {
                    if (confirm('⚠️ ATENÇÃO!\n\nTem certeza que deseja limpar TODOS os dados?\n\nEsta ação não pode ser desfeita e todos os clientes, imóveis, agenda e configurações serão perdidos.')) {
                        try {
                            await Database.clear('clientes');
                            await Database.clear('imoveis');
                            await Database.clear('agenda');
                            await Database.clear('plantoes');
                            await Database.clear('funnel');
                            await Database.clear('settings');
                            
                            Sistema.data.clientes = [];
                            Sistema.data.imoveis = [];
                            Sistema.data.agenda = [];
                            Sistema.data.plantoes = [];
                            Sistema.data.funnel = {
                                stages: [
                                    { id: 'lead', name: 'Lead', color: '#0d4a2d', order: 1, icon: 'fas fa-user' },
                                    { id: 'prospect', name: 'Prospect', color: '#0f6d3e', order: 2, icon: 'fas fa-user-check' },
                                    { id: 'visita', name: 'Visita', color: '#2a5c8b', order: 3, icon: 'fas fa-eye' },
                                    { id: 'proposta', name: 'Proposta', color: '#4a7fb8', order: 4, icon: 'fas fa-file-contract' },
                                    { id: 'fechado', name: 'Fechado', color: '#d4af37', order: 5, icon: 'fas fa-handshake' }
                                ],
                                metas: {
                                    leads: 50,
                                    vendas: 5,
                                    receita: 500000
                                }
                            };
                            Sistema.data.settings = {
                                id: 'settings',
                                nome: 'Corretor',
                                creci: '00000',
                                telefone: '',
                                email: '',
                                logo: ''
                            };
                            
                            UI.showToast('Todos os dados foram limpos');
                            UI.renderDashboard();
                            UI.renderClientes();
                            UI.renderImoveis();
                            UI.renderCalendar();
                            Funnel.render();
                            
                        } catch (error) {
                            UI.showToast('Erro ao limpar dados', 'error');
                        }
                    }
                }
            }
        };

        // --- RELATÓRIOS ---
        const Relatorios = {
            render: function() {
                this.renderReportsGrid();
                this.renderPerformanceChart();
            },
            
            renderReportsGrid: function() {
                const grid = document.getElementById('reports-grid');
                grid.innerHTML = `
                    <div class="report-card" onclick="Relatorios.gerarRelatorioVendas()">
                        <div class="report-icon" style="background: var(--primary); color: white;">
                            <i class="fas fa-handshake"></i>
                        </div>
                        <div class="report-name">Relatório de Vendas</div>
                        <div class="report-desc">PDF com vendas do mês</div>
                    </div>
                    
                    <div class="report-card" onclick="Relatorios.gerarRelatorioClientes()">
                        <div class="report-icon" style="background: var(--secondary); color: white;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="report-name">Relatório de Clientes</div>
                        <div class="report-desc">Lista completa de clientes</div>
                    </div>
                    
                    <div class="report-card" onclick="Relatorios.gerarRelatorioImoveis()">
                        <div class="report-icon" style="background: var(--accent); color: white;">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="report-name">Relatório de Imóveis</div>
                        <div class="report-desc">Inventário completo</div>
                    </div>
                    
                    <div class="report-card" onclick="Relatorios.gerarRelatorioAgenda()">
                        <div class="report-icon" style="background: var(--primary); color: white;">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="report-name">Relatório de Agenda</div>
                        <div class="report-desc">Agendamentos do mês</div>
                    </div>
                    
                    <div class="report-card" onclick="Relatorios.gerarRelatorioFunil()">
                        <div class="report-icon" style="background: var(--secondary); color: white;">
                            <i class="fas fa-filter"></i>
                        </div>
                        <div class="report-name">Relatório do Funil</div>
                        <div class="report-desc">Análise de conversão</div>
                    </div>
                    
                    <div class="report-card" onclick="Relatorios.gerarRelatorioPlantao()">
                        <div class="report-icon" style="background: var(--accent); color: white;">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="report-name">Relatório de Plantão</div>
                        <div class="report-desc">Plantões realizados</div>
                    </div>
                    
                    <div class="report-card" onclick="Relatorios.gerarRelatorioMetas()">
                        <div class="report-icon" style="background: var(--primary); color: white;">
                            <i class="fas fa-bullseye"></i>
                        </div>
                        <div class="report-name">Relatório de Metas</div>
                        <div class="report-desc">Desempenho vs Metas</div>
                    </div>
                    
                    <div class="report-card" onclick="Relatorios.gerarRelatorioFinanceiro()">
                        <div class="report-icon" style="background: var(--secondary); color: white;">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="report-name">Relatório Financeiro</div>
                        <div class="report-desc">Receitas e despesas</div>
                    </div>
                `;
            },
            
            renderPerformanceChart: function() {
                const ctx = document.getElementById('performance-chart').getContext('2d');
                const metas = Sistema.data.funnel.metas;
                
                const hoje = new Date();
                const meses = [];
                const vendasPorMes = [];
                
                for (let i = 5; i >= 0; i--) {
                    const mes = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                    const mesFormatado = mes.toLocaleDateString('pt-BR', { month: 'short' });
                    meses.push(mesFormatado);
                    
                    const vendas = Sistema.data.clientes.filter(c => {
                        if (c.status !== 'fechado' || !c.dataFechamento) return false;
                        
                        const dataFechamento = new Date(c.dataFechamento);
                        return dataFechamento.getMonth() === mes.getMonth() && 
                               dataFechamento.getFullYear() === mes.getFullYear();
                    }).length;
                    
                    vendasPorMes.push(vendas);
                }
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: meses,
                        datasets: [{
                            label: 'Vendas por Mês',
                            data: vendasPorMes,
                            backgroundColor: 'rgba(13, 74, 45, 0.5)',
                            borderColor: 'rgb(13, 74, 45)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            },
            
            gerarRelatorioVendas: function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const settings = Sistema.data.settings;
                const hoje = new Date();
                const mesAtual = hoje.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                doc.setFontSize(18);
                doc.text('RELATÓRIO DE VENDAS', 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(`Período: ${mesAtual}`, 20, 30);
                doc.text(`Emitido por: ${settings.nome} - CRECI: ${settings.creci}`, 20, 36);
                doc.text(`Data: ${hoje.toLocaleDateString('pt-BR')}`, 20, 42);
                
                const vendas = Sistema.data.clientes.filter(c => c.status === 'fechado');
                let y = 60;
                
                if (vendas.length === 0) {
                    doc.text('Nenhuma venda registrada neste período.', 20, y);
                } else {
                    const tableData = vendas.map((venda, index) => [
                        index + 1,
                        venda.nome,
                        venda.telefone,
                        venda.valorVenda ? Utils.formatCurrency(venda.valorVenda) : '-',
                        venda.dataFechamento || '-'
                    ]);
                    
                    doc.autoTable({
                        head: [['#', 'Cliente', 'Telefone', 'Valor', 'Data']],
                        body: tableData,
                        startY: y,
                        theme: 'grid',
                        headStyles: { fillColor: [13, 74, 45] }
                    });
                    
                    y = doc.lastAutoTable.finalY + 10;
                    
                    const totalVendas = vendas.length;
                    const totalReceita = vendas.reduce((acc, v) => acc + (v.valorVenda || 0), 0);
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`Total de Vendas: ${totalVendas}`, 20, y);
                    y += 7;
                    doc.text(`Receita Total: ${Utils.formatCurrency(totalReceita)}`, 20, y);
                }
                
                doc.save(`Relatorio_Vendas_${hoje.toISOString().split('T')[0]}.pdf`);
                UI.showToast('Relatório de vendas gerado em PDF');
            },
            
            gerarRelatorioClientes: function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const settings = Sistema.data.settings;
                const hoje = new Date().toLocaleDateString('pt-BR');
                
                doc.setFontSize(18);
                doc.text('RELATÓRIO DE CLIENTES', 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(`Emitido por: ${settings.nome} - CRECI: ${settings.creci}`, 20, 30);
                doc.text(`Data: ${hoje}`, 20, 36);
                doc.text(`Total de Clientes: ${Sistema.data.clientes.length}`, 20, 42);
                
                const tableData = Sistema.data.clientes.map((cliente, index) => [
                    index + 1,
                    cliente.nome,
                    cliente.telefone,
                    cliente.nascimento || '-',
                    cliente.status
                ]);
                
                doc.autoTable({
                    head: [['#', 'Nome', 'Telefone', 'Nascimento', 'Status']],
                    body: tableData,
                    startY: 50,
                    theme: 'grid',
                    headStyles: { fillColor: [13, 74, 45] }
                });
                
                doc.save(`Relatorio_Clientes_${hoje.replace(/\//g, '-')}.pdf`);
                UI.showToast('Relatório de clientes gerado em PDF');
            },
            
            gerarRelatorioImoveis: function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const settings = Sistema.data.settings;
                const hoje = new Date().toLocaleDateString('pt-BR');
                
                doc.setFontSize(18);
                doc.text('RELATÓRIO DE IMÓVEIS', 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(`Emitido por: ${settings.nome} - CRECI: ${settings.creci}`, 20, 30);
                doc.text(`Data: ${hoje}`, 20, 36);
                doc.text(`Total de Imóveis: ${Sistema.data.imoveis.length}`, 20, 42);
                
                const tableData = Sistema.data.imoveis.map((imovel, index) => [
                    index + 1,
                    imovel.nome,
                    Utils.formatCurrency(imovel.valor),
                    imovel.status,
                    imovel.dataCadastro || '-'
                ]);
                
                doc.autoTable({
                    head: [['#', 'Descrição', 'Valor', 'Status', 'Cadastro']],
                    body: tableData,
                    startY: 50,
                    theme: 'grid',
                    headStyles: { fillColor: [13, 74, 45] }
                });
                
                doc.save(`Relatorio_Imoveis_${hoje.replace(/\//g, '-')}.pdf`);
                UI.showToast('Relatório de imóveis gerado em PDF');
            },
            
            gerarRelatorioAgenda: function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const settings = Sistema.data.settings;
                const hoje = new Date();
                const mesAtual = hoje.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                doc.setFontSize(18);
                doc.text('RELATÓRIO DE AGENDA', 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(`Período: ${mesAtual}`, 20, 30);
                doc.text(`Emitido por: ${settings.nome} - CRECI: ${settings.creci}`, 20, 36);
                doc.text(`Data: ${hoje.toLocaleDateString('pt-BR')}`, 20, 42);
                
                const mes = hoje.getMonth();
                const ano = hoje.getFullYear();
                const agendaMes = Sistema.data.agenda.filter(a => {
                    const data = new Date(a.data);
                    return data.getMonth() === mes && data.getFullYear() === ano;
                });
                
                let y = 60;
                
                if (agendaMes.length === 0) {
                    doc.text('Nenhum agendamento neste período.', 20, y);
                } else {
                    const tableData = agendaMes.map((agenda, index) => {
                        const cliente = Sistema.data.clientes.find(c => c.id === agenda.clienteId);
                        return [
                            index + 1,
                            agenda.tipo,
                            cliente ? cliente.nome : '-',
                            agenda.data,
                            agenda.horario,
                            agenda.status
                        ];
                    });
                    
                    doc.autoTable({
                        head: [['#', 'Tipo', 'Cliente', 'Data', 'Horário', 'Status']],
                        body: tableData,
                        startY: y,
                        theme: 'grid',
                        headStyles: { fillColor: [13, 74, 45] }
                    });
                    
                    y = doc.lastAutoTable.finalY + 10;
                    
                    const stats = {
                        total: agendaMes.length,
                        confirmados: agendaMes.filter(a => a.status === 'confirmado').length,
                        pendentes: agendaMes.filter(a => a.status === 'agendado').length,
                        cancelados: agendaMes.filter(a => a.status === 'cancelado').length
                    };
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`Total de Agendamentos: ${stats.total}`, 20, y);
                    y += 7;
                    doc.text(`Confirmados: ${stats.confirmados} | Pendentes: ${stats.pendentes} | Cancelados: ${stats.cancelados}`, 20, y);
                }
                
                doc.save(`Relatorio_Agenda_${hoje.toISOString().split('T')[0]}.pdf`);
                UI.showToast('Relatório de agenda gerado em PDF');
            },
            
            gerarRelatorioFunil: function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const settings = Sistema.data.settings;
                const hoje = new Date().toLocaleDateString('pt-BR');
                
                doc.setFontSize(18);
                doc.text('RELATÓRIO DO FUNIL', 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(`Emitido por: ${settings.nome} - CRECI: ${settings.creci}`, 20, 30);
                doc.text(`Data: ${hoje}`, 20, 36);
                
                const stages = Sistema.data.funnel.stages;
                const totalClientes = Sistema.data.clientes.length;
                
                let y = 50;
                
                stages.forEach((stage, index) => {
                    const clientesNaEtapa = Sistema.data.clientes.filter(c => c.status === stage.id).length;
                    const porcentagem = totalClientes > 0 ? (clientesNaEtapa / totalClientes * 100).toFixed(1) : 0;
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${stage.name}`, 20, y);
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`   Quantidade: ${clientesNaEtapa} (${porcentagem}%)`, 25, y + 6);
                    
                    y += 15;
                });
                
                y += 10;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('ANÁLISE DE CONVERSÃO', 20, y);
                y += 10;
                
                const leads = Sistema.data.clientes.filter(c => c.status === 'lead' || c.status === 'prospect').length;
                const fechados = Sistema.data.clientes.filter(c => c.status === 'fechado').length;
                const taxaConversao = leads > 0 ? ((fechados / leads) * 100).toFixed(1) : 0;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Total de Leads: ${leads}`, 20, y);
                y += 7;
                doc.text(`Total de Vendas: ${fechados}`, 20, y);
                y += 7;
                doc.setFont(undefined, 'bold');
                doc.text(`Taxa de Conversão: ${taxaConversao}%`, 20, y);
                
                doc.save(`Relatorio_Funil_${hoje.replace(/\//g, '-')}.pdf`);
                UI.showToast('Relatório do funil gerado em PDF');
            },
            
            gerarRelatorioPlantao: function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const settings = Sistema.data.settings;
                const hoje = new Date();
                const mesAtual = hoje.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                doc.setFontSize(18);
                doc.text('RELATÓRIO DE PLANTÃO', 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(`Período: ${mesAtual}`, 20, 30);
                doc.text(`Emitido por: ${settings.nome} - CRECI: ${settings.creci}`, 20, 36);
                doc.text(`Data: ${hoje.toLocaleDateString('pt-BR')}`, 20, 42);
                
                const mes = hoje.getMonth();
                const ano = hoje.getFullYear();
                const plantoesMes = Sistema.data.plantoes.filter(p => {
                    const data = new Date(p.data);
                    return data.getMonth() === mes && data.getFullYear() === ano;
                });
                
                let y = 60;
                
                if (plantoesMes.length === 0) {
                    doc.text('Nenhum plantão registrado neste período.', 20, y);
                } else {
                    const tableData = plantoesMes.map((plantao, index) => [
                        index + 1,
                        plantao.data,
                        plantao.empreendimento || '-',
                        plantao.periodo || '-'
                    ]);
                    
                    doc.autoTable({
                        head: [['#', 'Data', 'Empreendimento', 'Período']],
                        body: tableData,
                        startY: y,
                        theme: 'grid',
                        headStyles: { fillColor: [13, 74, 45] }
                    });
                    
                    y = doc.lastAutoTable.finalY + 10;
                    
                    const stats = {
                        total: plantoesMes.length,
                        manha: plantoesMes.filter(p => p.periodo === 'manha').length,
                        tarde: plantoesMes.filter(p => p.periodo === 'tarde').length,
                        noite: plantoesMes.filter(p => p.periodo === 'noite').length,
                        integral: plantoesMes.filter(p => p.periodo === 'integral').length
                    };
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`Total de Plantões: ${stats.total}`, 20, y);
                    y += 7;
                    doc.text(`Manhã: ${stats.manha} | Tarde: ${stats.tarde} | Noite: ${stats.noite} | Integral: ${stats.integral}`, 20, y);
                }
                
                doc.save(`Relatorio_Plantao_${hoje.toISOString().split('T')[0]}.pdf`);
                UI.showToast('Relatório de plantão gerado em PDF');
            },
            
            gerarRelatorioMetas: function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const settings = Sistema.data.settings;
                const hoje = new Date();
                const mesAtual = hoje.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                doc.setFontSize(18);
                doc.text('RELATÓRIO DE METAS', 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(`Período: ${mesAtual}`, 20, 30);
                doc.text(`Emitido por: ${settings.nome} - CRECI: ${settings.creci}`, 20, 36);
                doc.text(`Data: ${hoje.toLocaleDateString('pt-BR')}`, 20, 42);
                
                const metas = Sistema.data.funnel.metas;
                const stats = Sistema.updateDashboard();
                
                let y = 60;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('METAS MENSAS', 20, y);
                y += 10;
                
                const tableData = [
                    ['Leads', metas.leads, stats.leadsAtivos, ((stats.leadsAtivos / metas.leads) * 100).toFixed(1) + '%'],
                    ['Vendas', metas.vendas, stats.vendasMes, ((stats.vendasMes / metas.vendas) * 100).toFixed(1) + '%'],
                    ['Receita', Utils.formatCurrency(metas.receita), 
                     Utils.formatCurrency(stats.receitaMes), 
                     ((stats.receitaMes / metas.receita) * 100).toFixed(1) + '%']
                ];
                
                doc.autoTable({
                    head: [['Meta', 'Objetivo', 'Realizado', '% Atingido']],
                    body: tableData,
                    startY: y,
                    theme: 'grid',
                    headStyles: { fillColor: [13, 74, 45] },
                    didDrawCell: (data) => {
                        if (data.section === 'body' && data.column.index === 3) {
                            const value = parseFloat(data.cell.raw);
                            if (value >= 100) {
                                data.cell.styles.fillColor = [16, 185, 129];
                                data.cell.styles.textColor = [255, 255, 255];
                            } else if (value >= 70) {
                                data.cell.styles.fillColor = [245, 158, 11];
                                data.cell.styles.textColor = [255, 255, 255];
                            } else {
                                data.cell.styles.fillColor = [231, 76, 60];
                                data.cell.styles.textColor = [255, 255, 255];
                            }
                        }
                    }
                });
                
                y = doc.lastAutoTable.finalY + 15;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('ANÁLISE DE DESEMPENHO', 20, y);
                y += 10;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                const desempenho = ((stats.vendasMes / metas.vendas) * 100).toFixed(1);
                
                if (desempenho >= 100) {
                    doc.text('✅ Excelente desempenho! As metas foram superadas.', 20, y);
                    y += 7;
                    doc.text('Continue com o ótimo trabalho.', 20, y);
                } else if (desempenho >= 70) {
                    doc.text('⚠️ Bom desempenho, mas há espaço para melhorias.', 20, y);
                    y += 7;
                    doc.text('Foque na prospecção para atingir as metas.', 20, y);
                } else {
                    doc.text('❌ Desempenho abaixo do esperado.', 20, y);
                    y += 7;
                    doc.text('Reveja sua estratégia e intensifique a prospecção.', 20, y);
                }
                
                doc.save(`Relatorio_Metas_${hoje.toISOString().split('T')[0]}.pdf`);
                UI.showToast('Relatório de metas gerado em PDF');
            },
            
            gerarRelatorioFinanceiro: function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const settings = Sistema.data.settings;
                const hoje = new Date();
                const mesAtual = hoje.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                doc.setFontSize(18);
                doc.text('RELATÓRIO FINANCEIRO', 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(`Período: ${mesAtual}`, 20, 30);
                doc.text(`Emitido por: ${settings.nome} - CRECI: ${settings.creci}`, 20, 36);
                doc.text(`Data: ${hoje.toLocaleDateString('pt-BR')}`, 20, 42);
                
                const vendas = Sistema.data.clientes.filter(c => c.status === 'fechado' && c.valorVenda);
                let y = 60;
                
                if (vendas.length === 0) {
                    doc.text('Nenhuma transação financeira registrada.', 20, y);
                } else {
                    const tableData = vendas.map((venda, index) => [
                        index + 1,
                        venda.nome,
                        venda.dataFechamento || '-',
                        Utils.formatCurrency(venda.valorVenda)
                    ]);
                    
                    doc.autoTable({
                        head: [['#', 'Cliente', 'Data', 'Valor']],
                        body: tableData,
                        startY: y,
                        theme: 'grid',
                        headStyles: { fillColor: [13, 74, 45] }
                    });
                    
                    y = doc.lastAutoTable.finalY + 10;
                    
                    const totalReceita = vendas.reduce((acc, v) => acc + (v.valorVenda || 0), 0);
                    const mediaVenda = totalReceita / vendas.length;
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`Total de Vendas: ${vendas.length}`, 20, y);
                    y += 7;
                    doc.text(`Receita Total: ${Utils.formatCurrency(totalReceita)}`, 20, y);
                    y += 7;
                    doc.text(`Ticket Médio: ${Utils.formatCurrency(mediaVenda)}`, 20, y);
                }
                
                doc.save(`Relatorio_Financeiro_${hoje.toISOString().split('T')[0]}.pdf`);
                UI.showToast('Relatório financeiro gerado em PDF');
            },
            
            exportAllReports: function() {
                if (confirm('Deseja exportar todos os relatórios em PDF?\n\nEsta ação pode levar alguns segundos.')) {
                    setTimeout(() => Relatorios.gerarRelatorioVendas(), 100);
                    setTimeout(() => Relatorios.gerarRelatorioClientes(), 500);
                    setTimeout(() => Relatorios.gerarRelatorioImoveis(), 900);
                    setTimeout(() => Relatorios.gerarRelatorioAgenda(), 1300);
                    setTimeout(() => Relatorios.gerarRelatorioFunil(), 1700);
                    setTimeout(() => Relatorios.gerarRelatorioPlantao(), 2100);
                    setTimeout(() => Relatorios.gerarRelatorioMetas(), 2500);
                    setTimeout(() => Relatorios.gerarRelatorioFinanceiro(), 2900);
                    
                    UI.showToast('Todos os relatórios estão sendo gerados...');
                }
            },
            
            gerarFichaClientePrompt: function() {
                if (Sistema.data.clientes.length === 0) {
                    UI.showToast('Nenhum cliente cadastrado', 'error');
                    return;
                }
                
                let html = '<div style="padding: 20px;">';
                html += '<h3 style="margin-bottom: 16px;">Selecione um cliente:</h3>';
                html += '<div style="max-height: 300px; overflow-y: auto;">';
                
                Sistema.data.clientes.forEach(cliente => {
                    html += `
                        <div class="list-card" onclick="App.cliente.generatePDF('${cliente.id}'); UI.closeModal('select-pdf')" style="margin-bottom: 8px;">
                            <div class="card-title">${cliente.nome}</div>
                            <div class="card-subtitle">
                                <i class="fas fa-phone"></i> ${cliente.telefone}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                
                document.getElementById('pdf-modal-title').innerHTML = '<i class="fas fa-user"></i> Selecione Cliente';
                document.getElementById('pdf-select-list').innerHTML = html;
                UI.showModal('select-pdf');
            },
            
            gerarFichaImovelPrompt: function() {
                if (Sistema.data.imoveis.length === 0) {
                    UI.showToast('Nenhum imóvel cadastrado', 'error');
                    return;
                }
                
                let html = '<div style="padding: 20px;">';
                html += '<h3 style="margin-bottom: 16px;">Selecione um imóvel:</h3>';
                html += '<div style="max-height: 300px; overflow-y: auto;">';
                
                Sistema.data.imoveis.forEach(imovel => {
                    html += `
                        <div class="list-card" onclick="App.imovel.generatePDF('${imovel.id}'); UI.closeModal('select-pdf')" style="margin-bottom: 8px;">
                            <div class="card-title">${imovel.nome}</div>
                            <div class="card-subtitle">
                                <i class="fas fa-dollar-sign"></i> ${Utils.formatCurrency(imovel.valor)}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                
                document.getElementById('pdf-modal-title').innerHTML = '<i class="fas fa-home"></i> Selecione Imóvel';
                document.getElementById('pdf-select-list').innerHTML = html;
                UI.showModal('select-pdf');
            }
        };

        // --- INICIALIZAÇÃO DO SISTEMA ---
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await Sistema.init();
            } catch (error) {
                console.error('Erro fatal na inicialização:', error);
                UI.showToast('Erro ao inicializar o sistema. Tente recarregar a página.', 'error');
            }
        });
    </script>
</body>
</html>
