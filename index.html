<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ImobiManager - Gestão para Corretores</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Cores Modernas Palette - Tema Imobiliário */
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --accent: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            
            /* Cores específicas imobiliárias */
            --imovel-new: #06b6d4;
            --imovel-launch: #8b5cf6;
            --imovel-construction: #f59e0b;
            --imovel-ready: #10b981;
            --imovel-lot: #64748b;
            
            /* Dimensões e Espaçamentos */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --header-height: calc(60px + var(--safe-top));
            --nav-height: calc(65px + var(--safe-bottom));
            --radius-lg: 16px;
            --radius-md: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-float: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: var(--dark);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* --- Header --- */
        header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: var(--safe-top) 16px 10px;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 50;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: var(--shadow-sm);
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--dark);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .brand span { color: var(--primary); }
        
        .header-actions { display: flex; gap: 12px; }
        .icon-btn {
            background: none; border: none; font-size: 1.2rem;
            color: var(--secondary); padding: 8px;
            border-radius: 50%; transition: 0.2s;
        }
        .icon-btn:active { background: #f1f5f9; color: var(--primary); transform: scale(0.95); }

        /* --- Main Content Area --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding: calc(var(--header-height) + 16px) 16px calc(var(--nav-height) + 80px);
            scroll-behavior: smooth;
        }

        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Cards & Stats --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--surface);
            padding: 16px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:active { transform: scale(0.98); box-shadow: var(--shadow-sm); }

        .stat-icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem;
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--dark); line-height: 1; }
        .stat-label { font-size: 0.8rem; color: var(--secondary); font-weight: 500; }

        /* Chart Container */
        .chart-container {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            height: 300px;
            position: relative;
        }

        /* Colors for Stats */
        .bg-blue { background: #dbeafe; color: var(--primary); }
        .bg-green { background: #d1fae5; color: var(--success); }
        .bg-orange { background: #ffedd5; color: var(--warning); }
        .bg-red { background: #fee2e2; color: var(--danger); }
        .bg-purple { background: #f3e8ff; color: #8b5cf6; }
        .bg-cyan { background: #cffafe; color: #06b6d4; }
        .bg-teal { background: #ccfbf1; color: #0d9488; }

        /* --- Lists & items --- */
        .section-title {
            font-size: 1.1rem; font-weight: 700; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .search-container {
            position: relative; margin-bottom: 16px;
        }
        .search-input {
            width: 100%; padding: 12px 12px 12px 40px;
            border: 1px solid var(--border); border-radius: var(--radius-md);
            background: var(--surface); font-size: 1rem; outline: none;
            -webkit-appearance: none;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: var(--secondary);
        }

        /* List Card - Melhorado para clicar */
        .list-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            border-left: 4px solid transparent;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .list-card:active { transform: scale(0.98); }

        .card-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .card-title { font-weight: 700; font-size: 1rem; color: var(--dark); }
        .card-subtitle { font-size: 0.85rem; color: var(--secondary); display: flex; gap: 6px; align-items: center; }
        
        .tag {
            font-size: 0.7rem; padding: 4px 8px; border-radius: 99px;
            font-weight: 600; text-transform: uppercase;
        }
        .tag-new { background: #e0f2fe; color: #0369a1; }
        .tag-lead { background: #fef3c7; color: #b45309; }
        .tag-prospect { background: #d1fae5; color: #047857; }
        .tag-negotiation { background: #dbeafe; color: #1d4ed8; }
        .tag-contract { background: #f3e8ff; color: #7c3aed; }
        .tag-closed { background: #dcfce7; color: #15803d; }
        .tag-lost { background: #fee2e2; color: #b91c1c; }
        .tag-alert { background: #fee2e2; color: #ef4444; animation: pulse 2s infinite; }
        .tag-scheduled { background: #fef3c7; color: #b45309; }

        /* Tags para imóveis */
        .tag-pre-lancamento { background: #cffafe; color: #0e7490; }
        .tag-lancamento { background: #e0e7ff; color: #4f46e5; }
        .tag-em-obra { background: #fef3c7; color: #b45309; }
        .tag-pronto { background: #d1fae5; color: #047857; }
        .tag-lote { background: #e2e8f0; color: #475569; }

        .card-price { font-size: 1.1rem; font-weight: 800; color: var(--primary); margin-top: 8px; }

        .action-row {
            display: flex; gap: 8px; margin-top: 12px; padding-top: 12px;
            border-top: 1px solid #f1f5f9;
        }
        .btn-sm {
            flex: 1; padding: 8px; border-radius: 8px;
            border: none; font-size: 0.85rem; font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            cursor: pointer;
        }
        .btn-light { background: #f1f5f9; color: var(--secondary); }
        .btn-primary-soft { background: #dbeafe; color: var(--primary); }
        .btn-whatsapp { background: #dcfce7; color: #16a34a; }
        .btn-cyan { background: #cffafe; color: #0e7490; }
        .btn-purple { background: #f3e8ff; color: #7c3aed; }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--nav-height);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around;
            padding-bottom: var(--safe-bottom);
            z-index: 50;
        }

        .nav-item {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: #94a3b8; text-decoration: none;
            font-size: 0.7rem; font-weight: 500;
            gap: 4px; transition: 0.2s;
        }
        .nav-item i { font-size: 1.25rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }

        /* --- Floating Action Button (FAB) --- */
        .fab {
            position: fixed;
            bottom: calc(var(--nav-height) + 16px);
            right: 16px;
            width: 56px; height: 56px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-float);
            z-index: 40;
            border: none;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9) rotate(90deg); }

        /* --- Modals / Sheets --- */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: none; opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .modal-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--surface);
            border-radius: 20px 20px 0 0;
            padding: 24px 16px calc(24px + var(--safe-bottom));
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 90vh;
            overflow-y: auto;
            z-index: 101;
            display: flex; flex-direction: column;
        }
        .modal-overlay.active + .modal-sheet { transform: translateY(0); }

        .sheet-handle {
            width: 40px; height: 4px; background: #cbd5e1;
            border-radius: 2px; margin: 0 auto 20px;
        }

        /* --- Forms --- */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 6px; color: var(--dark); }
        .form-control {
            width: 100%; padding: 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            background: #f8fafc;
            -webkit-appearance: none;
        }
        .form-control:focus { background: white; border-color: var(--primary); outline: none; }
        textarea.form-control { min-height: 100px; resize: none; }
        select.form-control { cursor: pointer; }

        .btn-block {
            width: 100%; padding: 16px;
            border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 700;
            background: var(--primary); color: white;
            margin-top: 10px;
        }

        /* --- Card de Detalhes --- */
        .details-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-md);
        }
        
        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .details-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--dark);
        }
        
        .details-subtitle {
            font-size: 0.9rem;
            color: var(--secondary);
            margin-top: 5px;
        }
        
        .details-section {
            margin-bottom: 20px;
        }
        
        .details-section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .details-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .info-label {
            font-size: 0.8rem;
            color: var(--secondary);
            font-weight: 500;
        }
        
        .info-value {
            font-size: 1rem;
            color: var(--dark);
            font-weight: 600;
        }
        
        .private-notes {
            background: #fff7ed;
            border-left: 4px solid var(--warning);
            padding: 12px 16px;
            border-radius: 0 8px 8px 0;
            margin-top: 20px;
        }
        
        .private-notes-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: #c2410c;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .private-notes-content {
            font-size: 0.9rem;
            color: #7c2d12;
            line-height: 1.4;
        }
        
        .details-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        .btn-details {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn-details:active { transform: scale(0.95); }
        
        .btn-details-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-details-whatsapp {
            background: #25D366;
            color: white;
        }
        
        .btn-details-secondary {
            background: var(--light);
            color: var(--secondary);
        }
        
        .btn-details-danger {
            background: var(--light);
            color: var(--danger);
        }

        /* Preview de Fotos */
        .photos-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .photo-preview {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid var(--border);
        }
        
        .photo-upload-area {
            width: 60px;
            height: 60px;
            border: 2px dashed var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .photo-upload-area:active {
            background: var(--light);
        }

        /* Imagem Preview no Settings */
        .logo-preview-container {
            width: 100%; display: flex; justify-content: center; margin-bottom: 15px;
        }
        .logo-preview {
            width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
            border: 2px dashed var(--border); background: var(--light);
        }
        
        /* Utility */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--secondary); }
        .empty-state i { font-size: 3rem; margin-bottom: 16px; opacity: 0.3; }
        
        .toast {
            position: fixed; top: var(--header-height); left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--dark); color: white;
            padding: 12px 24px; border-radius: 50px;
            font-size: 0.9rem; font-weight: 500;
            box-shadow: var(--shadow-float);
            z-index: 200;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 8px;
            white-space: nowrap;
        }
        .toast.show { transform: translateX(-50%) translateY(20px); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        
        /* Badge para notificações */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
        }
        
        .badge-primary { background: var(--primary); color: white; }
        .badge-warning { background: var(--warning); color: white; }
        .badge-danger { background: var(--danger); color: white; }
        .badge-cyan { background: #06b6d4; color: white; }
        .badge-teal { background: #0d9488; color: white; }
        
        /* Data e hora formatadas */
        .date-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--light);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--secondary);
        }
        
        /* Alertas de agenda */
        .agenda-alert-card {
            background: #fffbeb;
            border-left: 4px solid var(--warning);
            margin-bottom: 12px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .agenda-date-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: #b45309;
            background: #fef3c7;
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 4px;
        }
        
        /* Status de contato agendado */
        .status-agenda {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .status-agenda.scheduled {
            background: #fef3c7;
            color: #b45309;
        }
        
        .status-agenda.completed {
            background: #d1fae5;
            color: #047857;
        }
        
        /* Filtros */
        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--light);
            color: var(--secondary);
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Modal de confirmação WhatsApp */
        .confirm-whatsapp-modal {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            max-width: 400px;
            width: 90%;
            margin: auto;
            text-align: center;
        }
        
        .confirm-whatsapp-modal .modal-icon {
            font-size: 3rem;
            color: #25D366;
            margin-bottom: 16px;
        }
        
        .confirm-whatsapp-modal .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }
        
        .confirm-whatsapp-modal .modal-description {
            color: var(--secondary);
            margin-bottom: 24px;
            line-height: 1.4;
        }
        
        .confirm-whatsapp-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .confirm-whatsapp-btn {
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .confirm-whatsapp-btn:active { transform: scale(0.98); }
        
        .confirm-whatsapp-btn.simples {
            background: #dbeafe;
            color: var(--primary);
        }
        
        .confirm-whatsapp-btn.completo {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .confirm-whatsapp-btn.massa {
            background: #f3e8ff;
            color: #7c3aed;
        }
        
        .confirm-whatsapp-btn.cancelar {
            background: var(--light);
            color: var(--secondary);
        }
        
        /* Card de imóvel com foto */
        .imovel-card-photo {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border-radius: 8px 8px 0 0;
            margin: -16px -16px 12px -16px;
        }
        
        /* Grid de fotos no modal */
        .fotos-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .foto-thumb {
            width: 100%;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
        }
        
        /* Formulário dinâmico para lotes */
        .dynamic-fields {
            display: none;
        }
        
        .dynamic-fields.active {
            display: block;
        }
        
        /* Seletor de clientes para mensagem em massa */
        .client-selector {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 16px;
        }
        
        .client-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
        }
        
        .client-checkbox-item:hover {
            background: var(--light);
        }
        
        .client-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        /* Funil visual */
        .funnel-container {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 16px 0;
            margin-bottom: 24px;
        }
        
        .funnel-stage {
            min-width: 200px;
            background: var(--light);
            border-radius: 12px;
            padding: 12px;
        }
        
        .funnel-stage-title {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid;
            text-align: center;
        }
        
        .funnel-lead-item {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
        }
        
        .funnel-lead-item:hover {
            box-shadow: var(--shadow-md);
        }
        
        /* Grid para múltiplas fotos */
        .multi-photo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .multi-photo-item {
            position: relative;
            width: 100%;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .multi-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-photo {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
        }
        
        /* Estilo para relatórios */
        .report-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
        }
        
        .report-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--dark);
            margin-bottom: 8px;
        }
        
        .report-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <i class="fas fa-home" style="color: var(--primary);"></i>
            Imobi<span>Manager</span>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="App.backup.exportData()"><i class="fas fa-cloud-download-alt"></i></button>
            <button class="icon-btn" onclick="UI.openSettings()"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i> <span>Ação realizada!</span>
    </div>

    <main>
        <div id="dashboard-view" class="view active">
            <div class="section-title">Visão Geral</div>
            <div class="stats-grid">
                <div class="stat-card" onclick="UI.navigate('clientes')">
                    <div class="stat-icon bg-blue"><i class="fas fa-users"></i></div>
                    <div class="stat-value" id="dash-total-clientes">0</div>
                    <div class="stat-label">Clientes</div>
                </div>
                <div class="stat-card" onclick="UI.navigate('imoveis')">
                    <div class="stat-icon bg-purple"><i class="fas fa-building"></i></div>
                    <div class="stat-value" id="dash-total-imoveis">0</div>
                    <div class="stat-label">Imóveis</div>
                </div>
                <div class="stat-card" onclick="UI.navigateToAgenda('today')">
                    <div class="stat-icon bg-orange"><i class="fas fa-calendar-day"></i></div>
                    <div class="stat-value" id="dash-agenda-hoje">0</div>
                    <div class="stat-label">Agenda Hoje</div>
                </div>
                <div class="stat-card" onclick="UI.navigate('vendas')">
                    <div class="stat-icon bg-green"><i class="fas fa-handshake"></i></div>
                    <div class="stat-value" id="dash-vendas-mes">0</div>
                    <div class="stat-label">Vendas/Mês</div>
                </div>
                <div class="stat-card" onclick="UI.navigate('funil')">
                    <div class="stat-icon bg-cyan"><i class="fas fa-filter"></i></div>
                    <div class="stat-value" id="dash-leads-ativos">0</div>
                    <div class="stat-label">Leads Ativos</div>
                </div>
                <div class="stat-card" onclick="UI.navigate('financeiro')">
                    <div class="stat-icon bg-teal"><i class="fas fa-chart-line"></i></div>
                    <div class="stat-value" id="dash-receita-mes">R$ 0</div>
                    <div class="stat-label">Receita/Mês</div>
                </div>
            </div>

            <div class="section-title">
                Agenda para Hoje
                <span class="tag tag-alert" id="agenda-badge" style="display:none">!</span>
            </div>
            <div id="agenda-hoje-list">
                <!-- Lista de agenda será preenchida aqui -->
            </div>
            
            <div class="section-title">
                Leads para Follow-up
                <span class="tag tag-scheduled" id="followup-badge" style="display:none">!</span>
            </div>
            <div id="followup-list">
                <!-- Lista de follow-ups será preenchida aqui -->
            </div>
        </div>

        <div id="clientes-view" class="view">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar clientes..." oninput="UI.renderClientes(this.value)">
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="UI.filterClientes('all')">Todos</button>
                <button class="filter-btn" onclick="UI.filterClientes('lead')">Leads</button>
                <button class="filter-btn" onclick="UI.filterClientes('prospect')">Prospects</button>
                <button class="filter-btn" onclick="UI.filterClientes('negotiation')">Negociação</button>
                <button class="filter-btn" onclick="UI.filterClientes('contract')">Contrato</button>
                <button class="filter-btn" onclick="UI.filterClientes('closed')">Fechados</button>
                <button class="filter-btn" onclick="UI.filterClientes('lost')">Perdidos</button>
            </div>
            
            <div id="clientes-list"></div>
        </div>

        <div id="imoveis-view" class="view">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar imóveis..." oninput="UI.renderImoveis(this.value)">
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="UI.filterImoveis('all')">Todos</button>
                <button class="filter-btn" onclick="UI.filterImoveis('pre-lancamento')">Pré-lançamento</button>
                <button class="filter-btn" onclick="UI.filterImoveis('lancamento')">Lançamento</button>
                <button class="filter-btn" onclick="UI.filterImoveis('em-obra')">Em Obra</button>
                <button class="filter-btn" onclick="UI.filterImoveis('pronto')">Pronto</button>
                <button class="filter-btn" onclick="UI.filterImoveis('lote')">Lotes</button>
                <button class="filter-btn" onclick="UI.filterImoveis('vendido')">Vendidos</button>
                <button class="filter-btn" onclick="UI.filterImoveis('disponivel')">Disponíveis</button>
            </div>
            
            <div id="imoveis-list"></div>
        </div>

        <div id="funil-view" class="view">
            <div class="section-title">Funil de Vendas</div>
            <div class="funnel-container">
                <div class="funnel-stage">
                    <div class="funnel-stage-title" style="border-color: #f59e0b; color: #f59e0b;">Lead (0)</div>
                    <div id="funnel-lead"></div>
                </div>
                <div class="funnel-stage">
                    <div class="funnel-stage-title" style="border-color: #3b82f6; color: #3b82f6;">Prospect (0)</div>
                    <div id="funnel-prospect"></div>
                </div>
                <div class="funnel-stage">
                    <div class="funnel-stage-title" style="border-color: #8b5cf6; color: #8b5cf6;">Negociação (0)</div>
                    <div id="funnel-negotiation"></div>
                </div>
                <div class="funnel-stage">
                    <div class="funnel-stage-title" style="border-color: #10b981; color: #10b981;">Contrato (0)</div>
                    <div id="funnel-contract"></div>
                </div>
                <div class="funnel-stage">
                    <div class="funnel-stage-title" style="border-color: #0d9488; color: #0d9488;">Fechado (0)</div>
                    <div id="funnel-closed"></div>
                </div>
            </div>
            
            <div class="section-title">Estatísticas do Funil</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-blue"><i class="fas fa-signal"></i></div>
                    <div class="stat-value" id="funil-taxa-conversao">0%</div>
                    <div class="stat-label">Taxa Conversão</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-green"><i class="fas fa-clock"></i></div>
                    <div class="stat-value" id="funil-tempo-medio">0 dias</div>
                    <div class="stat-label">Tempo Médio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-purple"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="stat-value" id="funil-valor-medio">R$ 0</div>
                    <div class="stat-label">Ticket Médio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-red"><i class="fas fa-times-circle"></i></div>
                    <div class="stat-value" id="funil-perdidos">0</div>
                    <div class="stat-label">Perdidos</div>
                </div>
            </div>
        </div>

        <div id="agenda-view" class="view">
            <div class="section-title">Agenda</div>
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar na agenda..." oninput="UI.renderAgenda(this.value)">
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="UI.filterAgenda('today')">Hoje</button>
                <button class="filter-btn" onclick="UI.filterAgenda('week')">Esta Semana</button>
                <button class="filter-btn" onclick="UI.filterAgenda('month')">Este Mês</button>
                <button class="filter-btn" onclick="UI.filterAgenda('visita')">Visitas</button>
                <button class="filter-btn" onclick="UI.filterAgenda('reuniao')">Reuniões</button>
                <button class="filter-btn" onclick="UI.filterAgenda('assinatura')">Assinaturas</button>
                <button class="filter-btn" onclick="UI.filterAgenda('plantao')">Plantões</button>
            </div>
            
            <div id="agenda-list"></div>
        </div>

        <div id="relatorios-view" class="view">
            <div class="section-title">Relatórios</div>
            
            <div class="section-title">Vendas por Mês</div>
            <div class="chart-container">
                <canvas id="salesChart"></canvas>
            </div>
            
            <div class="section-title">Resumo do Mês</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-green"><i class="fas fa-handshake"></i></div>
                    <div class="stat-value" id="rel-vendas-mes">0</div>
                    <div class="stat-label">Vendas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-teal"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="stat-value" id="rel-receita-mes">R$ 0</div>
                    <div class="stat-label">Receita</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-blue"><i class="fas fa-users"></i></div>
                    <div class="stat-value" id="rel-novos-clientes">0</div>
                    <div class="stat-label">Novos Clientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-purple"><i class="fas fa-home"></i></div>
                    <div class="stat-value" id="rel-imoveis-vendidos">0</div>
                    <div class="stat-label">Imóveis Vendidos</div>
                </div>
            </div>
            
            <div class="section-title">Relatórios Detalhados</div>
            <div class="report-card" onclick="App.relatorios.gerarVendas()">
                <div class="report-title">Relatório de Vendas</div>
                <div class="report-value"><i class="fas fa-file-pdf"></i> Gerar PDF</div>
            </div>
            <div class="report-card" onclick="App.relatorios.gerarPlantao()">
                <div class="report-title">Relatório de Plantão</div>
                <div class="report-value"><i class="fas fa-file-pdf"></i> Gerar PDF</div>
            </div>
            <div class="report-card" onclick="App.relatorios.gerarClientes()">
                <div class="report-title">Relatório de Clientes</div>
                <div class="report-value"><i class="fas fa-file-pdf"></i> Gerar PDF</div>
            </div>
        </div>

        <div id="configuracoes-view" class="view">
            <div class="section-title">Configurações</div>
            <div id="configuracoes-content">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
        </div>
    </main>

    <button class="fab" onclick="UI.openNewCliente()" id="main-fab">
        <i class="fas fa-plus"></i>
    </button>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-target="dashboard-view" onclick="UI.switchTab(this)">
            <i class="fas fa-home"></i> <span>Início</span>
        </a>
        <a href="#" class="nav-item" data-target="clientes-view" onclick="UI.switchTab(this)">
            <i class="fas fa-user-friends"></i> <span>Clientes</span>
        </a>
        <a href="#" class="nav-item" data-target="imoveis-view" onclick="UI.switchTab(this)">
            <i class="fas fa-building"></i> <span>Imóveis</span>
        </a>
        <a href="#" class="nav-item" data-target="funil-view" onclick="UI.switchTab(this)">
            <i class="fas fa-filter"></i> <span>Funil</span>
        </a>
        <a href="#" class="nav-item" data-target="agenda-view" onclick="UI.switchTab(this)">
            <i class="fas fa-calendar-alt"></i> <span>Agenda</span>
        </a>
        <a href="#" class="nav-item" data-target="relatorios-view" onclick="UI.switchTab(this)">
            <i class="fas fa-chart-bar"></i> <span>Relatórios</span>
        </a>
    </nav>

    <!-- Modal de Detalhes do Cliente -->
    <div class="modal-overlay" id="overlay-cliente-details"></div>
    <div class="modal-sheet" id="sheet-cliente-details">
        <div class="sheet-handle"></div>
        <div id="cliente-details-content">
            <!-- Conteúdo será preenchido dinamicamente -->
        </div>
    </div>

    <!-- Modal de Detalhes do Imóvel -->
    <div class="modal-overlay" id="overlay-imovel-details"></div>
    <div class="modal-sheet" id="sheet-imovel-details">
        <div class="sheet-handle"></div>
        <div id="imovel-details-content">
            <!-- Conteúdo será preenchido dinamicamente -->
        </div>
    </div>

    <!-- Modal de Cadastro/Edição de Cliente -->
    <div class="modal-overlay" id="overlay-cliente"></div>
    <div class="modal-sheet" id="sheet-cliente">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-cliente">Novo Cliente</h3>
        <form id="form-cliente" onsubmit="App.cliente.save(event)">
            <input type="hidden" id="c-id">
            <div class="form-group">
                <label class="form-label">Nome Completo</label>
                <input type="text" id="c-nome" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Telefone (WhatsApp)</label>
                <input type="tel" id="c-telefone" class="form-control" placeholder="(00) 00000-0000" required oninput="Utils.maskPhone(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="c-email" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Data de Nascimento</label>
                <input type="date" id="c-nascimento" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">CPF</label>
                <input type="text" id="c-cpf" class="form-control" placeholder="000.000.000-00" oninput="Utils.maskCPF(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Renda Mensal (R$)</label>
                <input type="text" id="c-renda" class="form-control" placeholder="0,00" oninput="Utils.maskMoney(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Status no Funil</label>
                <select id="c-status" class="form-control">
                    <option value="lead">Lead</option>
                    <option value="prospect">Prospect</option>
                    <option value="negotiation">Negociação</option>
                    <option value="contract">Contrato</option>
                    <option value="closed">Fechado</option>
                    <option value="lost">Perdido</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Imóveis de Interesse</label>
                <select id="c-imoveis-interesse" class="form-control" multiple style="height: 100px;">
                    <!-- Imóveis serão carregados dinamicamente -->
                </select>
                <div style="font-size: 0.8rem; color: var(--secondary); margin-top: 4px;">
                    Segure Ctrl (Windows) ou Cmd (Mac) para selecionar múltiplos imóveis
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Observações</label>
                <textarea id="c-observacoes" class="form-control" placeholder="Anotações sobre o cliente..."></textarea>
            </div>
            <button type="submit" class="btn-block">Salvar Cliente</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <!-- Modal de Cadastro/Edição de Imóvel -->
    <div class="modal-overlay" id="overlay-imovel"></div>
    <div class="modal-sheet" id="sheet-imovel">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-imovel">Novo Imóvel</h3>
        <form id="form-imovel" onsubmit="App.imovel.save(event)">
            <input type="hidden" id="i-id">
            
            <div class="form-group">
                <label class="form-label">Tipo de Imóvel</label>
                <select id="i-tipo" class="form-control" required onchange="App.imovel.toggleTipoFields()">
                    <option value="apartamento">Apartamento</option>
                    <option value="casa">Casa</option>
                    <option value="comercial">Comercial</option>
                    <option value="terreno">Terreno</option>
                    <option value="lote">Lote</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Nome/Descrição</label>
                <input type="text" id="i-nome" class="form-control" placeholder="Ex: Apartamento 2 quartos com varanda gourmet" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Modalidade</label>
                <select id="i-modalidade" class="form-control" required>
                    <option value="pre-lancamento">Pré-lançamento</option>
                    <option value="lancamento">Lançamento</option>
                    <option value="em-obra">Em Obra</option>
                    <option value="pronto">Pronto</option>
                    <option value="lote">Lote</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Construtora/Incorporadora</label>
                <input type="text" id="i-construtora" class="form-control">
            </div>
            
            <div class="form-group">
                <label class="form-label">Valor (R$)</label>
                <input type="text" id="i-valor" class="form-control" placeholder="0,00" required oninput="Utils.maskMoney(this)">
            </div>
            
            <div class="form-group">
                <label class="form-label">Forma de Pagamento</label>
                <textarea id="i-forma-pagamento" class="form-control" placeholder="Descrição da forma de pagamento..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Data de Entrega</label>
                <input type="date" id="i-data-entrega" class="form-control">
            </div>
            
            <div class="form-group">
                <label class="form-label">Localização</label>
                <textarea id="i-localizacao" class="form-control" placeholder="Endereço completo ou descrição da localização..."></textarea>
            </div>
            
            <!-- Campos dinâmicos baseados no tipo -->
            <div id="campos-apartamento" class="dynamic-fields active">
                <div style="display: flex; gap: 12px;">
                    <div style="flex: 1;">
                        <label class="form-label">Quartos</label>
                        <input type="number" id="i-quartos" class="form-control" min="0">
                    </div>
                    <div style="flex: 1;">
                        <label class="form-label">Banheiros</label>
                        <input type="number" id="i-banheiros" class="form-control" min="0">
                    </div>
                    <div style="flex: 1;">
                        <label class="form-label">Vagas</label>
                        <input type="number" id="i-vagas" class="form-control" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Área Total (m²)</label>
                    <input type="text" id="i-area" class="form-control" placeholder="0,00" oninput="Utils.maskDecimal(this)">
                </div>
            </div>
            
            <div id="campos-lote" class="dynamic-fields">
                <div style="display: flex; gap: 12px;">
                    <div style="flex: 1;">
                        <label class="form-label">Largura (m)</label>
                        <input type="text" id="i-largura" class="form-control" placeholder="0,00" oninput="Utils.maskDecimal(this)">
                    </div>
                    <div style="flex: 1;">
                        <label class="form-label">Comprimento (m)</label>
                        <input type="text" id="i-comprimento" class="form-control" placeholder="0,00" oninput="Utils.maskDecimal(this)">
                    </div>
                    <div style="flex: 1;">
                        <label class="form-label">Área Total (m²)</label>
                        <input type="text" id="i-area-lote" class="form-control" placeholder="0,00" oninput="Utils.maskDecimal(this)">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Descrição Completa</label>
                <textarea id="i-descricao" class="form-control" placeholder="Descreva detalhadamente o imóvel..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Fotos (até 20)</label>
                <div class="multi-photo-grid" id="fotos-container">
                    <!-- Fotos serão adicionadas aqui -->
                </div>
                <div style="text-align: center;">
                    <label for="i-fotos-input" class="btn-sm btn-light" style="display: inline-flex; margin-top: 8px;">
                        <i class="fas fa-plus"></i> Adicionar Fotos
                    </label>
                    <input type="file" id="i-fotos-input" accept="image/*" style="display: none;" multiple onchange="App.imovel.handleFotos(this)">
                    <div style="font-size: 0.8rem; color: var(--secondary); margin-top: 4px;">
                        Clique para adicionar fotos (máximo 20)
                    </div>
                </div>
                <input type="hidden" id="i-fotos-data">
            </div>
            
            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="i-status" class="form-control">
                    <option value="disponivel">Disponível</option>
                    <option value="reservado">Reservado</option>
                    <option value="vendido">Vendido</option>
                </select>
            </div>

            <button type="submit" class="btn-block">Salvar Imóvel</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <!-- Modal para Agendamento -->
    <div class="modal-overlay" id="overlay-agenda"></div>
    <div class="modal-sheet" id="sheet-agenda">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-agenda">Novo Agendamento</h3>
        <form id="form-agenda" onsubmit="App.agenda.save(event)">
            <input type="hidden" id="a-id">
            
            <div class="form-group">
                <label class="form-label">Tipo de Agendamento</label>
                <select id="a-tipo" class="form-control" required>
                    <option value="visita">Visita ao Imóvel</option>
                    <option value="reuniao">Reunião</option>
                    <option value="treinamento">Treinamento</option>
                    <option value="plantao">Plantão</option>
                    <option value="assinatura">Assinatura de Contrato</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Cliente</label>
                <select id="a-cliente" class="form-control" required>
                    <!-- Clientes serão carregados dinamicamente -->
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Imóvel (para visitas)</label>
                <select id="a-imovel" class="form-control">
                    <option value="">Selecione um imóvel...</option>
                    <!-- Imóveis serão carregados dinamicamente -->
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Data</label>
                <input type="date" id="a-data" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Horário</label>
                <input type="time" id="a-horario" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Local</label>
                <input type="text" id="a-local" class="form-control" placeholder="Endereço ou local da reunião...">
            </div>
            
            <div class="form-group">
                <label class="form-label">Descrição/Observações</label>
                <textarea id="a-descricao" class="form-control" placeholder="Detalhes do agendamento..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="a-status" class="form-control">
                    <option value="agendado">Agendado</option>
                    <option value="confirmado">Confirmado</option>
                    <option value="realizado">Realizado</option>
                    <option value="cancelado">Cancelado</option>
                </select>
            </div>

            <button type="submit" class="btn-block">Salvar Agendamento</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <!-- Modal para WhatsApp em Massa -->
    <div class="modal-overlay" id="overlay-whatsapp-massa"></div>
    <div class="modal-sheet" id="sheet-whatsapp-massa">
        <div class="sheet-handle"></div>
        <h3 class="section-title">Enviar Mensagem em Massa</h3>
        
        <div class="form-group">
            <label class="form-label">Selecionar Clientes</label>
            <div class="client-selector" id="whatsapp-clientes-list">
                <!-- Lista de clientes com checkbox -->
            </div>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button type="button" class="btn-sm btn-light" onclick="App.whatsapp.selectAll()">Selecionar Todos</button>
                <button type="button" class="btn-sm btn-light" onclick="App.whatsapp.deselectAll()">Limpar Seleção</button>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Template da Mensagem</label>
            <select id="whatsapp-template" class="form-control" onchange="App.whatsapp.changeTemplate()">
                <option value="lead">Para Leads (Novos Contatos)</option>
                <option value="prospect">Para Prospects (Interessados)</option>
                <option value="negotiation">Para Negociação</option>
                <option value="followup">Follow-up</option>
                <option value="promocao">Promoção/Novidades</option>
                <option value="custom">Personalizado</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Mensagem</label>
            <textarea id="whatsapp-mensagem" class="form-control" rows="6" placeholder="Digite sua mensagem..."></textarea>
            <div style="font-size: 0.8rem; color: var(--secondary); margin-top: 4px;">
                Use {nome} para incluir o nome do cliente, {saudacao} para saudação do dia
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Anexar Imagem (opcional)</label>
            <input type="file" id="whatsapp-imagem" class="form-control" accept="image/*">
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button type="button" class="btn-block" onclick="App.whatsapp.sendMassa()" style="background: #25D366; color: white;">
                <i class="fab fa-whatsapp"></i> Enviar
            </button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary);" onclick="UI.closeModals()">
                Cancelar
            </button>
        </div>
    </div>

    <!-- Modal de confirmação WhatsApp -->
    <div class="modal-overlay" id="overlay-whatsapp-confirm"></div>
    <div class="modal-sheet" id="sheet-whatsapp-confirm">
        <div class="sheet-handle"></div>
        <div class="confirm-whatsapp-modal">
            <div class="modal-icon">
                <i class="fab fa-whatsapp"></i>
            </div>
            <div class="modal-title">Enviar para WhatsApp</div>
            <div class="modal-description">
                Como você gostaria de iniciar a conversa?
            </div>
            <div class="confirm-whatsapp-options">
                <button class="confirm-whatsapp-btn simples" onclick="App.whatsapp.openConversaSimples()">
                    <i class="fas fa-comment-dots"></i>
                    <div style="text-align: left; flex: 1;">
                        <div style="font-weight: 700; font-size: 1.1rem;">Conversa Simples</div>
                        <div style="font-size: 0.85rem; font-weight: normal;">Abrir conversa sem envio de conteúdo</div>
                    </div>
                </button>
                <button class="confirm-whatsapp-btn completo" onclick="App.whatsapp.openComDetalhes()">
                    <i class="fas fa-home"></i>
                    <div style="text-align: left; flex: 1;">
                        <div style="font-weight: 700; font-size: 1.1rem;">Com Detalhes</div>
                        <div style="font-size: 0.85rem; font-weight: normal;">Enviar detalhes do imóvel/agendamento</div>
                    </div>
                </button>
                <button class="confirm-whatsapp-btn massa" onclick="UI.openWhatsappMassa()">
                    <i class="fas fa-users"></i>
                    <div style="text-align: left; flex: 1;">
                        <div style="font-weight: 700; font-size: 1.1rem;">Mensagem em Massa</div>
                        <div style="font-size: 0.85rem; font-weight: normal;">Enviar para múltiplos clientes</div>
                    </div>
                </button>
            </div>
            <button class="confirm-whatsapp-btn cancelar" onclick="UI.closeModals()">
                <i class="fas fa-times"></i>
                Cancelar
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="overlay-settings"></div>
    <div class="modal-sheet" id="sheet-settings">
        <div class="sheet-handle"></div>
        <h3 class="section-title">Configurações</h3>
        <form id="form-settings" onsubmit="App.settings.save(event)">
            
            <div class="logo-preview-container">
                <img id="s-logo-preview" class="logo-preview" src="" style="display:none">
                <div id="s-logo-placeholder" class="logo-preview" style="display:flex; align-items:center; justify-content:center; color:var(--secondary);"><i class="fas fa-image"></i></div>
            </div>
            <div class="form-group" style="text-align: center;">
                <label for="s-logo-input" style="color: var(--primary); font-weight: 600; cursor: pointer;">
                    <i class="fas fa-upload"></i> Carregar Logomarca
                </label>
                <input type="file" id="s-logo-input" accept="image/*" style="display: none;" onchange="App.settings.previewLogo(this)">
                <input type="hidden" id="s-logo-data">
            </div>

            <div class="form-group">
                <label class="form-label">Nome do Corretor/Imobiliária</label>
                <input type="text" id="s-nome" class="form-control" placeholder="Ex: João Corretor Imóveis">
            </div>
            <div class="form-group">
                <label class="form-label">CRECI</label>
                <input type="text" id="s-creci" class="form-control" placeholder="Número do CRECI">
            </div>
            <div class="form-group">
                <label class="form-label">Telefone</label>
                <input type="tel" id="s-telefone" class="form-control" oninput="Utils.maskPhone(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="s-email" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Instagram (@)</label>
                <input type="text" id="s-instagram" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Endereço da Imobiliária</label>
                <textarea id="s-endereco" class="form-control" placeholder="Endereço completo..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mensagens Padrão WhatsApp</label>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div>
                        <label style="font-size: 0.8rem; color: var(--secondary);">Para Leads:</label>
                        <textarea id="s-msg-lead" class="form-control" style="font-size: 0.9rem;" rows="2">{saudacao}, {nome}! Tudo bem? Me chamo {corretor} e gostaria de apresentar algumas oportunidades de imóveis que podem interessar a você. Posso te enviar mais informações?</textarea>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--secondary);">Para Follow-up:</label>
                        <textarea id="s-msg-followup" class="form-control" style="font-size: 0.9rem;" rows="2">{saudacao}, {nome}! Espero que esteja bem. Estou entrando em contato para saber se ainda tem interesse nos imóveis que apresentei. Posso te ajudar com alguma dúvida?</textarea>
                    </div>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 16px 0;">
            <button type="button" class="btn-block" style="background: var(--danger);" onclick="App.backup.clearData()">
                <i class="fas fa-trash"></i> Resetar Todos os Dados
            </button>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="button" class="btn-block" style="background: var(--secondary); margin: 0;" onclick="App.backup.importTrigger()">Importar Backup</button>
                <input type="file" id="import-file" style="display: none;" accept=".json" onchange="App.backup.importData(this)">
                <button type="submit" class="btn-block" style="background: var(--primary); margin: 0;">Salvar Configurações</button>
            </div>
        </form>
    </div>

    <script>
        // --- UTILITÁRIOS ---
        const Utils = {
            id: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            formatCurrency: (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
            parseCurrency: (str) => parseFloat(str.replace('R$', '').replace(/\./g, '').replace(',', '.').trim()) || 0,
            formatDate: (dateStr) => {
                if(!dateStr) return '-';
                const [y, m, d] = dateStr.split('-');
                return `${d}/${m}/${y}`;
            },
            formatDateTime: (dateStr, timeStr = '') => {
                if(!dateStr) return '-';
                const date = new Date(dateStr + (timeStr ? 'T' + timeStr : ''));
                return date.toLocaleDateString('pt-BR') + (timeStr ? ' ' + timeStr : '');
            },
            maskPhone: (input) => {
                let v = input.value.replace(/\D/g, "");
                v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
                v = v.replace(/(\d)(\d{4})$/, "$1-$2");
                input.value = v.substring(0, 15);
            },
            maskCPF: (input) => {
                let v = input.value.replace(/\D/g, "");
                v = v.replace(/(\d{3})(\d)/, "$1.$2");
                v = v.replace(/(\d{3})(\d)/, "$1.$2");
                v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
                input.value = v.substring(0, 14);
            },
            maskMoney: (input) => {
                let v = input.value.replace(/\D/g, "");
                v = (v / 100).toFixed(2) + "";
                v = v.replace(".", ",");
                v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
                input.value = v;
            },
            maskDecimal: (input) => {
                let v = input.value.replace(/[^\d,]/g, "");
                v = v.replace(",", ".");
                if(v.split(".").length > 2) {
                    v = v.substring(0, v.lastIndexOf("."));
                }
                v = v.replace(".", ",");
                input.value = v;
            },
            toast: (msg, type = 'success') => {
                const t = document.getElementById('toast');
                t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> <span>${msg}</span>`;
                t.style.background = type === 'success' ? 'var(--dark)' : 'var(--danger)';
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            },
            readImage: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },
            getToday: () => {
                const today = new Date();
                return today.toISOString().split('T')[0];
            },
            isToday: (dateStr) => {
                if(!dateStr) return false;
                return dateStr === Utils.getToday();
            },
            isPast: (dateStr) => {
                if(!dateStr) return false;
                return dateStr < Utils.getToday();
            },
            getSaudacao: () => {
                const hora = new Date().getHours();
                if (hora < 12) return "Bom dia";
                if (hora < 18) return "Boa tarde";
                return "Boa noite";
            },
            getStatusText: (status) => {
                const statusMap = {
                    'lead': 'Lead',
                    'prospect': 'Prospect',
                    'negotiation': 'Negociação',
                    'contract': 'Contrato',
                    'closed': 'Fechado',
                    'lost': 'Perdido'
                };
                return statusMap[status] || status;
            },
            getStatusColor: (status) => {
                const colorMap = {
                    'lead': 'warning',
                    'prospect': 'primary',
                    'negotiation': 'purple',
                    'contract': 'accent',
                    'closed': 'success',
                    'lost': 'danger'
                };
                return colorMap[status] || 'secondary';
            },
            getModalidadeText: (modalidade) => {
                const modalidadeMap = {
                    'pre-lancamento': 'Pré-lançamento',
                    'lancamento': 'Lançamento',
                    'em-obra': 'Em Obra',
                    'pronto': 'Pronto',
                    'lote': 'Lote'
                };
                return modalidadeMap[modalidade] || modalidade;
            },
            getTipoAgendaText: (tipo) => {
                const tipoMap = {
                    'visita': 'Visita ao Imóvel',
                    'reuniao': 'Reunião',
                    'treinamento': 'Treinamento',
                    'plantao': 'Plantão',
                    'assinatura': 'Assinatura de Contrato'
                };
                return tipoMap[tipo] || tipo;
            },
            calcularTempoFunil: (cliente) => {
                if(!cliente.dataCadastro) return 0;
                const hoje = new Date();
                const cadastro = new Date(cliente.dataCadastro);
                const diffTime = Math.abs(hoje - cadastro);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            }
        };

        // --- STORAGE MANAGER ---
        const Storage = {
            get: (key) => JSON.parse(localStorage.getItem(`imobim_${key}`)) || [],
            set: (key, data) => localStorage.setItem(`imobim_${key}`, JSON.stringify(data)),
            getSettings: () => JSON.parse(localStorage.getItem('imobim_settings')) || { 
                nome: 'Corretor Imóveis',
                creci: '00000',
                telefone: '(00) 00000-0000',
                email: 'corretor@email.com',
                instagram: '@corretor',
                endereco: 'Rua Exemplo, 123 - Centro\nCidade - Estado\nCEP: 00000-000',
                logo: null,
                msgLead: '{saudacao}, {nome}! Tudo bem? Me chamo {corretor} e gostaria de apresentar algumas oportunidades de imóveis que podem interessar a você. Posso te enviar mais informações?',
                msgFollowup: '{saudacao}, {nome}! Espero que esteja bem. Estou entrando em contato para saber se ainda tem interesse nos imóveis que apresentei. Posso te ajudar com alguma dúvida?'
            },
            saveSettings: (data) => localStorage.setItem('imobim_settings', JSON.stringify(data))
        };

        // --- UI MANAGER ---
        const UI = {
            data: { clientes: [], imoveis: [], agenda: [] },
            chartInstance: null,
            currentFilterClientes: 'all',
            currentFilterImoveis: 'all',
            currentFilterAgenda: 'today',
            currentWhatsappClienteId: null,
            
            init: () => {
                UI.data.clientes = Storage.get('clientes');
                UI.data.imoveis = Storage.get('imoveis');
                UI.data.agenda = Storage.get('agenda');
                
                UI.renderDashboard();
                
                // Tabs listeners
                document.querySelectorAll('.bottom-nav .nav-item').forEach(el => {
                    el.addEventListener('click', (e) => e.preventDefault());
                });
            },

            switchTab: (el) => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                
                el.classList.add('active');
                const target = el.getAttribute('data-target');
                document.getElementById(target).classList.add('active');

                // Toggle FAB visibility
                const fab = document.getElementById('main-fab');
                if(target === 'dashboard-view' || target === 'clientes-view') {
                    fab.style.display = 'flex';
                    fab.onclick = UI.openNewCliente;
                } else if (target === 'imoveis-view') {
                    fab.style.display = 'flex';
                    fab.onclick = UI.openNewImovel;
                } else if (target === 'agenda-view') {
                    fab.style.display = 'flex';
                    fab.onclick = UI.openNewAgenda;
                } else {
                    fab.style.display = 'none';
                }

                if(target === 'clientes-view') UI.renderClientes();
                if(target === 'imoveis-view') UI.renderImoveis();
                if(target === 'funil-view') UI.renderFunil();
                if(target === 'agenda-view') UI.renderAgenda();
                if(target === 'relatorios-view') UI.renderRelatorios();
                if(target === 'configuracoes-view') UI.renderConfiguracoes();
            },

            navigate: (tabName) => {
                const el = document.querySelector(`.nav-item[data-target="${tabName}-view"]`);
                if(el) UI.switchTab(el);
            },
            
            navigateToAgenda: (filter = 'today') => {
                UI.navigate('agenda');
                setTimeout(() => {
                    UI.filterAgenda(filter);
                }, 100);
            },

            // --- RENDER FUNCTIONS ---
            renderDashboard: () => {
                const { clientes, imoveis, agenda } = UI.data;
                
                // Estatísticas básicas
                document.getElementById('dash-total-clientes').innerText = clientes.length;
                document.getElementById('dash-total-imoveis').innerText = imoveis.length;
                
                // Agenda para hoje
                const today = Utils.getToday();
                const agendaHoje = agenda.filter(a => a.data === today && a.status !== 'cancelado');
                document.getElementById('dash-agenda-hoje').innerText = agendaHoje.length;
                document.getElementById('agenda-badge').style.display = agendaHoje.length > 0 ? 'inline-block' : 'none';
                
                // Vendas do mês
                const hoje = new Date();
                const mesAtual = hoje.getMonth() + 1;
                const anoAtual = hoje.getFullYear();
                const vendasMes = clientes.filter(c => 
                    c.status === 'closed' && 
                    c.dataFechamento &&
                    c.dataFechamento.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                ).length;
                document.getElementById('dash-vendas-mes').innerText = vendasMes;
                
                // Leads ativos (excluindo fechados e perdidos)
                const leadsAtivos = clientes.filter(c => 
                    c.status !== 'closed' && 
                    c.status !== 'lost' &&
                    (!c.dataCadastro || Utils.calcularTempoFunil(c) < 90)
                ).length;
                document.getElementById('dash-leads-ativos').innerText = leadsAtivos;
                
                // Receita do mês
                const receitaMes = clientes
                    .filter(c => c.status === 'closed' && c.valorVenda)
                    .reduce((acc, c) => acc + c.valorVenda, 0);
                document.getElementById('dash-receita-mes').innerText = Utils.formatCurrency(receitaMes);

                // Render agenda para hoje
                const agendaList = document.getElementById('agenda-hoje-list');
                if(agendaHoje.length === 0) {
                    agendaList.innerHTML = `<div class="empty-state"><i class="fas fa-calendar-check"></i><p>Nenhum agendamento para hoje!</p></div>`;
                } else {
                    agendaList.innerHTML = agendaHoje.map(a => UI.createAgendaCard(a, true)).join('');
                }
                
                // Render leads para follow-up (clientes com status lead/prospect sem contato há 7 dias)
                const followups = clientes.filter(c => 
                    (c.status === 'lead' || c.status === 'prospect') &&
                    (!c.ultimoContato || Utils.isPast(c.ultimoContato)) &&
                    (!c.dataCadastro || Utils.calcularTempoFunil(c) >= 7)
                ).slice(0, 5); // Limitar a 5
                
                const followupList = document.getElementById('followup-list');
                document.getElementById('followup-badge').style.display = followups.length > 0 ? 'inline-block' : 'none';
                
                if(followups.length === 0) {
                    followupList.innerHTML = `<div class="empty-state"><i class="fas fa-thumbs-up"></i><p>Nenhum follow-up necessário!</p></div>`;
                } else {
                    followupList.innerHTML = followups.map(c => UI.createFollowupCard(c)).join('');
                }
            },

            createAgendaCard: (a, isToday = false) => {
                const c = UI.data.clientes.find(cl => cl.id === a.clienteId) || { nome: 'Desconhecido' };
                let i = null;
                if(a.imovelId) {
                    i = UI.data.imoveis.find(im => im.id === a.imovelId);
                }
                
                let statusClass = '';
                if(a.status === 'cancelado') statusClass = 'tag-lost';
                else if(a.status === 'realizado') statusClass = 'tag-closed';
                else if(a.status === 'confirmado') statusClass = 'tag-contract';
                else statusClass = 'tag-scheduled';
                
                return `
                    <div class="list-card" onclick="UI.showAgendaDetails('${a.id}')">
                        <div class="card-header">
                            <div class="card-title">${Utils.getTipoAgendaText(a.tipo)} - ${c.nome}</div>
                            <span class="tag ${statusClass}">${a.status === 'agendado' ? 'AGENDADO' : a.status.toUpperCase()}</span>
                        </div>
                        <div class="card-subtitle">
                            <i class="fas fa-calendar-day"></i> ${Utils.formatDateTime(a.data, a.horario)}
                            ${a.local ? `• ${a.local.substring(0, 20)}...` : ''}
                        </div>
                        ${i ? `<div class="card-subtitle"><i class="fas fa-home"></i> ${i.nome.substring(0, 30)}...</div>` : ''}
                        ${a.descricao ? `<div class="card-subtitle">${a.descricao.substring(0, 40)}...</div>` : ''}
                        <div class="action-row">
                            <button class="btn-sm btn-cyan" onclick="event.stopPropagation(); App.agenda.edit('${a.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-sm btn-whatsapp" onclick="event.stopPropagation(); App.whatsapp.confirmOpenCliente('${c.id}')">
                                <i class="fab fa-whatsapp"></i> Zap
                            </button>
                            <button class="btn-sm btn-light" onclick="event.stopPropagation(); UI.showAgendaDetails('${a.id}')">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                        </div>
                    </div>
                `;
            },

            createFollowupCard: (c) => {
                const dias = Utils.calcularTempoFunil(c);
                let imoveisInfo = '';
                if(c.imoveisInteresse && c.imoveisInteresse.length > 0) {
                    const imovel = UI.data.imoveis.find(i => i.id === c.imoveisInteresse[0]);
                    if(imovel) {
                        imoveisInfo = `<div class="card-subtitle"><i class="fas fa-home"></i> Interesse: ${imovel.nome.substring(0, 30)}...</div>`;
                    }
                }
                
                return `
                    <div class="list-card" onclick="UI.showClienteDetails('${c.id}')">
                        <div class="card-header">
                            <div class="card-title">${c.nome}</div>
                            <span class="tag ${c.status === 'lead' ? 'tag-lead' : 'tag-prospect'}">${Utils.getStatusText(c.status)}</span>
                        </div>
                        <div class="card-subtitle"><i class="fas fa-phone"></i> ${c.telefone}</div>
                        ${imoveisInfo}
                        <div class="card-subtitle">
                            <i class="fas fa-clock"></i> ${dias} dias sem contato
                        </div>
                        <div class="action-row">
                            <button class="btn-sm btn-whatsapp" onclick="event.stopPropagation(); App.whatsapp.confirmOpenCliente('${c.id}')">
                                <i class="fab fa-whatsapp"></i> Contatar
                            </button>
                            <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.cliente.edit('${c.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </div>
                    </div>
                `;
            },

            renderClientes: (filter = '') => {
                const list = document.getElementById('clientes-list');
                let filtered = UI.getFilteredClientes(UI.currentFilterClientes);
                
                if(filter) {
                    filtered = filtered.filter(c => 
                        c.nome.toLowerCase().includes(filter.toLowerCase()) ||
                        c.telefone.includes(filter) ||
                        c.email?.toLowerCase().includes(filter.toLowerCase())
                    );
                }

                if(filtered.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-user-plus"></i><p>Nenhum cliente encontrado.</p></div>`;
                } else {
                    list.innerHTML = filtered.map(c => UI.createClienteCard(c)).join('');
                }
            },
            
            getFilteredClientes: (filterType) => {
                let filtered = [...UI.data.clientes];
                
                if(filterType !== 'all') {
                    filtered = filtered.filter(c => c.status === filterType);
                }
                
                return filtered.sort((a,b) => {
                    if(a.status === b.status) {
                        return new Date(b.dataCadastro || 0) - new Date(a.dataCadastro || 0);
                    }
                    return a.status.localeCompare(b.status);
                });
            },
            
            filterClientes: (filterType) => {
                UI.currentFilterClientes = filterType;
                
                // Atualizar botões de filtro
                document.querySelectorAll('#clientes-view .filter-buttons .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const activeBtn = document.querySelector(`#clientes-view .filter-btn:nth-child(${
                    ['all', 'lead', 'prospect', 'negotiation', 'contract', 'closed', 'lost'].indexOf(filterType) + 1
                })`);
                
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
                
                UI.renderClientes();
            },

            createClienteCard: (c) => {
                let statusTag = '';
                const statusColor = Utils.getStatusColor(c.status);
                statusTag = `<span class="tag tag-${statusColor}">${Utils.getStatusText(c.status)}</span>`;
                
                let imoveisInfo = '';
                if(c.imoveisInteresse && c.imoveisInteresse.length > 0) {
                    const count = c.imoveisInteresse.length;
                    imoveisInfo = `<div class="card-subtitle"><i class="fas fa-home"></i> ${count} imóvel${count > 1 ? 'eis' : ''} de interesse</div>`;
                }
                
                return `
                    <div class="list-card" onclick="UI.showClienteDetails('${c.id}')">
                        <div class="card-header">
                            <div class="card-title">${c.nome}</div>
                            ${statusTag}
                        </div>
                        <div class="card-subtitle"><i class="fas fa-phone"></i> ${c.telefone}</div>
                        ${c.email ? `<div class="card-subtitle"><i class="fas fa-envelope"></i> ${c.email}</div>` : ''}
                        ${imoveisInfo}
                        ${c.renda ? `<div class="card-price">Renda: ${Utils.formatCurrency(c.renda)}</div>` : ''}
                        <div class="action-row">
                            <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.cliente.edit('${c.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-sm btn-whatsapp" onclick="event.stopPropagation(); App.whatsapp.confirmOpenCliente('${c.id}')">
                                <i class="fab fa-whatsapp"></i> Zap
                            </button>
                            <button class="btn-sm btn-purple" onclick="event.stopPropagation(); UI.openNewAgendaForCliente('${c.id}')">
                                <i class="fas fa-calendar-plus"></i> Agendar
                            </button>
                        </div>
                    </div>
                `;
            },

            renderImoveis: (filter = '') => {
                const list = document.getElementById('imoveis-list');
                let filtered = UI.getFilteredImoveis(UI.currentFilterImoveis);
                
                if(filter) {
                    filtered = filtered.filter(i => 
                        i.nome.toLowerCase().includes(filter.toLowerCase()) ||
                        i.localizacao?.toLowerCase().includes(filter.toLowerCase()) ||
                        i.construtora?.toLowerCase().includes(filter.toLowerCase())
                    );
                }

                if(filtered.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-building"></i><p>Nenhum imóvel encontrado.</p></div>`;
                } else {
                    list.innerHTML = filtered.map(i => UI.createImovelCard(i)).join('');
                }
            },
            
            getFilteredImoveis: (filterType) => {
                let filtered = [...UI.data.imoveis];
                
                switch(filterType) {
                    case 'pre-lancamento':
                        filtered = filtered.filter(i => i.modalidade === 'pre-lancamento');
                        break;
                    case 'lancamento':
                        filtered = filtered.filter(i => i.modalidade === 'lancamento');
                        break;
                    case 'em-obra':
                        filtered = filtered.filter(i => i.modalidade === 'em-obra');
                        break;
                    case 'pronto':
                        filtered = filtered.filter(i => i.modalidade === 'pronto');
                        break;
                    case 'lote':
                        filtered = filtered.filter(i => i.modalidade === 'lote' || i.tipo === 'lote');
                        break;
                    case 'vendido':
                        filtered = filtered.filter(i => i.status === 'vendido');
                        break;
                    case 'disponivel':
                        filtered = filtered.filter(i => i.status === 'disponivel');
                        break;
                    case 'all':
                    default:
                        break;
                }
                
                return filtered.sort((a,b) => new Date(b.dataCadastro || 0) - new Date(a.dataCadastro || 0));
            },
            
            filterImoveis: (filterType) => {
                UI.currentFilterImoveis = filterType;
                
                // Atualizar botões de filtro
                document.querySelectorAll('#imoveis-view .filter-buttons .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const index = ['all', 'pre-lancamento', 'lancamento', 'em-obra', 'pronto', 'lote', 'vendido', 'disponivel'].indexOf(filterType);
                const activeBtn = document.querySelector(`#imoveis-view .filter-btn:nth-child(${index + 1})`);
                
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
                
                UI.renderImoveis();
            },

            createImovelCard: (i) => {
                let modalidadeTag = '';
                switch(i.modalidade) {
                    case 'pre-lancamento':
                        modalidadeTag = `<span class="tag tag-pre-lancamento">PRÉ-LANÇAMENTO</span>`;
                        break;
                    case 'lancamento':
                        modalidadeTag = `<span class="tag tag-lancamento">LANÇAMENTO</span>`;
                        break;
                    case 'em-obra':
                        modalidadeTag = `<span class="tag tag-em-obra">EM OBRA</span>`;
                        break;
                    case 'pronto':
                        modalidadeTag = `<span class="tag tag-pronto">PRONTO</span>`;
                        break;
                    case 'lote':
                        modalidadeTag = `<span class="tag tag-lote">LOTE</span>`;
                        break;
                }
                
                let statusTag = '';
                if(i.status === 'vendido') {
                    statusTag = `<span class="tag tag-closed">VENDIDO</span>`;
                } else if(i.status === 'reservado') {
                    statusTag = `<span class="tag tag-negotiation">RESERVADO</span>`;
                }
                
                let fotoHTML = '';
                if(i.fotos && i.fotos.length > 0) {
                    fotoHTML = `<img src="${i.fotos[0]}" class="imovel-card-photo">`;
                } else {
                    fotoHTML = `<div class="imovel-card-photo" style="background: var(--light); display: flex; align-items: center; justify-content: center; color: var(--secondary);">
                        <i class="fas fa-home" style="font-size: 2rem;"></i>
                    </div>`;
                }
                
                let detalhes = '';
                if(i.tipo === 'lote') {
                    detalhes = `<div class="card-subtitle"><i class="fas fa-ruler-combined"></i> ${i.area || '0'} m²</div>`;
                } else {
                    detalhes = `<div class="card-subtitle">
                        ${i.quartos ? `<i class="fas fa-bed"></i> ${i.quartos} quartos` : ''}
                        ${i.banheiros ? ` • ${i.banheiros} banheiros` : ''}
                        ${i.vagas ? ` • ${i.vagas} vagas` : ''}
                        ${i.area ? ` • ${i.area} m²` : ''}
                    </div>`;
                }
                
                return `
                    <div class="list-card" onclick="UI.showImovelDetails('${i.id}')">
                        ${fotoHTML}
                        <div class="card-header">
                            <div class="card-title" style="margin-top: 8px;">${i.nome}</div>
                            <div style="display: flex; gap: 4px;">
                                ${modalidadeTag}
                                ${statusTag}
                            </div>
                        </div>
                        ${detalhes}
                        <div class="card-subtitle">
                            <i class="fas fa-map-marker-alt"></i> ${i.localizacao ? i.localizacao.substring(0, 30) + (i.localizacao.length > 30 ? '...' : '') : 'Localização não informada'}
                        </div>
                        ${i.construtora ? `<div class="card-subtitle"><i class="fas fa-industry"></i> ${i.construtora}</div>` : ''}
                        <div class="card-price">${Utils.formatCurrency(i.valor)}</div>
                        <div class="action-row">
                            <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.imovel.edit('${i.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-sm btn-primary-soft" onclick="event.stopPropagation(); UI.openNewAgendaForImovel('${i.id}')">
                                <i class="fas fa-calendar-plus"></i> Visita
                            </button>
                            <button class="btn-sm btn-whatsapp" onclick="event.stopPropagation(); App.whatsapp.shareImovel('${i.id}')">
                                <i class="fab fa-whatsapp"></i> Compartilhar
                            </button>
                        </div>
                    </div>
                `;
            },

            renderFunil: () => {
                const clientes = UI.data.clientes;
                
                // Contar por estágio
                const leads = clientes.filter(c => c.status === 'lead');
                const prospects = clientes.filter(c => c.status === 'prospect');
                const negociacao = clientes.filter(c => c.status === 'negotiation');
                const contrato = clientes.filter(c => c.status === 'contract');
                const fechados = clientes.filter(c => c.status === 'closed');
                
                // Atualizar contadores nos títulos
                document.querySelector('#funnel-lead').parentElement.querySelector('.funnel-stage-title').innerHTML = `Lead (${leads.length})`;
                document.querySelector('#funnel-prospect').parentElement.querySelector('.funnel-stage-title').innerHTML = `Prospect (${prospects.length})`;
                document.querySelector('#funnel-negotiation').parentElement.querySelector('.funnel-stage-title').innerHTML = `Negociação (${negociacao.length})`;
                document.querySelector('#funnel-contract').parentElement.querySelector('.funnel-stage-title').innerHTML = `Contrato (${contrato.length})`;
                document.querySelector('#funnel-closed').parentElement.querySelector('.funnel-stage-title').innerHTML = `Fechado (${fechados.length})`;
                
                // Renderizar clientes em cada estágio
                document.getElementById('funnel-lead').innerHTML = leads.map(c => `
                    <div class="funnel-lead-item" onclick="UI.showClienteDetails('${c.id}')">
                        <div style="font-weight: 600; font-size: 0.9rem;">${c.nome}</div>
                        <div style="font-size: 0.7rem; color: var(--secondary);">${Utils.calcularTempoFunil(c)} dias</div>
                    </div>
                `).join('');
                
                document.getElementById('funnel-prospect').innerHTML = prospects.map(c => `
                    <div class="funnel-lead-item" onclick="UI.showClienteDetails('${c.id}')">
                        <div style="font-weight: 600; font-size: 0.9rem;">${c.nome}</div>
                        <div style="font-size: 0.7rem; color: var(--secondary);">${c.renda ? Utils.formatCurrency(c.renda) : 'Sem renda'}</div>
                    </div>
                `).join('');
                
                document.getElementById('funnel-negotiation').innerHTML = negociacao.map(c => `
                    <div class="funnel-lead-item" onclick="UI.showClienteDetails('${c.id}')">
                        <div style="font-weight: 600; font-size: 0.9rem;">${c.nome}</div>
                        <div style="font-size: 0.7rem; color: var(--secondary);">
                            ${c.imoveisInteresse ? c.imoveisInteresse.length + ' imóveis' : 'Sem interesse definido'}
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('funnel-contract').innerHTML = contrato.map(c => `
                    <div class="funnel-lead-item" onclick="UI.showClienteDetails('${c.id}')">
                        <div style="font-weight: 600; font-size: 0.9rem;">${c.nome}</div>
                        <div style="font-size: 0.7rem; color: var(--secondary);">
                            ${c.dataContrato ? Utils.formatDate(c.dataContrato) : 'Sem data'}
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('funnel-closed').innerHTML = fechados.map(c => `
                    <div class="funnel-lead-item" onclick="UI.showClienteDetails('${c.id}')">
                        <div style="font-weight: 600; font-size: 0.9rem;">${c.nome}</div>
                        <div style="font-size: 0.7rem; color: var(--success);">
                            ${c.valorVenda ? Utils.formatCurrency(c.valorVenda) : 'Valor não informado'}
                        </div>
                    </div>
                `).join('');
                
                // Calcular estatísticas do funil
                const totalClientes = clientes.length;
                const totalFechados = fechados.length;
                const totalPerdidos = clientes.filter(c => c.status === 'lost').length;
                
                const taxaConversao = totalClientes > 0 ? Math.round((totalFechados / totalClientes) * 100) : 0;
                const valorMedio = fechados.length > 0 ? 
                    fechados.reduce((acc, c) => acc + (c.valorVenda || 0), 0) / fechados.length : 0;
                
                // Tempo médio no funil (apenas para fechados)
                let tempoMedio = 0;
                if(fechados.length > 0) {
                    const tempos = fechados.map(c => Utils.calcularTempoFunil(c));
                    tempoMedio = Math.round(tempos.reduce((a, b) => a + b, 0) / tempos.length);
                }
                
                document.getElementById('funil-taxa-conversao').innerText = `${taxaConversao}%`;
                document.getElementById('funil-tempo-medio').innerText = `${tempoMedio} dias`;
                document.getElementById('funil-valor-medio').innerText = Utils.formatCurrency(valorMedio);
                document.getElementById('funil-perdidos').innerText = totalPerdidos;
            },

            renderAgenda: (filter = '') => {
                const list = document.getElementById('agenda-list');
                let filtered = UI.getFilteredAgenda(UI.currentFilterAgenda);
                
                if(filter) {
                    filtered = filtered.filter(a => {
                        const c = UI.data.clientes.find(cl => cl.id === a.clienteId);
                        const cName = c ? c.nome.toLowerCase() : '';
                        const i = a.imovelId ? UI.data.imoveis.find(im => im.id === a.imovelId) : null;
                        const iName = i ? i.nome.toLowerCase() : '';
                        return cName.includes(filter.toLowerCase()) || 
                               iName.includes(filter.toLowerCase()) ||
                               a.local?.toLowerCase().includes(filter.toLowerCase());
                    });
                }

                if(filtered.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-calendar-alt"></i><p>Nenhum agendamento encontrado.</p></div>`;
                } else {
                    list.innerHTML = filtered.map(a => UI.createAgendaCard(a)).join('');
                }
            },
            
            getFilteredAgenda: (filterType) => {
                let filtered = [...UI.data.agenda];
                const today = Utils.getToday();
                const hoje = new Date();
                const inicioSemana = new Date(hoje);
                inicioSemana.setDate(hoje.getDate() - hoje.getDay());
                const fimSemana = new Date(inicioSemana);
                fimSemana.setDate(inicioSemana.getDate() + 6);
                
                const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                
                switch(filterType) {
                    case 'today':
                        filtered = filtered.filter(a => a.data === today);
                        break;
                    case 'week':
                        filtered = filtered.filter(a => {
                            const data = new Date(a.data);
                            return data >= inicioSemana && data <= fimSemana;
                        });
                        break;
                    case 'month':
                        filtered = filtered.filter(a => {
                            const data = new Date(a.data);
                            return data >= inicioMes && data <= fimMes;
                        });
                        break;
                    case 'visita':
                        filtered = filtered.filter(a => a.tipo === 'visita');
                        break;
                    case 'reuniao':
                        filtered = filtered.filter(a => a.tipo === 'reuniao');
                        break;
                    case 'assinatura':
                        filtered = filtered.filter(a => a.tipo === 'assinatura');
                        break;
                    case 'plantao':
                        filtered = filtered.filter(a => a.tipo === 'plantao');
                        break;
                }
                
                return filtered.sort((a,b) => {
                    if(a.data === b.data) {
                        return a.horario.localeCompare(b.horario);
                    }
                    return a.data.localeCompare(b.data);
                });
            },
            
            filterAgenda: (filterType) => {
                UI.currentFilterAgenda = filterType;
                
                // Atualizar botões de filtro
                document.querySelectorAll('#agenda-view .filter-buttons .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const index = ['today', 'week', 'month', 'visita', 'reuniao', 'assinatura', 'plantao'].indexOf(filterType);
                const activeBtn = document.querySelector(`#agenda-view .filter-btn:nth-child(${index + 1})`);
                
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
                
                UI.renderAgenda();
            },

            renderRelatorios: () => {
                const hoje = new Date();
                const mesAtual = hoje.getMonth() + 1;
                const anoAtual = hoje.getFullYear();
                const clientes = UI.data.clientes;
                const imoveis = UI.data.imoveis;
                const agenda = UI.data.agenda;
                
                // Vendas do mês
                const vendasMes = clientes.filter(c => 
                    c.status === 'closed' && 
                    c.dataFechamento &&
                    c.dataFechamento.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                ).length;
                document.getElementById('rel-vendas-mes').innerText = vendasMes;
                
                // Receita do mês
                const receitaMes = clientes
                    .filter(c => c.status === 'closed' && c.valorVenda && c.dataFechamento && c.dataFechamento.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`))
                    .reduce((acc, c) => acc + c.valorVenda, 0);
                document.getElementById('rel-receita-mes').innerText = Utils.formatCurrency(receitaMes);
                
                // Novos clientes do mês
                const novosClientes = clientes.filter(c => 
                    c.dataCadastro &&
                    c.dataCadastro.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                ).length;
                document.getElementById('rel-novos-clientes').innerText = novosClientes;
                
                // Imóveis vendidos do mês
                const imoveisVendidos = imoveis.filter(i => 
                    i.status === 'vendido' &&
                    i.dataVenda &&
                    i.dataVenda.startsWith(`${anoAtual}-${mesAtual.toString().padStart(2, '0')}`)
                ).length;
                document.getElementById('rel-imoveis-vendidos').innerText = imoveisVendidos;
                
                // Renderizar gráfico de vendas
                UI.renderSalesChart();
            },

            renderSalesChart: () => {
                const ctx = document.getElementById('salesChart').getContext('2d');
                const clientes = UI.data.clientes.filter(c => c.status === 'closed' && c.dataFechamento);
                
                // Agrupar por mês
                const vendasPorMes = {};
                const hoje = new Date();
                const meses = [];
                
                // Gerar últimos 12 meses
                for(let i = 11; i >= 0; i--) {
                    const date = new Date();
                    date.setMonth(hoje.getMonth() - i);
                    const mesAno = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    meses.push(mesAno);
                    vendasPorMes[mesAno] = 0;
                }
                
                // Contar vendas por mês
                clientes.forEach(c => {
                    if(c.dataFechamento) {
                        const mesAno = c.dataFechamento.substring(0, 7);
                        if(vendasPorMes[mesAno] !== undefined) {
                            vendasPorMes[mesAno]++;
                        }
                    }
                });
                
                // Preparar dados para o gráfico
                const labels = meses.map(m => {
                    const [ano, mes] = m.split('-');
                    return `${mes}/${ano.substring(2)}`;
                });
                
                const data = meses.map(m => vendasPorMes[m] || 0);
                
                if (UI.chartInstance) {
                    UI.chartInstance.destroy();
                }
                
                if (meses.length === 0) return;
                
                UI.chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Vendas por Mês',
                            data: data,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'top',
                                labels: { boxWidth: 12, font: { size: 10 } }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    font: { size: 10 }
                                }
                            },
                            x: {
                                ticks: { font: { size: 10 } }
                            }
                        }
                    }
                });
            },
            
            renderConfiguracoes: () => {
                const content = document.getElementById('configuracoes-content');
                content.innerHTML = `
                    <div class="details-card">
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-database"></i> DADOS DO SISTEMA</div>
                            <div class="details-info-grid">
                                <div class="info-item">
                                    <div class="info-label">Total de Clientes</div>
                                    <div class="info-value">${UI.data.clientes.length}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Total de Imóveis</div>
                                    <div class="info-value">${UI.data.imoveis.length}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Agendamentos</div>
                                    <div class="info-value">${UI.data.agenda.length}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Último Backup</div>
                                    <div class="info-value">${new Date().toLocaleDateString('pt-BR')}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-cog"></i> AÇÕES</div>
                            <div class="details-actions">
                                <button class="btn-details btn-details-primary" onclick="App.backup.exportData()">
                                    <i class="fas fa-cloud-download-alt"></i> Backup
                                </button>
                                <button class="btn-details btn-details-secondary" onclick="UI.openSettings()">
                                    <i class="fas fa-sliders-h"></i> Configurar
                                </button>
                                <button class="btn-details btn-details-danger" onclick="App.backup.clearData()">
                                    <i class="fas fa-trash"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            showClienteDetails: (id) => {
                const c = UI.data.clientes.find(x => x.id === id);
                if(!c) return;
                
                const imoveisInteresse = c.imoveisInteresse ? 
                    c.imoveisInteresse.map(imovelId => 
                        UI.data.imoveis.find(i => i.id === imovelId)
                    ).filter(Boolean) : [];
                
                // Contar agendamentos do cliente
                const agendamentosCliente = UI.data.agenda.filter(a => a.clienteId === id);
                
                let statusBadge = '';
                const statusColor = Utils.getStatusColor(c.status);
                statusBadge = `<span class="badge badge-${statusColor}">${Utils.getStatusText(c.status)}</span>`;
                
                const detailsContent = `
                    <div class="details-card">
                        <div class="details-header">
                            <div>
                                <div class="details-title">${c.nome}</div>
                                <div class="details-subtitle">Cliente desde: ${Utils.formatDate(c.dataCadastro || new Date().toISOString().split('T')[0])}</div>
                            </div>
                            ${statusBadge}
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-info-circle"></i> INFORMAÇÕES</div>
                            <div class="details-info-grid">
                                <div class="info-item">
                                    <div class="info-label">Telefone</div>
                                    <div class="info-value">${c.telefone}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Email</div>
                                    <div class="info-value">${c.email || '-'}</div>
                                </div>
                                ${c.cpf ? `
                                <div class="info-item">
                                    <div class="info-label">CPF</div>
                                    <div class="info-value">${c.cpf}</div>
                                </div>
                                ` : ''}
                                ${c.nascimento ? `
                                <div class="info-item">
                                    <div class="info-label">Data Nascimento</div>
                                    <div class="info-value">${Utils.formatDate(c.nascimento)}</div>
                                </div>
                                ` : ''}
                                ${c.renda ? `
                                <div class="info-item">
                                    <div class="info-label">Renda Mensal</div>
                                    <div class="info-value">${Utils.formatCurrency(c.renda)}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${imoveisInteresse.length > 0 ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-home"></i> IMÓVEIS DE INTERESSE</div>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${imoveisInteresse.map(i => `
                                    <div class="list-card" style="margin-bottom: 8px;" onclick="UI.showImovelDetails('${i.id}')">
                                        <div class="card-header">
                                            <div class="card-title">${i.nome}</div>
                                            <span class="tag ${i.modalidade === 'lote' ? 'tag-lote' : (i.modalidade === 'pronto' ? 'tag-pronto' : 'tag-pre-lancamento')}">
                                                ${Utils.getModalidadeText(i.modalidade)}
                                            </span>
                                        </div>
                                        <div class="card-subtitle">${Utils.formatCurrency(i.valor)} • ${i.localizacao ? i.localizacao.substring(0, 30) + '...' : ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${agendamentosCliente.length > 0 ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-calendar-alt"></i> ÚLTIMOS AGENDAMENTOS</div>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${agendamentosCliente.slice(0, 3).map(a => `
                                    <div class="list-card" style="margin-bottom: 8px;" onclick="UI.showAgendaDetails('${a.id}')">
                                        <div class="card-header">
                                            <div class="card-title">${Utils.getTipoAgendaText(a.tipo)}</div>
                                            <span class="tag ${a.status === 'realizado' ? 'tag-closed' : (a.status === 'cancelado' ? 'tag-lost' : 'tag-scheduled')}">
                                                ${a.status.toUpperCase()}
                                            </span>
                                        </div>
                                        <div class="card-subtitle">${Utils.formatDateTime(a.data, a.horario)} • ${a.local || 'Local não informado'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${c.observacoes ? `
                        <div class="private-notes">
                            <div class="private-notes-label"><i class="fas fa-sticky-note"></i> OBSERVAÇÕES</div>
                            <div class="private-notes-content">${c.observacoes}</div>
                        </div>
                        ` : ''}
                        
                        <div class="details-actions">
                            <button class="btn-details btn-details-primary" onclick="App.cliente.edit('${c.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-details btn-details-whatsapp" onclick="App.whatsapp.confirmOpenCliente('${c.id}')">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="btn-details btn-details-secondary" onclick="UI.openNewAgendaForCliente('${c.id}')">
                                <i class="fas fa-calendar-plus"></i> Agendar
                            </button>
                            <button class="btn-details btn-details-cyan" onclick="App.cliente.changeStatus('${c.id}')">
                                <i class="fas fa-exchange-alt"></i> Status
                            </button>
                        </div>
                    </div>
                    <button class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Fechar</button>
                `;
                
                document.getElementById('cliente-details-content').innerHTML = detailsContent;
                UI.openModal('cliente-details');
            },

            showImovelDetails: (id) => {
                const i = UI.data.imoveis.find(x => x.id === id);
                if(!i) return;
                
                // Encontrar clientes interessados neste imóvel
                const clientesInteressados = UI.data.clientes.filter(c => 
                    c.imoveisInteresse && c.imoveisInteresse.includes(id)
                );
                
                let modalidadeBadge = '';
                switch(i.modalidade) {
                    case 'pre-lancamento':
                        modalidadeBadge = `<span class="badge badge-cyan">PRÉ-LANÇAMENTO</span>`;
                        break;
                    case 'lancamento':
                        modalidadeBadge = `<span class="badge badge-primary">LANÇAMENTO</span>`;
                        break;
                    case 'em-obra':
                        modalidadeBadge = `<span class="badge badge-warning">EM OBRA</span>`;
                        break;
                    case 'pronto':
                        modalidadeBadge = `<span class="badge badge-teal">PRONTO</span>`;
                        break;
                    case 'lote':
                        modalidadeBadge = `<span class="badge badge-secondary">LOTE</span>`;
                        break;
                }
                
                let statusBadge = '';
                if(i.status === 'vendido') {
                    statusBadge = `<span class="badge badge-success">VENDIDO</span>`;
                } else if(i.status === 'reservado') {
                    statusBadge = `<span class="badge badge-warning">RESERVADO</span>`;
                } else {
                    statusBadge = `<span class="badge badge-primary">DISPONÍVEL</span>`;
                }
                
                // Mostrar fotos
                let fotosHTML = '';
                if(i.fotos && i.fotos.length > 0) {
                    fotosHTML = `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-images"></i> FOTOS</div>
                            <div class="fotos-grid">
                                ${i.fotos.map((foto, index) => `
                                    <img src="${foto}" class="foto-thumb" onclick="App.imovel.viewFoto('${id}', ${index})">
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Campos específicos por tipo
                let camposEspecificos = '';
                if(i.tipo === 'lote') {
                    camposEspecificos = `
                        <div class="details-info-grid">
                            <div class="info-item">
                                <div class="info-label">Largura</div>
                                <div class="info-value">${i.largura || '-'} m</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Comprimento</div>
                                <div class="info-value">${i.comprimento || '-'} m</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Área Total</div>
                                <div class="info-value">${i.area || '-'} m²</div>
                            </div>
                        </div>
                    `;
                } else {
                    camposEspecificos = `
                        <div class="details-info-grid">
                            ${i.quartos ? `
                            <div class="info-item">
                                <div class="info-label">Quartos</div>
                                <div class="info-value">${i.quartos}</div>
                            </div>
                            ` : ''}
                            ${i.banheiros ? `
                            <div class="info-item">
                                <div class="info-label">Banheiros</div>
                                <div class="info-value">${i.banheiros}</div>
                            </div>
                            ` : ''}
                            ${i.vagas ? `
                            <div class="info-item">
                                <div class="info-label">Vagas</div>
                                <div class="info-value">${i.vagas}</div>
                            </div>
                            ` : ''}
                            ${i.area ? `
                            <div class="info-item">
                                <div class="info-label">Área</div>
                                <div class="info-value">${i.area} m²</div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                const detailsContent = `
                    <div class="details-card">
                        <div class="details-header">
                            <div>
                                <div class="details-title">${i.nome}</div>
                                <div class="details-subtitle">${i.tipo ? i.tipo.charAt(0).toUpperCase() + i.tipo.slice(1) : 'Imóvel'}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                ${modalidadeBadge}
                                ${statusBadge}
                            </div>
                        </div>
                        
                        ${fotosHTML}
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-info-circle"></i> INFORMAÇÕES GERAIS</div>
                            ${camposEspecificos}
                            <div class="details-info-grid" style="margin-top: 12px;">
                                <div class="info-item">
                                    <div class="info-label">Valor</div>
                                    <div class="info-value" style="color: var(--primary); font-size: 1.2rem;">${Utils.formatCurrency(i.valor)}</div>
                                </div>
                                ${i.construtora ? `
                                <div class="info-item">
                                    <div class="info-label">Construtora</div>
                                    <div class="info-value">${i.construtora}</div>
                                </div>
                                ` : ''}
                                ${i.dataEntrega ? `
                                <div class="info-item">
                                    <div class="info-label">Data de Entrega</div>
                                    <div class="info-value">${Utils.formatDate(i.dataEntrega)}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-map-marker-alt"></i> LOCALIZAÇÃO</div>
                            <div class="info-item">
                                <div class="info-label">Endereço/Localização</div>
                                <div class="info-value">${i.localizacao || 'Não informada'}</div>
                            </div>
                        </div>
                        
                        ${i.formaPagamento ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-money-check-alt"></i> FORMA DE PAGAMENTO</div>
                            <div class="info-item">
                                <div class="info-label">Condições</div>
                                <div class="info-value">${i.formaPagamento}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${i.descricao ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-align-left"></i> DESCRIÇÃO</div>
                            <div class="info-item">
                                <div class="info-label">Detalhes</div>
                                <div class="info-value">${i.descricao}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${clientesInteressados.length > 0 ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-users"></i> CLIENTES INTERESSADOS (${clientesInteressados.length})</div>
                            <div style="max-height: 150px; overflow-y: auto;">
                                ${clientesInteressados.slice(0, 5).map(c => `
                                    <div class="list-card" style="margin-bottom: 8px;" onclick="UI.showClienteDetails('${c.id}')">
                                        <div class="card-header">
                                            <div class="card-title">${c.nome}</div>
                                            <span class="tag ${c.status === 'lead' ? 'tag-lead' : (c.status === 'closed' ? 'tag-closed' : 'tag-prospect')}">
                                                ${Utils.getStatusText(c.status)}
                                            </span>
                                        </div>
                                        <div class="card-subtitle">${c.telefone} ${c.renda ? '• ' + Utils.formatCurrency(c.renda) : ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="details-actions">
                            <button class="btn-details btn-details-primary" onclick="App.imovel.edit('${i.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-details btn-details-whatsapp" onclick="App.whatsapp.shareImovel('${i.id}')">
                                <i class="fab fa-whatsapp"></i> Compartilhar
                            </button>
                            <button class="btn-details btn-details-secondary" onclick="UI.openNewAgendaForImovel('${i.id}')">
                                <i class="fas fa-calendar-plus"></i> Agendar Visita
                            </button>
                        </div>
                    </div>
                    <button class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Fechar</button>
                `;
                
                document.getElementById('imovel-details-content').innerHTML = detailsContent;
                UI.openModal('imovel-details');
            },
            
            showAgendaDetails: (id) => {
                const a = UI.data.agenda.find(x => x.id === id);
                if(!a) return;
                
                const c = UI.data.clientes.find(cl => cl.id === a.clienteId) || { nome: 'Desconhecido' };
                const i = a.imovelId ? UI.data.imoveis.find(im => im.id === a.imovelId) : null;
                
                let statusBadge = '';
                if(a.status === 'cancelado') statusBadge = `<span class="badge badge-danger">CANCELADO</span>`;
                else if(a.status === 'realizado') statusBadge = `<span class="badge badge-success">REALIZADO</span>`;
                else if(a.status === 'confirmado') statusBadge = `<span class="badge badge-primary">CONFIRMADO</span>`;
                else statusBadge = `<span class="badge badge-warning">AGENDADO</span>`;
                
                const detailsContent = `
                    <div class="details-card">
                        <div class="details-header">
                            <div>
                                <div class="details-title">${Utils.getTipoAgendaText(a.tipo)}</div>
                                <div class="details-subtitle">Com ${c.nome}</div>
                            </div>
                            ${statusBadge}
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-calendar-alt"></i> DETALHES</div>
                            <div class="details-info-grid">
                                <div class="info-item">
                                    <div class="info-label">Data</div>
                                    <div class="info-value">${Utils.formatDate(a.data)}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Horário</div>
                                    <div class="info-value">${a.horario}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Local</div>
                                    <div class="info-value">${a.local || 'Não informado'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Cliente</div>
                                    <div class="info-value">${c.nome}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${i ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-home"></i> IMÓVEL</div>
                            <div class="list-card" onclick="UI.showImovelDetails('${i.id}')">
                                <div class="card-header">
                                    <div class="card-title">${i.nome}</div>
                                    <span class="tag ${i.modalidade === 'lote' ? 'tag-lote' : (i.modalidade === 'pronto' ? 'tag-pronto' : 'tag-pre-lancamento')}">
                                        ${Utils.getModalidadeText(i.modalidade)}
                                    </span>
                                </div>
                                <div class="card-subtitle">${Utils.formatCurrency(i.valor)} • ${i.localizacao ? i.localizacao.substring(0, 30) + '...' : ''}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${a.descricao ? `
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-sticky-note"></i> DESCRIÇÃO/OBSERVAÇÕES</div>
                            <div class="info-item">
                                <div class="info-label">Detalhes</div>
                                <div class="info-value">${a.descricao}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="details-actions">
                            <button class="btn-details btn-details-primary" onclick="App.agenda.edit('${a.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-details btn-details-whatsapp" onclick="App.whatsapp.confirmOpenCliente('${c.id}')">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="btn-details btn-details-secondary" onclick="App.agenda.delete('${a.id}')">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        </div>
                    </div>
                    <button class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Fechar</button>
                `;
                
                // Criar um modal temporário para mostrar os detalhes
                const tempModal = document.createElement('div');
                tempModal.className = 'modal-overlay active';
                tempModal.innerHTML = `
                    <div class="modal-sheet" style="transform: translateY(0);">
                        <div class="sheet-handle"></div>
                        <div id="agenda-details-content">${detailsContent}</div>
                    </div>
                `;
                
                tempModal.addEventListener('click', (e) => {
                    if (e.target === tempModal) {
                        document.body.removeChild(tempModal);
                    }
                });
                
                document.body.appendChild(tempModal);
            },

            // --- MODALS ---
            openModal: (type) => {
                document.getElementById(`overlay-${type}`).classList.add('active');
                requestAnimationFrame(() => {
                    document.getElementById(`overlay-${type}`).classList.add('active');
                });
            },
            closeModals: () => {
                document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
            },

            openNewCliente: () => {
                // Carregar imóveis para o select múltiplo
                const selectImoveis = document.getElementById('c-imoveis-interesse');
                selectImoveis.innerHTML = '<option value="">Selecione imóveis de interesse...</option>';
                UI.data.imoveis.forEach(i => {
                    if(i.status !== 'vendido') {
                        selectImoveis.innerHTML += `<option value="${i.id}">${i.nome} - ${Utils.formatCurrency(i.valor)}</option>`;
                    }
                });
                
                document.getElementById('form-cliente').reset();
                document.getElementById('c-id').value = '';
                document.getElementById('title-cliente').innerText = 'Novo Cliente';
                UI.openModal('cliente');
            },

            openNewImovel: () => {
                // Limpar fotos anteriores
                document.getElementById('fotos-container').innerHTML = '';
                document.getElementById('i-fotos-data').value = '';
                
                document.getElementById('form-imovel').reset();
                document.getElementById('i-id').value = '';
                document.getElementById('title-imovel').innerText = 'Novo Imóvel';
                
                // Mostrar campos apropriados
                App.imovel.toggleTipoFields();
                
                UI.openModal('imovel');
            },
            
            openNewAgenda: () => {
                const selectCliente = document.getElementById('a-cliente');
                const selectImovel = document.getElementById('a-imovel');
                
                // Carregar clientes
                selectCliente.innerHTML = '<option value="">Selecione um cliente...</option>';
                UI.data.clientes.forEach(c => {
                    selectCliente.innerHTML += `<option value="${c.id}">${c.nome} - ${c.telefone}</option>`;
                });
                
                // Carregar imóveis
                selectImovel.innerHTML = '<option value="">Selecione um imóvel...</option>';
                UI.data.imoveis.forEach(i => {
                    if(i.status !== 'vendido') {
                        selectImovel.innerHTML += `<option value="${i.id}">${i.nome} - ${Utils.formatCurrency(i.valor)}</option>`;
                    }
                });
                
                // Definir data para hoje
                document.getElementById('a-data').value = Utils.getToday();
                
                document.getElementById('form-agenda').reset();
                document.getElementById('a-id').value = '';
                document.getElementById('title-agenda').innerText = 'Novo Agendamento';
                UI.openModal('agenda');
            },
            
            openNewAgendaForCliente: (clienteId) => {
                UI.closeModals();
                setTimeout(() => {
                    UI.openNewAgenda();
                    setTimeout(() => {
                        document.getElementById('a-cliente').value = clienteId;
                    }, 100);
                }, 300);
            },
            
            openNewAgendaForImovel: (imovelId) => {
                UI.closeModals();
                setTimeout(() => {
                    UI.openNewAgenda();
                    setTimeout(() => {
                        document.getElementById('a-imovel').value = imovelId;
                        document.getElementById('a-tipo').value = 'visita';
                    }, 100);
                }, 300);
            },
            
            openWhatsappMassa: () => {
                // Carregar lista de clientes com checkbox
                const clientesList = document.getElementById('whatsapp-clientes-list');
                clientesList.innerHTML = UI.data.clientes
                    .filter(c => c.telefone && c.status !== 'lost')
                    .map(c => `
                        <div class="client-checkbox-item">
                            <input type="checkbox" id="whatsapp-cliente-${c.id}" value="${c.id}" data-nome="${c.nome}" data-telefone="${c.telefone}">
                            <label for="whatsapp-cliente-${c.id}" style="flex: 1; cursor: pointer;">
                                <div style="font-weight: 600;">${c.nome}</div>
                                <div style="font-size: 0.8rem; color: var(--secondary);">${c.telefone} • ${Utils.getStatusText(c.status)}</div>
                            </label>
                        </div>
                    `).join('');
                
                // Definir mensagem padrão
                document.getElementById('whatsapp-template').value = 'lead';
                App.whatsapp.changeTemplate();
                
                UI.openModal('whatsapp-massa');
            },

            openSettings: () => {
                const s = Storage.getSettings();
                document.getElementById('s-nome').value = s.nome || '';
                document.getElementById('s-creci').value = s.creci || '';
                document.getElementById('s-telefone').value = s.telefone || '';
                document.getElementById('s-email').value = s.email || '';
                document.getElementById('s-instagram').value = s.instagram || '';
                document.getElementById('s-endereco').value = s.endereco || '';
                document.getElementById('s-msg-lead').value = s.msgLead || '';
                document.getElementById('s-msg-followup').value = s.msgFollowup || '';
                
                // Logo Handling
                document.getElementById('s-logo-data').value = s.logo || '';
                if(s.logo) {
                    document.getElementById('s-logo-preview').src = s.logo;
                    document.getElementById('s-logo-preview').style.display = 'block';
                    document.getElementById('s-logo-placeholder').style.display = 'none';
                } else {
                    document.getElementById('s-logo-preview').style.display = 'none';
                    document.getElementById('s-logo-placeholder').style.display = 'flex';
                }
                
                UI.openModal('settings');
            },
            
            openWhatsappConfirmCliente: (clienteId) => {
                UI.currentWhatsappClienteId = clienteId;
                UI.openModal('whatsapp-confirm');
            }
        };

        // --- APP LOGIC ---
        const App = {
            cliente: {
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('c-id').value || Utils.id();
                    const nome = document.getElementById('c-nome').value;
                    const telefone = document.getElementById('c-telefone').value;
                    const email = document.getElementById('c-email').value;
                    const nascimento = document.getElementById('c-nascimento').value;
                    const cpf = document.getElementById('c-cpf').value;
                    const renda = Utils.parseCurrency(document.getElementById('c-renda').value);
                    const status = document.getElementById('c-status').value;
                    const observacoes = document.getElementById('c-observacoes').value;
                    
                    // Obter imóveis de interesse (select múltiplo)
                    const imoveisSelect = document.getElementById('c-imoveis-interesse');
                    const imoveisInteresse = Array.from(imoveisSelect.selectedOptions).map(opt => opt.value);

                    const newClient = { 
                        id, 
                        nome, 
                        telefone, 
                        email,
                        nascimento,
                        cpf,
                        renda,
                        status,
                        observacoes,
                        imoveisInteresse,
                        dataCadastro: new Date().toISOString().split('T')[0],
                        ultimoContato: new Date().toISOString().split('T')[0]
                    };
                    
                    // Se for fechado, adicionar data de fechamento
                    if(status === 'closed' && !UI.data.clientes.find(c => c.id === id)?.dataFechamento) {
                        newClient.dataFechamento = new Date().toISOString().split('T')[0];
                    }
                    
                    const existingIdx = UI.data.clientes.findIndex(c => c.id === id);
                    if(existingIdx >= 0) {
                        UI.data.clientes[existingIdx] = newClient;
                    } else {
                        UI.data.clientes.push(newClient);
                    }

                    Storage.set('clientes', UI.data.clientes);
                    Utils.toast('Cliente salvo!');
                    UI.closeModals();
                    UI.renderDashboard();
                    UI.renderClientes();
                    UI.renderFunil();
                    UI.renderRelatorios();
                },
                edit: (id) => {
                    const c = UI.data.clientes.find(x => x.id === id);
                    if(!c) return;
                    
                    document.getElementById('c-id').value = c.id;
                    document.getElementById('c-nome').value = c.nome;
                    document.getElementById('c-telefone').value = c.telefone;
                    document.getElementById('c-email').value = c.email || '';
                    document.getElementById('c-nascimento').value = c.nascimento || '';
                    document.getElementById('c-cpf').value = c.cpf || '';
                    
                    const rendaInput = document.getElementById('c-renda');
                    if(c.renda) {
                        rendaInput.value = (c.renda * 100).toFixed(0);
                        Utils.maskMoney(rendaInput);
                    } else {
                        rendaInput.value = '';
                    }
                    
                    document.getElementById('c-status').value = c.status;
                    document.getElementById('c-observacoes').value = c.observacoes || '';
                    
                    // Carregar imóveis para o select múltiplo
                    const selectImoveis = document.getElementById('c-imoveis-interesse');
                    selectImoveis.innerHTML = '<option value="">Selecione imóveis de interesse...</option>';
                    UI.data.imoveis.forEach(i => {
                        if(i.status !== 'vendido') {
                            const selected = c.imoveisInteresse && c.imoveisInteresse.includes(i.id) ? 'selected' : '';
                            selectImoveis.innerHTML += `<option value="${i.id}" ${selected}>${i.nome} - ${Utils.formatCurrency(i.valor)}</option>`;
                        }
                    });
                    
                    document.getElementById('title-cliente').innerText = 'Editar Cliente';
                    UI.openModal('cliente');
                },
                delete: (id) => {
                    if(confirm('Excluir este cliente?')) {
                        UI.data.clientes = UI.data.clientes.filter(c => c.id !== id);
                        Storage.set('clientes', UI.data.clientes);
                        UI.renderDashboard();
                        UI.renderClientes();
                        UI.renderFunil();
                        Utils.toast('Cliente excluído!', 'success');
                    }
                },
                changeStatus: (id) => {
                    const c = UI.data.clientes.find(x => x.id === id);
                    if(!c) return;
                    
                    const currentStatus = c.status;
                    const statusOptions = ['lead', 'prospect', 'negotiation', 'contract', 'closed', 'lost'];
                    const currentIndex = statusOptions.indexOf(currentStatus);
                    const nextIndex = (currentIndex + 1) % statusOptions.length;
                    
                    c.status = statusOptions[nextIndex];
                    
                    // Se mudou para fechado, registrar data
                    if(c.status === 'closed' && !c.dataFechamento) {
                        c.dataFechamento = new Date().toISOString().split('T')[0];
                    }
                    
                    Storage.set('clientes', UI.data.clientes);
                    Utils.toast(`Status alterado para: ${Utils.getStatusText(c.status)}`);
                    
                    // Atualizar UI
                    UI.renderDashboard();
                    UI.renderClientes();
                    UI.renderFunil();
                    
                    // Fechar modal se estiver aberto
                    UI.closeModals();
                }
            },

            imovel: {
                fotos: [],
                
                toggleTipoFields: () => {
                    const tipo = document.getElementById('i-tipo').value;
                    
                    // Ocultar todos os campos dinâmicos
                    document.querySelectorAll('.dynamic-fields').forEach(field => {
                        field.classList.remove('active');
                    });
                    
                    // Mostrar campos apropriados
                    if(tipo === 'lote') {
                        document.getElementById('campos-lote').classList.add('active');
                    } else {
                        document.getElementById('campos-apartamento').classList.add('active');
                    }
                },
                
                handleFotos: async (input) => {
                    if (input.files && input.files.length > 0) {
                        const files = Array.from(input.files);
                        const maxFotos = 20;
                        const fotosAtuais = App.imovel.fotos.length;
                        
                        if(fotosAtuais + files.length > maxFotos) {
                            Utils.toast(`Máximo de ${maxFotos} fotos permitido`, 'error');
                            return;
                        }
                        
                        try {
                            for(const file of files.slice(0, maxFotos - fotosAtuais)) {
                                const base64 = await Utils.readImage(file);
                                App.imovel.fotos.push(base64);
                            }
                            
                            App.imovel.renderFotos();
                            Utils.toast(`${files.length} foto(s) adicionada(s)`);
                        } catch (e) {
                            Utils.toast('Erro ao processar fotos', 'error');
                        }
                    }
                },
                
                renderFotos: () => {
                    const container = document.getElementById('fotos-container');
                    container.innerHTML = App.imovel.fotos.map((foto, index) => `
                        <div class="multi-photo-item">
                            <img src="${foto}" class="multi-photo">
                            <button type="button" class="remove-photo" onclick="App.imovel.removeFoto(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `).join('');
                    
                    // Adicionar botão de adicionar mais fotos se ainda houver espaço
                    if(App.imovel.fotos.length < 20) {
                        container.innerHTML += `
                            <div class="multi-photo-item" style="border: 2px dashed var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="document.getElementById('i-fotos-input').click()">
                                <i class="fas fa-plus" style="color: var(--secondary); font-size: 1.5rem;"></i>
                            </div>
                        `;
                    }
                    
                    // Salvar fotos em campo hidden
                    document.getElementById('i-fotos-data').value = JSON.stringify(App.imovel.fotos);
                },
                
                removeFoto: (index) => {
                    App.imovel.fotos.splice(index, 1);
                    App.imovel.renderFotos();
                    Utils.toast('Foto removida');
                },
                
                viewFoto: (imovelId, index) => {
                    const i = UI.data.imoveis.find(x => x.id === imovelId);
                    if(!i || !i.fotos || !i.fotos[index]) return;
                    
                    // Criar modal para visualizar foto
                    const modal = document.createElement('div');
                    modal.className = 'modal-overlay active';
                    modal.innerHTML = `
                        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90vw; max-height: 90vh;">
                            <img src="${i.fotos[index]}" style="max-width: 100%; max-height: 80vh; border-radius: 12px;">
                            <button onclick="document.body.removeChild(this.parentElement.parentElement)" style="position: absolute; top: -40px; right: 0; background: var(--dark); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 1rem;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            document.body.removeChild(modal);
                        }
                    });
                    
                    document.body.appendChild(modal);
                },
                
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('i-id').value || Utils.id();
                    const tipo = document.getElementById('i-tipo').value;
                    const nome = document.getElementById('i-nome').value;
                    const modalidade = document.getElementById('i-modalidade').value;
                    const construtora = document.getElementById('i-construtora').value;
                    const valor = Utils.parseCurrency(document.getElementById('i-valor').value);
                    const formaPagamento = document.getElementById('i-forma-pagamento').value;
                    const dataEntrega = document.getElementById('i-data-entrega').value;
                    const localizacao = document.getElementById('i-localizacao').value;
                    const descricao = document.getElementById('i-descricao').value;
                    const status = document.getElementById('i-status').value;
                    
                    // Campos específicos
                    let quartos, banheiros, vagas, area, largura, comprimento, areaLote;
                    
                    if(tipo === 'lote') {
                        largura = parseFloat(document.getElementById('i-largura').value?.replace(',', '.')) || 0;
                        comprimento = parseFloat(document.getElementById('i-comprimento').value?.replace(',', '.')) || 0;
                        areaLote = parseFloat(document.getElementById('i-area-lote').value?.replace(',', '.')) || 0;
                        area = areaLote;
                    } else {
                        quartos = parseInt(document.getElementById('i-quartos').value) || 0;
                        banheiros = parseInt(document.getElementById('i-banheiros').value) || 0;
                        vagas = parseInt(document.getElementById('i-vagas').value) || 0;
                        area = parseFloat(document.getElementById('i-area').value?.replace(',', '.')) || 0;
                    }
                    
                    // Obter fotos
                    let fotos = [];
                    try {
                        fotos = JSON.parse(document.getElementById('i-fotos-data').value) || App.imovel.fotos;
                    } catch (e) {
                        fotos = App.imovel.fotos;
                    }

                    const imovel = {
                        id,
                        tipo,
                        nome,
                        modalidade,
                        construtora,
                        valor,
                        formaPagamento,
                        dataEntrega,
                        localizacao,
                        descricao,
                        status,
                        quartos,
                        banheiros,
                        vagas,
                        area,
                        largura,
                        comprimento,
                        fotos,
                        dataCadastro: new Date().toISOString().split('T')[0]
                    };
                    
                    // Se foi vendido, registrar data
                    if(status === 'vendido' && !UI.data.imoveis.find(i => i.id === id)?.dataVenda) {
                        imovel.dataVenda = new Date().toISOString().split('T')[0];
                    }

                    const idx = UI.data.imoveis.findIndex(i => i.id === id);
                    if(idx >= 0) {
                        UI.data.imoveis[idx] = imovel;
                    } else {
                        UI.data.imoveis.push(imovel);
                    }

                    Storage.set('imoveis', UI.data.imoveis);
                    Utils.toast('Imóvel salvo!');
                    UI.closeModals();
                    UI.renderDashboard();
                    UI.renderImoveis();
                    UI.renderRelatorios();
                    
                    // Resetar fotos
                    App.imovel.fotos = [];
                },
                edit: (id) => {
                    const i = UI.data.imoveis.find(x => x.id === id);
                    if(!i) return;
                    
                    document.getElementById('i-id').value = i.id;
                    document.getElementById('i-tipo').value = i.tipo || 'apartamento';
                    document.getElementById('i-nome').value = i.nome;
                    document.getElementById('i-modalidade').value = i.modalidade || 'pre-lancamento';
                    document.getElementById('i-construtora').value = i.construtora || '';
                    document.getElementById('i-forma-pagamento').value = i.formaPagamento || '';
                    document.getElementById('i-data-entrega').value = i.dataEntrega || '';
                    document.getElementById('i-localizacao').value = i.localizacao || '';
                    document.getElementById('i-descricao').value = i.descricao || '';
                    document.getElementById('i-status').value = i.status || 'disponivel';
                    
                    const valorInput = document.getElementById('i-valor');
                    if(i.valor) {
                        valorInput.value = (i.valor * 100).toFixed(0);
                        Utils.maskMoney(valorInput);
                    } else {
                        valorInput.value = '';
                    }
                    
                    // Preencher campos específicos
                    if(i.tipo === 'lote') {
                        document.getElementById('i-largura').value = i.largura || '';
                        document.getElementById('i-comprimento').value = i.comprimento || '';
                        document.getElementById('i-area-lote').value = i.area || '';
                    } else {
                        document.getElementById('i-quartos').value = i.quartos || '';
                        document.getElementById('i-banheiros').value = i.banheiros || '';
                        document.getElementById('i-vagas').value = i.vagas || '';
                        document.getElementById('i-area').value = i.area || '';
                    }
                    
                    // Carregar fotos
                    App.imovel.fotos = i.fotos || [];
                    App.imovel.renderFotos();
                    
                    // Mostrar campos apropriados
                    App.imovel.toggleTipoFields();
                    
                    document.getElementById('title-imovel').innerText = `Editar Imóvel`;
                    UI.openModal('imovel');
                },
                delete: (id) => {
                    if(confirm('Excluir este imóvel?')) {
                        UI.data.imoveis = UI.data.imoveis.filter(i => i.id !== id);
                        Storage.set('imoveis', UI.data.imoveis);
                        UI.renderDashboard();
                        UI.renderImoveis();
                        UI.renderRelatorios();
                        Utils.toast('Imóvel excluído!', 'success');
                    }
                }
            },
            
            agenda: {
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('a-id').value || Utils.id();
                    const tipo = document.getElementById('a-tipo').value;
                    const clienteId = document.getElementById('a-cliente').value;
                    const imovelId = document.getElementById('a-imovel').value || null;
                    const data = document.getElementById('a-data').value;
                    const horario = document.getElementById('a-horario').value;
                    const local = document.getElementById('a-local').value;
                    const descricao = document.getElementById('a-descricao').value;
                    const status = document.getElementById('a-status').value;

                    const agendamento = {
                        id,
                        tipo,
                        clienteId,
                        imovelId,
                        data,
                        horario,
                        local,
                        descricao,
                        status,
                        dataCriacao: new Date().toISOString()
                    };
                    
                    // Atualizar último contato do cliente
                    const clienteIdx = UI.data.clientes.findIndex(c => c.id === clienteId);
                    if(clienteIdx >= 0) {
                        UI.data.clientes[clienteIdx].ultimoContato = data;
                    }

                    const idx = UI.data.agenda.findIndex(a => a.id === id);
                    if(idx >= 0) {
                        UI.data.agenda[idx] = agendamento;
                    } else {
                        UI.data.agenda.push(agendamento);
                    }

                    Storage.set('agenda', UI.data.agenda);
                    Storage.set('clientes', UI.data.clientes); // Salvar atualização do cliente
                    Utils.toast('Agendamento salvo!');
                    UI.closeModals();
                    UI.renderDashboard();
                    UI.renderAgenda();
                },
                edit: (id) => {
                    const a = UI.data.agenda.find(x => x.id === id);
                    if(!a) return;
                    
                    // Carregar clientes
                    const selectCliente = document.getElementById('a-cliente');
                    selectCliente.innerHTML = '<option value="">Selecione um cliente...</option>';
                    UI.data.clientes.forEach(c => {
                        const selected = c.id === a.clienteId ? 'selected' : '';
                        selectCliente.innerHTML += `<option value="${c.id}" ${selected}>${c.nome} - ${c.telefone}</option>`;
                    });
                    
                    // Carregar imóveis
                    const selectImovel = document.getElementById('a-imovel');
                    selectImovel.innerHTML = '<option value="">Selecione um imóvel...</option>';
                    UI.data.imoveis.forEach(i => {
                        const selected = i.id === a.imovelId ? 'selected' : '';
                        selectImovel.innerHTML += `<option value="${i.id}" ${selected}>${i.nome} - ${Utils.formatCurrency(i.valor)}</option>`;
                    });
                    
                    document.getElementById('a-id').value = a.id;
                    document.getElementById('a-tipo').value = a.tipo;
                    document.getElementById('a-cliente').value = a.clienteId;
                    document.getElementById('a-imovel').value = a.imovelId || '';
                    document.getElementById('a-data').value = a.data;
                    document.getElementById('a-horario').value = a.horario;
                    document.getElementById('a-local').value = a.local || '';
                    document.getElementById('a-descricao').value = a.descricao || '';
                    document.getElementById('a-status').value = a.status;
                    
                    document.getElementById('title-agenda').innerText = `Editar Agendamento`;
                    UI.openModal('agenda');
                },
                delete: (id) => {
                    if(confirm('Excluir este agendamento?')) {
                        UI.data.agenda = UI.data.agenda.filter(a => a.id !== id);
                        Storage.set('agenda', UI.data.agenda);
                        UI.renderDashboard();
                        UI.renderAgenda();
                        Utils.toast('Agendamento excluído!', 'success');
                    }
                }
            },

            settings: {
                previewLogo: async (input) => {
                    if (input.files && input.files[0]) {
                        try {
                            const base64 = await Utils.readImage(input.files[0]);
                            document.getElementById('s-logo-data').value = base64;
                            document.getElementById('s-logo-preview').src = base64;
                            document.getElementById('s-logo-preview').style.display = 'block';
                            document.getElementById('s-logo-placeholder').style.display = 'none';
                        } catch (e) {
                            Utils.toast('Erro ao ler imagem', 'error');
                        }
                    }
                },
                save: (e) => {
                    e.preventDefault();
                    const s = Storage.getSettings();
                    s.nome = document.getElementById('s-nome').value;
                    s.creci = document.getElementById('s-creci').value;
                    s.telefone = document.getElementById('s-telefone').value;
                    s.email = document.getElementById('s-email').value;
                    s.instagram = document.getElementById('s-instagram').value;
                    s.endereco = document.getElementById('s-endereco').value;
                    s.logo = document.getElementById('s-logo-data').value;
                    s.msgLead = document.getElementById('s-msg-lead').value;
                    s.msgFollowup = document.getElementById('s-msg-followup').value;
                    
                    Storage.saveSettings(s);
                    Utils.toast('Configurações salvas');
                    UI.closeModals();
                }
            },

            whatsapp: {
                confirmOpenCliente: (id) => {
                    UI.openWhatsappConfirmCliente(id);
                },
                
                openConversaSimples: () => {
                    if (!UI.currentWhatsappClienteId) return;
                    
                    const c = UI.data.clientes.find(x => x.id === UI.currentWhatsappClienteId);
                    if (!c) return;
                    
                    const num = c.telefone.replace(/\D/g, '');
                    const saudacao = Utils.getSaudacao();
                    const settings = Storage.getSettings();
                    
                    let msg = `${saudacao}, ${c.nome.split(' ')[0]}! Tudo bem?\n\n`;
                    msg += `Aqui é ${settings.nome}, como posso te ajudar hoje?`;
                    
                    window.open(`https://wa.me/55${num}?text=${encodeURIComponent(msg)}`, '_blank');
                    UI.closeModals();
                    UI.currentWhatsappClienteId = null;
                },
                
                openComDetalhes: () => {
                    if (!UI.currentWhatsappClienteId) return;
                    
                    const c = UI.data.clientes.find(x => x.id === UI.currentWhatsappClienteId);
                    const settings = Storage.getSettings();
                    
                    if (!c) return;
                    
                    const num = c.telefone.replace(/\D/g, '');
                    const saudacao = Utils.getSaudacao();
                    
                    let msg = `${saudacao}, ${c.nome.split(' ')[0]}! Tudo bem?\n\n`;
                    msg += `Aqui é ${settings.nome}. `;
                    
                    // Verificar se tem imóveis de interesse
                    if(c.imoveisInteresse && c.imoveisInteresse.length > 0) {
                        const imoveis = c.imoveisInteresse.map(id => 
                            UI.data.imoveis.find(i => i.id === id)
                        ).filter(Boolean);
                        
                        if(imoveis.length > 0) {
                            msg += `Gostaria de te atualizar sobre os imóveis do seu interesse:\n\n`;
                            
                            imoveis.forEach((i, index) => {
                                if(index < 3) { // Limitar a 3 imóveis
                                    msg += `🏠 *${i.nome}*\n`;
                                    msg += `💰 ${Utils.formatCurrency(i.valor)}\n`;
                                    msg += `📍 ${i.localizacao ? i.localizacao.substring(0, 50) : 'Localização não informada'}\n`;
                                    if(i.modalidade) {
                                        msg += `📅 ${Utils.getModalidadeText(i.modalidade)}\n`;
                                    }
                                    msg += `\n`;
                                }
                            });
                            
                            if(imoveis.length > 3) {
                                msg += `E mais ${imoveis.length - 3} imóveis...\n\n`;
                            }
                        }
                    }
                    
                    msg += `Fico à disposição para agendar uma visita ou esclarecer qualquer dúvida!`;
                    
                    window.open(`https://wa.me/55${num}?text=${encodeURIComponent(msg)}`, '_blank');
                    UI.closeModals();
                    UI.currentWhatsappClienteId = null;
                },
                
                shareImovel: (imovelId) => {
                    const i = UI.data.imoveis.find(x => x.id === imovelId);
                    const settings = Storage.getSettings();
                    
                    if(!i) return;
                    
                    let msg = `🏠 *${i.nome}*\n\n`;
                    msg += `💰 *Valor:* ${Utils.formatCurrency(i.valor)}\n`;
                    
                    if(i.tipo === 'lote') {
                        msg += `📏 *Área:* ${i.area || '-'} m²\n`;
                        if(i.largura && i.comprimento) {
                            msg += `📐 *Dimensões:* ${i.largura}m x ${i.comprimento}m\n`;
                        }
                    } else {
                        if(i.quartos) msg += `🛏️ *Quartos:* ${i.quartos}\n`;
                        if(i.banheiros) msg += `🚿 *Banheiros:* ${i.banheiros}\n`;
                        if(i.vagas) msg += `🚗 *Vagas:* ${i.vagas}\n`;
                        if(i.area) msg += `📏 *Área:* ${i.area} m²\n`;
                    }
                    
                    if(i.modalidade) {
                        msg += `📅 *Status:* ${Utils.getModalidadeText(i.modalidade)}\n`;
                    }
                    
                    if(i.localizacao) {
                        msg += `📍 *Localização:* ${i.localizacao}\n`;
                    }
                    
                    if(i.construtora) {
                        msg += `🏢 *Construtora:* ${i.construtora}\n`;
                    }
                    
                    msg += `\n*Contato:* ${settings.nome}\n`;
                    msg += `📞 ${settings.telefone}\n\n`;
                    msg += `_Interessado(a) neste imóvel? Entre em contato para mais informações!_`;
                    
                    // Codificar a mensagem para URL
                    const encodedMsg = encodeURIComponent(msg);
                    
                    // Abrir WhatsApp com a mensagem pré-preenchida (sem número específico)
                    window.open(`https://wa.me/?text=${encodedMsg}`, '_blank');
                },
                
                selectAll: () => {
                    document.querySelectorAll('#whatsapp-clientes-list input[type="checkbox"]').forEach(cb => {
                        cb.checked = true;
                    });
                },
                
                deselectAll: () => {
                    document.querySelectorAll('#whatsapp-clientes-list input[type="checkbox"]').forEach(cb => {
                        cb.checked = false;
                    });
                },
                
                changeTemplate: () => {
                    const template = document.getElementById('whatsapp-template').value;
                    const settings = Storage.getSettings();
                    let msg = '';
                    
                    switch(template) {
                        case 'lead':
                            msg = settings.msgLead || '{saudacao}, {nome}! Tudo bem? Me chamo {corretor} e gostaria de apresentar algumas oportunidades de imóveis que podem interessar a você. Posso te enviar mais informações?';
                            break;
                        case 'prospect':
                            msg = '{saudacao}, {nome}! Espero que esteja bem. Estou entrando em contato para saber se ainda tem interesse nos imóveis que apresentei. Posso te ajudar com alguma dúvida?';
                            break;
                        case 'negotiation':
                            msg = '{saudacao}, {nome}! Como vai? Gostaria de dar sequência à nossa negociação. Podemos agendar uma reunião para finalizar os detalhes?';
                            break;
                        case 'followup':
                            msg = settings.msgFollowup || '{saudacao}, {nome}! Espero que esteja bem. Estou entrando em contato para saber se ainda tem interesse nos imóveis que apresentei. Posso te ajudar com alguma dúvida?';
                            break;
                        case 'promocao':
                            msg = '{saudacao}, {nome}! Tenho uma ótima oportunidade para você! Novos imóveis com condições especiais. Posso te enviar os detalhes?';
                            break;
                        case 'custom':
                            msg = '';
                            break;
                    }
                    
                    document.getElementById('whatsapp-mensagem').value = msg;
                },
                
                sendMassa: () => {
                    // Coletar clientes selecionados
                    const checkboxes = document.querySelectorAll('#whatsapp-clientes-list input[type="checkbox"]:checked');
                    if(checkboxes.length === 0) {
                        Utils.toast('Selecione pelo menos um cliente', 'error');
                        return;
                    }
                    
                    const mensagem = document.getElementById('whatsapp-mensagem').value;
                    if(!mensagem.trim()) {
                        Utils.toast('Digite uma mensagem', 'error');
                        return;
                    }
                    
                    const settings = Storage.getSettings();
                    const saudacao = Utils.getSaudacao();
                    
                    // Para cada cliente selecionado
                    checkboxes.forEach((cb, index) => {
                        setTimeout(() => {
                            const clienteId = cb.value;
                            const c = UI.data.clientes.find(x => x.id === clienteId);
                            if(!c) return;
                            
                            // Personalizar mensagem
                            let msgPersonalizada = mensagem
                                .replace(/{nome}/g, c.nome.split(' ')[0])
                                .replace(/{saudacao}/g, saudacao)
                                .replace(/{corretor}/g, settings.nome.split(' ')[0]);
                            
                            const num = c.telefone.replace(/\D/g, '');
                            const encodedMsg = encodeURIComponent(msgPersonalizada);
                            
                            window.open(`https://wa.me/55${num}?text=${encodedMsg}`, '_blank');
                            
                        }, index * 2000); // Delay de 2 segundos entre cada abertura
                    });
                    
                    Utils.toast(`Mensagem enviada para ${checkboxes.length} cliente(s)`);
                    UI.closeModals();
                }
            },

            relatorios: {
                gerarVendas: () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    const settings = Storage.getSettings();
                    const hoje = new Date().toLocaleDateString('pt-BR');
                    
                    // Cabeçalho
                    doc.setFontSize(16);
                    doc.text('RELATÓRIO DE VENDAS', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.text(`Emitido por: ${settings.nome}`, 20, 30);
                    doc.text(`Data: ${hoje}`, 20, 36);
                    doc.text(`CRECI: ${settings.creci}`, 20, 42);
                    
                    // Clientes fechados
                    const clientesFechados = UI.data.clientes.filter(c => c.status === 'closed');
                    
                    let y = 60;
                    
                    if(clientesFechados.length === 0) {
                        doc.text('Nenhuma venda registrada.', 20, y);
                    } else {
                        doc.setFontSize(12);
                        doc.text('VENDAS REALIZADAS:', 20, y);
                        y += 10;
                        
                        clientesFechados.forEach((c, index) => {
                            if(y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            doc.setFontSize(10);
                            doc.text(`${index + 1}. ${c.nome}`, 25, y);
                            y += 6;
                            doc.text(`   CPF: ${c.cpf || 'Não informado'}`, 25, y);
                            y += 6;
                            doc.text(`   Valor: ${c.valorVenda ? Utils.formatCurrency(c.valorVenda) : 'Não informado'}`, 25, y);
                            y += 6;
                            doc.text(`   Data: ${c.dataFechamento ? Utils.formatDate(c.dataFechamento) : 'Não informada'}`, 25, y);
                            y += 10;
                        });
                        
                        // Totais
                        y += 5;
                        doc.setFontSize(11);
                        doc.setFont(undefined, 'bold');
                        const totalVendas = clientesFechados.length;
                        const totalReceita = clientesFechados.reduce((acc, c) => acc + (c.valorVenda || 0), 0);
                        doc.text(`TOTAL DE VENDAS: ${totalVendas}`, 20, y);
                        y += 7;
                        doc.text(`RECEITA TOTAL: ${Utils.formatCurrency(totalReceita)}`, 20, y);
                    }
                    
                    doc.save(`Relatorio_Vendas_${hoje.replace(/\//g, '-')}.pdf`);
                    Utils.toast('Relatório de vendas gerado!');
                },
                
                gerarPlantao: () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    const settings = Storage.getSettings();
                    const hoje = new Date().toLocaleDateString('pt-BR');
                    
                    // Cabeçalho
                    doc.setFontSize(16);
                    doc.text('RELATÓRIO DE PLANTÃO', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.text(`Emitido por: ${settings.nome}`, 20, 30);
                    doc.text(`Data: ${hoje}`, 20, 36);
                    
                    // Agendamentos do tipo plantão
                    const plantoes = UI.data.agenda.filter(a => a.tipo === 'plantao');
                    
                    let y = 60;
                    
                    if(plantoes.length === 0) {
                        doc.text('Nenhum plantão registrado.', 20, y);
                    } else {
                        // Agrupar por data
                        const plantoesPorData = {};
                        plantoes.forEach(p => {
                            if(!plantoesPorData[p.data]) {
                                plantoesPorData[p.data] = [];
                            }
                            plantoesPorData[p.data].push(p);
                        });
                        
                        // Ordenar datas
                        const datas = Object.keys(plantoesPorData).sort();
                        
                        datas.forEach(data => {
                            if(y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            doc.setFontSize(12);
                            doc.text(`DATA: ${Utils.formatDate(data)}`, 20, y);
                            y += 10;
                            
                            const plantoesDia = plantoesPorData[data];
                            plantoesDia.forEach((p, index) => {
                                if(y > 270) {
                                    doc.addPage();
                                    y = 20;
                                }
                                
                                const c = UI.data.clientes.find(cl => cl.id === p.clienteId);
                                doc.setFontSize(10);
                                doc.text(`${index + 1}. Horário: ${p.horario}`, 25, y);
                                y += 6;
                                if(c) {
                                    doc.text(`   Cliente: ${c.nome}`, 25, y);
                                    y += 6;
                                }
                                if(p.local) {
                                    doc.text(`   Local: ${p.local}`, 25, y);
                                    y += 6;
                                }
                                if(p.descricao) {
                                    const descLines = doc.splitTextToSize(`   Obs: ${p.descricao}`, 150);
                                    descLines.forEach(line => {
                                        doc.text(line, 25, y);
                                        y += 6;
                                    });
                                }
                                y += 4;
                            });
                            y += 5;
                        });
                        
                        // Totais
                        y += 5;
                        doc.setFontSize(11);
                        doc.setFont(undefined, 'bold');
                        doc.text(`TOTAL DE PLANTÕES: ${plantoes.length}`, 20, y);
                    }
                    
                    doc.save(`Relatorio_Plantao_${hoje.replace(/\//g, '-')}.pdf`);
                    Utils.toast('Relatório de plantão gerado!');
                },
                
                gerarClientes: () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    const settings = Storage.getSettings();
                    const hoje = new Date().toLocaleDateString('pt-BR');
                    
                    // Cabeçalho
                    doc.setFontSize(16);
                    doc.text('RELATÓRIO DE CLIENTES', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.text(`Emitido por: ${settings.nome}`, 20, 30);
                    doc.text(`Data: ${hoje}`, 20, 36);
                    doc.text(`Total de Clientes: ${UI.data.clientes.length}`, 20, 42);
                    
                    // Estatísticas por status
                    const statusCount = {};
                    UI.data.clientes.forEach(c => {
                        statusCount[c.status] = (statusCount[c.status] || 0) + 1;
                    });
                    
                    let y = 60;
                    
                    // Tabela de status
                    doc.setFontSize(12);
                    doc.text('DISTRIBUIÇÃO POR STATUS:', 20, y);
                    y += 10;
                    
                    Object.entries(statusCount).forEach(([status, count]) => {
                        if(y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        doc.setFontSize(10);
                        doc.text(`${Utils.getStatusText(status)}: ${count} clientes`, 25, y);
                        y += 7;
                    });
                    
                    // Lista de clientes (após estatísticas)
                    y += 10;
                    doc.setFontSize(12);
                    doc.text('LISTA DE CLIENTES:', 20, y);
                    y += 10;
                    
                    UI.data.clientes.forEach((c, index) => {
                        if(y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        doc.setFontSize(9);
                        doc.text(`${index + 1}. ${c.nome}`, 25, y);
                        y += 5;
                        doc.text(`   Status: ${Utils.getStatusText(c.status)}`, 25, y);
                        y += 5;
                        doc.text(`   Telefone: ${c.telefone}`, 25, y);
                        y += 5;
                        if(c.email) {
                            doc.text(`   Email: ${c.email}`, 25, y);
                            y += 5;
                        }
                        if(c.renda) {
                            doc.text(`   Renda: ${Utils.formatCurrency(c.renda)}`, 25, y);
                            y += 5;
                        }
                        if(c.dataCadastro) {
                            doc.text(`   Cadastro: ${Utils.formatDate(c.dataCadastro)}`, 25, y);
                            y += 5;
                        }
                        y += 3;
                    });
                    
                    doc.save(`Relatorio_Clientes_${hoje.replace(/\//g, '-')}.pdf`);
                    Utils.toast('Relatório de clientes gerado!');
                }
            },

            backup: {
                exportData: () => {
                    const data = {
                        clientes: UI.data.clientes,
                        imoveis: UI.data.imoveis,
                        agenda: UI.data.agenda,
                        settings: Storage.getSettings()
                    };
                    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_imobimanager_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    Utils.toast('Backup exportado com sucesso!');
                },
                importTrigger: () => document.getElementById('import-file').click(),
                importData: (input) => {
                    const file = input.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if(data.clientes) Storage.set('clientes', data.clientes);
                            if(data.imoveis) Storage.set('imoveis', data.imoveis);
                            if(data.agenda) Storage.set('agenda', data.agenda);
                            if(data.settings) Storage.saveSettings(data.settings);
                            location.reload();
                            Utils.toast('Backup importado com sucesso!');
                        } catch(err) {
                            Utils.toast('Erro no arquivo de backup', 'error');
                        }
                    };
                    reader.readAsText(file);
                },
                clearData: () => {
                    if(confirm('Tem certeza? Isso apagará TODOS os dados do sistema!')) {
                        localStorage.clear();
                        location.reload();
                    }
                }
            }
        };

        // Event listeners
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if(e.target === overlay) UI.closeModals();
            });
        });

        // Listener para alteração de tipo de imóvel
        document.getElementById('i-tipo').addEventListener('change', function() {
            App.imovel.toggleTipoFields();
        });

        document.addEventListener('DOMContentLoaded', UI.init);
    </script>
</body>
</html>